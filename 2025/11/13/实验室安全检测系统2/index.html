<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|JetBrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"atffang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="花了一个下午的时间修改了一下项目结构，简单记录一下">
<meta property="og:type" content="article">
<meta property="og:title" content="实验室安全检测系统2">
<meta property="og:url" content="https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/index.html">
<meta property="og:site_name" content="Tianyao&#39; s BLOG">
<meta property="og:description" content="花了一个下午的时间修改了一下项目结构，简单记录一下">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://atffang.github.io/2025/11/13/实验室安全检测系统2/结构.png">
<meta property="og:image" content="https://atffang.github.io/2025/11/13/实验室安全检测系统2/架构.png">
<meta property="article:published_time" content="2025-11-13T12:41:07.000Z">
<meta property="article:modified_time" content="2025-11-13T12:50:07.437Z">
<meta property="article:author" content="Fang Tianyao">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://atffang.github.io/2025/11/13/实验室安全检测系统2/结构.png">

<link rel="canonical" href="https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>实验室安全检测系统2 | Tianyao' s BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Tianyao' s BLOG" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tianyao' s BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Tianyao</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Fang Tianyao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tianyao' s BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          实验室安全检测系统2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-13 20:41:07 / 修改时间：20:50:07" itemprop="dateCreated datePublished" datetime="2025-11-13T20:41:07+08:00">2025-11-13</time>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>19 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>花了一个下午的时间修改了一下项目结构，简单记录一下</p>
<span id="more"></span>
<p>上次介绍了一下参与的一个横向中的一个模块，最近花了一点时间梳理了一下结构，简单记录一下。功能并没有增加，还是比较简单的。</p>
<h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3>
<img src="https://atffang.github.io/2025/11/13/实验室安全检测系统2/结构.png"/>
<p>系统由三个功能层组成：</p>
<ul>
<li><strong>infra</strong>：基础功能层，包括config（配置加载）、logging（日志打印）、messagequeues（消息队列）</li>
<li><strong>data</strong>：负责数据部分功能，主要包括frameprocessor（视频流相关）、database（minio与postgresql数据库的增删改查接口）。连接的psql数据库和minio由docker实现。</li>
<li><strong>core</strong>：核心业务层，包括prepocess（负责加载识别模型加载前需要预加载的数据）、modelloader（加载识别模型，定义识别方法（pridict）、输出识别结果、postprocess（后处理，主要为每日数据迁移任务））</li>
</ul>
<h4 id="1-infra"><a class="markdownIt-Anchor" href="#1-infra"></a> 1. infra</h4>
<h5 id="11-config"><a class="markdownIt-Anchor" href="#11-config"></a> 1.1 config</h5>
<p>读取根目录下的<code>config.yaml</code>文件，提供加载各类配置的接口，<code>config</code>文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -------- 数据库配置 --------</span></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5434</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">&quot;labcamera&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- MinIO配置 --------</span></span><br><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">&quot;localhost:9000&quot;</span></span><br><span class="line">  <span class="attr">access_key:</span> <span class="string">&quot;minioadmin&quot;</span></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">&quot;minioadmin&quot;</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">&quot;detection-results&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 事件映射表 --------</span></span><br><span class="line"><span class="attr">event:</span></span><br><span class="line">  <span class="attr">event_dict:</span></span><br><span class="line">    <span class="attr">coat:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">nightsingle:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">channeloccupancy:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 模型参数配置 --------</span></span><br><span class="line"><span class="attr">model:</span></span><br><span class="line">  <span class="attr">coatdetecter:</span> <span class="string">&quot;coatdetecter.json&quot;</span></span><br><span class="line">  <span class="attr">nightsingledetecter:</span> <span class="string">&quot;nightsingledetecter.json&quot;</span></span><br><span class="line">  <span class="attr">channeloccupancydetecter:</span> <span class="string">&quot;channeloccupancydetecter.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 监控流配置 --------</span></span><br><span class="line"><span class="attr">rtsp:</span></span><br><span class="line">  <span class="attr">server_ip:</span> <span class="string">&quot;***.***.***.***&quot;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">  <span class="attr">channel_num:</span> <span class="number">256</span></span><br><span class="line">  <span class="attr">stream_type:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 启动时间配置 --------</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="attr">&quot;main_program&quot;:</span></span><br><span class="line">    <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;05:00&quot;</span></span><br><span class="line">    <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">  <span class="attr">&quot;summary_program&quot;:</span></span><br><span class="line">    <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">    <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;05:00&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="12-logging"><a class="markdownIt-Anchor" href="#12-logging"></a> 1.2 logging</h5>
<p>日志模块</p>
<h5 id="13-messagequeues"><a class="markdownIt-Anchor" href="#13-messagequeues"></a> 1.3 messagequeues</h5>
<p>消息队列模块，首先在<code>PhotoMessage.py</code>中定义了两个类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoMessage</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    表示视频流处理管线中的单帧消息对象。  </span></span><br><span class="line"><span class="string">    用于封装单帧图像及其关联的上下文信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    属性说明：</span></span><br><span class="line"><span class="string">        photo_id (str): 帧的唯一标识符（默认使用 UUID 自动生成）。</span></span><br><span class="line"><span class="string">        camera_id (str): 摄像头设备编号或标识。</span></span><br><span class="line"><span class="string">        room_id (str): 拍摄帧所在的物理位置或房间标识。</span></span><br><span class="line"><span class="string">        photo_path (Path): 帧图像文件的路径或内存引用。</span></span><br><span class="line"><span class="string">        timestamp (datetime): 帧捕获的时间戳（若未提供则自动生成）。</span></span><br><span class="line"><span class="string">        metadata (Dict[str, Any]): 附加的处理上下文信息。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    camera_id: <span class="built_in">str</span></span><br><span class="line">    room_id: <span class="built_in">str</span></span><br><span class="line">    photo_path: Path</span><br><span class="line">    task_id: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    photo_id: <span class="built_in">str</span> = field(default_factory=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    timestamp: datetime = field(default_factory=datetime.now)</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DetectionResult</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    表示单帧图像检测（识别）结果的数据结构。  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    属性说明：</span></span><br><span class="line"><span class="string">        ifwarning (bool): 是否触发告警（True 表示异常或警告）。</span></span><br><span class="line"><span class="string">        image (Optional[Image.Image]): 检测后的处理图像或标注结果。</span></span><br><span class="line"><span class="string">        description (str): 检测结果的文本描述信息。</span></span><br><span class="line"><span class="string">        timestamp (Optional[datetime]): 检测结果生成的时间戳。</span></span><br><span class="line"><span class="string">        task_id (int): 关联的任务标识符。</span></span><br><span class="line"><span class="string">        room_id (str): 检测帧所在的物理房间标识。</span></span><br><span class="line"><span class="string">        camera_id (str): 对应的摄像头编号。</span></span><br><span class="line"><span class="string">        alarm_category (str): 告警类型或类别（默认值为 &#x27;unknow&#x27;）。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ifwarning: <span class="built_in">bool</span> = <span class="literal">False</span>, image: <span class="type">Optional</span>[Image.Image] = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                 description: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, timestamp: <span class="type">Optional</span>[datetime] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 task_id: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 room_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, camera_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, alarm_category: <span class="built_in">str</span> = <span class="string">&quot;unknow&quot;</span></span>):</span><br><span class="line">        ifwarning = ifwarning</span><br><span class="line">        self.image = image</span><br><span class="line">        self.description = description</span><br><span class="line">        self.timestamp = timestamp</span><br><span class="line">        self.room_id = room_id</span><br><span class="line">        self.camera_id = camera_id</span><br><span class="line">        self.alarm_category = alarm_category</span><br><span class="line">        self.task_id = task_id</span><br></pre></td></tr></table></figure>
<p>并在<code>MessageQueue.py</code>中定义了一个全局消息队列<code>GlobalMessageQueue()</code>，用于存放<code>PhotoMessage</code>，并确保其线程安全。并实现：</p>
<ul>
<li><code>put_message(self, msg: PhotoMessage) -&gt; bool</code></li>
<li><code>get_message(self) -&gt; Optional[PhotoMessage]</code></li>
<li><code>persist_messages(self, file_path: Path) -&gt; int</code></li>
<li><code>load_messages(self, file_path: Path) -&gt; int</code></li>
<li>……</li>
</ul>
<p>等方法。</p>
<h4 id="2data"><a class="markdownIt-Anchor" href="#2data"></a> 2.Data</h4>
<h5 id="21-frameprocessor"><a class="markdownIt-Anchor" href="#21-frameprocessor"></a> 2.1 frameprocessor</h5>
<p>负责视频流处理。首先在<code>rtsp_client.py</code>中定义了实现：</p>
<ul>
<li>登录视频服务器获取 Token</li>
<li>定时保活</li>
<li>注册播放通道</li>
<li>获取指定摄像头的 RTSP URL</li>
<li>登出释放 Token</li>
</ul>
<p>功能的RTSPClient 类，并定义了其线程实现<code>RTSPServiceThread(threading.Thread)</code>，该线程启动后运行逻辑为：</p>
<ul>
<li>登录并注册播放通道</li>
<li>循环执行 keep_alive 保活</li>
<li>异常处理后自动登出</li>
</ul>
<p>随后在<code>get_rtsp.py</code>定义了<code>CaptureThread(threading.Thread)</code>的摄像头抓帧线程，管理 RTSP 流保活和帧捕获。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CaptureThread</span>(threading.Thread):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    摄像头抓帧线程，管理 RTSP 流保活和帧捕获。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        rtsp_config (dict): RTSP 配置</span></span><br><span class="line"><span class="string">        rtsp_thread (RTSPServiceThread): RTSP 服务线程</span></span><br><span class="line"><span class="string">        db_conn: 数据库连接对象</span></span><br><span class="line"><span class="string">        running (bool): 线程运行状态</span></span><br><span class="line"><span class="string">        camera_list (List[Dict[str, Any]]): 当前任务摄像头列表</span></span><br><span class="line"><span class="string">        wait_rtsp (int): 两次摄像头抓帧间隔（秒）</span></span><br><span class="line"><span class="string">        round_rtsp (int): 每轮抓帧最小总间隔（秒）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(daemon=<span class="literal">True</span>)</span><br><span class="line">        self.rtsp_config = RTSP_CONFIG</span><br><span class="line">        self.rtsp_thread = RTSPServiceThread(RTSP_CONFIG)</span><br><span class="line">        self.db_conn = <span class="literal">None</span></span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.camera_list: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = []</span><br><span class="line">        self.wait_rtsp = <span class="number">1</span></span><br><span class="line">        self.round_rtsp = <span class="number">600</span></span><br></pre></td></tr></table></figure>
<p>线程主逻辑：</p>
<ul>
<li>启动 RTSP 服务线程（自动保活）</li>
<li>连接数据库获取摄像头列表</li>
<li>循环抓取摄像头单帧图像并发送到消息队列</li>
</ul>
<h5 id="22-database"><a class="markdownIt-Anchor" href="#22-database"></a> 2.2 database</h5>
<p>database模块基于分层式架构模式（entity、repository、service三层）</p>
<ul>
<li>entity：实体层，定义了数据库中各个表对应的实体类，如<code>Camera</code>、<code>Results</code>、<code>ResultsTemp</code>。</li>
<li>repository：数据访问层，负责与数据库进行交互，提供数据持久化和检索功能，如<code>CameraRepository</code>、<code>ResultsRepository</code>、<code>ResultsTempRepository</code>。</li>
<li>service：业务逻辑层，负责处理业务逻辑，如<code>CameraService</code>、<code>ResultsMigrationService</code>、<code>ResultsNightService</code>、<code>ResultsTempSaverService</code>，这部分负责提供数据库部分的各个接口，给其他组件调用，实现解耦。</li>
</ul>
<p>我们以数据暂存为例，其需求是每次检测完成后，暂存数据到t_results_temp表中，因此，我们需要先定义一个<strong>ResultsTemp</strong>的Entity：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResultsEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;t_results&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    task_id = Column(String(<span class="number">100</span>))</span><br><span class="line">    event_id = Column(Integer)</span><br><span class="line">    description = Column(Text)</span><br><span class="line">    time1 = Column(TIMESTAMP)</span><br><span class="line">    time2 = Column(TIMESTAMP)</span><br><span class="line">    picture1 = Column(String(<span class="number">255</span>))</span><br><span class="line">    picture2 = Column(String(<span class="number">255</span>))</span><br><span class="line">    picture3 = Column(String(<span class="number">255</span>))</span><br></pre></td></tr></table></figure>
<p>随后，定义一层数据访问层<strong>ResultsTempRepository</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> entity.ResultsTemp <span class="keyword">import</span> ResultsTempEntity</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResultsTempRepository</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, session: Session</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert</span>(<span class="params">self, entity: ResultsTempEntity</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_all</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_task</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_by_event_and_date</span>(<span class="params">self, event_ids, date_str</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_batch</span>(<span class="params">self, records</span>):</span><br></pre></td></tr></table></figure>
<p>最后，定义一个Service：<strong>ResultsTempSaverService</strong> 来提供服务接口：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataSaverService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Service 层：处理检测结果保存（数据库 + MinIO 上传）&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_detection_result</span>(<span class="params">self, result: DetectionResult</span>):</span><br></pre></td></tr></table></figure>
<p>那么，在其他组件中调用<code>save_detection_result</code>即可。</p>
<h4 id="3-core"><a class="markdownIt-Anchor" href="#3-core"></a> 3. Core</h4>
<h5 id="31-preprocess"><a class="markdownIt-Anchor" href="#31-preprocess"></a> 3.1 preprocess</h5>
<p>里面放一些预处理函数，比如从数据库下载通道范围。然后我们在<code>detect.py</code>中在启动识别线程前调用即可。比如说我在<code>detect.py</code>里面调用的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.preprocess <span class="keyword">import</span> LoadChannelRange</span><br><span class="line"><span class="comment"># 首先下载摄像头范围数据</span></span><br><span class="line">LoadChannelRange.save()</span><br></pre></td></tr></table></figure>
<h5 id="32-modelloader"><a class="markdownIt-Anchor" href="#32-modelloader"></a> 3.2 modelloader</h5>
<p><strong>重点</strong></p>
<p>modeller部分负责加载模型，并实现识别功能。<br />
对于一个识别功能模块，首先，我们需要在modelloader/config中添加一个配置json文件，比如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;coatdetecter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yolo11s&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pt&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core/modelloader/model/yolo11s.pt&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mobilenet_v2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core/modelloader/model/coat_classifier_final.pth&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>并将其添加到根目录下的<code>config.yaml</code>文件中的 模型参数配置 部分。<br />
并且按照&quot;weight_path&quot;的路径正确将权重模型存放在相应的路径。</p>
<p>随后，我们在在modelloader/functionmodel定义一个模型识别类，我在这个路径下的<code>base_detector.py</code>提供了一个抽象类:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseDetector</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Detector 示例模板</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    子类必须实现 load 方法，返回 predict 函数：</span></span><br><span class="line"><span class="string">        predict(message: PhotoMessage, image_input: np.ndarray) -&gt; Optional[DetectionResult]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    predict 函数必须：</span></span><br><span class="line"><span class="string">    1. 接受 PhotoMessage 和 np.ndarray（BGR 图像）</span></span><br><span class="line"><span class="string">    2. 返回 DetectionResult 或 None</span></span><br><span class="line"><span class="string">    3. 对图像操作应使用 copy()，避免并行冲突</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">model_pipeline: <span class="built_in">list</span>, device</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化模型，返回 predict 函数。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> 在这里实现你的模型初始化逻辑</span></span><br><span class="line">        <span class="comment"># 初始化逻辑示例：</span></span><br><span class="line">        <span class="comment"># parent_dir = Path(__file__).resolve().parents[3]</span></span><br><span class="line">        <span class="comment"># yolo_path = parent_dir / model_pipeline[0][&quot;weight_path&quot;]</span></span><br><span class="line">        <span class="comment"># yolo_model = YOLO(yolo_path).to(device)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">message: PhotoMessage, image_input: np.ndarray</span>) -&gt; <span class="type">Optional</span>[DetectionResult]:</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            对输入图像执行检测，返回 DetectionResult 或 None。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> 在这里实现你的检测逻辑</span></span><br><span class="line">            image = image_input.copy()</span><br><span class="line">            <span class="comment"># 检测逻辑示例：</span></span><br><span class="line">            <span class="comment"># for box in detected_boxes:</span></span><br><span class="line">            <span class="comment">#     crop = image[...]</span></span><br><span class="line">            <span class="comment">#     pred = classify(crop)</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果有异常情况,则构造并返回DetectionResult：</span></span><br><span class="line">            <span class="comment"># return DetectionResult(...)</span></span><br><span class="line">            <span class="comment"># 如果没有异常情况，返回None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> predict</span><br></pre></td></tr></table></figure>
<p>基于这个抽象类的要求，实现一个具体的识别类，比如我在<code>coat_detector.py</code>中实现了一个<code>CoatDetector(BaseDetector)</code>类。</p>
<p>同时，在<code>modelloader.py</code>中，提供了一个工厂类<code>ModelLoader</code>，用于加载模型，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelLoader</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    模型加载工厂类，统一根据模型名称返回预测函数。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    MODEL_MAP: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Callable</span>[[<span class="type">Any</span>, torch.device], <span class="type">Any</span>]] = &#123;</span><br><span class="line">        <span class="string">&quot;coatdetecter&quot;</span>: CoatDetector.load,</span><br><span class="line">        <span class="string">&quot;nightsingledetecter&quot;</span>: NightSingleDetector.load,</span><br><span class="line">        <span class="string">&quot;channeloccupancydetecter&quot;</span>: ChannelOccupancyDetector.load</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loader</span>(<span class="params">model_name: <span class="built_in">str</span>, model_pipeline: <span class="type">Any</span>, device: torch.device</span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据模型名称加载对应的检测模型，并返回预测函数。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            model_name (str): 模型名称，如 &quot;coatdetecter&quot;。</span></span><br><span class="line"><span class="string">            model_pipeline (Any): 模型权重路径或配置列表。</span></span><br><span class="line"><span class="string">            device (torch.device): 模型运行设备。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Callable: 用于执行预测的函数，输入为 image/message，输出 DetectionResult。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValueError: 如果模型名称不在支持列表中。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            load_func = ModelLoader.MODEL_MAP[model_name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Model &#x27;<span class="subst">&#123;model_name&#125;</span>&#x27; is not supported.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> load_func(model_pipeline, device)</span><br></pre></td></tr></table></figure>
<p>为了加载刚刚的模型，我们把模型名字和模型类.load函数加载在<code>MODEL_MAP</code>中</p>
<p>再同时，在<code>modelloader.py</code>中，还提供了一个<code>IdentificationModel</code>类，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IdentificationModel</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        self.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">        self.name = config[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        self.pipeline = config[<span class="string">&quot;pipeline&quot;</span>]</span><br><span class="line">        self.predict = self._loadmodel()</span><br></pre></td></tr></table></figure>
<p>这个<code>IdentificationModel</code>类，调用了工厂类<code>ModelLoader</code>的<code>loader</code>方法，将模型加载到<code>predict</code>中，然后我们就可以直接调用实例化后的<code>IdentificationModel</code>类的<code>predict</code>方法进行识别了。这里其实逻辑比较混乱，读者完全可以将这两个类合并。</p>
<p>了解完这些后，我们最终定义一个消费者线程类，该类首先基于config文件，初始化一个<code>IdentificationModel</code>实例列表，然后对于<code>messagequeue</code>中的每个<code>PhotoMessage</code>，遍历调用每个<code>IdentificationModel</code>实例的<code>pridict()</code>方法进行识别，并调用<code>data.service</code>暴露的存储接口进行存储。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoConsumer</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_list: <span class="type">List</span>[<span class="built_in">dict</span>], poll_interval: <span class="built_in">float</span> = <span class="number">1</span>, max_workers: <span class="built_in">int</span> = <span class="number">4</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        多线程消费者：从 global_mq 获取消息，读取图片，执行模型推理，并删除图片。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param config_list: 一组 config 字典（每个配置一个模型）</span></span><br><span class="line"><span class="string">        :param poll_interval: 轮询间隔秒数</span></span><br><span class="line"><span class="string">        :param max_workers: 并发处理的最大线程数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(daemon=<span class="literal">True</span>)</span><br><span class="line">        self.poll_interval = poll_interval</span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.db = DataSaver()</span><br><span class="line">        self.executor = ThreadPoolExecutor(max_workers=max_workers)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化模型列表</span></span><br><span class="line">        self.modellist = [IdentificationModel(config) <span class="keyword">for</span> config <span class="keyword">in</span> config_list]</span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> self.modellist:</span><br><span class="line">            logger.info(model)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="string">&quot;&quot;&quot;停止线程并关闭线程池&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;主线程循环获取消息并交由线程池处理&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, message: PhotoMessage</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理单条消息的识别与存储&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>最后定义一个<code>start_photo_consumer_concurrent()</code>函数用于启动模型消费者，有detect.py调用，其中，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer = PhotoConsumer(config_list, max_workers=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>其中，<code>max_workers</code>为启用的消费者线程数</p>
<h5 id="33-postprocess"><a class="markdownIt-Anchor" href="#33-postprocess"></a> 3.3 postprocess</h5>
<p>里面放一天的识别结束后的操作，比如说将识别结果数据梳理后从t_results_temp表迁移到t_results表，并删除t_results_temp表中的数据。preprocess和postprocess里面的操作大多数被封装为了data.database.service里面的服务接口，只要调用就行了。值得关注的是，preprocess在<code>detect.py</code>中被调用，而postprocess在<code>main.py</code>中被调用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.postprocess.migration_runner <span class="keyword">import</span> DailyMigrationTask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 归纳程序控制</span></span><br><span class="line">summary_start = str_to_time(config[<span class="string">&quot;summary_program&quot;</span>][<span class="string">&quot;start&quot;</span>])</span><br><span class="line">summary_end = str_to_time(config[<span class="string">&quot;summary_program&quot;</span>][<span class="string">&quot;end&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> in_time_range(summary_start, summary_end, now):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> started_summary:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] 启动归纳程序&quot;</span>)</span><br><span class="line">        task = DailyMigrationTask()</span><br><span class="line">        task.run()</span><br><span class="line">        started_summary = <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> started_summary <span class="keyword">and</span> summary_proc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] 关闭归纳程序&quot;</span>)</span><br><span class="line">        started_summary = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">60</span>)</span><br></pre></td></tr></table></figure>
<h3 id="架构"><a class="markdownIt-Anchor" href="#架构"></a> 架构</h3>
<img src="https://atffang.github.io/2025/11/13/实验室安全检测系统2/架构.png"/>
现在没有设计多GPU，也暂时没有必要。
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/11/12/deepsort/" rel="prev" title="DeepSort (SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC)">
      <i class="fa fa-chevron-left"></i> DeepSort (SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC)
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/12/21/MTMCT%E6%96%B9%E5%90%91%E7%9A%84%E5%BA%A6%E9%87%8F%E5%AD%A6%E4%B9%A0%E6%A2%B3%E7%90%86/" rel="next" title="MTMCT方向的度量学习梳理">
      MTMCT方向的度量学习梳理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text"> 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-infra"><span class="nav-number">1.1.</span> <span class="nav-text"> 1. infra</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#11-config"><span class="nav-number">1.1.1.</span> <span class="nav-text"> 1.1 config</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-logging"><span class="nav-number">1.1.2.</span> <span class="nav-text"> 1.2 logging</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-messagequeues"><span class="nav-number">1.1.3.</span> <span class="nav-text"> 1.3 messagequeues</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2data"><span class="nav-number">1.2.</span> <span class="nav-text"> 2.Data</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#21-frameprocessor"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 2.1 frameprocessor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#22-database"><span class="nav-number">1.2.2.</span> <span class="nav-text"> 2.2 database</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-core"><span class="nav-number">1.3.</span> <span class="nav-text"> 3. Core</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#31-preprocess"><span class="nav-number">1.3.1.</span> <span class="nav-text"> 3.1 preprocess</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32-modelloader"><span class="nav-number">1.3.2.</span> <span class="nav-text"> 3.2 modelloader</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#33-postprocess"><span class="nav-number">1.3.3.</span> <span class="nav-text"> 3.3 postprocess</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text"> 架构</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fang Tianyao"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Fang Tianyao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:fty643737159@gmail.com" title="欢迎交流 E-Mail → mailto:fty643737159@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>欢迎交流 E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://geo.ecnu.edu.cn/" title="华东师范大学，地图学与地理信息系统 → https:&#x2F;&#x2F;geo.ecnu.edu.cn&#x2F;" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>华东师范大学，地图学与地理信息系统</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-terminal"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fang Tianyao</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">213k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:28</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  











<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css">


  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":25,"vOffset":-30},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
