<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Tianyao&#39; s BLOG</title>
  
  <subtitle>Tianyao</subtitle>
  <link href="https://atffang.github.io/atom.xml" rel="self"/>
  
  <link href="https://atffang.github.io/"/>
  <updated>2026-01-22T04:50:02.318Z</updated>
  <id>https://atffang.github.io/</id>
  
  <author>
    <name>Fang Tianyao</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kafka架构入门</title>
    <link href="https://atffang.github.io/2026/01/16/Kafka1kafka%E6%9E%B6%E6%9E%84%E5%85%A5%E9%97%A8/"/>
    <id>https://atffang.github.io/2026/01/16/Kafka1kafka%E6%9E%B6%E6%9E%84%E5%85%A5%E9%97%A8/</id>
    <published>2026-01-16T03:33:39.000Z</published>
    <updated>2026-01-22T04:50:02.318Z</updated>
    
    <content type="html"><![CDATA[<p>Kafka架构入门：以一个解耦SpringBoot和Python的需求为例。</p><span id="more"></span><h3 id="intro"><a class="markdownIt-Anchor" href="#intro"></a> Intro</h3><h4 id="kafka简介"><a class="markdownIt-Anchor" href="#kafka简介"></a> Kafka简介</h4><p>由 LinkedIn 开发的 <span style="color: #BB8ED0; font-weight: bold;">Kafka</span> 是一个开源的<strong>分布式事件流平台</strong>（Distributed Event Streaming Platform），旨在解决大规模数据传输中的低延迟与高吞吐难题，后贡献给 Apache 基金会。</p><p>在现代微服务架构与大数据体系中，Kafka 早已超越了传统<strong>消息队列</strong>（Message Queue）的范畴，成为处理流式数据、实现系统解耦以及构建实时数据管道的核心基础设施。</p><p>从计算机科学的角度定义，Kafka 是一个<strong>基于日志结构（Log-structured）的分布式发布-订阅消息系统</strong>。</p><p>其核心设计哲学源于<span style="color: #5aa9e6; font-weight: bold;">预写日志</span>（Write-Ahead Log, WAL）。在数据库设计中，WAL 用于保证事务的原子性和持久性；Kafka 将这一概念泛化，将数据流抽象为一个不可变的、有序的、仅支持追加写入的日志序列。</p><div style="background-color: #f7f9fc; border: 1px solid #e1e4e8; border-radius: 15px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"><p style="margin-top: 0; margin-bottom: 6px; color: #333; border-bottom: 2px solid #5aa9e6; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;">预写日志</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">预写日志（Write-Ahead Log，简称 WAL ）</span>是数据库和分布式系统中保证数据可靠性（Durability）和一致性（Consistency）的核心技术。它的核心逻辑是，在修改真正的数据库文件（数据页）之前，必须先将这次修改的行为记录在日志文件中，并持久化到磁盘上。</p></div><br>这种基于预写日志的设计带来了两个本质优势：- <span style="color: #89986D; font-weight: bold;">持久化（Durability）</span>：消息被直接写入磁盘，而非仅驻留在内存，确保数据不丢失。- <span style="color: #89986D; font-weight: bold;">顺序 I/O（Sequential I/O）</span>：利用磁盘的顺序读写特性，在机械硬盘（HDD）上也能实现接近内存的随机读写性能。<h4 id="核心架构组件"><a class="markdownIt-Anchor" href="#核心架构组件"></a> 核心架构组件</h4><img src="/2026/01/16/Kafka1kafka%E6%9E%B6%E6%9E%84%E5%85%A5%E9%97%A8/%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84.jpg" class="" title="sucessful"><p>Kafka 的运行时架构由以下逻辑实体与物理节点构成：</p><h5 id="broker代理节点"><a class="markdownIt-Anchor" href="#broker代理节点"></a> Broker（代理节点）</h5><p>Kafka 集群中的物理服务器节点。一个 Kafka 集群由多个 <span style="color: #89986D; font-weight: bold;">Broker</span> 组成。Broker 负责接收生产者的消息、持久化存储数据至磁盘，并响应消费者的拉取请求。</p><h5 id="topic主题与-partition分区"><a class="markdownIt-Anchor" href="#topic主题与-partition分区"></a> Topic（主题）与 Partition（分区）</h5><ul><li><p><span style="color: #89986D; font-weight: bold;">Topic</span>：数据的逻辑分类单位。在逻辑上，一个 Topic 可以被视为一个消息流。</p></li><li><p><span style="color: #89986D; font-weight: bold;">Partition</span>：Topic 的物理分片。这是 Kafka 实现<strong>水平扩展（Horizontal Scalability）与并行处理</strong>的关键。</p><ul><li>一个 Topic 分散在多个 Broker 上的多个 Partition 中。</li><li>每个 Partition 是一个有序的日志文件。</li><li><strong>Offset（偏移量）</strong>：Partition 中的每条消息都分配有一个唯一的、单调递增的整数 ID，称为 Offset。它唯一标识了消息在分区内的位置。</li></ul></li></ul><h5 id="producer生产者"><a class="markdownIt-Anchor" href="#producer生产者"></a> Producer（生产者）</h5><p><span style="color: #89986D; font-weight: bold;">Producer</span>负责向 Topic 发送消息的客户端应用。</p><ul><li><strong>路由策略</strong>：生产者决定将消息发送到 Topic 的哪个 Partition。默认采用<strong>轮询</strong>（Round-robin）策略以实现负载均衡；若消息指定了 Key，则通过哈希算法（<code>Hash(Key) % PartitionCount</code>）确保相同 Key 的消息始终写入同一 Partition，从而保证局部有序性。</li></ul><h5 id="consumer消费者与-consumer-group消费者组"><a class="markdownIt-Anchor" href="#consumer消费者与-consumer-group消费者组"></a> Consumer（消费者）与 Consumer Group（消费者组）</h5><p>这是 Kafka 区别于传统 MQ 最重要的设计模式。</p><ul><li><span style="color: #89986D; font-weight: bold;">Consumer Group</span>：一个逻辑上的订阅者集合。组内的每个消费者负责消费 Topic 中不同 Partition 的数据。</li><li><strong>并行消费机制</strong>：一个 Partition 在同一时刻只能被同一个 Consumer Group 内的一个 Consumer 消费。这保证了消息处理的互斥性与顺序性。</li><li><strong>发布/订阅模式</strong>：不同 Consumer Group 之间相互隔离，可以独立消费同一份数据（即广播模式）。</li></ul><h5 id="replication副本机制与-isr"><a class="markdownIt-Anchor" href="#replication副本机制与-isr"></a> Replication（副本机制）与 ISR</h5><p>为了保障高可用性（High Availability），每个 Partition 都有多个副本。</p><ul><li><strong>Leader Replica</strong>：负责处理所有的读写请求。</li><li><strong>Follower Replica</strong>：被动地从 Leader 同步数据，仅用于故障转移（Failover）。</li><li><strong>ISR (In-Sync Replicas)</strong>：处于同步状态的副本集合。只有 ISR 中的节点才有资格被选举为新的 Leader。</li></ul><h4 id="关键技术特性"><a class="markdownIt-Anchor" href="#关键技术特性"></a> 关键技术特性</h4><p>Kafka 之所以能达到<strong>每秒百万级的吞吐量</strong>，主要依赖于以下底层机制：</p><ul><li><span style="color: #89986D; font-weight: bold;">零拷贝（Zero Copy）技术</span> ：在传统的网络传输中，数据需经由“磁盘 -&gt; 内核缓冲区 -&gt; 用户缓冲区 -&gt; Socket 缓冲区 -&gt; 网卡”的多次拷贝。Kafka 利用操作系统的 <code>sendfile</code> 系统调用，直接将数据从 Page Cache 传输到 NIC（网卡）缓冲区，避免了上下文切换与多余的内存拷贝。</li><li><span style="color: #89986D; font-weight: bold;">页缓存（Page Cache）利用</span> ：Kafka 并不显式管理内存缓存，而是极度依赖操作系统的 Page Cache。这意味着即使 Java 进程重启，只要操作系统未崩溃，热点数据依然驻留在内存中，极大提升了读取性能。</li><li><span style="color: #89986D; font-weight: bold;">批处理（Batching）</span> ：生产者并非逐条发送消息，而是将多条消息打包成 Batch 进行网络传输；服务端同样以 Batch 为单位进行磁盘写入。这有效减少了网络 RTT（往返时延）和磁盘 IOPS。</li></ul><h4 id="适用场景"><a class="markdownIt-Anchor" href="#适用场景"></a> 适用场景</h4><p>基于上述架构，我们列举四个 Kafka 的常用场景：</p><div style="background-color: #F0F4F8; border: 1px solid #D9E2EC; border-radius: 15px; padding: 16px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"> <p style="margin-top: 0; margin-bottom: 8px; color: #243B53; border-bottom: 2px solid #829AB1; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;"> 1. 异步通信与解耦 (Asynchronous Decoupling)</p> <p style="color: #486581; font-size: 0.95em; margin: 8px 0; line-height: 1.6;"> <span style="font-weight: bold; color: #334E68;">在微服务架构中，缓解上游服务的压力，平滑突发流量（削峰填谷）。</span> </p> <div style="background-color: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; margin-top: 10px;"> 用户上传了一个 500MB 的 PDF 文档给 Java 后端，Java 不需要死等解析进程解析完，而是直接把任务扔进 Kafka 并立刻告诉用户上传成功。后端的解析进程可以在后台从 Kafka 领取任务解析，互不干扰。 </div> </div><br><div style="background-color: #F0F5F1; border: 1px solid #E1E8E3; border-radius: 15px; padding: 16px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"> <p style="margin-top: 0; margin-bottom: 8px; color: #2D4A3E; border-bottom: 2px solid #8DA399; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;"> 2. 日志聚合 (Log Aggregation)</p> <p style="color: #4A6359; font-size: 0.95em; margin: 8px 0; line-height: 1.6;"> <span style="font-weight: bold; color: #2F4F42;">作为 ELK (Elasticsearch, Logstash, Kibana) 技术栈的核心缓冲层，收集分布在数千台服务器上的业务日志</span> </p> <div style="background-color: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; margin-top: 10px;"> 你有 100 台微服务节点，某个订单报错了。如果没有 Kafka，你需要登录 100 台机器去 grep 日志。有了 Kafka后，可以通过Elasticsearch集中管理。 </div> </div><br><div style="background-color: #FDF2F2; border: 1px solid #F0E0E0; border-radius: 15px; padding: 16px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"> <p style="margin-top: 0; margin-bottom: 8px; color: #612F2F; border-bottom: 2px solid #CFA9A9; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;"> 3. 流式处理 (Stream Processing)</p> <p style="color: #7D4E4E; font-size: 0.95em; margin: 8px 0; line-height: 1.6;"> <span style="font-weight: bold; color: #5C2B2B;">结合 Kafka Streams 或 Apache Flink，对实时数据流进行窗口计算、聚合与变换。</span> </p> <div style="background-color: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; margin-top: 10px;">用户在短视频APP里每划过一个视频，这个行为就是一个事件流。可以通过 Kafka 实时捕获这些点击，使用流计算引擎立算用户的兴趣点，调整他的推荐算法。 </div> </div><br><div style="background-color: #F9F7F3; border: 1px solid #EBE6DC; border-radius: 15px; padding: 16px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"> <p style="margin-top: 0; margin-bottom: 8px; color: #594D33; border-bottom: 2px solid #B5A886; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;">4. 事件源 (Event Sourcing)</p> <p style="color: #6E6145; font-size: 0.95em; margin: 8px 0; line-height: 1.6;"> <span style="font-weight: bold; color: #4D422B;">利用 Kafka 的持久化与有序性，将状态的变化记录为一系列事件序列，用于系统状态的重建与审计</span> </p> <div style="background-color: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; margin-top: 10px;"> 在金融级应用中，仅维护当前的账户余额并不足以满足合规与溯源需求。通过 Kafka 持久化存储存款、消费、转账等一系列事务指令，当发生系统宕机或数据损毁时，系统能够通过顺序重放（Replay）事件序列，在内存中精确重建特定时刻的账户状态。 </div> </div><h4 id="基础语法与-cli-操作规范"><a class="markdownIt-Anchor" href="#基础语法与-cli-操作规范"></a> 基础语法与 CLI 操作规范</h4><h5 id="创建主题-create-topic"><a class="markdownIt-Anchor" href="#创建主题-create-topic"></a> 创建主题 (Create Topic)</h5><p>创建一个名为 <code>tasks</code> 的主题，包含 3 个分区与 1 个副本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --create \</span><br><span class="line">    --topic geo-tasks \</span><br><span class="line">    --bootstrap-server localhost:9092 \</span><br><span class="line">    --partitions 3 \</span><br><span class="line">    --replication-factor 1</span><br></pre></td></tr></table></figure><h5 id="查看主题详情-describe-topic"><a class="markdownIt-Anchor" href="#查看主题详情-describe-topic"></a> 查看主题详情 (Describe Topic)</h5><p>用于确认分区分布与 Leader 节点位置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --describe \</span><br><span class="line">    --topic geo-tasks \</span><br><span class="line">    --bootstrap-server localhost:9092</span><br></pre></td></tr></table></figure><h4 id="生产消息-console-producer"><a class="markdownIt-Anchor" href="#生产消息-console-producer"></a> 生产消息 (Console Producer)</h4><p>启动控制台生产者，向主题发送消息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh \</span><br><span class="line">    --topic geo-tasks \</span><br><span class="line">    --bootstrap-server localhost:9092</span><br><span class="line"><span class="comment"># 输入如下内容后回车</span></span><br><span class="line">&gt; &#123;<span class="string">&quot;id&quot;</span>: 1, <span class="string">&quot;action&quot;</span>: <span class="string">&quot;ingest&quot;</span>, <span class="string">&quot;file&quot;</span>: <span class="string">&quot;map.shp&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h5 id="消费消息-console-consumer"><a class="markdownIt-Anchor" href="#消费消息-console-consumer"></a> 消费消息 (Console Consumer)</h5><p>启动控制台消费者。<strong>注意</strong>：在生产环境中，必须指定 <code>group.id</code> 以便管理消费进度。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh \</span><br><span class="line">    --topic geo-tasks \</span><br><span class="line">    --bootstrap-server localhost:9092 \</span><br><span class="line">    --group georag-backend-group \</span><br><span class="line">    --from-beginning</span><br></pre></td></tr></table></figure><ul><li><code>--from-beginning</code>：表示从 Topic 的起始位置开始消费，而非仅消费启动后新到达的消息。</li><li><code>--group</code>：指定消费者组 ID。Kafka 会自动记录该组消费到的 Offset。</li></ul><h3 id="项目简介"><a class="markdownIt-Anchor" href="#项目简介"></a> 项目简介</h3><p>由于本次项目的需求，仅介绍 Kafka 作为 MQ 是的应用方法。</p><p>在本项目中，<strong>Spring Boot</strong>持有与前端用户的 WebSocket 连接、HTTP 会话（Session）以及业务数据库的读写权限。而<strong>Python</strong>是后台计算引擎，负责 CPU/GPU 密集型的 AI 运算，但不直接与用户浏览器通信。</p><p>在<span style="color: #89986D; font-weight: bold;">任务下发</span>流程中，Spring Boot接受到用户发起的请求后，会做以下工作：</p><ul><li>生成一个唯一的 <strong>Task ID</strong></li><li>将任务载荷（例如 <code>&#123; &quot;taskId&quot;: &quot;1001&quot;, &quot;fileUrl&quot;: &quot;/data/a.shp&quot; &#125;</code>）封装成 JSON。</li><li>将消息写入 Kafka 的 <strong>请求主题</strong>（例如 <code>topic-task-request</code>）。</li><li>写入 Kafka 后，立即向前端返回 HTTP 200 “Task Received”，释放 Web 线程。</li><li>Python 监听 <code>topic-task-request</code>，当轮到该消息时，Python 拉取数据，开始执行运算。</li></ul><p>在<span style="color: #89986D; font-weight: bold;">结果回传</span>流程中，Python 运算结束，生成结果数据后，会做以下工作：</p><ul><li>将结果封装成 JSON，<strong>带上之前的 Task ID</strong>（例如 <code>&#123; &quot;taskId&quot;: &quot;1001&quot;, &quot;status&quot;: &quot;DONE&quot;, &quot;vector&quot;: [...] &#125;</code>）。</li><li>将消息写入 Kafka 的 <strong>结果主题</strong>（例如 <code>topic-task-result</code>）。这里是写入另一个不同的 Topic，实现了读写分离。</li><li>Java（配置了 <code>@KafkaListener</code>）实时监听 <code>topic-task-result</code>。</li><li>一旦收到消息，Java 解析 JSON，提取 <code>taskId</code>。</li><li>Java 根据 <code>taskId</code> 找到对应的业务记录，找到对应的用户连接，将最终结果实时推送给前端展示。</li></ul><p>该流程就是一次<span style="color: #5aa9e6; font-weight: bold;">全双工通信</span>。</p><div style="background-color: #f7f9fc; border: 1px solid #e1e4e8; border-radius: 15px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"><p style="margin-top: 0; margin-bottom: 6px; color: #333; border-bottom: 2px solid #5aa9e6; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;">全双工通信</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">全双工通信（Full-Duplex Communication）</span>是数据通信的一种方式，指数据可以同时在两个方向上传输。其要求通信时在通信链路上拥有独立的两条路径，一条用于发送（TX），一条用于接收（RX），并在同一条物理路径上，通过不同的频率（FDD）或极短的时间切片（TDD）来区分发送和接收信号。</p></div><br>### Spring Boot 集成 Kafka#### 基础配置在微服务架构中，Spring Boot 通过 `spring-kafka` 项目提供了对 Kafka 客户端的高级抽象。它封装了底层的 `KafkaProducer` 和 `KafkaConsumer` API，通过自动配置与模板模式，极大降低了通过 Java 进行流式交互的复杂度。<p>首先，需要在构建工具中引入 Spring Kafka 的官方 Starter 依赖，如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Kafka 是基于字节流传输的，因此必须明确定义键（Key）与值（Value）的序列化与反序列化策略（SerDes）。考虑到系统后续需与 Python 服务进行交互，采用 JSON 作为 Payload 标准是最好的。</p><p>配置文件<code>application.yml</code>如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  kafka:</span><br><span class="line">    bootstrap-servers: localhost:9092 # 集群接入点地址</span><br><span class="line">    </span><br><span class="line">    # 生产者配置</span><br><span class="line">    producer:</span><br><span class="line">      # 重试次数，增强网络抖动下的容错性</span><br><span class="line">      retries: 3 </span><br><span class="line">      # 确认机制：all 代表 Leader 和 ISR 队列所有副本都确认写入才视为成功，保障数据强一致性</span><br><span class="line">      acks: all </span><br><span class="line">      # 批处理大小（字节），提升网络吞吐</span><br><span class="line">      batch-size: 16384 </span><br><span class="line">      # 序列化器：Key 使用字符串，Value 使用 JSON</span><br><span class="line">      key-serializer: org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer</span><br><span class="line">      properties:</span><br><span class="line">        # 自定义 JSON 类型映射，防止反序列化时的安全限制</span><br><span class="line">        spring.json.trusted.packages: &quot;*&quot;</span><br><span class="line"></span><br><span class="line">    # 消费者配置</span><br><span class="line">    consumer:</span><br><span class="line">      # 默认消费者组 ID，用于标识逻辑订阅者集合</span><br><span class="line">      group-id: georag-backend-group</span><br><span class="line">      # 当 Offset 丢失时的策略：earliest (从头消费), latest (只消费新消息)</span><br><span class="line">      auto-offset-reset: earliest</span><br><span class="line">      # 反序列化器：需与生产者对应</span><br><span class="line">      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer</span><br><span class="line">      properties:</span><br><span class="line">        spring.json.trusted.packages: &quot;*&quot;</span><br></pre></td></tr></table></figure><h4 id="生产者"><a class="markdownIt-Anchor" href="#生产者"></a> 生产者</h4><p>Spring Boot 提供的 <code>KafkaTemplate</code> 是线程安全的，支持并发发送。在生产环境中，必须采用异步回调来处理发送结果，避免主线程阻塞。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.kafka.core.KafkaTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.support.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, Object&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EventProducer</span><span class="params">(KafkaTemplate&lt;String, Object&gt; kafkaTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送数据处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic 目标主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 消息键（通常用于分区路由，如 fileId）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload 消息载荷实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendGeoTask</span><span class="params">(String topic, String key, Object payload)</span> &#123;</span><br><span class="line">        <span class="comment">// 执行异步发送</span></span><br><span class="line">        CompletableFuture&lt;SendResult&lt;String, Object&gt;&gt; future = kafkaTemplate.send(topic, key, payload);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册回调函数处理结果</span></span><br><span class="line">        future.whenComplete((result, ex) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 发送成功：记录元数据（分区信息、偏移量）</span></span><br><span class="line">                System.out.printf(<span class="string">&quot;Sent message to topic: %s, partition: %d, offset: %d%n&quot;</span>,</span><br><span class="line">                        topic,</span><br><span class="line">                        result.getRecordMetadata().partition(),</span><br><span class="line">                        result.getRecordMetadata().offset());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 发送失败：执行重试逻辑或落库记录死信</span></span><br><span class="line">                System.err.println(<span class="string">&quot;Unable to send message due to: &quot;</span> + ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="消费者"><a class="markdownIt-Anchor" href="#消费者"></a> 消费者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.support.Acknowledgment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听处理结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> record 包含元数据和载荷的记录对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack 手动提交确认对象（如开启手动提交模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;topic-knowledge-result&quot;, groupId = &quot;georag-backend-group&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleGeoResult</span><span class="params">(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> record.key();</span><br><span class="line">            <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> record.value();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 业务逻辑：处理 Python 返回的结果</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;Received result for file %s from partition %d%n&quot;</span>, fileId, record.partition());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 此处调用 WebSocket 服务通知前端或更新数据库状态</span></span><br><span class="line">            processResult(fileId, resultJson);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 显式提交 Offset（如果配置了手动提交）</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 异常处理：记录日志，且不提交 Offset 以触发重试</span></span><br><span class="line">            System.err.println(<span class="string">&quot;Error consuming message: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processResult</span><span class="params">(String fileId, String data)</span> &#123;</span><br><span class="line">        <span class="comment">// 具体业务逻辑实现</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="python-集成-kafka"><a class="markdownIt-Anchor" href="#python-集成-kafka"></a> Python 集成 Kafka</h3><p>在 Python 生态中，主流的 Kafka 客户端库有两个：</p><ol><li><strong><code>kafka-python</code></strong>：纯 Python 实现，安装简便，社区活跃，适合大多数中等吞吐场景</li><li><strong><code>confluent-kafka</code></strong>：基于 C 语言 <code>librdkafka</code> 的封装，性能极高，适合超高吞吐场景。</li></ol><p>考虑到个人的项目属于计算密集型而非 I/O 密集型（瓶颈在于 GPU 推理而非网络吞吐），采用代码可读性更强的 <code>kafka-python</code> 是合理的工程选择。</p><p>安装依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install kafka-python</span><br></pre></td></tr></table></figure><h4 id="消费者-2"><a class="markdownIt-Anchor" href="#消费者-2"></a> 消费者</h4><p>为了接收 Java 端 <code>JsonSerializer</code> 发送的消息，Python 端必须严格遵循对应的反序列化协议。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> kafka <span class="keyword">import</span> KafkaConsumer, KafkaProducer</span><br><span class="line"><span class="keyword">from</span> kafka.errors <span class="keyword">import</span> KafkaError</span><br><span class="line"></span><br><span class="line">KAFKA_BOOTSTRAP_SERVERS = [<span class="string">&#x27;localhost:9092&#x27;</span>]</span><br><span class="line">TOPIC_INPUT = <span class="string">&#x27;topic-knowledge-ingest&#x27;</span>   <span class="comment"># 接收任务的主题</span></span><br><span class="line">TOPIC_OUTPUT = <span class="string">&#x27;topic-knowledge-result&#x27;</span>  <span class="comment"># 回传结果的主题</span></span><br><span class="line">GROUP_ID = <span class="string">&#x27;georag-python-worker-group&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeoRAGWorker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化消费者</span></span><br><span class="line">        <span class="comment"># 关键配置：enable_auto_commit=False 确保业务处理完才提交偏移量</span></span><br><span class="line">        self.consumer = KafkaConsumer(</span><br><span class="line">            TOPIC_INPUT,</span><br><span class="line">            bootstrap_servers=KAFKA_BOOTSTRAP_SERVERS,</span><br><span class="line">            group_id=GROUP_ID,</span><br><span class="line">            auto_offset_reset=<span class="string">&#x27;earliest&#x27;</span>,</span><br><span class="line">            enable_auto_commit=<span class="literal">False</span>,</span><br><span class="line">            value_deserializer=<span class="keyword">lambda</span> m: json.loads(m.decode(<span class="string">&#x27;utf-8&#x27;</span>)),</span><br><span class="line">            <span class="comment"># 防止长任务导致的 Rebalance (根据实际业务耗时调整)</span></span><br><span class="line">            max_poll_interval_ms=<span class="number">600000</span> </span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化生产者</span></span><br><span class="line">        self.producer = KafkaProducer(</span><br><span class="line">            bootstrap_servers=KAFKA_BOOTSTRAP_SERVERS,</span><br><span class="line">            value_serializer=<span class="keyword">lambda</span> v: json.dumps(v).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 注册信号处理，用于优雅退出</span></span><br><span class="line">        signal.signal(signal.SIGINT, self.shutdown)</span><br><span class="line">        signal.signal(signal.SIGTERM, self.shutdown)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shutdown</span>(<span class="params">self, signum, frame</span>):</span><br><span class="line">        logger.info(<span class="string">&quot;Received shutdown signal. Stopping worker...&quot;</span>)</span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        logger.info(<span class="string">f&quot;Worker started. Listening on <span class="subst">&#123;TOPIC_INPUT&#125;</span>...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 循环拉取消息，timeout_ms 允许在没有消息时让出 CPU 检查 running 状态</span></span><br><span class="line">            <span class="keyword">while</span> self.running:</span><br><span class="line">                <span class="comment"># poll 返回的是一个字典 &#123;TopicPartition: [Record, ...]&#125;</span></span><br><span class="line">                msg_pack = self.consumer.poll(timeout_ms=<span class="number">1000</span>) </span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> partition, messages <span class="keyword">in</span> msg_pack.items():</span><br><span class="line">                    <span class="keyword">for</span> message <span class="keyword">in</span> messages:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self.running: <span class="keyword">break</span></span><br><span class="line">                        self._handle_single_message(message)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Critical worker error: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.consumer.close()</span><br><span class="line">            self.producer.close()</span><br><span class="line">            logger.info(<span class="string">&quot;Kafka connections closed. Bye.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_single_message</span>(<span class="params">self, message</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        处理单条消息的生命周期：解析 -&gt; 执行 -&gt; 回传 -&gt; 提交</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = message.value</span><br><span class="line">            task_id = payload.get(<span class="string">&#x27;fileId&#x27;</span>) <span class="keyword">or</span> payload.get(<span class="string">&#x27;taskId&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">f&quot;Received Task [<span class="subst">&#123;task_id&#125;</span>] from partition <span class="subst">&#123;message.partition&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 1. 【核心】执行业务逻辑 (占位)</span></span><br><span class="line">            result_data = self.process_business_logic(payload)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 2. 回传结果</span></span><br><span class="line">            self._send_result(task_id, result_data)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. 手动提交偏移量 (Ack)</span></span><br><span class="line">            <span class="comment"># 注意：此处使用的是同步提交 commit_sync 或 异步 commit_async</span></span><br><span class="line">            <span class="comment"># 为了数据绝对安全，关键任务建议使用 commit_sync</span></span><br><span class="line">            self.consumer.commit() </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error processing message: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> 可以在此处增加死信队列 (DLQ) 的投递逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_business_logic</span>(<span class="params">self, payload</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        [占位函数] 在此处填入你的 GeoRAG / 深度学习推理逻辑</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># --- 业务代码开始 ---</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># --- 业务代码结束 ---</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: <span class="string">&quot;SUCCESS&quot;</span>, </span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Vectorization complete&quot;</span>, </span><br><span class="line">            <span class="string">&quot;vector_ids&quot;</span>: [<span class="number">101</span>, <span class="number">102</span>, <span class="number">103</span>] <span class="comment"># 模拟结果</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_send_result</span>(<span class="params">self, task_id, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        发送处理结果到输出 Topic</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        response = &#123;</span><br><span class="line">            <span class="string">&quot;taskId&quot;</span>: task_id,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;payload&quot;</span>: data</span><br><span class="line">        &#125;</span><br><span class="line">        future = self.producer.send(TOPIC_OUTPUT, value=response)</span><br><span class="line">        <span class="comment"># 简单的阻塞等待确认，保证结果一定写入 Kafka</span></span><br><span class="line">        future.get(timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    GeoRAGWorker().start()</span><br></pre></td></tr></table></figure><h3 id="死信队列"><a class="markdownIt-Anchor" href="#死信队列"></a> 死信队列</h3><p>若缺乏隔离机制，一条无法被正常处理的消息（即“毒丸消息”，Poison Pill）会导致消费者陷入 <strong>“读取 -&gt; 崩溃 -&gt; 重启 -&gt; 再读取”</strong> 的死循环，进而阻塞分区内后续所有正常消息的处理。<span style="color: #BB8ED0; font-weight: bold;">死信队列（Dead Letter Queue, DLQ）</span> 正是解决这一问题的标准架构模式。</p><p>在没有 DLQ 的架构中，消费者的默认行为通常是“失败重试”。然而，对于确定性错误（如数据格式损坏、业务逻辑冲突），无限重试毫无意义，只会导致消费滞后迅速累积，最终拖垮整个处理链路。</p><p>引入 DLQ 后，系统的容错逻辑变更为：</p><ol><li><span style="color: #89986D; font-weight: bold;">重试（Retry）</span>：在遇到瞬态错误（如网络抖动）时，进行有限次数的重试。</li><li><span style="color: #89986D; font-weight: bold;">隔离（Isolate）</span>：当重试耗尽或遇到非恢复性错误时，将该消息转移至 DLQ 主题。</li><li><span style="color: #89986D; font-weight: bold;">提交（Commit）</span>：向 Kafka 提交原消息的 Offset，欺骗 Broker 认为该消息已被消费，从而让消费者指针向前移动，继续处理后续的正常数据。</li></ol><p>以下是死信生产的标准时序流程：</p><ol><li><strong>消息拉取 (Fetch)</strong>：消费者从 <code>topic-knowledge-ingest</code> 获取 Offset 为 <code>N</code> 的消息。</li><li><strong>业务试错 (Try)</strong>：将 Payload 传入核心业务逻辑。</li><li><strong>异常抛出 (Throw)</strong>：业务逻辑因数据格式错误抛出 <code>ValueError</code> 或 <code>JSONDecodeError</code>。</li><li><strong>异常捕获 (Catch)</strong>：在最外层拦截该异常，阻止 Worker 崩溃。</li><li><strong>死信封装 (Wrap)</strong>：将原始消息 + 错误堆栈打包成新的 JSON 对象。</li><li><strong>死信投递 (Produce)</strong>：将封装包发送至 <code>topic-knowledge-ingest-dlq</code>。</li><li><strong>伪装成功 (Commit)</strong>：向 Kafka 提交 Offset <code>N</code>，欺骗 Broker 认为该消息已被“成功消费”。从而让消费者指针移动到 <code>N+1</code>，继续处理后续正常任务。</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Kafka架构入门：以一个解耦SpringBoot和Python的需求为例。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Redis：三种常用的缓存读写策略</title>
    <link href="https://atffang.github.io/2026/01/15/Redis1-3%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E7%AD%96%E7%95%A5/"/>
    <id>https://atffang.github.io/2026/01/15/Redis1-3%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E7%AD%96%E7%95%A5/</id>
    <published>2026-01-15T02:34:04.000Z</published>
    <updated>2026-01-17T05:00:47.429Z</updated>
    
    <content type="html"><![CDATA[<ul><li>Cache Aside Pattern（旁路缓存模式）</li><li>Read/Write Through Pattern（读写穿透）</li><li>Write Behind Pattern（异步缓存写入）</li></ul><span id="more"></span><h3 id="intro"><a class="markdownIt-Anchor" href="#intro"></a> Intro</h3><h4 id="redis简介"><a class="markdownIt-Anchor" href="#redis简介"></a> Redis简介</h4><p>Redis （<strong>RE</strong>mote <strong>DI</strong>ctionary <strong>S</strong>erver）是一个基于 C 语言开发的开源 NoSQL 数据库（BSD 许可）。与传统数据库不同的是，Redis 的数据是保存在内存中的（内存数据库，支持持久化），因此读写速度非常快，被广泛应用于分布式缓存方向。并且，Redis 存储的是 KV 键值对数据。</p><p>为了满足不同的业务场景，Redis 内置了多种数据类型实现（比如 String、Hash、Sorted Set、Bitmap、HyperLogLog、GEO）。并且，Redis 还支持事务、持久化、Lua 脚本、发布订阅模型、多种开箱即用的集群方案（Redis Sentinel、Redis Cluster）。</p><p>Redis 内部做了非常多的性能优化，使得其读写速度极快，主要包括以下四点：</p><ul><li><span style="color: #89986D; font-weight: bold;">纯内存操作 (Memory-Based Storage)</span> ：这是最主要的原因。Redis 数据读写操作都发生在内存中，访问速度是纳秒级别，而传统数据库频繁读写磁盘的速度是毫秒级别，两者相差数个数量级。</li><li><span style="color: #89986D; font-weight: bold;">高效的 I/O 模型 (I/O Multiplexing &amp; Single-Threaded Event Loop)</span> ：Redis 使用单线程事件循环配合 I/O 多路复用技术，让单个线程可以同时处理多个网络连接上的 I/O 事件（如读写），避免了多线程模型中的上下文切换和锁竞争问题。虽然是单线程，但结合内存操作的高效性和 I/O 多路复用，使得 Redis 能轻松处理大量并发请求（Redis 线程模型会在后文中详细介绍到）。</li><li><span style="color: #89986D; font-weight: bold;">优化的内部数据结构 (Optimized Data Structures)</span> ：Redis 提供多种数据类型（如 String, List, Hash, Set, Sorted Set 等），其内部实现采用高度优化的编码方式（如 ziplist, quicklist, skiplist, hashtable 等）。Redis 会根据数据大小和类型动态选择最合适的内部编码，以在性能和空间效率之间取得最佳平衡。</li><li><span style="color: #89986D; font-weight: bold;">简洁高效的通信协议 (Simple Protocol - RESP)</span> ：Redis 使用的是自己设计的 RESP (REdis Serialization Protocol) 协议。这个协议实现简单、解析性能好，并且是二进制安全的。客户端和服务端之间通信的序列化/反序列化开销很小，有助于提升整体的交互速度。</li></ul><img src="/2026/01/15/Redis1-3%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E7%AD%96%E7%95%A5/why-redis-so-fast.png" class="" title="sucessful"><p>除了访问速度更快之外，Redis 缓存的并发也更高。一般像 MySQL 这类的数据库的 QPS 大概都在 4k 左右（4 核 8g），但是使用 Redis 缓存之后很容易达到 5w+，甚至能达到 10w+。由此可见，直接操作缓存能够承受的数据库请求数量是远远大于直接访问数据库的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。</p><h3 id="3种常用的缓存读写策略"><a class="markdownIt-Anchor" href="#3种常用的缓存读写策略"></a> 3种常用的缓存读写策略</h3><p>尽管 Redis 速度极快，但它无法取代数据库，在生产环境中，单存储架构（只用数据库或只用 Redis）通常无法兼顾性能与容量，我们通常只将一部分频繁读写的数据放置于redis。但当我们同时拥有内存和磁盘两份数据拷贝时，如何保证它们的一致性成为了重要的问题，因此，需要引入三种常用的缓存读写策略：</p><ul><li><p><span style="color: #BB8ED0; font-weight: bold;">Cache Aside Pattern（旁路缓存模式）</span></p></li><li><p><span style="color: #BB8ED0; font-weight: bold;">Read/Write Through Pattern（读写穿透）</span></p></li><li><p><span style="color: #BB8ED0; font-weight: bold;">Write Behind Pattern（异步缓存写入）</span></p></li></ul><h4 id="cache-aside-pattern旁路缓存模式"><a class="markdownIt-Anchor" href="#cache-aside-pattern旁路缓存模式"></a> Cache Aside Pattern（旁路缓存模式）</h4><p>这是我们日常开发中<strong>最常用、最经典</strong>的一种模式，几乎是互联网应用缓存方案的事实标准，尤其适合<strong>读多写少</strong>的业务场景。</p><p>这个模式之所以被称为<span style="color: #89986D; font-weight: bold;">旁路</span> ,是因为应用程序的写操作完全绕过了缓存，直接操作数据库。在这个模式下，应用程序需要同时维护 Cache 和 DB 两个数据源。</p><img src="/2026/01/15/Redis1-3%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E7%AD%96%E7%95%A5/How-Cache-Aside-Works.png" class="" title="sucessful"><p><strong>读操作</strong>的顺序为：</p><ol><li><span style="color: #89986D; font-weight: bold;">应用先从 Cache 读取数据</span></li><li><span style="color: #89986D; font-weight: bold;">如果命中(Hit)，则直接返回</span></li><li><span style="color: #89986D; font-weight: bold;">如果未命中(Miss)，则从 DB 读取数据，成功读取后，将数据写回 Cache，然后返回</span></li></ol><p><strong>写操作</strong>的顺序为：</p><ol><li><span style="color: #89986D; font-weight: bold;">应用先更新 DB</span></li><li><span style="color: #89986D; font-weight: bold;">然后直接删除 Cache中对应的数据</span></li></ol><p>我们基于SpringBoot，举一个简单的例子</p><p>首先是<strong>读操作</strong>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, User&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span> + id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 尝试从缓存获取</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> redisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> user; <span class="comment">// 缓存命中 (Hit)</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 缓存未命中 (Miss)，查数据库</span></span><br><span class="line">        user = userRepository.findById(id).orElse(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 将结果写回缓存，并设置过期时间</span></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, user, <span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其次是<strong>写操作</strong>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span> + user.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 先更新数据库</span></span><br><span class="line">    userRepository.save(user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 更新成功后，直接删除缓存</span></span><br><span class="line">    <span class="comment">// 强制下一次读请求触发 Cache Miss，从而从 DB 加载最新值</span></span><br><span class="line">    redisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们注意到，在写操作时，是“删除”而不是“更新”缓存。如果不慎写成 <code>redisTemplate.opsForValue().set(key, user)</code> 去更新缓存，在并发环境下会发生以下情况：</p><ul><li>线程 A 更新了数据库。</li><li>线程 B 更新了数据库。</li><li>由于网络原因，线程 B 先把缓存更新了。</li><li>线程 A 随后才更新了缓存。</li></ul><p>结果就是，数据库里是 B 的值，缓存里是 A 的旧值，导致了数据不一致。而删除操作是幂等的，它消除了更新顺序带来的竞争条件，相对安全的多。</p><p>同时，更新数据库和删除缓存的顺序也有说法，如果违背了先后原则，先删除了缓存，再更新数据库，在并发环境下会发生以下情况：</p><ul><li>线程 A: 先将 Cache 中的数据删除。</li><li>线程 B: 此时发现 Cache 为空，于是去 DB 读取<strong>旧值</strong>，并准备写入 Cache。</li><li>线程 A : 将<strong>新值</strong>写入 DB。</li><li>线程 B: 将之前读到的<strong>旧值</strong>写入了 Cache。<br />结果就是，DB 中是新值，而 Cache 中是旧值，也会导致数据不一致。</li></ul><p>Cache Aside 虽然解决了同步逻辑，但如果遇到一个极热点的 Key 在失效瞬间，成千上万个请求同时发现 Miss，全部打到数据库，就会发生<span style="color: #BB8ED0; font-weight: bold;">缓存击穿</span>。为了防止缓存击穿发生，我们可以给请求逻辑<strong>加锁</strong>，将并行的请求串行化，等待第一个请求数据的线程拿到数据后，其会将数据写入Redis，那么后续的请求可以从Cache中而非DB取数据了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> redis.get(id);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) <span class="keyword">return</span> user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取分布式锁</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;lock:&quot;</span> + id);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock.tryLock(<span class="number">10</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            user = redis.get(id);</span><br><span class="line">            <span class="keyword">if</span> (user != <span class="literal">null</span>) <span class="keyword">return</span> user;</span><br><span class="line"></span><br><span class="line">            user = db.get(id);</span><br><span class="line">            redis.set(id, user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 Spring Boot 中，官方提供了<code>@Cacheable</code> 注解中的 <strong><code>sync</code></strong> 属性以实现上述功能。默认情况下，<code>@Cacheable</code> 是不加锁的。当多个线程同时访问同一个失效的 Key 时，它们都会执行业务方法（查库）。但当你设置 <code>sync = true</code> 时，<strong>对于同一个 Key，多个并发请求进入时，Spring 会确保只有一个线程去执行目标方法（查库）</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sync = true 开启同步锁，防止缓存击穿</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;userCache&quot;, key = &quot;#id&quot;, sync = true)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// 只有第一个线程会进入这里，其余线程会等待并直接从缓存取值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;正在从数据库加载用户数据... ID: &quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(id).orElse(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="readwrite-through-pattern读写穿透"><a class="markdownIt-Anchor" href="#readwrite-through-pattern读写穿透"></a> Read/Write Through Pattern（读写穿透）</h4><p>Cache Aside 是由应用程序同时管理缓存和数据库，<strong>Read/Write Through</strong> 模式则是通过一个<strong>中间层</strong>（通常是缓存服务或 Data Provider）将数据库操作隐藏起来。</p><p>在这个模式下，应用程序将缓存视为<strong>唯一的数据源</strong>。它不关心底层数据是如何存储的，所有的读写请求都直接发往缓存，由缓存层负责与数据库进行同步。</p><p>读操作（Read Through）的顺序为：</p><ol><li><span style="color: #89986D; font-weight: bold;">应用查询 Cache</span>。</li><li><span style="color: #89986D; font-weight: bold;">如果命中(Hit)，直接返回数据</span>。</li><li><span style="color: #89986D; font-weight: bold;">如果未命中(Miss)，由 Cache 组件负责从 DB 加载数据，写入 Cache 后返回给应用</span>。</li></ol><p>写操作（Write Through）的顺序为：</p><ol><li><span style="color: #89986D; font-weight: bold;">应用向 Cache 写入数据</span>。</li><li><span style="color: #89986D; font-weight: bold;">Cache 组件同步地将数据写入 DB</span>。</li><li><span style="color: #89986D; font-weight: bold;">待 DB 更新成功后，写操作才算完成，返回成功</span>。</li></ol><p>在 Java 生态中，原生的 Redis 并不直接支持与 MySQL 的这种穿透同步。通常我们需要在业务层抽象出一个 <strong>Cache Store 层</strong>。以下是一个基于 Spring Boot 的概念性实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserCacheManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, User&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read Through</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">get</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span> + id;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> redisTemplate.opsForValue().get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 由缓存管理器组件负责从数据库加载，业务层不感知</span></span><br><span class="line">            user = userRepository.findById(id).orElse(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write Through</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span> + user.getId();</span><br><span class="line">        <span class="comment">// 1. 写缓存</span></span><br><span class="line">        redisTemplate.opsForValue().set(key, user);</span><br><span class="line">        <span class="comment">// 2. 同步写数据库，保证强一致性</span></span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Read/Write Through 的核心价值在于<strong>关注点分离（Separation of Concerns）</strong>。业务逻辑变得极度纯粹，因为它不再需要处理繁琐的缓存失效和补偿逻辑。</p><ol><li><p><strong>强一致性保障</strong>：由于写操作是同步进行的（写缓存 + 写数据库全部成功才返回），这种模式能最大程度保证缓存和数据库的数据一致。</p></li><li><p><strong>写延迟（Latency）问题</strong>：这是该模式的最大痛点。写操作的吞吐量受限于数据库的磁盘 I/O。每一次写请求都要经历两次网络交互和一次磁盘写入，遵循木桶效应，系统的整体性能取决于最慢的一环（DB）。</p></li><li><p><strong>数据预热（Warming Up）</strong>：由于读操作在 Miss 时会自动加载，这种模式天生具备热点数据预热的能力。</p></li></ol><p><strong>在实际工程中</strong>，本地缓存（如 Guava Cache 或 Caffeine）通常提供现成的 <code>CacheLoader</code> 机制来完美支持 Read Through。但在 Redis 场景下，由于 Redis 无法主动去抓取 MySQL 的数据，这种模式往往需要开发者自行封装中间服务来实现。</p><h4 id="write-behind-pattern异步缓存写入"><a class="markdownIt-Anchor" href="#write-behind-pattern异步缓存写入"></a> Write Behind Pattern（异步缓存写入）</h4><p>Write Behind（也常被称为 Write-Back） Pattern 和 Read/Write Through Pattern 很相似，两者都是由 Cache 服务来负责 Cache 和 DB 的读写。</p><p>但是，两个又有很大的不同：<strong>Read/Write Through 是同步更新 Cache 和 DB，而 Write Behind 则是只更新缓存，不直接更新 DB，而是改为异步批量的方式来更新 DB。</strong></p><p><strong>读操作</strong>的顺序为：</p><ol><li><span style="color: #89986D; font-weight: bold;">同 Read Through</span>。</li><li><span style="color: #89986D; font-weight: bold;">如果命中则返回；如果未命中，则由缓存层同步从 DB 加载数据，写回缓存并返回</span>。</li></ol><p><strong>写操作</strong>的顺序为：</p><ol><li><span style="color: #89986D; font-weight: bold;">应用向 Cache 写入数据</span>。</li><li><span style="color: #89986D; font-weight: bold;">Cache 立即返回写成功信号</span>。</li><li><span style="color: #89986D; font-weight: bold;">缓存层异步地（批量或定时）将变更的数据刷入 DB</span>。</li></ol><p>基于 Spring Boot，我们通常利用 <strong>消息队列 (MQ)</strong> 或 <strong>定时任务</strong> 来模拟这种异步合并写入的逻辑：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteBehindService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写操作：只写缓存，然后扔进异步任务队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span> + user.getId();</span><br><span class="line">        <span class="comment">// 1. 更新缓存</span></span><br><span class="line">        redisTemplate.opsForValue().set(key, user.toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 将需要更新的 ID 放入一个待刷新队列（可以是 Redis 的 List 或 Set）</span></span><br><span class="line">        redisTemplate.opsForSet().add(<span class="string">&quot;dirty_user_ids&quot;</span>, user.getId().toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 立即返回成功</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后台异步任务：批量刷入数据库</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 5000)</span> <span class="comment">// 每 5 秒批量同步一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flushToDb</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; dirtyIds = redisTemplate.opsForSet().members(<span class="string">&quot;dirty_user_ids&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dirtyIds == <span class="literal">null</span> || dirtyIds.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String id : dirtyIds) &#123;</span><br><span class="line">            <span class="comment">// 从缓存取最新值，写入数据库</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getUserFromCache(Long.parseLong(id));</span><br><span class="line">            userRepository.save(user);</span><br><span class="line">            <span class="comment">// 同步成功后移除脏标记</span></span><br><span class="line">            redisTemplate.opsForSet().remove(<span class="string">&quot;dirty_user_ids&quot;</span>, id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>写操作合并（Write Coalescing）</strong> 是该模式最强大的地方。如果在 5 秒内某个用户被更新了 10 次，Write Behind 模式只会将最后一次的结果刷入数据库，大大减轻了可能存在的负担。</p><p>但是，如果 Redis 在异步刷盘前宕机，内存中尚未同步到 DB 的数据会<strong>永久丢失</strong>。因此，这种模式绝不能用于涉及钱财、订单等核心金融场景。</p><h3 id="缓存雪崩击穿与穿透"><a class="markdownIt-Anchor" href="#缓存雪崩击穿与穿透"></a> 缓存雪崩，击穿与穿透</h3><p>我们在旁路缓存模式中了解到，如果遇到一个极热点的 Key 在失效瞬间，成千上万个请求同时发现 Miss，全部打到数据库，就会发生<span style="color: #BB8ED0; font-weight: bold;">缓存击穿</span>。事实上，只要引入了缓存层，就会面临缓存异常，且不只是缓存击穿，还包括<strong>缓存雪崩、缓存穿透</strong>。</p><img src="/2026/01/15/Redis1-3%E7%A7%8D%E5%B8%B8%E7%94%A8%E7%9A%84%E7%BC%93%E5%AD%98%E8%AF%BB%E5%86%99%E7%AD%96%E7%95%A5/%E7%BC%93%E5%AD%98%E5%BC%82%E5%B8%B8%E7%9A%84%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98.png" class="" title="sucessful"><h4 id="缓存雪崩"><a class="markdownIt-Anchor" href="#缓存雪崩"></a> 缓存雪崩</h4><p>通常我们为了保证缓存中的数据与数据库中的数据一致性，会给 Redis 里的数据设置过期时间，当缓存数据过期后，用户访问的数据如果不在缓存里，业务系统需要重新生成缓存，因此就会访问数据库，并将数据更新到 Redis 里，这样后续请求都可以直接命中缓存。</p><p>那么，当<strong>大量缓存数据在同一时间过期（失效）或者 Redis 故障宕机</strong>时，如果此时有大量的用户请求，都无法在 Redis 中处理，于是全部请求都直接访问数据库，从而导致数据库的压力骤增，严重的会造成数据库宕机，从而形成一系列连锁反应，造成整个系统崩溃，这就是<span style="color: #BB8ED0; font-weight: bold;">缓存雪崩</span>的原因。</p><p>因此，缓存雪崩的原因主要就是：</p><ul><li><span style="color: #89986D; font-weight: bold;">大量数据同时过期</span></li><li><span style="color: #89986D; font-weight: bold;">Redis故障宕机</span></li></ul><p>我们分别总结这两种原因的应对策略：</p><div style="background-color: #f7f9fc; border: 1px solid #e1e4e8; border-radius: 15px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"><p style="margin-top: 0; margin-bottom: 12px; color: #333; border-bottom: 2px solid #5aa9e6; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;">大量数据同时过期的应对策略</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">均匀设置过期时间 ：</span>在基础过期时间（TTL）上增加随机扰动值，将缓存失效的时间点离散化，避免集中失效。</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">互斥锁机制 ：</span>当缓存失效时，利用锁机制确保同一时刻只有一个线程能访问数据库，其他线程等待或重试。</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">后台更新缓存 ：</span>业务线程不处理缓存更新，而是由独立的后台线程定时或异步检测并刷新缓存，实现逻辑上的永不过期。</p></div><br><div style="background-color: #F5FBE6; border: 1px solid #e1e4e8; border-radius: 15px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"><p style="margin-top: 0; margin-bottom: 12px; color: #333; border-bottom: 2px solid #CDB885; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;">Redis故障宕机的应对策略</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">服务熔断或请求限流机制 ：</span>可以启动服务熔断机制，暂停业务应用对缓存服务的访问，直接返回错误，不用再继续访问数据库，从而降低对数据库的访问压力。或者启动请求限流机制，只允许少量的请求访问。</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">构建 Redis 缓存高可靠集群 ：</span>通过主从节点方式构建Redis 缓存高可靠集群后，如果 Redis 缓存的主节点故障宕机，从节点可以切换成为主节点，继续提供缓存服务，避免了由于 Redis 故障宕机而导致的缓存雪崩问题。</p></div><h4 id="缓存击穿"><a class="markdownIt-Anchor" href="#缓存击穿"></a> 缓存击穿</h4><p>我们的业务通常会有几个数据会被频繁地访问，比如秒杀活动，这类被频地访问的数据被称为<strong>热点数据</strong>。</p><p>如果缓存中的某个热点数据过期了，此时大量的请求访问了该热点数据，就无法从缓存中读取，直接访问数据库，数据库很容易就被高并发的请求冲垮，这就是<span style="color: #BB8ED0; font-weight: bold;">缓存击穿</span>。</p><p>可以发现缓存击穿跟缓存雪崩很相似，你可以认为缓存击穿是缓存雪崩的一个子集。应对缓存击穿可以采取前面说到两种方案，即<strong>互斥锁</strong>和<strong>过期时间</strong>。</p><h4 id="缓存穿透"><a class="markdownIt-Anchor" href="#缓存穿透"></a> 缓存穿透</h4><p>当发生缓存雪崩或击穿时，数据库中还是保存了应用要访问的数据，一旦缓存恢复相对应的数据，就可以减轻数据库的压力，而缓存穿透就不一样了。</p><p>当用户访问的数据，<strong>既不在缓存中，也不在数据库中</strong>，导致请求在访问缓存时，发现缓存缺失，再去访问数据库时，发现数据库中也没有要访问的数据，没办法构建缓存数据，来服务后续的请求。那么当有大量这样的请求到来时，数据库的压力骤增，这就是<span style="color: #BB8ED0; font-weight: bold;">缓存穿透</span>。</p><p>缓存穿透的发生一般有这两种情况：</p><ul><li><span style="color: #89986D; font-weight: bold;">业务误操作，缓存中的数据和数据库中的数据都被误删除了。</span></li><li><span style="color: #89986D; font-weight: bold;">黑客恶意攻击，故意大量访问某些读取不存在数据的业务。</span> 黑客太坏了。</li></ul><p>应对缓存穿透，常见的方案有三种：</p><ul><li><span style="color: #89986D; font-weight: bold;">限制非法请求</span></li><li><span style="color: #89986D; font-weight: bold;">缓存空值或者默认值</span></li><li><span style="color: #89986D; font-weight: bold;">使用布隆过滤器快速判断数据是否存在</span></li></ul><p>我们分别总结这三种应对策略：</p><div style="background-color: #f7f9fc; border: 1px solid #e1e4e8; border-radius: 15px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"><p style="margin-top: 0; margin-bottom: 12px; color: #333; border-bottom: 2px solid #5aa9e6; padding-bottom: 8px; display: inline-block; font-size: 1.1em; font-weight: 600;">大量数据同时过期的应对策略</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">限制非法请求 ：</span>在 API 入口层进行严格检查。对于 ID 小于 0、格式错误或逻辑不符的请求，以及未登录或无权访问的非法请求，直接在前端或网关层拦截，不给缓存和数据库造成压力。</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">缓存空值或者默认值 ：</span>当查询数据库未命中时，也将一个空对象（null）或特定的默认值写入缓存，防止同一个 ID 重复攻击数据库。同时为这些空值设置一个较短的过期时间（如 5 分钟），以保证如果后续该数据真的被创建了，缓存能及时更新。</p><p style="color: #666; font-size: 0.9em; margin: 8px 0; line-height: 1.5;"><span style="color: #333; font-weight: bold;">使用布隆过滤器快速判断 ：</span>在访问 Redis 之前，先查询布隆过滤器。利用其高效的数据结构，快速判断该 Key 是否可能存在。如果布隆过滤器判断 Key 一定不存在，则直接返回，彻底隔绝请求与底层存储的接触。</p></div><h5 id="什么是布隆过滤器"><a class="markdownIt-Anchor" href="#什么是布隆过滤器"></a> 什么是布隆过滤器？</h5><p><span style="color: #BB8ED0; font-weight: bold;">布隆过滤器（Bloom Filter）</span>本质上是由<strong>一个很长的二进制向量</strong>（位图/BitMap）和 <strong>一系列随机映射函数</strong>（Hash Functions）组成的。</p><p>假设我们有一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> 的位数组，初始全为 0，当我们要把元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 放进去时：</p><ol><li>使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个不同的哈希函数对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span> 进行计算，得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个哈希值。</li><li>把位数组中这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个位置的 bit 都置为 <strong>1</strong>。</li></ol><p>当我们要查询元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> 是否存在时：</p><ol><li>同样用那 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个哈希函数对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> 进行计算。</li><li>检查位数组中这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个位置的 bit：<ul><li><strong>如果全都是 1</strong>：说明 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> <strong>可能存在</strong>（因为这些 1 可能是由其他元素 A、B、C 共同凑出来的）。</li><li><strong>如果有任何一个是 0</strong>：说明 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> <strong>一定不存在</strong>（因为如果存过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span>，这些位置肯定早就被置为 1 了）。</li></ul></li></ol><p>随着存入的数据越来越多，越来越多的 bit 被置为 1。 当我们查询一个没存过的元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span> 时，它算出来的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 个位置，可能恰好被之前存进去的元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 把坑占了。因此，布隆过滤器的特点就是：<br /><strong>它说不存在，那就一定不存在；它说存在，那有可能不存在</strong>。它可以做到以极小的内存代价，快速判断一个元素是否在一个集合中。</p><h3 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h3><p><strong>3种常用的缓存读写策略详解</strong> <a href="https://javaguide.cn/database/redis/3-commonly-used-cache-read-and-write-strategies.html">https://javaguide.cn/database/redis/3-commonly-used-cache-read-and-write-strategies.html</a></p><p><strong>Cache-Aside Pattern</strong> <a href="https://www.geeksforgeeks.org/system-design/cache-aside-pattern/">https://www.geeksforgeeks.org/system-design/cache-aside-pattern/</a></p><p><strong>【🔥缓存与数据库双写一致性的终极指南】旁路缓存下，我们如何避免“脏数据”灾难？</strong> <a href="https://www.cnblogs.com/sun-10387834/p/19001248">https://www.cnblogs.com/sun-10387834/p/19001248</a></p><p><strong>数据库和缓存如何保证一致性？</strong> <a href="https://www.xiaolincoding.com/redis/architecture/mysql_redis_consistency.html">https://www.xiaolincoding.com/redis/architecture/mysql_redis_consistency.html</a></p>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;Cache Aside Pattern（旁路缓存模式）&lt;/li&gt;
&lt;li&gt;Read/Write Through Pattern（读写穿透）&lt;/li&gt;
&lt;li&gt;Write Behind Pattern（异步缓存写入）&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="其他" scheme="https://atffang.github.io/categories/%E5%85%B6%E4%BB%96/"/>
    
    
  </entry>
  
  <entry>
    <title>LangChain学习日志: LangGraph</title>
    <link href="https://atffang.github.io/2026/01/11/LangGraph/"/>
    <id>https://atffang.github.io/2026/01/11/LangGraph/</id>
    <published>2026-01-11T01:13:19.000Z</published>
    <updated>2026-01-11T15:05:07.178Z</updated>
    
    <content type="html"><![CDATA[<p>尝试使用LangGraph。<br><span id="more"></span></p><h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>传统的开发模式往往将 LLM 视为无状态的处理器，而在构建真正的生产级应用时，我们需要的往往是能够长期运行、拥有记忆并能与环境交互的系统。这正是 <span style="color: #BB8ED0; font-weight: bold;">LangGraph</span> 诞生的背景。(<a href="https://docs.langchain.com/oss/python/langgraph/overview">https://docs.langchain.com/oss/python/langgraph/overview</a> )</p><p><span style="color: #BB8ED0; font-weight: bold;">LangGraph</span> 是一个专为构建、管理和部署长期运行、Stateful（有状态）智能体而设计的底层编排框架（Low-level orchestration framework）。</p><p>与提供高层封装的传统框架不同，LangGraph 赋予了开发者极高的控制权。它不仅仅关注模型和工具的连接，更专注于<span style="color: #BB8ED0; font-weight: bold;">Agent Orchestration</span>（智能体编排）的核心能力。</p><p>官方文档告诉我们，其具有以下优势：</p><ul><li><a href="https://docs.langchain.com/oss/python/langgraph/durable-execution">Durable execution</a>: Build agents that persist through failures and can run for extended periods, resuming from where they left off.</li><li><a href="https://docs.langchain.com/oss/python/langgraph/interrupts">Human-in-the-loop</a>: Incorporate human oversight by inspecting and modifying agent state at any point.</li><li><a href="https://docs.langchain.com/oss/python/concepts/memory">Comprehensive memory</a>: Create stateful agents with both short-term working memory for ongoing reasoning and long-term memory across sessions.</li><li><a href="https://docs.langchain.com/langsmith/home">Debugging with LangSmith</a>: Gain deep visibility into complex agent behavior with visualization tools that trace execution paths, capture state transitions, and provide detailed runtime metrics.</li><li><a href="https://docs.langchain.com/langsmith/deployments">Production-ready deployment</a>: Deploy sophisticated agent systems confidently with scalable infrastructure designed to handle the unique challenges of stateful, long-running workflows.</li></ul><h3 id="Get-Started"><a href="#Get-Started" class="headerlink" title="Get Started"></a>Get Started</h3><p>下载 LangGraph<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install -U langchain</span><br><span class="line"><span class="comment"># Requires Python 3.10+</span></span><br></pre></td></tr></table></figure></p><h4 id="Define-tools-and-model"><a href="#Define-tools-and-model" class="headerlink" title="Define tools and model"></a>Define tools and model</h4><p>在上一篇文章中，我们介绍了<a href="/2026/01/10/langchainAgent/" title="Agent如何调用工具">Agent如何调用工具</a>，而在官方文档对于LangGraph的例子中，定义了简单的运算工具：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> init_chat_model</span><br><span class="line"></span><br><span class="line">model = init_chat_model(</span><br><span class="line">    <span class="string">&quot;claude-sonnet-4-5-20250929&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define tools</span></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Multiply `a` and `b`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        a: First int</span></span><br><span class="line"><span class="string">        b: Second int</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Adds `a` and `b`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        a: First int</span></span><br><span class="line"><span class="string">        b: Second int</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">divide</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Divide `a` and `b`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        a: First int</span></span><br><span class="line"><span class="string">        b: Second int</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a / b</span><br><span class="line"></span><br><span class="line"><span class="comment"># Augment the LLM with tools</span></span><br><span class="line">tools = [add, multiply, divide]</span><br><span class="line">tools_by_name = &#123;tool.name: tool <span class="keyword">for</span> tool <span class="keyword">in</span> tools&#125;</span><br><span class="line">model_with_tools = model.bind_tools(tools)</span><br></pre></td></tr></table></figure></p><h4 id="Define-state"><a href="#Define-state" class="headerlink" title="Define state"></a>Define state</h4><p><span style="color: #89986D; font-weight: bold;">图中的所有节点通过状态进行通信</span>。在这个例子中，我们直接使用了内置的 <code>MessagesState</code>。 它本质上是一个包含 <code>messages</code> 列表的字典。当你在不同节点间流转时，新的消息会被 Append 到这个列表中，从而形成对话历史。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> AnyMessage</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict, Annotated</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessagesState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>[AnyMessage], operator.add]</span><br><span class="line">    llm_calls: <span class="built_in">int</span></span><br></pre></td></tr></table></figure></p><h4 id="Define-model-node"><a href="#Define-model-node" class="headerlink" title="Define model node"></a>Define model node</h4><p><span style="color: #89986D; font-weight: bold;">模型节点不仅负责生成回复，还负责决定是否需要调用工具</span>，直接上面的<code>model_with_tools</code>就可以调用工具。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> SystemMessage</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call</span>(<span class="params">state: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;LLM decides whether to call a tool or not&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            model_with_tools.invoke(</span><br><span class="line">                [</span><br><span class="line">                    SystemMessage(</span><br><span class="line">                        content=<span class="string">&quot;You are a helpful assistant tasked with performing arithmetic on a set of inputs.&quot;</span></span><br><span class="line">                    )</span><br><span class="line">                ]</span><br><span class="line">                + state[<span class="string">&quot;messages&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;llm_calls&quot;</span>: state.get(<span class="string">&#x27;llm_calls&#x27;</span>, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h4 id="Define-tool-node"><a href="#Define-tool-node" class="headerlink" title="Define tool node"></a>Define tool node</h4><p>当 LLM 决定使用工具时，<span style="color: #89986D; font-weight: bold;">工具节点</span>会执行具体的计算或查询逻辑，并将结果（<span style="color: #BB8ED0; font-weight: bold;">ToolMessage</span>）返回给状态。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> ToolMessage</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tool_node</span>(<span class="params">state: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Performs the tool call&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> tool_call <span class="keyword">in</span> state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].tool_calls:</span><br><span class="line">        tool = tools_by_name[tool_call[<span class="string">&quot;name&quot;</span>]]</span><br><span class="line">        observation = tool.invoke(tool_call[<span class="string">&quot;args&quot;</span>])</span><br><span class="line">        result.append(ToolMessage(content=observation, tool_call_id=tool_call[<span class="string">&quot;id&quot;</span>]))</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: result&#125;</span><br></pre></td></tr></table></figure></p><p>当你把 Tools 绑定到模型上后（例如我们上面使用 <code>model.bind_tools(tools)</code>），它不会直接回答文字，而是产生一个包含 <code>tool_calls</code> 的消息。一个典型的 <code>tool_calls</code> 结构如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tool_calls&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;get_weather&quot;</span><span class="punctuation">,</span>           <span class="comment">// 想要调用的工具名称</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Beijing&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>  <span class="comment">// 模型自动提取的参数</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;call_123abcd&quot;</span><span class="punctuation">,</span>            <span class="comment">// 此次调用的ID</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tool_call&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></p><p>因此，在上面的逻辑中，<code>tool_node</code> 会遍历这个列表，根据 <code>name</code> 找到对应的 Python 函数，把 <code>args</code> 传进去。</p><h4 id="Define-end-logic"><a href="#Define-end-logic" class="headerlink" title="Define end logic"></a>Define end logic</h4><p><span style="color: #89986D; font-weight: bold;">Conditional Edge</span>（条件边函数）用于根据 LLM 是否进行工具调用来路由到工具节点或末端。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, START, END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_continue</span>(<span class="params">state: MessagesState</span>) -&gt; <span class="type">Literal</span>[<span class="string">&quot;tool_node&quot;</span>, END]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Decide if we should continue the loop or stop based upon whether the LLM made a tool call&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    messages = state[<span class="string">&quot;messages&quot;</span>]</span><br><span class="line">    last_message = messages[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If the LLM makes a tool call, then perform an action</span></span><br><span class="line">    <span class="keyword">if</span> last_message.tool_calls:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;tool_node&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Otherwise, we stop (reply to the user)</span></span><br><span class="line">    <span class="keyword">return</span> END</span><br></pre></td></tr></table></figure></p><p>这里的 <code>Literal</code> 是 Python 的类型注解，它明确告诉编译器，这个函数执行完后，<strong>流量只能流向这两个目的地之一</strong>。</p><h4 id="Build-and-compile-the-agent"><a href="#Build-and-compile-the-agent" class="headerlink" title="Build and compile the agent"></a>Build and compile the agent</h4><p>这一部分是将孤立的逻辑函数（节点）和跳转规则（边）封装成一个可执行的智能体对象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build workflow</span></span><br><span class="line">agent_builder = StateGraph(MessagesState)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add nodes</span></span><br><span class="line">agent_builder.add_node(<span class="string">&quot;llm_call&quot;</span>, llm_call)</span><br><span class="line">agent_builder.add_node(<span class="string">&quot;tool_node&quot;</span>, tool_node)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add edges to connect nodes</span></span><br><span class="line">agent_builder.add_edge(START, <span class="string">&quot;llm_call&quot;</span>)</span><br><span class="line">agent_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;llm_call&quot;</span>,</span><br><span class="line">    should_continue,</span><br><span class="line">    [<span class="string">&quot;tool_node&quot;</span>, END]</span><br><span class="line">)</span><br><span class="line">agent_builder.add_edge(<span class="string">&quot;tool_node&quot;</span>, <span class="string">&quot;llm_call&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile the agent</span></span><br><span class="line">agent = agent_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show the agent</span></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line">display(Image(agent.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke</span></span><br><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line">messages = [HumanMessage(content=<span class="string">&quot;Add 3 and 4.&quot;</span>)]</span><br><span class="line">messages = agent.invoke(&#123;<span class="string">&quot;messages&quot;</span>: messages&#125;)</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> messages[<span class="string">&quot;messages&quot;</span>]:</span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure></p><p>我们来拆解一下。首先通过 <code>StateGraph</code> 类定义系统的<strong>状态模式 (State Schema)</strong>。这是整个图的基石，决定了各节点间通信的数据契约。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化图容器，注入全局状态模型</span></span><br><span class="line">agent_builder = StateGraph(MessagesState)</span><br></pre></td></tr></table></figure></p><p>节点是最小的逻辑调度单位。通过 <code>add_node</code> 建立<strong>逻辑名称</strong>与<strong>执行函数</strong>的映射关系。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册算力节点（LLM 决策）与 I/O 节点（工具执行）</span></span><br><span class="line">agent_builder.add_node(<span class="string">&quot;llm_call&quot;</span>, llm_call)</span><br><span class="line">agent_builder.add_node(<span class="string">&quot;tool_node&quot;</span>, tool_node)</span><br></pre></td></tr></table></figure></p><p><strong>确定性边</strong>与<strong>动态条件边</strong>：</p><ul><li><strong>Entry Point</strong>：使用 <code>START</code> 指定系统的入口。</li><li><strong>Cyclic Edge</strong>：通过 <code>add_edge(&quot;tool_node&quot;, &quot;llm_call&quot;)</code> 建立回环，允许智能体根据工具返回的结果进行二次推理。</li><li><strong>Conditional Routing</strong>：核心路由逻辑由 <code>add_conditional_edges</code> 实现。它接收一个判断函数，根据函数返回的 <code>Literal</code> 标签，在预设的路径列表中动态分发流量。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">agent_builder.add_edge(START, <span class="string">&quot;llm_call&quot;</span>)</span><br><span class="line">agent_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;llm_call&quot;</span>,</span><br><span class="line">    should_continue,</span><br><span class="line">    [<span class="string">&quot;tool_node&quot;</span>, END]</span><br><span class="line">)</span><br><span class="line">agent_builder.add_edge(<span class="string">&quot;tool_node&quot;</span>, <span class="string">&quot;llm_call&quot;</span>)</span><br></pre></td></tr></table></figure><p>验证图的连通性并完成协议转换：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将静态拓扑编译为可执行的 Runtime 环境</span></span><br><span class="line">agent = agent_builder.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>根据官方文档，LangGraph 的定义流程可以被总结为：</p><p><strong>1. Define tools and model（定义工具与模型）</strong> 实例化具体的 ChatModel（如 Claude），并通过 <code>.bind_tools()</code> 方法将自定义的 Python 函数（工具）注入模型。这一步确立了智能体的“大脑”和可使用的“技能列表”。</p><p><strong>2. Define state（定义状态）</strong> 通过 <code>TypedDict</code> 构建 <code>MessagesState</code>，并利用 <code>Annotated[list, operator.add]</code> 机制，确保后续产生的新消息（无论是 LLM 回复还是工具结果）都会被追加到历史列表中，而不是覆盖原有数据。</p><p><strong>3. Define model node（定义模型节点）</strong> 、该节点运行绑定了工具的 LLM，接收当前的状态历史，并输出一条新的消息。这条消息可能包含了直接对用户的回复，也可能包含了需要调用工具的结构化指令 (<code>tool_calls</code>)。</p><p><strong>4. Define tool node（定义工具节点）</strong> 、该节点专门负责解析上一轮模型输出中的 <code>tool_calls</code>，找到对应的 Python 函数并执行，最终将执行结果封装为 <code>ToolMessage</code> 返回给状态。</p><p><strong>5. Define end logic（定义结束逻辑）</strong> 、通过定义 <code>should_continue</code> 条件函数，判断最近一条消息中是否存在工具调用请求。它决定了控制流是跳转到工具节点继续干活，还是直接走向 END 结束对话。</p><p><strong>6. Build and compile the agent（构建与编译智能体）</strong> 利用 <code>StateGraph</code> 将上述所有节点（Node）和逻辑判断（Edge）连接成一个完整的图结构，并调用 <code>.compile()</code> 将其转化为可执行的 Runnable 对象，准备好随时响应 <code>invoke</code> 调用。</p><h3 id="WorkFlows-amp-Agents"><a href="#WorkFlows-amp-Agents" class="headerlink" title="WorkFlows &amp; Agents"></a>WorkFlows &amp; Agents</h3><p>我们刚才做的算术助手其实就是一个典型的 <strong>Agent</strong>，因为是 LLM 在决定要不要用加法工具。但在实际开发中，并不是所有场景都需要这么高的自由度。有时候，使用 <strong>Workflow</strong>（比如固定的翻译流程）反而更稳健。LangGraph 的强大之处在于，它允许你在同一个图中<strong>混合使用</strong>这两种模式。</p><p><span style="color: #BB8ED0; font-weight: bold;">Workflows（工作流）</span>具有预先设定的代码路径，并设计为按特定顺序运行。在这个模式中，开发者在代码中硬编码了所有的步骤和逻辑分支，而 LLM 仅被用来完成某个特定步骤，而不负责控制整个流程的走向。</p><p>而<span style="color: #BB8ED0; font-weight: bold;">Agents</span>是由 LLM 动态决定控制流的系统，由LLM 负责决定下一步该做什么，控制着循环的终止条件和路径选择。</p><p><strong>Workflows</strong> 和 <strong>Agents</strong> 并不是非黑即白的二元对立，而是一个连续的<strong>光谱</strong>，Workflows一端代表着<strong>低自主性</strong>，而Agents代表着<strong>高自主性</strong>。基于这两个概念，LangChain设计了以下几种模式：</p><h4 id="Prompt-Chaining"><a href="#Prompt-Chaining" class="headerlink" title="Prompt Chaining"></a>Prompt Chaining</h4><p><span style="color: #89986D; font-weight: bold;">Prompt Chaining（提示词链）</span>是最基础的线性工作流模式。当一个任务过于复杂，无法通过单个 Prompt 准确完成时，我们将其拆解为多个子步骤，前一个步骤的输出作为后一个步骤的输入。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, START, END</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Graph state</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    topic: <span class="built_in">str</span></span><br><span class="line">    joke: <span class="built_in">str</span></span><br><span class="line">    improved_joke: <span class="built_in">str</span></span><br><span class="line">    final_joke: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nodes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_joke</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;First LLM call to generate initial joke&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    msg = llm.invoke(<span class="string">f&quot;Write a short joke about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;joke&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_punchline</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Gate function to check if the joke has a punchline&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Simple check - does the joke contain &quot;?&quot; or &quot;!&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;?&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;joke&quot;</span>] <span class="keyword">or</span> <span class="string">&quot;!&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;joke&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pass&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Fail&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">improve_joke</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Second LLM call to improve the joke&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    msg = llm.invoke(<span class="string">f&quot;Make this joke funnier by adding wordplay: <span class="subst">&#123;state[<span class="string">&#x27;joke&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;improved_joke&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">polish_joke</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Third LLM call for final polish&quot;&quot;&quot;</span></span><br><span class="line">    msg = llm.invoke(<span class="string">f&quot;Add a surprising twist to this joke: <span class="subst">&#123;state[<span class="string">&#x27;improved_joke&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_joke&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build workflow</span></span><br><span class="line">workflow = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add nodes</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;generate_joke&quot;</span>, generate_joke)</span><br><span class="line">workflow.add_node(<span class="string">&quot;improve_joke&quot;</span>, improve_joke)</span><br><span class="line">workflow.add_node(<span class="string">&quot;polish_joke&quot;</span>, polish_joke)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add edges to connect nodes</span></span><br><span class="line">workflow.add_edge(START, <span class="string">&quot;generate_joke&quot;</span>)</span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;generate_joke&quot;</span>, check_punchline, &#123;<span class="string">&quot;Fail&quot;</span>: <span class="string">&quot;improve_joke&quot;</span>, <span class="string">&quot;Pass&quot;</span>: END&#125;</span><br><span class="line">)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;improve_joke&quot;</span>, <span class="string">&quot;polish_joke&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;polish_joke&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile</span></span><br><span class="line">chain = workflow.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show workflow</span></span><br><span class="line">display(Image(chain.get_graph().draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke</span></span><br><span class="line">state = chain.invoke(&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;cats&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Initial joke:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(state[<span class="string">&quot;joke&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n--- --- ---\n&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;improved_joke&quot;</span> <span class="keyword">in</span> state:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Improved joke:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(state[<span class="string">&quot;improved_joke&quot;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n--- --- ---\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Final joke:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(state[<span class="string">&quot;final_joke&quot;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Final joke:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(state[<span class="string">&quot;joke&quot;</span>])</span><br></pre></td></tr></table></figure><h4 id="Parallelization"><a href="#Parallelization" class="headerlink" title="Parallelization"></a>Parallelization</h4><p><span style="color: #89986D; font-weight: bold;">Parallelization（并行化）</span>允许 LLM 同时处理多个独立的子任务。这不仅能提升速度，还能通过多视角增强结果的鲁棒性。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Graph state</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    topic: <span class="built_in">str</span></span><br><span class="line">    joke: <span class="built_in">str</span></span><br><span class="line">    story: <span class="built_in">str</span></span><br><span class="line">    poem: <span class="built_in">str</span></span><br><span class="line">    combined_output: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nodes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_llm_1</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;First LLM call to generate initial joke&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    msg = llm.invoke(<span class="string">f&quot;Write a joke about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;joke&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_llm_2</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Second LLM call to generate story&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    msg = llm.invoke(<span class="string">f&quot;Write a story about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;story&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_llm_3</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Third LLM call to generate poem&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    msg = llm.invoke(<span class="string">f&quot;Write a poem about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;poem&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aggregator</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Combine the joke, story and poem into a single output&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    combined = <span class="string">f&quot;Here&#x27;s a story, joke, and poem about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>!\n\n&quot;</span></span><br><span class="line">    combined += <span class="string">f&quot;STORY:\n<span class="subst">&#123;state[<span class="string">&#x27;story&#x27;</span>]&#125;</span>\n\n&quot;</span></span><br><span class="line">    combined += <span class="string">f&quot;JOKE:\n<span class="subst">&#123;state[<span class="string">&#x27;joke&#x27;</span>]&#125;</span>\n\n&quot;</span></span><br><span class="line">    combined += <span class="string">f&quot;POEM:\n<span class="subst">&#123;state[<span class="string">&#x27;poem&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;combined_output&quot;</span>: combined&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build workflow</span></span><br><span class="line">parallel_builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add nodes</span></span><br><span class="line">parallel_builder.add_node(<span class="string">&quot;call_llm_1&quot;</span>, call_llm_1)</span><br><span class="line">parallel_builder.add_node(<span class="string">&quot;call_llm_2&quot;</span>, call_llm_2)</span><br><span class="line">parallel_builder.add_node(<span class="string">&quot;call_llm_3&quot;</span>, call_llm_3)</span><br><span class="line">parallel_builder.add_node(<span class="string">&quot;aggregator&quot;</span>, aggregator)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add edges to connect nodes</span></span><br><span class="line">parallel_builder.add_edge(START, <span class="string">&quot;call_llm_1&quot;</span>)</span><br><span class="line">parallel_builder.add_edge(START, <span class="string">&quot;call_llm_2&quot;</span>)</span><br><span class="line">parallel_builder.add_edge(START, <span class="string">&quot;call_llm_3&quot;</span>)</span><br><span class="line">parallel_builder.add_edge(<span class="string">&quot;call_llm_1&quot;</span>, <span class="string">&quot;aggregator&quot;</span>)</span><br><span class="line">parallel_builder.add_edge(<span class="string">&quot;call_llm_2&quot;</span>, <span class="string">&quot;aggregator&quot;</span>)</span><br><span class="line">parallel_builder.add_edge(<span class="string">&quot;call_llm_3&quot;</span>, <span class="string">&quot;aggregator&quot;</span>)</span><br><span class="line">parallel_builder.add_edge(<span class="string">&quot;aggregator&quot;</span>, END)</span><br><span class="line">parallel_workflow = parallel_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show workflow</span></span><br><span class="line">display(Image(parallel_workflow.get_graph().draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke</span></span><br><span class="line">state = parallel_workflow.invoke(&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;cats&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(state[<span class="string">&quot;combined_output&quot;</span>])</span><br></pre></td></tr></table></figure><h4 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h4><p><span style="color: #89986D; font-weight: bold;">Routing（路由）</span>引入了分类的概念。系统根据输入的语义或类型，将其分发给最擅长处理该问题的下游路径。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> HumanMessage, SystemMessage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Schema for structured output to use as routing logic</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Route</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    step: <span class="type">Literal</span>[<span class="string">&quot;poem&quot;</span>, <span class="string">&quot;story&quot;</span>, <span class="string">&quot;joke&quot;</span>] = Field(</span><br><span class="line">        <span class="literal">None</span>, description=<span class="string">&quot;The next step in the routing process&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Augment the LLM with schema for structured output</span></span><br><span class="line">router = llm.with_structured_output(Route)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># State</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="built_in">input</span>: <span class="built_in">str</span></span><br><span class="line">    decision: <span class="built_in">str</span></span><br><span class="line">    output: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nodes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call_1</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Write a story&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    result = llm.invoke(state[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;output&quot;</span>: result.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call_2</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Write a joke&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    result = llm.invoke(state[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;output&quot;</span>: result.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call_3</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Write a poem&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    result = llm.invoke(state[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;output&quot;</span>: result.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call_router</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Route the input to the appropriate node&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run the augmented LLM with structured output to serve as routing logic</span></span><br><span class="line">    decision = router.invoke(</span><br><span class="line">        [</span><br><span class="line">            SystemMessage(</span><br><span class="line">                content=<span class="string">&quot;Route the input to story, joke, or poem based on the user&#x27;s request.&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            HumanMessage(content=state[<span class="string">&quot;input&quot;</span>]),</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;decision&quot;</span>: decision.step&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional edge function to route to the appropriate node</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">route_decision</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="comment"># Return the node name you want to visit next</span></span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;decision&quot;</span>] == <span class="string">&quot;story&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;llm_call_1&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> state[<span class="string">&quot;decision&quot;</span>] == <span class="string">&quot;joke&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;llm_call_2&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> state[<span class="string">&quot;decision&quot;</span>] == <span class="string">&quot;poem&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;llm_call_3&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build workflow</span></span><br><span class="line">router_builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add nodes</span></span><br><span class="line">router_builder.add_node(<span class="string">&quot;llm_call_1&quot;</span>, llm_call_1)</span><br><span class="line">router_builder.add_node(<span class="string">&quot;llm_call_2&quot;</span>, llm_call_2)</span><br><span class="line">router_builder.add_node(<span class="string">&quot;llm_call_3&quot;</span>, llm_call_3)</span><br><span class="line">router_builder.add_node(<span class="string">&quot;llm_call_router&quot;</span>, llm_call_router)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add edges to connect nodes</span></span><br><span class="line">router_builder.add_edge(START, <span class="string">&quot;llm_call_router&quot;</span>)</span><br><span class="line">router_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;llm_call_router&quot;</span>,</span><br><span class="line">    route_decision,</span><br><span class="line">    &#123;  <span class="comment"># Name returned by route_decision : Name of next node to visit</span></span><br><span class="line">        <span class="string">&quot;llm_call_1&quot;</span>: <span class="string">&quot;llm_call_1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;llm_call_2&quot;</span>: <span class="string">&quot;llm_call_2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;llm_call_3&quot;</span>: <span class="string">&quot;llm_call_3&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br><span class="line">router_builder.add_edge(<span class="string">&quot;llm_call_1&quot;</span>, END)</span><br><span class="line">router_builder.add_edge(<span class="string">&quot;llm_call_2&quot;</span>, END)</span><br><span class="line">router_builder.add_edge(<span class="string">&quot;llm_call_3&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile workflow</span></span><br><span class="line">router_workflow = router_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show the workflow</span></span><br><span class="line">display(Image(router_workflow.get_graph().draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke</span></span><br><span class="line">state = router_workflow.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;Write me a joke about cats&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(state[<span class="string">&quot;output&quot;</span>])</span><br></pre></td></tr></table></figure><h4 id="Orchestrator-Worker"><a href="#Orchestrator-Worker" class="headerlink" title="Orchestrator-Worker"></a>Orchestrator-Worker</h4><p><span style="color: #89986D; font-weight: bold;">Orchestrator-Worker（指挥官-工人）</span>是并行化的高级形态。在普通并行中，任务数量往往是写死的；而在该模式下，<strong>Orchestrator（指挥官）</strong> 会动态分析任务，决定需要拆分成多少个子任务，并动态创建 <strong>Worker（工人）</strong> 节点。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated, <span class="type">List</span></span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Schema for structured output to use in planning</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Section</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(</span><br><span class="line">        description=<span class="string">&quot;Name for this section of the report.&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    description: <span class="built_in">str</span> = Field(</span><br><span class="line">        description=<span class="string">&quot;Brief overview of the main topics and concepts to be covered in this section.&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sections</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    sections: <span class="type">List</span>[Section] = Field(</span><br><span class="line">        description=<span class="string">&quot;Sections of the report.&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Augment the LLM with schema for structured output</span></span><br><span class="line">planner = llm.with_structured_output(Sections)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.types <span class="keyword">import</span> Send</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Graph state</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    topic: <span class="built_in">str</span>  <span class="comment"># Report topic</span></span><br><span class="line">    sections: <span class="built_in">list</span>[Section]  <span class="comment"># List of report sections</span></span><br><span class="line">    completed_sections: Annotated[</span><br><span class="line">        <span class="built_in">list</span>, operator.add</span><br><span class="line">    ]  <span class="comment"># All workers write to this key in parallel</span></span><br><span class="line">    final_report: <span class="built_in">str</span>  <span class="comment"># Final report</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Worker state</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkerState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    section: Section</span><br><span class="line">    completed_sections: Annotated[<span class="built_in">list</span>, operator.add]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nodes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">orchestrator</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Orchestrator that generates a plan for the report&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Generate queries</span></span><br><span class="line">    report_sections = planner.invoke(</span><br><span class="line">        [</span><br><span class="line">            SystemMessage(content=<span class="string">&quot;Generate a plan for the report.&quot;</span>),</span><br><span class="line">            HumanMessage(content=<span class="string">f&quot;Here is the report topic: <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>&quot;</span>),</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;sections&quot;</span>: report_sections.sections&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call</span>(<span class="params">state: WorkerState</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Worker writes a section of the report&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Generate section</span></span><br><span class="line">    section = llm.invoke(</span><br><span class="line">        [</span><br><span class="line">            SystemMessage(</span><br><span class="line">                content=<span class="string">&quot;Write a report section following the provided name and description. Include no preamble for each section. Use markdown formatting.&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            HumanMessage(</span><br><span class="line">                content=<span class="string">f&quot;Here is the section name: <span class="subst">&#123;state[<span class="string">&#x27;section&#x27;</span>].name&#125;</span> and description: <span class="subst">&#123;state[<span class="string">&#x27;section&#x27;</span>].description&#125;</span>&quot;</span></span><br><span class="line">            ),</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Write the updated section to completed sections</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;completed_sections&quot;</span>: [section.content]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">synthesizer</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Synthesize full report from sections&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># List of completed sections</span></span><br><span class="line">    completed_sections = state[<span class="string">&quot;completed_sections&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Format completed section to str to use as context for final sections</span></span><br><span class="line">    completed_report_sections = <span class="string">&quot;\n\n---\n\n&quot;</span>.join(completed_sections)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_report&quot;</span>: completed_report_sections&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional edge function to create llm_call workers that each write a section of the report</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">assign_workers</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Assign a worker to each section in the plan&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Kick off section writing in parallel via Send() API</span></span><br><span class="line">    <span class="keyword">return</span> [Send(<span class="string">&quot;llm_call&quot;</span>, &#123;<span class="string">&quot;section&quot;</span>: s&#125;) <span class="keyword">for</span> s <span class="keyword">in</span> state[<span class="string">&quot;sections&quot;</span>]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build workflow</span></span><br><span class="line">orchestrator_worker_builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the nodes</span></span><br><span class="line">orchestrator_worker_builder.add_node(<span class="string">&quot;orchestrator&quot;</span>, orchestrator)</span><br><span class="line">orchestrator_worker_builder.add_node(<span class="string">&quot;llm_call&quot;</span>, llm_call)</span><br><span class="line">orchestrator_worker_builder.add_node(<span class="string">&quot;synthesizer&quot;</span>, synthesizer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add edges to connect nodes</span></span><br><span class="line">orchestrator_worker_builder.add_edge(START, <span class="string">&quot;orchestrator&quot;</span>)</span><br><span class="line">orchestrator_worker_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;orchestrator&quot;</span>, assign_workers, [<span class="string">&quot;llm_call&quot;</span>]</span><br><span class="line">)</span><br><span class="line">orchestrator_worker_builder.add_edge(<span class="string">&quot;llm_call&quot;</span>, <span class="string">&quot;synthesizer&quot;</span>)</span><br><span class="line">orchestrator_worker_builder.add_edge(<span class="string">&quot;synthesizer&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile the workflow</span></span><br><span class="line">orchestrator_worker = orchestrator_worker_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show the workflow</span></span><br><span class="line">display(Image(orchestrator_worker.get_graph().draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke</span></span><br><span class="line">state = orchestrator_worker.invoke(&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;Create a report on LLM scaling laws&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Markdown</span><br><span class="line">Markdown(state[<span class="string">&quot;final_report&quot;</span>])</span><br></pre></td></tr></table></figure><h4 id="Evaluator-Optimizer"><a href="#Evaluator-Optimizer" class="headerlink" title="Evaluator-Optimizer"></a>Evaluator-Optimizer</h4><p><span style="color: #89986D; font-weight: bold;">Evaluator-Optimizer（评估-优化环）</span>模式引入了“反馈循环”。一个 LLM 负责生成，另一个 LLM（或人类）负责评估。如果结果不达标，会携带反馈意见退回给生成器重做。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Graph state</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    joke: <span class="built_in">str</span></span><br><span class="line">    topic: <span class="built_in">str</span></span><br><span class="line">    feedback: <span class="built_in">str</span></span><br><span class="line">    funny_or_not: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Schema for structured output to use in evaluation</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Feedback</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    grade: <span class="type">Literal</span>[<span class="string">&quot;funny&quot;</span>, <span class="string">&quot;not funny&quot;</span>] = Field(</span><br><span class="line">        description=<span class="string">&quot;Decide if the joke is funny or not.&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    feedback: <span class="built_in">str</span> = Field(</span><br><span class="line">        description=<span class="string">&quot;If the joke is not funny, provide feedback on how to improve it.&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Augment the LLM with schema for structured output</span></span><br><span class="line">evaluator = llm.with_structured_output(Feedback)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nodes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call_generator</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;LLM generates a joke&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.get(<span class="string">&quot;feedback&quot;</span>):</span><br><span class="line">        msg = llm.invoke(</span><br><span class="line">            <span class="string">f&quot;Write a joke about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span> but take into account the feedback: <span class="subst">&#123;state[<span class="string">&#x27;feedback&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        msg = llm.invoke(<span class="string">f&quot;Write a joke about <span class="subst">&#123;state[<span class="string">&#x27;topic&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;joke&quot;</span>: msg.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_call_evaluator</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;LLM evaluates the joke&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    grade = evaluator.invoke(<span class="string">f&quot;Grade the joke <span class="subst">&#123;state[<span class="string">&#x27;joke&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;funny_or_not&quot;</span>: grade.grade, <span class="string">&quot;feedback&quot;</span>: grade.feedback&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional edge function to route back to joke generator or end based upon feedback from the evaluator</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">route_joke</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Route back to joke generator or end based upon feedback from the evaluator&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;funny_or_not&quot;</span>] == <span class="string">&quot;funny&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Accepted&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> state[<span class="string">&quot;funny_or_not&quot;</span>] == <span class="string">&quot;not funny&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Rejected + Feedback&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build workflow</span></span><br><span class="line">optimizer_builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the nodes</span></span><br><span class="line">optimizer_builder.add_node(<span class="string">&quot;llm_call_generator&quot;</span>, llm_call_generator)</span><br><span class="line">optimizer_builder.add_node(<span class="string">&quot;llm_call_evaluator&quot;</span>, llm_call_evaluator)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add edges to connect nodes</span></span><br><span class="line">optimizer_builder.add_edge(START, <span class="string">&quot;llm_call_generator&quot;</span>)</span><br><span class="line">optimizer_builder.add_edge(<span class="string">&quot;llm_call_generator&quot;</span>, <span class="string">&quot;llm_call_evaluator&quot;</span>)</span><br><span class="line">optimizer_builder.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;llm_call_evaluator&quot;</span>,</span><br><span class="line">    route_joke,</span><br><span class="line">    &#123;  <span class="comment"># Name returned by route_joke : Name of next node to visit</span></span><br><span class="line">        <span class="string">&quot;Accepted&quot;</span>: END,</span><br><span class="line">        <span class="string">&quot;Rejected + Feedback&quot;</span>: <span class="string">&quot;llm_call_generator&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile the workflow</span></span><br><span class="line">optimizer_workflow = optimizer_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Show the workflow</span></span><br><span class="line">display(Image(optimizer_workflow.get_graph().draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invoke</span></span><br><span class="line">state = optimizer_workflow.invoke(&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;Cats&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(state[<span class="string">&quot;joke&quot;</span>])</span><br></pre></td></tr></table></figure><h4 id="Agents"><a href="#Agents" class="headerlink" title="Agents"></a>Agents</h4><p><span style="color: #89986D; font-weight: bold;">Agents（智能体）</span>是自动化程度最高的模式。与上述模式不同，智能体的执行路径不是预定义的，而是由 LLM 自主决定的。它依赖 <span style="color: #BB8ED0; font-weight: bold;">Tools</span>（工具）与环境交互，直到它认为任务已完成。</p><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>这次我选择基于LangGraph做一个<strong>周末旅游顾问</strong>，负责向用户推荐当天旅游目的地。</p><div style="background-color: #f7f9fc; border: 1px solid #e1e4e8; border-radius: 15px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"> <p style="margin-top: 0; margin-bottom: 12px; color: #333; border-bottom: 2px solid #5aa9e6; padding-bottom: 8px; display: inline-block; font-size: 1.1em;">🤖 周末旅游顾问</p> <p style="color: #666; font-size: 0.9em; margin: 6px 0; line-height: 1.4;">推荐 ：根据用户当前位置，想出 3 个周边目的地</p> <p style="color: #666; font-size: 0.9em; margin: 6px 0; line-height: 1.4;">查天气：同时去查这 3 个地方的天气</p>  <p style="color: #666; font-size: 0.9em; margin: 6px 0; line-height: 1.4;">决策：汇总天气信息，选出一个天气最好的</p> </div><p>按照上述文档的规范，我们先定义一个工具<code>weathertool</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Type</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field, SecretStr, ValidationError</span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> BaseTool</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志</span></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 1. 定义输入 Schema ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherInput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    city: <span class="built_in">str</span> = Field(</span><br><span class="line">        description=<span class="string">&quot;需要查询的城市英文名称 (e.g., &#x27;Beijing&#x27;, &#x27;Shanghai&#x27;, &#x27;London&#x27;)&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 2. 封装专业的工具类 ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpenWeatherTool</span>(<span class="title class_ inherited__">BaseTool</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    基于 OpenWeatherMap 的天气查询工具。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    name: <span class="built_in">str</span> = <span class="string">&quot;get_weather_data&quot;</span></span><br><span class="line">    description: <span class="built_in">str</span> = <span class="string">&quot;获取目标城市的实时天气数据，包括温度、天气状况(condition)、湿度等。&quot;</span></span><br><span class="line">    args_schema: <span class="type">Type</span>[BaseModel] = WeatherInput</span><br><span class="line"></span><br><span class="line">    api_key: SecretStr = Field(default_factory=<span class="keyword">lambda</span>: SecretStr(os.environ.get(<span class="string">&quot;OPENWEATHER_API_KEY&quot;</span>, <span class="string">&quot;&quot;</span>)))</span><br><span class="line">    base_url: <span class="built_in">str</span> = <span class="string">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_run</span>(<span class="params">self, city: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.api_key.get_secret_value():</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;ConfigurationError&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Missing OPENWEATHER_API_KEY&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&quot;q&quot;</span>: city,</span><br><span class="line">            <span class="string">&quot;appid&quot;</span>: self.api_key.get_secret_value(),</span><br><span class="line">            <span class="string">&quot;units&quot;</span>: <span class="string">&quot;metric&quot;</span>, </span><br><span class="line">            <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;en&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 设置超时</span></span><br><span class="line">            response = requests.get(self.base_url, params=params, timeout=<span class="number">10</span>)</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            data = response.json()</span><br><span class="line"></span><br><span class="line">            result = &#123;</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: data.get(<span class="string">&quot;name&quot;</span>, city),</span><br><span class="line">                <span class="string">&quot;temp&quot;</span>: data[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;temp&quot;</span>],</span><br><span class="line">                <span class="string">&quot;feels_like&quot;</span>: data[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;feels_like&quot;</span>],</span><br><span class="line">                <span class="string">&quot;humidity&quot;</span>: data[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;humidity&quot;</span>],</span><br><span class="line">                <span class="string">&quot;condition&quot;</span>: data[<span class="string">&quot;weather&quot;</span>][<span class="number">0</span>][<span class="string">&quot;main&quot;</span>],</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: data[<span class="string">&quot;weather&quot;</span>][<span class="number">0</span>][<span class="string">&quot;description&quot;</span>],</span><br><span class="line">                <span class="string">&quot;wind_speed&quot;</span>: data[<span class="string">&quot;wind&quot;</span>][<span class="string">&quot;speed&quot;</span>],</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="string">f&quot;Successfully fetched weather for <span class="subst">&#123;city&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;HTTP Error for <span class="subst">&#123;city&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;City not found&quot;</span>, <span class="string">&quot;city&quot;</span>: city&#125;</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;API Error: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Connection Error for <span class="subst">&#123;city&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Connection timeout or failure&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Unknown Error for <span class="subst">&#123;city&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 3. 将结构化数据转为自然语言 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_weather_for_llm</span>(<span class="params">weather_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">if</span> weather_data.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;error&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;查询失败: <span class="subst">&#123;weather_data.get(<span class="string">&#x27;message&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="string">f&quot;【<span class="subst">&#123;weather_data[<span class="string">&#x27;city&#x27;</span>]&#125;</span>】\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;天气: <span class="subst">&#123;weather_data[<span class="string">&#x27;condition&#x27;</span>]&#125;</span> (<span class="subst">&#123;weather_data[<span class="string">&#x27;description&#x27;</span>]&#125;</span>)\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;温度: <span class="subst">&#123;weather_data[<span class="string">&#x27;temp&#x27;</span>]&#125;</span>°C (体感 <span class="subst">&#123;weather_data[<span class="string">&#x27;feels_like&#x27;</span>]&#125;</span>°C)\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;湿度: <span class="subst">&#123;weather_data[<span class="string">&#x27;humidity&#x27;</span>]&#125;</span>%\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;风速: <span class="subst">&#123;weather_data[<span class="string">&#x27;wind_speed&#x27;</span>]&#125;</span> m/s&quot;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>和上一篇Agent的文章一样，我们使用 OpenWeatherMap 的天气查询服务，实际上，这个 tool 仅负责规范输入输出并封装天气查询功能。</p><p>回到主函数，我们先定义三个状态，即数据流转的格式规范：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Destination</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;单体目的地结构&quot;&quot;&quot;</span></span><br><span class="line">    city: <span class="built_in">str</span></span><br><span class="line">    reason: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;全局共享状态&quot;&quot;&quot;</span></span><br><span class="line">    current_location: <span class="built_in">str</span></span><br><span class="line">    candidates: <span class="type">List</span>[Destination]  <span class="comment"># LLM 推荐的城市列表</span></span><br><span class="line">    weather_reports: Annotated[<span class="type">List</span>[<span class="type">Dict</span>], operator.add] </span><br><span class="line">    final_decision: <span class="type">Dict</span>           <span class="comment"># 最终选定的方案</span></span><br><span class="line">    final_output: <span class="built_in">str</span>              <span class="comment"># 最终给用户的建议文案</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherWorkerState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Worker 节点的专用输入状态&quot;&quot;&quot;</span></span><br><span class="line">    city: <span class="built_in">str</span></span><br></pre></td></tr></table></figure></p><p>再定义langgraph的节点。我们需要的agent的行为顺序是选择候选城市-&gt;查询天气-&gt;根据天气选出最佳城市。</p><p>第一个节点根据用户ip自动构建让llm推荐周边城市的 prompt，并发送给llm，让其返回一个city列表。第二个节点负责调用封装好的<code>weathertool</code>，查询这些城市的天气情况。第三个节点负责选出天气最好的城市，这里我们只做一个逻辑判断，不调用llm。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化通义千问模型</span></span><br><span class="line">llm = ChatTongyi(model_name=<span class="string">&quot;qwen-max&quot;</span>, temperature=<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.1 推荐节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendOutput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    cities: <span class="type">List</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;3个推荐的周边城市英文名&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recommend_node</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    structured_llm = llm.with_structured_output(RecommendOutput)</span><br><span class="line">    </span><br><span class="line">    prompt = <span class="string">f&quot;我在 <span class="subst">&#123;state[<span class="string">&#x27;current_location&#x27;</span>]&#125;</span>，请推荐3个适合周末自驾游的周边城市。请只返回城市英文名。&quot;</span></span><br><span class="line">    result = structured_llm.invoke(prompt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;candidates&quot;</span>: [&#123;<span class="string">&quot;city&quot;</span>: c, <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;LLM推荐&quot;</span>&#125; <span class="keyword">for</span> c <span class="keyword">in</span> result.cities]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.2 天气查询节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">weather_worker</span>(<span class="params">state: WeatherWorkerState</span>):</span><br><span class="line">    city = state[<span class="string">&quot;city&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 实例化并调用工具</span></span><br><span class="line">    tool = OpenWeatherTool()</span><br><span class="line">    weather_data = tool.invoke(&#123;<span class="string">&quot;city&quot;</span>: city&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;weather_reports&quot;</span>: [weather_data]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.3 决策节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decision_node</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    reports = state[<span class="string">&quot;weather_reports&quot;</span>]</span><br><span class="line">    best_city = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 策略1: 优先找晴天</span></span><br><span class="line">    sunny_cities = [r <span class="keyword">for</span> r <span class="keyword">in</span> reports <span class="keyword">if</span> r.get(<span class="string">&quot;condition&quot;</span>) <span class="keyword">in</span> [<span class="string">&quot;Sunny&quot;</span>, <span class="string">&quot;Clear&quot;</span>]]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> sunny_cities:</span><br><span class="line">        <span class="comment"># 如果有多个晴天，选温度最高的</span></span><br><span class="line">        best_city = <span class="built_in">max</span>(sunny_cities, key=<span class="keyword">lambda</span> x: x.get(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>))</span><br><span class="line">        strategy = <span class="string">&quot;天气晴朗&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 策略2: 如果都没晴天，选温度最高的</span></span><br><span class="line">        non_rainy = [r <span class="keyword">for</span> r <span class="keyword">in</span> reports <span class="keyword">if</span> <span class="string">&quot;Rain&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.get(<span class="string">&quot;condition&quot;</span>, <span class="string">&quot;&quot;</span>)]</span><br><span class="line">        <span class="keyword">if</span> non_rainy:</span><br><span class="line">            best_city = <span class="built_in">max</span>(non_rainy, key=<span class="keyword">lambda</span> x: x.get(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>))</span><br><span class="line">            strategy = <span class="string">&quot;虽然多云但温暖&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 策略3: 只有雨天，随便选一个</span></span><br><span class="line">            best_city = reports[<span class="number">0</span>]</span><br><span class="line">            strategy = <span class="string">&quot;室内活动为主&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成最终文案</span></span><br><span class="line">    final_text = (</span><br><span class="line">        <span class="string">f&quot;决定去：【<span class="subst">&#123;best_city[<span class="string">&#x27;city&#x27;</span>]&#125;</span>】\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;天气状况：<span class="subst">&#123;best_city[<span class="string">&#x27;condition&#x27;</span>]&#125;</span>, <span class="subst">&#123;best_city[<span class="string">&#x27;temp&#x27;</span>]&#125;</span>°C\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;湿度：<span class="subst">&#123;best_city[<span class="string">&#x27;humidity&#x27;</span>]&#125;</span>%\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;推荐理由：<span class="subst">&#123;strategy&#125;</span>，适合周末出行。&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_decision&quot;</span>: best_city, <span class="string">&quot;final_output&quot;</span>: final_text&#125;</span><br></pre></td></tr></table></figure><p>定义路由逻辑：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">map_weather_tasks</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Map 步骤：</span></span><br><span class="line"><span class="string">    读取 candidates 列表，为每个城市生成一个 Send 对象。</span></span><br><span class="line"><span class="string">    这将触发 N 个 weather_worker 并行运行。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    candidates = state[<span class="string">&quot;candidates&quot;</span>]</span><br><span class="line">    <span class="comment"># 语法: Send(目标节点名, 传递给该节点的Input)</span></span><br><span class="line">    <span class="keyword">return</span> [Send(<span class="string">&quot;weather_worker&quot;</span>, &#123;<span class="string">&quot;city&quot;</span>: c[<span class="string">&quot;city&quot;</span>]&#125;) <span class="keyword">for</span> c <span class="keyword">in</span> candidates]</span><br></pre></td></tr></table></figure></p><p>构建graph：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_agent</span>():</span><br><span class="line">    workflow = StateGraph(AgentState)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加节点</span></span><br><span class="line">    workflow.add_node(<span class="string">&quot;recommend_node&quot;</span>, recommend_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;weather_worker&quot;</span>, weather_worker)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;decision_node&quot;</span>, decision_node)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义边</span></span><br><span class="line">    workflow.add_edge(START, <span class="string">&quot;recommend_node&quot;</span>)</span><br><span class="line">    workflow.add_conditional_edges(<span class="string">&quot;recommend_node&quot;</span>, map_weather_tasks, [<span class="string">&quot;weather_worker&quot;</span>])</span><br><span class="line">    workflow.add_edge(<span class="string">&quot;weather_worker&quot;</span>, <span class="string">&quot;decision_node&quot;</span>)</span><br><span class="line">    workflow.add_edge(<span class="string">&quot;decision_node&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> workflow.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure></p><p>最后贴出整合后的完整的主函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated, <span class="type">Any</span>, <span class="type">Dict</span>, <span class="type">List</span>, TypedDict</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> END, START, StateGraph</span><br><span class="line"><span class="keyword">from</span> langgraph.types <span class="keyword">import</span> Send</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> tools.weathertool <span class="keyword">import</span> OpenWeatherTool</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">LOG_FORMAT = <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=LOG_FORMAT)</span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;TravelAgent&quot;</span>)</span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;**&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENWEATHER_API_KEY&quot;</span>] = <span class="string">&quot;**&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- State Definitions ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Destination</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    city: <span class="built_in">str</span></span><br><span class="line">    reason: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    current_location: <span class="built_in">str</span></span><br><span class="line">    candidates: <span class="type">List</span>[Destination]</span><br><span class="line">    <span class="comment"># 并行任务结果聚合</span></span><br><span class="line">    weather_reports: Annotated[<span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]], operator.add]</span><br><span class="line">    final_decision: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    final_output: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherWorkerState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    city: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendOutput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    cities: <span class="type">List</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;List of 3 recommended cities (English names only).&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Service Initialization ---</span></span><br><span class="line"></span><br><span class="line">llm = ChatTongyi(model_name=<span class="string">&quot;qwen-max&quot;</span>, temperature=<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Node Implementations ---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recommend_node</span>(<span class="params">state: AgentState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generates city recommendations based on current location.&quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;Generating recommendations for location: <span class="subst">&#123;state[<span class="string">&#x27;current_location&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    structured_llm = llm.with_structured_output(RecommendOutput)</span><br><span class="line">    prompt = <span class="string">f&quot;Located in <span class="subst">&#123;state[<span class="string">&#x27;current_location&#x27;</span>]&#125;</span>. Recommend 3 suitable cities for a weekend road trip. Return English names only.&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = structured_llm.invoke(prompt)</span><br><span class="line">        logger.info(<span class="string">f&quot;Generated candidates: <span class="subst">&#123;result.cities&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;candidates&quot;</span>: [&#123;<span class="string">&quot;city&quot;</span>: c, <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;LLM Recommendation&quot;</span>&#125; <span class="keyword">for</span> c <span class="keyword">in</span> result.cities]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Recommendation failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">weather_worker</span>(<span class="params">state: WeatherWorkerState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Fetches weather data for a specific city.&quot;&quot;&quot;</span></span><br><span class="line">    city = state[<span class="string">&quot;city&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tool = OpenWeatherTool()</span><br><span class="line">        weather_data = tool.invoke(&#123;<span class="string">&quot;city&quot;</span>: city&#125;)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;weather_reports&quot;</span>: [weather_data]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Weather fetch failed for <span class="subst">&#123;city&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;weather_reports&quot;</span>: [&#123;<span class="string">&quot;city&quot;</span>: city, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;error&quot;</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decision_node</span>(<span class="params">state: AgentState</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Selects the best destination based on weather conditions.&quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">&quot;Evaluating weather reports for final decision.&quot;</span>)</span><br><span class="line">    reports = state[<span class="string">&quot;weather_reports&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 过滤无效报告</span></span><br><span class="line">    valid_reports = [r <span class="keyword">for</span> r <span class="keyword">in</span> reports <span class="keyword">if</span> r.get(<span class="string">&quot;status&quot;</span>) != <span class="string">&quot;error&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid_reports:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;No valid weather reports available.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 决策逻辑：优先晴天 -&gt; 其次无雨 -&gt; 最后兜底</span></span><br><span class="line">    sunny_cities = [r <span class="keyword">for</span> r <span class="keyword">in</span> valid_reports <span class="keyword">if</span> r.get(<span class="string">&quot;condition&quot;</span>) <span class="keyword">in</span> [<span class="string">&quot;Sunny&quot;</span>, <span class="string">&quot;Clear&quot;</span>]]</span><br><span class="line">    non_rainy = [r <span class="keyword">for</span> r <span class="keyword">in</span> valid_reports <span class="keyword">if</span> <span class="string">&quot;Rain&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.get(<span class="string">&quot;condition&quot;</span>, <span class="string">&quot;&quot;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sunny_cities:</span><br><span class="line">        best_city = <span class="built_in">max</span>(sunny_cities, key=<span class="keyword">lambda</span> x: x.get(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>))</span><br><span class="line">        strategy = <span class="string">&quot;Optimal weather conditions (Sunny/Clear)&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> non_rainy:</span><br><span class="line">        best_city = <span class="built_in">max</span>(non_rainy, key=<span class="keyword">lambda</span> x: x.get(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>))</span><br><span class="line">        strategy = <span class="string">&quot;Acceptable conditions (Non-rainy)&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        best_city = valid_reports[<span class="number">0</span>]</span><br><span class="line">        strategy = <span class="string">&quot;Fallback selection (Indoor activities recommended)&quot;</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Selected: <span class="subst">&#123;best_city[<span class="string">&#x27;city&#x27;</span>]&#125;</span> | Reason: <span class="subst">&#123;strategy&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    final_text = (</span><br><span class="line">        <span class="string">f&quot;Destination: <span class="subst">&#123;best_city[<span class="string">&#x27;city&#x27;</span>]&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;Conditions: <span class="subst">&#123;best_city.get(<span class="string">&#x27;condition&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>, <span class="subst">&#123;best_city.get(<span class="string">&#x27;temp&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>°C\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;Humidity: <span class="subst">&#123;best_city.get(<span class="string">&#x27;humidity&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>%\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;Strategy: <span class="subst">&#123;strategy&#125;</span>&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_decision&quot;</span>: best_city, <span class="string">&quot;final_output&quot;</span>: final_text&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Routing Logic ---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">map_weather_tasks</span>(<span class="params">state: AgentState</span>) -&gt; <span class="type">List</span>[Send]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generates parallel tasks for weather checking.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [Send(<span class="string">&quot;weather_worker&quot;</span>, &#123;<span class="string">&quot;city&quot;</span>: c[<span class="string">&quot;city&quot;</span>]&#125;) <span class="keyword">for</span> c <span class="keyword">in</span> state[<span class="string">&quot;candidates&quot;</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Graph Construction ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_agent</span>() -&gt; <span class="type">Any</span>:</span><br><span class="line">    workflow = StateGraph(AgentState)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Nodes</span></span><br><span class="line">    workflow.add_node(<span class="string">&quot;recommend_node&quot;</span>, recommend_node)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;weather_worker&quot;</span>, weather_worker)</span><br><span class="line">    workflow.add_node(<span class="string">&quot;decision_node&quot;</span>, decision_node)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Edges</span></span><br><span class="line">    workflow.add_edge(START, <span class="string">&quot;recommend_node&quot;</span>)</span><br><span class="line">    workflow.add_conditional_edges(<span class="string">&quot;recommend_node&quot;</span>, map_weather_tasks, [<span class="string">&quot;weather_worker&quot;</span>])</span><br><span class="line">    workflow.add_edge(<span class="string">&quot;weather_worker&quot;</span>, <span class="string">&quot;decision_node&quot;</span>)</span><br><span class="line">    workflow.add_edge(<span class="string">&quot;decision_node&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> workflow.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Execution Entry Point ---</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    agent = create_agent()</span><br><span class="line">    inputs = &#123;<span class="string">&quot;current_location&quot;</span>: <span class="string">&quot;Shanghai&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    logger.info(<span class="string">&quot;Starting Travel Agent execution...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        final_state = agent.invoke(inputs)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n--- Execution Result ---&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(final_state[<span class="string">&quot;final_output&quot;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;------------------------\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        logger.debug(<span class="string">&quot;Full weather reports: %s&quot;</span>, final_state[<span class="string">&quot;weather_reports&quot;</span>])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.critical(<span class="string">f&quot;Execution failed: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></p><p>运行输出为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2026-01-11 23:00:39,700 - TravelAgent - INFO - Starting Travel Agent execution...</span><br><span class="line">2026-01-11 23:00:39,700 - TravelAgent - INFO - Generating recommendations <span class="keyword">for</span> location: Shanghai</span><br><span class="line">2026-01-11 23:00:43,200 - TravelAgent - INFO - Generated candidates: [<span class="string">&#x27;Hangzhou&#x27;</span>, <span class="string">&#x27;Suzhou&#x27;</span>, <span class="string">&#x27;Nanjing&#x27;</span>]</span><br><span class="line">2026-01-11 23:00:43,812 - tools.weathertool - INFO - Successfully fetched weather <span class="keyword">for</span> Hangzhou</span><br><span class="line">2026-01-11 23:00:43,818 - tools.weathertool - INFO - Successfully fetched weather <span class="keyword">for</span> Suzhou</span><br><span class="line">2026-01-11 23:00:44,667 - tools.weathertool - INFO - Successfully fetched weather <span class="keyword">for</span> Nanjing</span><br><span class="line">2026-01-11 23:00:44,669 - TravelAgent - INFO - Evaluating weather reports <span class="keyword">for</span> final decision.</span><br><span class="line">2026-01-11 23:00:44,670 - TravelAgent - INFO - Selected: Nanjing | Reason: Acceptable conditions (Non-rainy)</span><br><span class="line"></span><br><span class="line">--- Execution Result ---</span><br><span class="line">Destination: Nanjing</span><br><span class="line">Conditions: Clouds, 2.21°C</span><br><span class="line">Humidity: 19%</span><br><span class="line">Strategy: Acceptable conditions (Non-rainy)</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;尝试使用LangGraph。&lt;br&gt;</summary>
    
    
    
    <category term="编程学习-Python" scheme="https://atffang.github.io/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0-Python/"/>
    
    
  </entry>
  
  <entry>
    <title>LangChain学习日志: Agent</title>
    <link href="https://atffang.github.io/2026/01/10/langchainAgent/"/>
    <id>https://atffang.github.io/2026/01/10/langchainAgent/</id>
    <published>2026-01-10T07:33:25.000Z</published>
    <updated>2026-01-11T01:35:58.638Z</updated>
    
    <content type="html"><![CDATA[<p>尝试使用LangChain的Agents功能。<br><span id="more"></span></p><h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>LangChain 官方文档的 Core components 第一项就是 <span style="color: #BB8ED0; font-weight: bold;">Agents </span> ，我们先来看看<a href="https://docs.langchain.com/oss/python/langchain/agents">官方是如何介绍的</a> ：</p><p>Agents combine language models with tools to create systems that can reason about tasks, decide which tools to use, and iteratively work towards solutions.</p><p><code>create_agent</code> provides a production-ready agent implementation.</p><p>An LLM Agent runs tools in a loop to achieve a goal. An agent runs until a stop condition is met - i.e., when the model emits a final output or an iteration limit is reached.</p><p>这段话告诉我们三个信息：</p><ul><li>Agent 是将<span style="color: #BB8ED0; font-weight: bold;">语言模型（LLM）</span>与<span style="color: #BB8ED0; font-weight: bold;">工具（Tools）</span>结合的系统。它的特点是具备推理能力，能自主决定该用什么工具，并通过反复迭代来解决任务。</li><li>可以使用 <code>create_agent</code> 函数实现</li><li>Agent 的运行是一个<strong>循环过程</strong>：它会不断运行工具，直到满足停止条件为止。</li></ul><p>并且给出了简单的工作流程：<br><img src="/2026/01/10/langchainAgent/agent01.png" class="" title="sucessful"></p><h3 id="Core-components"><a href="#Core-components" class="headerlink" title="Core components"></a>Core components</h3><h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h4><p><span style="color: #89986D; font-weight: bold;">Model 就是 Agent 的推理引擎，负责思考、决策和生成回复。</span><br>对于 LLM 模型的调用分为两种模式：</p><ul><li><strong>Static Model</strong>：最常用的方式。在创建 Agent 时就固定好（例如指定用 <code>gpt-4o</code>），整个运行过程中不会变。</li><li><strong>Dynamic Model</strong>：一种高级用法，可以在运行时根据上下文动态选择模型。比如在简单的问题上使用便宜的模型。</li></ul><h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h4><p><span style="color: #89986D; font-weight: bold;">Tools 就是 Agent 与外部世界交互的工具。</span>通常是标准的 Python 函数，加上 <code>@tool</code> 装饰器。根据文档的示例，我们可以通过<code>create_agent</code>简单定义一个 Tool ：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_agent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Search for information.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Results for: <span class="subst">&#123;query&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params">location: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Get weather information for a location.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Weather in <span class="subst">&#123;location&#125;</span>: Sunny, 72°F&quot;</span></span><br><span class="line"></span><br><span class="line">agent = create_agent(model, tools=[search, get_weather])</span><br></pre></td></tr></table></figure></p><p>而如果要自定义Tool错误的处理方式，就使用 <code>@wrap_tool_call</code> 装饰器创建中间件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_agent</span><br><span class="line"><span class="keyword">from</span> langchain.agents.middleware <span class="keyword">import</span> wrap_tool_call</span><br><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> ToolMessage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@wrap_tool_call</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_tool_errors</span>(<span class="params">request, handler</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Handle tool execution errors with custom messages.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> handler(request)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># Return a custom error message to the model</span></span><br><span class="line">        <span class="keyword">return</span> ToolMessage(</span><br><span class="line">            content=<span class="string">f&quot;Tool error: Please check your input and try again. (<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>)&quot;</span>,</span><br><span class="line">            tool_call_id=request.tool_call[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">agent = create_agent(</span><br><span class="line">    model=<span class="string">&quot;gpt-4o&quot;</span>,</span><br><span class="line">    tools=[search, get_weather],</span><br><span class="line">    middleware=[handle_tool_errors]</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><h4 id="System-Prompt"><a href="#System-Prompt" class="headerlink" title="System Prompt"></a>System Prompt</h4><p>顾名思义，System Prompt 就是系统层面的提示词，<span style="color: #89986D; font-weight: bold;">用于设定 Agent 的行为规范和角色。</span><br>最简单的定义方式就是在构建agent示例时传入：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">agent = create_agent(</span><br><span class="line">    model,</span><br><span class="line">    tools,</span><br><span class="line">    system_prompt=<span class="string">&quot;You are a helpful assistant. Be concise and accurate.&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>这是传入Str，复杂一些，可以传入LangChain的  <a href="https://reference.langchain.com/python/langchain/messages/?_gl=1*njhwp7*_gcl_au*MzYwNTQyNDYwLjE3Njc5MjM3MTU.*_ga*MTQ2MjI5MjY5MC4xNzY3OTIzNzE2*_ga_47WX3HKKY2*czE3NjgwMzAwNzkkbzQkZzEkdDE3NjgwMzAzMjQkajYwJGwwJGgw#langchain.messages.SystemMessage"><code>SystemMessage</code></a>.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_agent</span><br><span class="line"><span class="keyword">from</span> langchain.messages <span class="keyword">import</span> SystemMessage, HumanMessage</span><br><span class="line"></span><br><span class="line">literary_agent = create_agent(</span><br><span class="line">    model=<span class="string">&quot;anthropic:claude-sonnet-4-5&quot;</span>,</span><br><span class="line">    system_prompt=SystemMessage(</span><br><span class="line">        content=[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: <span class="string">&quot;You are an AI assistant tasked with analyzing literary works.&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: <span class="string">&quot;&lt;the entire contents of &#x27;Pride and Prejudice&#x27;&gt;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;cache_control&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;ephemeral&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">result = literary_agent.invoke(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(<span class="string">&quot;Analyze the major themes in &#x27;Pride and Prejudice&#x27;.&quot;</span>)]&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><h4 id="Invocation"><a href="#Invocation" class="headerlink" title="Invocation"></a>Invocation</h4><p><span style="color: #89986D; font-weight: bold;">启动 Agent。</span></p><p>Agent 的运行是基于 <strong>State (状态)</strong> 的更新，通常只需要给它传入一个新的消息（Message），它就会开始根据图（Graph）的逻辑运行，直到得出结果。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = agent.invoke(</span><br><span class="line">    &#123;<span class="string">&quot;messages&quot;</span>: [&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;What&#x27;s the weather in San Francisco?&quot;</span>&#125;]&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>除了以上基础的必要的步骤，LangChain 还为 Agents 提供了一些高级功能。我们简单了解一下：<br><span style="color: #89986D; font-weight: bold;">Structured Output (结构化输出)</span><br>可以强制返回 JSON 数据（比如提取出的姓名、日期、订单号），方便程序直接后续处理。</p><p><span style="color: #89986D; font-weight: bold;">Memory (记忆机制)</span></p><ul><li><strong>短期记忆：</strong> 通过 State 实现记住这轮对话里你刚才说了什么。</li><li><strong>长期记忆：</strong> 通过数据库实现历史记忆。</li></ul><p><span style="color: #89986D; font-weight: bold;">Streaming (流式输出)</span><br>Agent 可以一边调用工具，一边就在屏幕上即时打印出它的思考过程。</p><p><span style="color: #89986D; font-weight: bold;">Middleware (中间件)</span><br>它可以在 Agent 说话前、说话后，或者工具报错时工作。比如在工具报错时，自动让 Agent 重试，而不是直接让程序崩溃。</p><p>这些Agents的功能似乎封装的还不错，那我们来实际尝试一下。</p><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>在实战中，我们需要实现一个日常小助手，他有以下两个小功能：</p><div style="background-color: #f7f9fc; border: 1px solid #e1e4e8; border-radius: 15px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;"> <p style="margin-top: 0; margin-bottom: 12px; color: #333; border-bottom: 2px solid #5aa9e6; padding-bottom: 8px; display: inline-block; font-size: 1.1em;">🤖Daily Assistant</p> <p style="color: #666; font-size: 0.9em; margin: 6px 0; line-height: 1.4;">WeatherTool: 查询某地天气</p> <p style="color: #666; font-size: 0.9em; margin: 6px 0; line-height: 1.4;">Loan Calculator: 计算等额本息</p> </div><h4 id="WeatherTool"><a href="#WeatherTool" class="headerlink" title="WeatherTool"></a>WeatherTool</h4><p>这是一个<span style="color: #BB8ED0; font-weight: bold;">天气查询工具</span>。为了查询真实的天气，我们去 OpenWeatherMap 官网申请一个免费的 API Key，然后使用其api查询指定城市的天气。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Type</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> BaseTool</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 定义输入参数的结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherInput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    city: <span class="built_in">str</span> = Field(</span><br><span class="line">        description=<span class="string">&quot;需要查询天气的城市英文名，例如 &#x27;Beijing&#x27;, &#x27;London&#x27;, &#x27;New York&#x27;&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 定义工具类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealWeatherTool</span>(<span class="title class_ inherited__">BaseTool</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = <span class="string">&quot;get_real_weather&quot;</span></span><br><span class="line">    description: <span class="built_in">str</span> = (</span><br><span class="line">        <span class="string">&quot;获取指定城市的实时天气详情。包含温度、天气状况、湿度等信息。&quot;</span></span><br><span class="line">        <span class="string">&quot;当用户询问&#x27;今天天气如何&#x27;或&#x27;下雨吗&#x27;时使用此工具。&quot;</span></span><br><span class="line">    )</span><br><span class="line">    args_schema: <span class="type">Type</span>[BaseModel] = WeatherInput</span><br><span class="line">    api_key: <span class="built_in">str</span> = os.getenv(<span class="string">&quot;OPENWEATHER_API_KEY&quot;</span>, <span class="string">&quot;******&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_run</span>(<span class="params">self, city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        base_url = <span class="string">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&quot;q&quot;</span>: city,</span><br><span class="line">            <span class="string">&quot;appid&quot;</span>: self.api_key,</span><br><span class="line">            <span class="string">&quot;units&quot;</span>: <span class="string">&quot;metric&quot;</span>,</span><br><span class="line">            <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;zh_cn&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(base_url, params=params)</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            </span><br><span class="line">            data = response.json()</span><br><span class="line">            </span><br><span class="line">            weather_desc = data[<span class="string">&quot;weather&quot;</span>][<span class="number">0</span>][<span class="string">&quot;description&quot;</span>]</span><br><span class="line">            temp = data[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;temp&quot;</span>]</span><br><span class="line">            humidity = data[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;humidity&quot;</span>]</span><br><span class="line">            wind_speed = data[<span class="string">&quot;wind&quot;</span>][<span class="string">&quot;speed&quot;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="string">f&quot;【<span class="subst">&#123;city&#125;</span> 实时天气】\n&quot;</span></span><br><span class="line">                <span class="string">f&quot;- 状况: <span class="subst">&#123;weather_desc&#125;</span>\n&quot;</span></span><br><span class="line">                <span class="string">f&quot;- 温度: <span class="subst">&#123;temp&#125;</span>°C\n&quot;</span></span><br><span class="line">                <span class="string">f&quot;- 湿度: <span class="subst">&#123;humidity&#125;</span>%\n&quot;</span></span><br><span class="line">                <span class="string">f&quot;- 风速: <span class="subst">&#123;wind_speed&#125;</span> m/s&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">f&quot;Error: 找不到城市 &#x27;<span class="subst">&#123;city&#125;</span>&#x27;，请检查拼写。&quot;</span></span><br><span class="line">            <span class="keyword">elif</span> response.status_code == <span class="number">401</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Error: API Key 无效。&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;Error: 请求失败 (<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>)&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;Error: 查询过程中发生未知错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><p>在上述代码中，我们先定义了输入参数的结构<code>WeatherInput</code>，其实就是输入一个城市名字符串。随后，继承<code>BaseTool</code>类定义一个<code>RealWeatherTool</code>类，定义内部字段并重写<code>_run</code>方法。</p><p>和上一篇笔记一样，我们使用阿里的 qwen 模型，创建一个agent，并把自定义的tool交给他测试一下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> create_agent</span><br><span class="line"><span class="keyword">from</span> tools.weathertool <span class="keyword">import</span> RealWeatherTool</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;******&quot;</span></span><br><span class="line">llm = ChatTongyi(model_name=<span class="string">&quot;qwen-max&quot;</span>)</span><br><span class="line"></span><br><span class="line">weather_tool = RealWeatherTool()</span><br><span class="line">tools = [weather_tool]</span><br><span class="line"></span><br><span class="line">agent = create_agent(llm, tools=tools)</span><br><span class="line"></span><br><span class="line">query = <span class="string">&quot;帮我查查杭州的天气。&quot;</span></span><br><span class="line">result = agent.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> result[<span class="string">&quot;messages&quot;</span>]:</span><br><span class="line">    message.pretty_print()</span><br></pre></td></tr></table></figure></p><p>我们打印完整的输出，记录了大模型调用工具的过程：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">=============== Human Message ===============</span><br><span class="line">帮我查查杭州的天气。</span><br><span class="line">=============== Ai Message ================</span><br><span class="line">Tool Calls:</span><br><span class="line">  get_real_weather (call_9a7740f492704862b7ae77)</span><br><span class="line"> Call ID: call_9a7740f492704862b7ae77</span><br><span class="line">  Args:</span><br><span class="line">    city: Hangzhou</span><br><span class="line">================ Tool Message ===============</span><br><span class="line">Name: get_real_weather</span><br><span class="line">【Hangzhou 实时天气】</span><br><span class="line">- 状况: 晴</span><br><span class="line">- 温度: 8.95°C</span><br><span class="line">- 湿度: 28%</span><br><span class="line">- 风速: 3.94 m/s</span><br><span class="line">================= Ai Message ===============</span><br><span class="line">杭州现在的天气情况如下：</span><br><span class="line">- 状况: 晴</span><br><span class="line">- 温度: 8.95°C</span><br><span class="line">- 湿度: 28%</span><br><span class="line">- 风速: 3.94 m/s</span><br><span class="line">天气晴朗，外出注意防晒哦！</span><br></pre></td></tr></table></figure></p><h4 id="Loan-Calculator"><a href="#Loan-Calculator" class="headerlink" title="Loan Calculator"></a>Loan Calculator</h4><p>这一部分我们做一个简单的<span style="color: #BB8ED0; font-weight: bold;">贷款计算器</span>，以实现精准的计算，这是 LLM 不具有的功能。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Type</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> BaseTool</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 定义输入模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoanInput</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    principal: <span class="built_in">float</span> = Field(description=<span class="string">&quot;贷款本金总额，单位为元。例如 1000000&quot;</span>)</span><br><span class="line">    annual_rate_percent: <span class="built_in">float</span> = Field(description=<span class="string">&quot;年利率百分比。例如 3.5 代表 3.5%&quot;</span>)</span><br><span class="line">    years: <span class="built_in">int</span> = Field(description=<span class="string">&quot;贷款期限（年）。例如 30&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 定义贷款计算工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoanCalculatorTool</span>(<span class="title class_ inherited__">BaseTool</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = <span class="string">&quot;calculate_loan_payment&quot;</span></span><br><span class="line">    description: <span class="built_in">str</span> = (</span><br><span class="line">        <span class="string">&quot;专业的贷款计算器（等额本息方式）。&quot;</span></span><br><span class="line">        <span class="string">&quot;当用户询问&#x27;房贷月供&#x27;、&#x27;车贷计算&#x27;、&#x27;分期付款利息&#x27;时使用此工具。&quot;</span></span><br><span class="line">        <span class="string">&quot;必须使用此工具进行计算，禁止模型自行估算。&quot;</span></span><br><span class="line">    )</span><br><span class="line">    args_schema: <span class="type">Type</span>[BaseModel] = LoanInput</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_run</span>(<span class="params">self, principal: <span class="built_in">float</span>, annual_rate_percent: <span class="built_in">float</span>, years: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 数据预处理</span></span><br><span class="line">            monthly_rate = annual_rate_percent / <span class="number">100</span> / <span class="number">12</span></span><br><span class="line">            total_months = years * <span class="number">12</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 核心计算逻辑</span></span><br><span class="line">            <span class="keyword">if</span> monthly_rate == <span class="number">0</span>:</span><br><span class="line">                monthly_payment = principal / total_months</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                numerator = principal * monthly_rate * math.<span class="built_in">pow</span>(<span class="number">1</span> + monthly_rate, total_months)</span><br><span class="line">                denominator = math.<span class="built_in">pow</span>(<span class="number">1</span> + monthly_rate, total_months) - <span class="number">1</span></span><br><span class="line">                monthly_payment = numerator / denominator</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 计算总额</span></span><br><span class="line">            total_payment = monthly_payment * total_months</span><br><span class="line">            total_interest = total_payment - principal</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="string">f&quot; 贷款本金: <span class="subst">&#123;principal:,<span class="number">.2</span>f&#125;</span> 元\n&quot;</span></span><br><span class="line">                <span class="string">f&quot; 年利率: <span class="subst">&#123;annual_rate_percent&#125;</span>%\n&quot;</span></span><br><span class="line">                <span class="string">f&quot; 贷款期限: <span class="subst">&#123;years&#125;</span> 年 (<span class="subst">&#123;total_months&#125;</span> 期)\n&quot;</span></span><br><span class="line">                <span class="string">f&quot; 每月月供: <span class="subst">&#123;monthly_payment:,<span class="number">.2</span>f&#125;</span> 元\n&quot;</span></span><br><span class="line">                <span class="string">f&quot; 总利息: <span class="subst">&#123;total_interest:,<span class="number">.2</span>f&#125;</span> 元\n&quot;</span></span><br><span class="line">                <span class="string">f&quot; 本息合计: <span class="subst">&#123;total_payment:,<span class="number">.2</span>f&#125;</span> 元&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;计算出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><p>只要在调用时示例化并加入 Tool 列表即可：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">calculator_tool = LoanCalculatorTool()</span><br><span class="line">tools = [weather_tool, calculator_tool]</span><br></pre></td></tr></table></figure></p><h4 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h4><p>我们对上述 Agent 进行一个简单的测试：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">================ Human Message ===============</span><br><span class="line"></span><br><span class="line">贷 100 万，30 年，利率 3.25%，每月月供多少？另外，北京今天天气如何？</span><br><span class="line">================ Ai Message ===============</span><br><span class="line">Tool Calls:</span><br><span class="line">  calculate_loan_payment (call_2f9e1a62ae0f42cab0eabd)</span><br><span class="line"> Call ID: call_2f9e1a62ae0f42cab0eabd</span><br><span class="line">  Args:</span><br><span class="line">    principal: 1000000</span><br><span class="line">    annual_rate_percent: 3.25</span><br><span class="line">    years: 30</span><br><span class="line">  get_real_weather (call_05f08c54e13747b4b6513d)</span><br><span class="line"> Call ID: call_05f08c54e13747b4b6513d</span><br><span class="line">  Args:</span><br><span class="line">    city: Beijing</span><br><span class="line">================ Tool Message ================</span><br><span class="line">Name: calculate_loan_payment</span><br><span class="line"></span><br><span class="line"> 贷款本金: 1,000,000.00 元</span><br><span class="line"> 年利率: 3.25%</span><br><span class="line"> 贷款期限: 30 年 (360 期)</span><br><span class="line"> 每月月供: 4,352.06 元</span><br><span class="line"> 总利息: 566,742.75 元</span><br><span class="line"> 本息合计: 1,566,742.75 元</span><br><span class="line">================ Tool Message ================</span><br><span class="line">Name: get_real_weather</span><br><span class="line"></span><br><span class="line">【Beijing 实时天气】</span><br><span class="line">- 状况: 晴</span><br><span class="line">- 温度: -4.06°C</span><br><span class="line">- 湿度: 17%</span><br><span class="line">- 风速: 7.74 m/s</span><br><span class="line">================= Ai Message ================</span><br><span class="line"></span><br><span class="line">您的贷款每月月供为 4,352.06 元。下面是详细信息：</span><br><span class="line">- 贷款本金: 1,000,000.00 元</span><br><span class="line">- 年利率: 3.25%</span><br><span class="line">- 贷款期限: 30 年 (360 期)</span><br><span class="line">- 总利息: 566,742.75 元</span><br><span class="line">- 本息合计: 1,566,742.75 元</span><br><span class="line"></span><br><span class="line">北京今天的实时天气情况如下：</span><br><span class="line">- 状况: 晴</span><br><span class="line">- 温度: -4.06°C</span><br><span class="line">- 湿度: 17%</span><br><span class="line">- 风速: 7.74 m/s</span><br><span class="line"></span><br><span class="line">请注意保暖，外出时可能需要携带外套。</span><br></pre></td></tr></table></figure></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;尝试使用LangChain的Agents功能。&lt;br&gt;</summary>
    
    
    
    <category term="编程学习-Python" scheme="https://atffang.github.io/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0-Python/"/>
    
    
  </entry>
  
  <entry>
    <title>LangChain学习日志: RAG</title>
    <link href="https://atffang.github.io/2026/01/09/langchainRAG/"/>
    <id>https://atffang.github.io/2026/01/09/langchainRAG/</id>
    <published>2026-01-09T02:12:47.000Z</published>
    <updated>2026-01-10T14:29:32.001Z</updated>
    
    <content type="html"><![CDATA[<p>尝试使用LangChain来实现RAG（检索增强生成）功能。</p><span id="more"></span><h3 id="rag简介"><a class="markdownIt-Anchor" href="#rag简介"></a> RAG简介</h3><p>本文将简单介绍<span style="color: #BB8ED0; font-weight: bold;">RAG（Retrieval-Augmented Generation，检索增强生成）</span>在LangChain中的实现</p><p>RAG是一种将<strong>检索技术</strong>与<strong>生成技术</strong>相结合的架构，当用户提出问题时，RAG 系统首先从外部知识库中检索出与问题相关的文档片段，然后将这些片段与用户的问题一起喂给大模型，以基于参考资料给出更准确、更实时的回答。</p><p>在大语言模型（LLM）的视角下，人类知识被分为两种形态：</p><ol><li><p><span style="color: #89986D; font-weight: bold;">参数化记忆（Parametric Memory）：指模型在预训练阶段通过海量文本学习到的、固化在神经元权重（Parameters）中的知识。</span></p></li><li><p><span style="color: #89986D; font-weight: bold;">非参数化记忆（Non-parametric Memory）：指模型之外的结构化或非结构化知识库（如维基百科、企业私有文档）。</span></p></li></ol><p><strong>RAG</strong>的本质，就是将这两种记忆结合，通过一个<strong>微分访问机制（Differentiable Access Mechanism）</strong>，让模型在生成回答前，先去“翻阅”外部的非参数化记忆。</p><h4 id="rag-的数学形式化定义"><a class="markdownIt-Anchor" href="#rag-的数学形式化定义"></a> RAG 的数学形式化定义</h4><p>在原始论文中（即来自的 NeurIPS2020 的著名论文<span style="color: #BB8ED0;">Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks</span>），RAG 被定义为一个<strong>隐变量模型（Latent Variable Model）</strong>。</p><p>假设用户输入为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>，系统检索到的文档片段为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>（作为隐变量），最终生成的答案为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>。RAG 的核心目标是计算在给定输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 的情况下，生成输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 的条件概率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(y|x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>。这一过程由<span style="color: #BB8ED0; font-weight: bold;">检索组件（Retriever）</span>和<span style="color: #BB8ED0; font-weight: bold;">生成组件（Generator）</span>组成。</p><h5 id="retriever"><a class="markdownIt-Anchor" href="#retriever"></a> Retriever</h5><p>检索器的任务是计算给定输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 时，文档 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> 的被选中的概率为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mi>η</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><mo>∝</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">(</mo><mi>z</mi><msup><mo stretchy="false">)</mo><mi mathvariant="normal">⊤</mi></msup><mi>q</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_\eta(z|x) \propto \exp(d(z)^\top q(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">η</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>：是由 BERT 构建的查询编码器（Query Encoder）生成的稠密向量。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>：是由 BERT 构建的文档编码器（Document Encoder）生成的文档向量。</li><li>此公式本质上是计算两个向量的<strong>点积相似度</strong>。</li></ul><h5 id="generator"><a class="markdownIt-Anchor" href="#generator"></a> Generator</h5><p>生成器的任务是根据输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 和检索到的上下文 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>，计算生成 token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的概率：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>z</mi><mo separator="true">,</mo><msub><mi>y</mi><mrow><mn>1</mn><mo>:</mo><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_\theta(y_i | x, z, y_{1:i-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>这通常由一个预训练的 Seq2Seq 模型（如论文中的 BART）来完成。</p><h4 id="两种-rag-建模范式"><a class="markdownIt-Anchor" href="#两种-rag-建模范式"></a> 两种 RAG 建模范式</h4><p>论文提出了两种处理隐变量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> 的方式，这直接决定了 RAG 系统的运行逻辑。</p><h5 id="rag-sequence序列化检索增强"><a class="markdownIt-Anchor" href="#rag-sequence序列化检索增强"></a> RAG-Sequence：序列化检索增强</h5><p>该模型假设一整个序列的生成只依赖于同一篇文档 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>。模型会先为每个检索到的文档计算完整的生成概率，最后进行加权求和。</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mtext>RAG-Sequence</mtext></msub><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><mo>≈</mo><munder><mo>∑</mo><mrow><mi>z</mi><mo>∈</mo><mtext>top-k</mtext><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">(</mo><mo>⋅</mo><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></munder><msub><mi>p</mi><mi>η</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><munderover><mo>∏</mo><mi>i</mi><mi>N</mi></munderover><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>z</mi><mo separator="true">,</mo><msub><mi>y</mi><mrow><mn>1</mn><mo>:</mo><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{\text{RAG-Sequence}}(y|x) \approx \sum_{z \in \text{top-k}(p(\cdot|x))} p_\eta(z|x) \prod_i^N p_\theta(y_i|x, z, y_{1:i-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RAG-Sequence</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.344341em;vertical-align:-1.516005em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.808995em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">top-k</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mopen mtight">(</span><span class="mord mtight">⋅</span><span class="mord mtight">∣</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">η</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><h5 id="rag-tokentoken-级检索增强"><a class="markdownIt-Anchor" href="#rag-tokentoken-级检索增强"></a> RAG-Token：Token 级检索增强</h5><p>该模型更加灵活，允许在生成每一个词（Token）时，都参考不同的文档。这意味着最终生成的句子可能是由多篇文档共同支撑的。</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mtext>RAG-Token</mtext></msub><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><mo>≈</mo><munderover><mo>∏</mo><mi>i</mi><mi>N</mi></munderover><munder><mo>∑</mo><mrow><mi>z</mi><mo>∈</mo><mtext>top-k</mtext><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">(</mo><mo>⋅</mo><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></munder><msub><mi>p</mi><mi>η</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>z</mi><mo separator="true">,</mo><msub><mi>y</mi><mrow><mn>1</mn><mo>:</mo><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{\text{RAG-Token}}(y|x) \approx \prod_i^N \sum_{z \in \text{top-k}(p(\cdot|x))} p_\eta(z|x) p_\theta(y_i|x, z, y_{1:i-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RAG-Token</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.344341em;vertical-align:-1.516005em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.808995em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">top-k</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mopen mtight">(</span><span class="mord mtight">⋅</span><span class="mord mtight">∣</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">η</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><h4 id="技术流程"><a class="markdownIt-Anchor" href="#技术流程"></a> 技术流程</h4><p>基于上述原理，一个标准的 RAG 工作流可以被拆解为以下五个步骤，这也是后续章节我们将使用 LangChain 实现的核心流程：</p><ol><li><span style="color: #BB8ED0; font-weight: bold;">索引（Indexing）</span>：将非参数化记忆（文档）切块并转化为向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>。</li><li><span style="color: #BB8ED0; font-weight: bold;">检索（Retrieval）</span>：根据用户查询 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>，在向量空间中寻找最相似的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>o</mi><mi>p</mi><mo>−</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">Top-K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 个文档 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>。</li><li><span style="color: #BB8ED0; font-weight: bold;">增强（Augmentation）</span>：将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> 拼接，构建出内容丰富的 Prompt。</li><li><span style="color: #BB8ED0; font-weight: bold;">生成（Generation）</span>：LLM 基于增强后的信息，计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(y|x, z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span> 并输出答案。</li><li><span style="color: #BB8ED0; font-weight: bold;">引用（Citation）</span>：由于我们可以追踪到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>，系统可以给出答案的出处，显著提升可信度。</li></ol><p>大概了解RAG之后，我们来构建一个最最简单的基于LangChain的RAG应用的例子⬇️</p><h3 id="infra"><a class="markdownIt-Anchor" href="#infra"></a> Infra</h3><p>在这个例子中，我们使用Python + Postgresql进行构建。</p><p>首先，需要一个安装了 <code>pgvector</code> 扩展的 PostgreSQL 实例。先安装<code>pgvector</code>，以我的mac为例。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pgvector</span><br></pre></td></tr></table></figure><p>然后对我们的目标数据库添加拓展：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> vector;</span><br></pre></td></tr></table></figure><p>我们需要安装 LangChain 的核心包、PostgreSQL 驱动以及阿里通义的 SDK。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install langchain langchain-community langchain-postgres </span><br><span class="line">pip install psycopg2-binary dashscope</span><br></pre></td></tr></table></figure><p>外加一些文档加载库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pypdf docx2txt</span><br></pre></td></tr></table></figure><h3 id="数据预处理入库"><a class="markdownIt-Anchor" href="#数据预处理入库"></a> 数据预处理入库</h3><p>这一步实现了 RAG 原理中的非参数化记忆（Non-parametric Memory）构建过程。我们需要将原始文档转化为检索器（Retriever）可以识别的向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>。</p><p>LangChain 提供了丰富的 <code>document_loaders</code>，以最常见的txt、pdf、word为例：</p><p><span style="color: #89986D; font-weight: bold;">txt</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> TextLoader</span><br><span class="line"></span><br><span class="line">loader = TextLoader(<span class="string">&quot;./data/example.txt&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">txt_docs = loader.load()</span><br></pre></td></tr></table></figure><p><span style="color: #89986D; font-weight: bold;">pdf</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> PyPDFLoader</span><br><span class="line"></span><br><span class="line">loader = PyPDFLoader(<span class="string">&quot;./data/example.pdf&quot;</span>)</span><br><span class="line">pdf_docs = loader.load()</span><br></pre></td></tr></table></figure><p><span style="color: #89986D; font-weight: bold;">word</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> Docx2txtLoader</span><br><span class="line"></span><br><span class="line">loader = Docx2txtLoader(<span class="string">&quot;./data/example.docx&quot;</span>)</span><br><span class="line">word_docs = loader.load()</span><br></pre></td></tr></table></figure><p>为了演示，我在网上找了本精美的家用菜谱大全pdf：</p><img src="/2026/01/09/langchainRAG/pdf.png" class="" title="sucessful"><p>看饿了。</p><p>对于中文 RAG，我们使用<span style="color: #BB8ED0; font-weight: bold;">BGE (BAAI General Embedding)</span>开源模型，先下载：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install sentence-transformers</span><br></pre></td></tr></table></figure><p>使用 langchain 加载pdf文档，切分，并存入数据库。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.document_loaders <span class="keyword">import</span> PyPDFLoader</span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> HuggingFaceEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_postgres.vectorstores <span class="keyword">import</span> PGVector</span><br><span class="line"></span><br><span class="line">FILE_PATH = <span class="string">&quot;/Users/fangtianyao/Downloads/家庭实用菜谱大全.pdf&quot;</span></span><br><span class="line">CONNECTION_STRING = <span class="string">&quot;postgresql+psycopg2://postgres:postgres@localhost:5432/rag&quot;</span></span><br><span class="line">COLLECTION_NAME = <span class="string">&quot;recipe_collection_bge&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 1. 加载本地 Embedding 模型 (BGE-small-zh)</span></span><br><span class="line">    embeddings = HuggingFaceEmbeddings(</span><br><span class="line">        model_name=<span class="string">&quot;BAAI/bge-small-zh-v1.5&quot;</span>,</span><br><span class="line">        model_kwargs=&#123;<span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;cpu&#x27;</span>&#125;,</span><br><span class="line">        encode_kwargs=&#123;<span class="string">&#x27;normalize_embeddings&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 加载 PDF</span></span><br><span class="line">    loader = PyPDFLoader(FILE_PATH)</span><br><span class="line">    documents = loader.load()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 切分文档</span></span><br><span class="line">    text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="number">600</span>, chunk_overlap=<span class="number">50</span>)</span><br><span class="line">    chunks = text_splitter.split_documents(documents)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 存入 PostgreSQL</span></span><br><span class="line">    vector_store = PGVector.from_documents(</span><br><span class="line">        embedding=embeddings,</span><br><span class="line">        documents=chunks,</span><br><span class="line">        collection_name=COLLECTION_NAME,</span><br><span class="line">        connection=CONNECTION_STRING,</span><br><span class="line">        use_jsonb=<span class="literal">True</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>LangChain会自动创建 <code>langchain_pg_embedding</code> 和 <code>langchain_pg_collection</code> 两个数据库，其中 <code>embedding</code> 字段会被定义为 <code>vector</code> 类型。</p><h3 id="简单的rag对话"><a class="markdownIt-Anchor" href="#简单的rag对话"></a> 简单的RAG对话</h3><p>我们参考文档<a href="https://docs.langchain.com/oss/python/integrations/chat/tongyi">https://docs.langchain.com/oss/python/integrations/chat/tongyi</a> ，基于阿里云的 <span style="color: #BB8ED0; font-weight: bold;">ChatTongyi</span> 构建RAG服务。可以看到，阿里云的模型可选择性很高。</p><img src="/2026/01/09/langchainRAG/aliyun.png" class="" title="sucessful"><p>申请一个阿里云百炼的 API-Key ，这里就不再赘述。我们先测试一下LangChain调用阿里云API的能力：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 API Key</span></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;********&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型</span></span><br><span class="line">llm = ChatTongyi(model_name=<span class="string">&quot;qwen-max&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简单的测试链路</span></span><br><span class="line">prompt = ChatPromptTemplate.from_template(<span class="string">&quot;讲个关于&#123;topic&#125;的笑话&quot;</span>)</span><br><span class="line">chain = prompt | llm | StrOutputParser()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(chain.invoke(&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;程序员&quot;</span>&#125;))</span><br></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">当然可以，这里有一个程序员可能会会心一笑的笑话：</span><br><span class="line"></span><br><span class="line">为什么程序员不喜欢在户外工作？</span><br><span class="line">因为那里有太多的 bugs（虫子/错误）！</span><br><span class="line"></span><br><span class="line">这里的“bugs”一词双关，既指自然界中的昆虫，也指编程中遇到的程序错误。希望这个小笑话能给你带来一丝轻松和快乐！</span><br></pre></td></tr></table></figure><p>好无聊的笑话……，不过至少证明我们测试成功了！那么现在，我们可以引入之前构建的向量数据库。导入包，连接数据库，并初始化和入库时一致的 Embedding 模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langchain_postgres.vectorstores <span class="keyword">import</span> PGVector</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> HuggingFaceEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;******&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line">CONNECTION_STRING = <span class="string">&quot;postgresql+psycopg2://postgres:postgres@localhost:5432/rag&quot;</span></span><br><span class="line">COLLECTION_NAME = <span class="string">&quot;recipe_collection_bge&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 Embedding 模型</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;正在加载本地 BGE 模型...&quot;</span>)</span><br><span class="line">embeddings = HuggingFaceEmbeddings(</span><br><span class="line">    model_name=<span class="string">&quot;BAAI/bge-small-zh-v1.5&quot;</span>,</span><br><span class="line">    model_kwargs=&#123;<span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;cpu&#x27;</span>&#125;,</span><br><span class="line">    encode_kwargs=&#123;<span class="string">&#x27;normalize_embeddings&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接现有的向量数据库</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;正在连接数据库集合: <span class="subst">&#123;COLLECTION_NAME&#125;</span>...&quot;</span>)</span><br><span class="line">vector_store = PGVector(</span><br><span class="line">    connection=CONNECTION_STRING,</span><br><span class="line">    embeddings=embeddings,</span><br><span class="line">    collection_name=COLLECTION_NAME,</span><br><span class="line">    use_jsonb=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建检索器 (Retriever)</span></span><br><span class="line">retriever = vector_store.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure><p>其中，我们通过 <code>retriever = vector_store.as_retriever(search_kwargs=&#123;&quot;k&quot;: 3&#125;)</code> 创建了检索器，而参数 <code>&quot;k&quot;: 3</code> 代表了表示每次检索最相似的 3 条记录。随后，定义 LLM 和 Prompt：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义 LLM 和 Prompt (LCEL 风格) </span></span><br><span class="line"><span class="comment"># 初始化通义千问 (Qwen-Max)</span></span><br><span class="line">llm = ChatTongyi(model_name=<span class="string">&quot;qwen-max&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写提示词模板</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;你是一个专业的智能大厨。请基于下面的【参考资料】回答用户的问题。</span></span><br><span class="line"><span class="string">如果参考资料里没有提到的内容，请诚实地说“资料中未提及”，不要编造。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">【参考资料】：</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">【用户问题】：</span></span><br><span class="line"><span class="string">&#123;question&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">prompt = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 辅助函数：将检索到的文档列表合并成一个字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_docs</span>(<span class="params">docs</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n\n&quot;</span>.join([doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> docs])</span><br></pre></td></tr></table></figure><p>构建 RAG 链：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rag_chain = (</span><br><span class="line">    &#123;<span class="string">&quot;context&quot;</span>: retriever | format_docs, <span class="string">&quot;question&quot;</span>: RunnablePassthrough()&#125;</span><br><span class="line">    | prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这是最重要的一步。上述代码使用的是 <strong>LCEL（LangChain Expression Language，表达式语言）</strong>，<code>|</code> 符号pipeline中每一道工序的间隔。我们把这个链拆解成三个阶段：</p><p><span style="color: #89986D; font-weight: bold;">STEP1 数据并行处理</span>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;context&quot;</span>: retriever | format_docs, <span class="string">&quot;question&quot;</span>: RunnablePassthrough()&#125;</span><br></pre></td></tr></table></figure><p>这一部分是一个字典。当你调用 <code>rag_chain.invoke(&quot;如何做红烧肉？&quot;)</code> 时，这个初始字符串会<strong>同时</strong>喂给两个分支：</p><ul><li><strong><code>question</code> 分支</strong>：<ul><li><code>RunnablePassthrough()</code> 不对输入做任何处理，直接把“如何做红烧肉？”原样传给 <code>question</code> 字段。</li></ul></li><li><strong><code>context</code> 分支</strong>（这是一个子链）：<ul><li><strong>第一步</strong>：<code>retriever</code> 接收到问题，去 PostgreSQL 向量库里寻找最相似的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 个文档片段（此时输出的是一个 <code>Document</code> 对象列表）。</li><li><strong>第二步</strong>：通过 <code>|</code> 传给 <code>format_docs</code> 函数。这个函数把多个文档对象里的文字提炼出来，拼接成一个大字符串。</li><li>最终 <code>context</code> 字段得到了库里的菜谱知识。</li></ul></li></ul><p><span style="color: #89986D; font-weight: bold;">STEP2 推理</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">... </span>| prompt | llm</span><br></pre></td></tr></table></figure><ul><li><strong>注入 Prompt (<code>| prompt</code>)</strong>：<ul><li>此时，前面的输出是一个字典：<code>&#123;&quot;context&quot;: &quot;...&quot;, &quot;question&quot;: &quot;如何做红烧肉？&quot;&#125;</code>。<code>ChatPromptTemplate</code> 会自动寻找对应的变量，把它们填入你定义的模板中，生成一段发给 AI 的完整指令。</li></ul></li><li><strong>调用大模型 (<code>| llm</code>)</strong>：<ul><li>将填充好的指令传给通义千问 <code>ChatTongyi</code>。</li></ul></li></ul><p><span style="color: #89986D; font-weight: bold;">STEP3 输出解析</span>：</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">... </span>| StrOutputParser()</span><br></pre></td></tr></table></figure><p><code>StrOutputParser()</code> 会从LLM返回的 <code>AIMessage</code> 对象中提取 <code>content</code> 属性。</p><p>最后，只要调用 <code>rag_chain.stream()</code>，就能获得流式输出的回答。给出完整的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> langchain_community.chat_models <span class="keyword">import</span> ChatTongyi</span><br><span class="line"><span class="keyword">from</span> langchain_postgres.vectorstores <span class="keyword">import</span> PGVector</span><br><span class="line"><span class="keyword">from</span> langchain_community.embeddings <span class="keyword">import</span> HuggingFaceEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;DASHSCOPE_API_KEY&quot;</span>] = <span class="string">&quot;sk-873463eacac84219b830314fb5f10992&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line">CONNECTION_STRING = <span class="string">&quot;postgresql+psycopg2://postgres:postgres@localhost:5432/rag&quot;</span></span><br><span class="line">COLLECTION_NAME = <span class="string">&quot;recipe_collection_bge&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 Embedding 模型</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;正在加载本地 BGE 模型...&quot;</span>)</span><br><span class="line">embeddings = HuggingFaceEmbeddings(</span><br><span class="line">    model_name=<span class="string">&quot;BAAI/bge-small-zh-v1.5&quot;</span>,</span><br><span class="line">    model_kwargs=&#123;<span class="string">&#x27;device&#x27;</span>: <span class="string">&#x27;cpu&#x27;</span>&#125;,</span><br><span class="line">    encode_kwargs=&#123;<span class="string">&#x27;normalize_embeddings&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接现有的向量数据库</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;正在连接数据库集合: <span class="subst">&#123;COLLECTION_NAME&#125;</span>...&quot;</span>)</span><br><span class="line">vector_store = PGVector(</span><br><span class="line">    connection=CONNECTION_STRING,</span><br><span class="line">    embeddings=embeddings,</span><br><span class="line">    collection_name=COLLECTION_NAME,</span><br><span class="line">    use_jsonb=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建检索器 (Retriever)</span></span><br><span class="line"><span class="comment"># k=3 表示每次检索最相似的 3 条菜谱</span></span><br><span class="line">retriever = vector_store.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">3</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 LLM 和 Prompt (LCEL 风格) </span></span><br><span class="line"><span class="comment"># 初始化通义千问 (Qwen-Max)</span></span><br><span class="line">llm = ChatTongyi(model_name=<span class="string">&quot;qwen-max&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写提示词模板</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;你是一个专业的智能大厨。请基于下面的【参考资料】回答用户的问题。</span></span><br><span class="line"><span class="string">如果参考资料里没有提到的内容，请诚实地说“资料中未提及”，不要编造。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">【参考资料】：</span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">【用户问题】：</span></span><br><span class="line"><span class="string">&#123;question&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">prompt = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 辅助函数：将检索到的文档列表合并成一个字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_docs</span>(<span class="params">docs</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n\n&quot;</span>.join([doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> docs])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 RAG 链 (The Chain) </span></span><br><span class="line">rag_chain = (</span><br><span class="line">    &#123;<span class="string">&quot;context&quot;</span>: retriever | format_docs, <span class="string">&quot;question&quot;</span>: RunnablePassthrough()&#125;</span><br><span class="line">    | prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行对话</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        question = <span class="built_in">input</span>(<span class="string">&quot;\n请问有什么可以帮您: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> question.lower() <span class="keyword">in</span> [<span class="string">&quot;quit&quot;</span>, <span class="string">&quot;exit&quot;</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n正在思考并检索数据库...&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 使用流式输出 (Stream) 提升体验</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n回答: &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> chunk <span class="keyword">in</span> rag_chain.stream(question):</span><br><span class="line">                <span class="built_in">print</span>(chunk, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>询问他菜谱中的菜“毛蛤拌菠菜”怎么做：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">请问有什么可以帮您: 我想制作毛蛤拌菠菜</span><br><span class="line"></span><br><span class="line">正在思考并检索数据库...</span><br><span class="line">回答: 您想制作的是“毛蛤拌菠菜”。根据提供的参考资料，下面是具体的步骤：</span><br><span class="line"></span><br><span class="line">### 材料</span><br><span class="line">- 毛蛤·250克</span><br><span class="line">- 菠菜·250克</span><br><span class="line">- 生姜·1小块</span><br><span class="line">- 大蒜·4瓣</span><br><span class="line"></span><br><span class="line">### 调料</span><br><span class="line">- 香油·2小匙</span><br><span class="line">- 香醋·1小匙</span><br><span class="line">- 精盐·1小匙</span><br><span class="line">- 味精· 小匙</span><br><span class="line"></span><br><span class="line">### 做法</span><br><span class="line">1. **准备材料**：首先将毛蛤煮熟后取出肉备用；同时将生姜和大蒜清洗干净后切成末。</span><br><span class="line">2. **处理菠菜**：将菠菜择洗干净，然后放入沸水中焯烫片刻。之后用凉水冲凉以去除多余的热量，并且沥干水分后切成段。</span><br><span class="line">3. **调拌**：将处理好的毛蛤、切好的菠菜以及之前准备的调料（包括盐、香醋、味精、香油、姜末和蒜末）混合在一起充分搅拌均匀。</span><br><span class="line">4. **完成**：最后将调拌好的食材装盘即可享用。</span><br><span class="line"></span><br><span class="line">按照以上步骤操作，您就能做出一道味道鲜美、清淡爽口的毛蛤拌菠菜了。希望这对您有所帮助！</span><br></pre></td></tr></table></figure><p>对比菜谱中的做法：</p><img src="/2026/01/09/langchainRAG/maoge.png" class="" title="sucessful"><p>非常成功✌️</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;尝试使用LangChain来实现RAG（检索增强生成）功能。&lt;/p&gt;</summary>
    
    
    
    <category term="编程学习-Python" scheme="https://atffang.github.io/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0-Python/"/>
    
    
  </entry>
  
  <entry>
    <title>论文精读 DyGLIP: A Dynamic Graph Model with Link Prediction forAccurate Multi-Camera Multiple Object Tracking</title>
    <link href="https://atffang.github.io/2025/12/29/DyGLIP/"/>
    <id>https://atffang.github.io/2025/12/29/DyGLIP/</id>
    <published>2025-12-29T06:53:15.000Z</published>
    <updated>2025-12-29T07:10:15.387Z</updated>
    
    <content type="html"><![CDATA[<p>论文精读 DyGLIP: A Dynamic Graph Model with Link Prediction forAccurate Multi-Camera Multiple Object Tracking</p><span id="more"></span><h1 id="dyglip-a-dynamic-graph-model-with-link-prediction-for-accurate-multi-camera-multiple-object-tracking"><a class="markdownIt-Anchor" href="#dyglip-a-dynamic-graph-model-with-link-prediction-for-accurate-multi-camera-multiple-object-tracking"></a> DyGLIP: A Dynamic Graph Model With Link Prediction for Accurate Multi-Camera Multiple Object Tracking</h1><p><strong>作者</strong>：Kha Gia Quach, Pha Nguyen, Huu Le<br />CVPR 2021</p><h2 id="任务定义与整体思路"><a class="markdownIt-Anchor" href="#任务定义与整体思路"></a> 任务定义与整体思路</h2><h3 id="问题背景与任务定义"><a class="markdownIt-Anchor" href="#问题背景与任务定义"></a> 问题背景与任务定义</h3><p>本研究聚焦于计算机视觉领域中的核心难题——<strong>多摄像头多目标跟踪 (Multi-Camera Multiple Object Tracking, MC-MOT)</strong> 。该任务的目标是在一个由多个摄像头组成的监控网络中，同时锁定并跟踪所有目标的全局运动轨迹 。在 MC-MOT 的流水线中，尽管单摄像头跟踪已经取得了长足进步，但<strong>数据关联</strong> (Data Association) 仍然是最具挑战性的环节，系统面临着极端的环境挑战：</p><ul><li><strong>外观一致性破坏</strong>： 当目标在不同摄像头之间移动时，光照条件的不一致（如从室内到室外）会导致同一目标的特征向量发生剧烈变化 。</li><li><strong>非重叠视域 (Non-overlapping FOVs)</strong>： 摄像头之间可能存在盲区，导致目标轨迹中断，且无法通过几何重叠直接匹配 。</li><li><strong>遮挡与运动模式差异</strong>： 目标的运动模式多变，且经常发生轨迹遮挡 。</li></ul><p>传统的依赖现成检测器或 ReID 模型提取静态特征向量的方法，在这些复杂场景下往往失效，导致身份（ID）分配错误 。因此，本任务的核心目标是：</p><ul><li><span style="color: #89986D; font-weight: bold;">设计一种鲁棒的数据关联机制，能够适应动态变化的特征表示，并优雅地解决跨摄像头（无论是否重叠）的目标身份匹配问题。</span></li></ul><h3 id="整体解决思路"><a class="markdownIt-Anchor" href="#整体解决思路"></a> 整体解决思路</h3><p>DyGLIP 摒弃了传统方法中常用的静态聚类（Clustering）或矩阵分解（Matrix Factorization）思路 ，提出了一种全新的视角：</p><ul><li><span style="color: #89986D; font-weight: bold;">将数据关联问题重构为动态图上的链路预测问题 (Link Prediction on a Dynamic Graph) 。</span><br />我们分三个主要创新点看待这个视角。</li></ul><p>首先是 <span style="color: #BB8ED0; font-weight: bold;">动态图演化</span> 。系统不再构建一个固定的全局图，而是维护一个随时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 演化的<strong>动态图</strong>：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi mathvariant="script">G</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mo stretchy="false">(</mo><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi mathvariant="script">E</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{G}^{(t)}=(\mathcal{V}^{(t)},\mathcal{E}^{(t)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.03522em;vertical-align:-0.09722em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.0593em;">G</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><ul><li><span style="color: #57595B; font-weight: bold;">图的顶点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathcal{V}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 代表了截至当前时刻所有已知的 Tracklets（短轨迹）。在每一个时间步 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>，单摄像头跟踪器（如 DeepSORT）产生的新 Tracklets 会作为新节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="script">N</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathcal{N}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 加入图中。</span></li><li><span style="color: #57595B; font-weight: bold;">任务转化为预测新加入的节点与图中已有节点之间是否存在边（Edge）。如果边存在，则意味着它们属于同一目标 。</span></li></ul><p>其次是 <span style="color: #BB8ED0; font-weight: bold;">动态图注意力机制</span> 。DyGLIP 认为直接使用原始检测特征进行关联是不可靠的 。该模型引入了一个<strong>动态图注意力机制 (Dynamic Graph with Self-Attention)</strong>，包含两个关键模块：</p><ul><li><span style="color: #57595B; font-weight: bold;">结构注意力 (Structural Attention)： 结合摄像头位置编码，捕捉同一时刻目标在空间拓扑上的关系 。</span></li><li><span style="color: #57595B; font-weight: bold;">时序注意力 (Temporal Attention)： 捕捉目标特征随时间推移的演变规律。</span></li></ul><p>最后是 <span style="color: #BB8ED0; font-weight: bold;">统一处理重叠与非重叠视域</span> 。不同于部分前人工作依赖摄像头的重叠区域进行几何匹配 ，DyGLIP 通过学习特征的时空演变，无需显式的视域重叠假设。这使得该模型能够通用于各种摄像头拓扑结构。</p><h2 id="技术路线"><a class="markdownIt-Anchor" href="#技术路线"></a> 技术路线</h2><p><strong>DyGLIP</strong> 的整体架构是一个端到端的流水线，核心在于将<strong>单摄像头跟踪</strong>产生的数据流，输入到一个<strong>动态图神经网络</strong>中，通过时空注意力机制重塑特征，最终输出全局 ID 分配结果。</p><h3 id="单摄像头局部跟踪"><a class="markdownIt-Anchor" href="#单摄像头局部跟踪"></a> 单摄像头局部跟踪</h3><p>依赖于现有的单摄像头多目标跟踪（Single-Camera MOT）算法，选择了 DeepSORT  作为基础跟踪器。</p><p>在时刻 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>，第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span> 个摄像头生成一组<strong>局部短轨迹（Tracklets）</strong>，记为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="script">L</mi><mi>c</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mo stretchy="false">{</mo><msubsup><mi>I</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{L}_{c}^{(t)}=\{I_{j}^{(t)}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.161392em;vertical-align:-0.11659199999999997em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834080000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.11659199999999997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.4577719999999998em;vertical-align:-0.4129719999999999em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4129719999999999em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span> 。</p><p>每一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>I</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">I_{j}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4577719999999998em;vertical-align:-0.4129719999999999em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4129719999999999em;"><span></span></span></span></span></span></span></span></span></span> 包含一个<strong>特征向量（Feature Vector）</strong>，由检测器或 Re-ID 模型提取。</p><h3 id="动态图构建"><a class="markdownIt-Anchor" href="#动态图构建"></a> 动态图构建</h3><p>系统维护一个随时间不断生长的 <span style="color: #BB8ED0; font-weight: bold;">动态图结构</span> 。<br />图的定义是，在时刻 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>，构建图：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi mathvariant="script">G</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mo stretchy="false">(</mo><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi mathvariant="script">E</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{G}^{(t)}=(\mathcal{V}^{(t)},\mathcal{E}^{(t)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.03522em;vertical-align:-0.09722em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.0593em;">G</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><ul><li>顶点集 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">V</mi></mrow><annotation encoding="application/x-tex">\mathcal{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span></span></span></span>)：代表所有已知的 <strong>Tracklets</strong></li><li>边集 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">E</mi></mrow><annotation encoding="application/x-tex">\mathcal{E}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span></span></span></span></span>)：代表 Tracklets 之间的关联关系（即是否为同一人）</li></ul><p>与构建固定图不同，DyGLIP 采用<strong>增量式更新</strong>：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi mathvariant="script">t</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>∪</mo><msup><mi mathvariant="script">N</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathcal{V^{(t)}}=\mathcal{V}^{(t-1)}\cup\mathcal{N}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.938em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.938em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathcal{V}^{(t-1)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 是上一时刻已存在的节点</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="script">N</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathcal{N}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 是当前时刻各摄像头新检测到的 Tracklets 集合</li></ul><p>此外，在初始化时，每个节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> 初始关联一个特征向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>，这一特征向量通常为 Re-ID 特征。</p><h3 id="时空注意力特征增强"><a class="markdownIt-Anchor" href="#时空注意力特征增强"></a> 时空注意力特征增强</h3><p>为了解决跨摄像头特征不一致的问题，DyGLIP 设计了一个 <span style="color: #BB8ED0; font-weight: bold;">双层注意力机制</span> ：<strong>结构注意力 (Structural Attention)</strong> 和 <strong>时序注意力 (Temporal Attention)</strong></p><p><strong>结构注意力</strong>的核心思想是，节点不应该是孤立的。在某一时刻，一个目标的特征应该与其所处的环境（摄像头位置）以及周围的其他目标特征进行关联。<span style="color: #57595B; font-weight: bold;">因此，模型引入了摄像头位置编码，学习每个摄像头特有的成像风格（如偏色或畸变），并利用周围邻居节点的分布情况，消除单摄环境带来的系统性偏差，获得更具代表性的局部拓扑特征。</span></p><p><strong>时序注意力</strong>的核心思想是，一个人的身份是连续演变的。如果模型知道目标在前一秒的长相，就能更好地预测他在后一秒的长相。<span style="color: #57595B; font-weight: bold;">因此，模型通过一个时间滑动窗口观察目标在过去几个时刻的特征变化趋势，捕捉目标特征随时间推移的动态演化规律。</span></p><h4 id="结构注意力层-structural-attention-layer-sal"><a class="markdownIt-Anchor" href="#结构注意力层-structural-attention-layer-sal"></a> 结构注意力层 (Structural Attention Layer, SAL)</h4><p>在进入注意力层之前，每个节点不仅携带外观特征，还融合了空间信息，因此，<br />对于时刻 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 的图 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="script">G</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathcal{G}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9852199999999999em;vertical-align:-0.09722em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.0593em;">G</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 中的每一个节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>，输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">e_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是外观特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span> 与 <strong>摄像头位置编码 (Camera Positional Encoding)</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">c_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的拼接：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>e</mi><mi>v</mi></msub><mo>=</mo><mo stretchy="false">{</mo><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><msub><mi>c</mi><mi>v</mi></msub><mo stretchy="false">}</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>D</mi><mi>E</mi></msub></msup></mrow><annotation encoding="application/x-tex">e_{v}=\{f(v)||c_{v}\}\in\mathbb{R}^{D_{E}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>D</mi><mi>F</mi></msub></msup></mrow><annotation encoding="application/x-tex">f(v) \in \mathbb{R}^{D_F}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>：原始 ReID 特征向量</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>v</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>D</mi><mi>C</mi></msub></msup></mrow><annotation encoding="application/x-tex">c_v \in \mathbb{R}^{D_C}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>：摄像头的空间位置编码（Camera Positional Encoding）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">||</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord">∣</span></span></span></span>：表示拼接操作（Concatenation）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi>E</mi></msub><mo>=</mo><msub><mi>D</mi><mi>F</mi></msub><mo>+</mo><msub><mi>D</mi><mi>C</mi></msub></mrow><annotation encoding="application/x-tex">D_E = D_F + D_C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：拼接后的总维度</li></ul><p>为了计算节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">v_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 对节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的重要性（即权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>），DyGLIP 采用了一种<strong>基于邻域的注意力机制</strong>。对于第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 个注意力头（Head），其系数计算公式为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>l</mi></msubsup><mo>=</mo><mfrac><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">(</mo><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>T</mi></msubsup><mo stretchy="false">[</mo><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow></munder><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">(</mo><msubsup><mi>W</mi><mrow><mi>k</mi><mi>j</mi></mrow><mi>T</mi></msubsup><mo stretchy="false">[</mo><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>k</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha_{ij}^{l}=\frac{exp(\sigma(W_{ij}^{T}[conv_{1\times1}^{l}(e_{v_{i}}^{t})||conv_{1\times1}^{l}(e_{v_{j}}^{t})]))}{\sum_{v_{k}\in\mathcal{V}^{(t)}}exp(\sigma(W_{kj}^{T}[conv_{1\times1}^{l}(e_{v_{i}}^{t})||conv_{1\times1}^{l}(e_{v_{k}}^{t})]))}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.282216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.899108em;"><span style="top:-2.4530000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.8417519999999996em;vertical-align:-1.158324em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6834279999999997em;"><span style="top:-2.279092em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.27571499999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.40557em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.823131em;"><span style="top:-2.3986920000000005em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4374159999999999em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.830908em;"><span style="top:-2.433692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3246389999999999em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7195559999999999em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.830908em;"><span style="top:-2.433692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3246389999999999em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7195559999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35285999999999995em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.8343199999999995em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-2.451892em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30643899999999996em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-2.451892em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30643899999999996em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.158324em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup></mrow><annotation encoding="application/x-tex">conv_{1\times1}^{l}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1555469999999999em;vertical-align:-0.30643899999999996em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-2.451892em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30643899999999996em;"><span></span></span></span></span></span></span></span></span></span>：一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1 \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 的卷积层（相当于全连接层），用于将高维输入特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">e_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 映射到当前注意力头 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 的子空间</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">||</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord">∣</span></span></span></span>，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">Concatenation</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span>：将变换后的源节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和邻居节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">v_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 的特征拼接，形成边缘特征</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>T</mi></msubsup></mrow><annotation encoding="application/x-tex">W_{ij}^{T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.236103em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span>：这是一个可学习的权重向量，将拼接后的特征映射为一个标量（Scalar），即未归一化的注意力分数</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span>：非线性激活函数，论文中选用 LeakyReLU</li><li><strong>Softmax 归一化</strong>：分母部分对节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的所有邻居节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">v_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 进行求和，确保权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 之和为 1</li><li><strong>稀疏性</strong>：为了降低计算量，求和仅针对邻接矩阵中定义的邻域 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(v_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 进行，而非全图</li></ul><p>理解上述的公式，我们需要先理解<strong>注意力头</strong>是什么，其是<strong>多头注意力机制</strong>的基本单元。多个注意力头就如同多个对一个目标观察的观测者，每个人关注目标的某一方面，最后将这四个观测者的观察结果拼接在一起，就能得到一个对这个目标非常全面、立体的描述。换成专业的叙述就是：</p><ul><li><span style="color: #BB8ED0; font-weight: bold;">多头注意力机制（Multi-Head Attention）</span>允许模型在不同的特征子空间（Subspaces）里并行地学习信息，防止只关注某一方面而忽略了其他重要细节</li></ul><p>在数学实现上，每一个头 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 都拥有自己独有的一套<strong>投影矩阵</strong>（权重参数）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>l</mi></msup></mrow><annotation encoding="application/x-tex">W^l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span></span></span>，第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 个头会独立计算出一组注意力系数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>l</mi></msubsup></mrow><annotation encoding="application/x-tex">\alpha_{ij}^l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2438799999999999em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.441336em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span> 和特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>h</mi><mi>l</mi></msup></mrow><annotation encoding="application/x-tex">h^l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span></span></span>，最后通过拼接操作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">Concat</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span></span></span></span> 把所有头的结果合成为最终向量。</p><p>那每个头计算出来的注意力系数又应该如何理解呢？</p><ul><li><span style="color: #BB8ED0; font-weight: bold;">注意力系数 (Attention Coefficients)</span> ，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，可以被理解为模型在处理信息时的判别权重。</li></ul><p>想象一下，对于动态图中的节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，它周围连接着很多其他节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">v_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>就意味着 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">v_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 的<strong>关注度</strong>，从论文的公式来看，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 是通过 Softmax 函数计算出来的，因此对于节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的所有邻居，注意力系数之和必须等于 1（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><mi>α</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum \alpha = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00001em;vertical-align:-0.25001em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>）。在聚合特征时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 实际上是在执行加权求和。</p><p>理解完这些，我们回到上面的注意力头系数计算公式：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>l</mi></msubsup><mo>=</mo><mfrac><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">(</mo><msubsup><mi>W</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>T</mi></msubsup><mo stretchy="false">[</mo><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>k</mi></msub><mo>∈</mo><msup><mi mathvariant="script">V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow></munder><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">(</mo><msubsup><mi>W</mi><mrow><mi>k</mi><mi>j</mi></mrow><mi>T</mi></msubsup><mo stretchy="false">[</mo><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>k</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha_{ij}^{l}=\frac{exp(\sigma(W_{ij}^{T}[conv_{1\times1}^{l}(e_{v_{i}}^{t})||conv_{1\times1}^{l}(e_{v_{j}}^{t})]))}{\sum_{v_{k}\in\mathcal{V}^{(t)}}exp(\sigma(W_{kj}^{T}[conv_{1\times1}^{l}(e_{v_{i}}^{t})||conv_{1\times1}^{l}(e_{v_{k}}^{t})]))}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.282216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.899108em;"><span style="top:-2.4530000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.8417519999999996em;vertical-align:-1.158324em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6834279999999997em;"><span style="top:-2.279092em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.27571499999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.08222em;">V</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.40557em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.823131em;"><span style="top:-2.3986920000000005em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4374159999999999em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.830908em;"><span style="top:-2.433692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3246389999999999em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7195559999999999em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.830908em;"><span style="top:-2.433692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0448000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3246389999999999em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7195559999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35285999999999995em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.8343199999999995em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-2.451892em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30643899999999996em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-2.451892em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30643899999999996em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.158324em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>其意图就是，计算：</p><ul><li><span style="color: #89986D; font-weight: bold;">激活函数处理后的，该注意力头权重矩阵✖️两个轨迹节点特征卷积结果的拼接，的softmax 归一化结果</span>。<br />获得注意力系数后，通过加权求和更新节点特征。输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>h</mi><msub><mi>v</mi><mi>i</mi></msub><mi>t</mi></msubsup></mrow><annotation encoding="application/x-tex">h_{v_i}^t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.140656em;vertical-align:-0.34709999999999996em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span></span></span></span> 的计算公式为：</li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>h</mi><msub><mi>v</mi><mi>i</mi></msub><mi>t</mi></msubsup><mo>=</mo><mi>C</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><msubsup><mi>t</mi><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mi>L</mi></msubsup><mo stretchy="false">[</mo><mi>σ</mi><mo stretchy="false">(</mo><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>j</mi></msub><mo>∈</mo><msup><mi>V</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow></munder><msubsup><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>l</mi></msubsup><mi>c</mi><mi>o</mi><mi>n</mi><msubsup><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><mi>l</mi></msubsup><mo stretchy="false">(</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mi>t</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">h_{v_{i}}^{t}=Concat_{l=1}^{L}[\sigma(\sum_{v_{j}\in V^{(t)}}\alpha_{ij}^{l}conv_{1\times1}^{l}(e_{v_{j}}^{t}))]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190656em;vertical-align:-0.34709999999999996em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.638755em;vertical-align:-1.58875em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.7585699999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.58875em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.899108em;"><span style="top:-2.4530000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.899108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305331em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></span></p><ul><li><strong>加权求和</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><msubsup><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>l</mi></msubsup><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\sum \alpha_{ij}^{l} ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2438799999999999em;vertical-align:-0.394772em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.441336em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span></span> 表示节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 聚合了周围邻居 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">v_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 的信息，权重由 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\alpha_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 决定。这意味着，与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 相似度高或空间关系紧密的节点，对其新特征的贡献更大。</li><li><strong>多头机制</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>o</mi><mi>n</mi><mi>c</mi><mi>a</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">Concat</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span></span></span></span>)：论文使用了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span></span></span></span> 个独立的注意力头（实验中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">L=4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>）。这允许模型关注不同的子空间信息（例如，一个头关注颜色纹理，另一个头关注摄像头位置关系）。最后将所有头的结果拼接作为 SAL 层的最终输出。</li></ul><h4 id="图时序注意力层-graph-temporal-attention-layer-tal"><a class="markdownIt-Anchor" href="#图时序注意力层-graph-temporal-attention-layer-tal"></a> 图时序注意力层 (Graph Temporal Attention Layer, TAL)</h4><p><span style="color: #89986D; font-weight: bold;">SAL 层处理了单帧内的空间关系，TAL 层则负责捕捉时间维度上的演化。</span> 它基于 Transformer 的 Self-Attention 架构，但针对动态图进行了因果性改进。</p><p>TAL 的输入不仅仅是特征，还需要知道时间点。<br />对于每个节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>，取其在时间窗口 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> 内的一系列 SAL 输出特征，并加上时间戳位置编码 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">p_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>)：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>x</mi><mi>v</mi></msub><mo>=</mo><mo stretchy="false">[</mo><msubsup><mi>h</mi><mi>v</mi><mn>1</mn></msubsup><mo>+</mo><msubsup><mi>p</mi><mi>v</mi><mn>1</mn></msubsup><mo separator="true">,</mo><mtext> </mtext><msubsup><mi>h</mi><mi>v</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>p</mi><mi>v</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mtext> </mtext><mo>⋅</mo><mo>⋅</mo><mo>⋅</mo><mo separator="true">,</mo><mtext> </mtext><msubsup><mi>h</mi><mi>v</mi><mi>W</mi></msubsup><mo>+</mo><msubsup><mi>p</mi><mi>v</mi><mi>W</mi></msubsup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x_{v}=[h_{v}^{1}+p_{v}^{1}, \ h_{v}^{2}+p_{v}^{2}, \ \cdot\cdot\cdot, \ h_{v}^{W}+p_{v}^{W}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.138331em;vertical-align:-0.247em;"></span><span class="mord">⋅</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p><p>将这些向量堆叠成一个矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>W</mi><mo>×</mo><msub><mi>D</mi><mi>H</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">X \in \mathbb{R}^{W \times D_H}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>。</p><p>遵循标准 Transformer 范式，通过线性变换生成 Query, Key, Value 矩阵 ：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mi>K</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mi>V</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">Q = XW_Q, \quad K = XW_K, \quad V = XW_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>K</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_Q, W_K, W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是可学习的投影矩阵。</p><p>随后，采用<strong>掩码缩放点积注意力 (Masked Scaled Dot-Product Attention)</strong> ，计算时间步之间的依赖关系：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>z</mi><mi>e</mi><mrow><mo stretchy="false">(</mo><mi>l</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mi>a</mi><mi>t</mi><mi>t</mi><msup><mi>n</mi><mrow><mo stretchy="false">(</mo><mi>l</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>D</mi><mi>Z</mi></msub></msqrt></mfrac><mo>+</mo><mi>M</mi><mo stretchy="false">)</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">z_{e}^{(l)}=attn^{(l)}(Q,K,V)=softmax(\frac{QK^{T}}{\sqrt{D_{Z}}}+M)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.185em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.448331em;vertical-align:-0.93em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.2583349999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.851665em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.811665em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18833500000000003em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035771em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>：计算不同时间步之间的相似度矩阵</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>D</mi><mi>Z</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{D_Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.18833500000000003em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.851665em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.811665em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18833500000000003em;"><span></span></span></span></span></span></span></span></span>：缩放因子，用于防止点积结果过大导致梯度消失</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span> (Mask Matrix)：这是一个掩码矩阵，用于强制因果性。若 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&gt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i &gt; j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>（即时间步 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> 晚于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>），则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">M_{ij} = -\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">∞</span></span></span></span>；否则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">M_{ij} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>。在 Softmax 后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></msup><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">e^{-\infty} \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>。这保证了当前时刻 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 的特征只能聚合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 时刻之前的历史信息。</li></ul><p>这样看可能不够直观，结合 Transformer 的理念，上述公式，即：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>z</mi><mi>e</mi><mrow><mo stretchy="false">(</mo><mi>l</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>D</mi><mi>Z</mi></msub></msqrt></mfrac><mo>+</mo><mi>M</mi><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">z_{e}^{(l)} = \text{softmax}\left(\frac{QK^{T}}{\sqrt{D_{Z}}} + M\right)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.185em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-2.4530000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.468361em;vertical-align:-0.95003em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.2583349999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.851665em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.811665em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18833500000000003em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p><p>由以下四个核心组件构成：</p><ol><li><strong>Q, K, V (查询、键、值矩阵)</strong>： 这些是通过对输入特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>（节点在不同时间步的特征序列）进行线性投影得到的。<ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span></span></span></span> (Query)： 代表当前时刻的节点正在寻找什么样的历史信息。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> (Key)： 代表过去各时刻节点所能“提供”的特征标签。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> (Value)： 代表节点实际包含的特征信息内容。</li></ul></li><li><strong>点积操作</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035771em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>)： 通过计算查询向量与键向量的点积，衡量当前时刻与过去每一个时刻之间的相关性或相似度。</li><li><strong>缩放因子</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><msqrt><msub><mi>D</mi><mi>Z</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">1/\sqrt{D_Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1016650000000001em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.851665em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.811665em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18833500000000003em;"><span></span></span></span></span></span></span></span></span>)： <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi>Z</mi></msub></mrow><annotation encoding="application/x-tex">D_Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是输出特征的维度。在计算点积后，将其除以维度的平方根。</li><li><strong>掩码矩阵</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span>)： 这是一个与时间窗口大小相同的矩阵，其元素取值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 或 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">∞</span></span></span></span>。</li></ol><p><strong>缩放的作用是</strong>随着特征维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi>Z</mi></msub></mrow><annotation encoding="application/x-tex">D_Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的增大，点积结果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035771em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 的量级会变得非常大。这会导致在经过 Softmax 函数处理时，梯度变得极小，通过除以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>D</mi><mi>Z</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{D_Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.18833500000000003em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.851665em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">Z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.811665em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18833500000000003em;"><span></span></span></span></span></span></span></span></span>，将计算结果重新缩放到一个更合理的范围，能够确保 Softmax 函数能够产生灵敏的梯度。</p><p>而<strong>掩码的作用是</strong>确保了每个节点在更新特征时，只能通过回顾历史来学习演化规律，而不会产生由于看到了未来的轨迹，而反向修正当前ID的非因果行为。</p><p>多头 TAL 的输出被拼接后，通过一个<strong>前馈神经网络</strong>进行非线性变换，得到最终的节点嵌入序列：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">{</mo><msup><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mo>⋅</mo><mo>⋅</mo><mo>⋅</mo><mo separator="true">,</mo><msup><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mrow><mo stretchy="false">(</mo><mi>W</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{ {e^{\prime}}^{(1)},{e^{\prime}}^{(2)},\cdot\cdot\cdot,{e^{\prime}}^{(W)}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.329792em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.079792em;"><span style="top:-3.254792em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.079792em;"><span style="top:-3.254792em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.329792em;vertical-align:-0.25em;"></span><span class="mord">⋅</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.079792em;"><span style="top:-3.254792em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></span></p><p>这个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">e&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 即为最终用于链路预测的特征。</p><h3 id="身份关联与模型损失函数定义"><a class="markdownIt-Anchor" href="#身份关联与模型损失函数定义"></a> 身份关联与模型损失函数定义</h3><p>在 DyGLIP 中，关联被定义为判断图中两个节点之间是否存在<strong>Link</strong>。</p><h4 id="关联概率计算-probability-scoring"><a class="markdownIt-Anchor" href="#关联概率计算-probability-scoring"></a> 关联概率计算 (Probability Scoring)</h4><p>给定一对经过增强的节点特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">e&#x27;_{v_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.098992em;vertical-align:-0.34709999999999996em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">e&#x27;_{v_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.196212em;vertical-align:-0.44432em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span></span></span></span>，模型需要计算它们属于同一目标的概率分数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s \in [0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，分数越高，表示这两个节点（Tracklets）属于同一个人的可能性越大 。</p><h4 id="度量标准与分类器选择-metrics-and-classifiers"><a class="markdownIt-Anchor" href="#度量标准与分类器选择-metrics-and-classifiers"></a> 度量标准与分类器选择 (Metrics and Classifiers)</h4><p>论文在探讨了两种不同的相似度度量与分类组合（余弦距离 + Sigmoi / 哈达玛积 + Softmax）之后，选择了后者。</p><p>即计算两个特征向量的<strong>哈达玛积</strong>（Hadamard product，即对应元素相乘 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>⊙</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">e_{v_{i}}^{\prime} \odot e_{v_{j}}^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.098992em;vertical-align:-0.34709999999999996em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.196212em;vertical-align:-0.44432em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span></span></span></span>），随后连接一个<strong>全连接层</strong>，最后通过 Softmax 层输出分类概率。</p><p>消融实验证明方案 B 效果显著优于方案 A 。这是因为哈达玛积保留了元素级别的交互特征，而 Softmax 配合全连接层能学习到更复杂的非线性匹配逻辑。</p><h4 id="联合损失函数-integrated-loss"><a class="markdownIt-Anchor" href="#联合损失函数-integrated-loss"></a> 联合损失函数 (Integrated Loss)</h4><p>为了让注意力模块和链路分类器协同工作，DyGLIP 采用了一种联合学习的方法。其目标是同时学习能够捕获时空信息的表示，并实现准确的链路预测。</p><p>模型的总体目标函数旨在平衡<strong>特征聚类</strong>和<strong>分类准确度</strong>，可以概括为<strong>特征表示学习</strong>和<strong>链路分类学习</strong>的耦合：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mtext>BCE Loss (Representation)</mtext><mo>+</mo><msub><mi>w</mi><mi>g</mi></msub><mo>⋅</mo><mtext>Classifier Loss</mtext></mrow><annotation encoding="application/x-tex">\mathcal{L}(v_{i}) = \text{BCE Loss (Representation)} + w_g \cdot \text{Classifier Loss}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">BCE Loss (Representation)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.730558em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">Classifier Loss</span></span></span></span></span></span></p><p>展开为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mi>t</mi><mi>T</mi></munderover><mrow><mo fence="true">(</mo><munder><munder><mrow><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>j</mi></msub><mo>∈</mo><msubsup><mi mathvariant="script">N</mi><mi>b</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></munder><mo>−</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">(</mo><mo stretchy="false">⟨</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">⟩</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>正样本特征拉近</mtext></munder><mo>+</mo><munder><munder><mrow><msub><mi>w</mi><mi>g</mi></msub><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>k</mi></msub><mo>∈</mo><msubsup><mi mathvariant="script">N</mi><mi>g</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></munder><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>σ</mi><mo stretchy="false">(</mo><mo stretchy="false">⟨</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>k</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">⟩</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>负样本特征推开</mtext></munder><mo>+</mo><munder><munder><mrow><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>j</mi></msub><mo>∈</mo><msubsup><mi mathvariant="script">N</mi><mi>a</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></munder><msub><mi mathvariant="script">L</mi><mi>c</mi></msub><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>链路预测分类损失</mtext></munder><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(v_{i})=\sum_{t}^{T} \left( \underbrace{\sum_{v_{j}\in \mathcal{N}_{b}^{(t)}(v_{i})}-log(\sigma(\langle e_{v_{i}}^{\prime}, e_{v_{j}}^{\prime} \rangle))}_{\text{正样本特征拉近}} + \underbrace{w_g \sum_{v_{k}\in\mathcal{N}_{g}^{(t)}(v_{i})}log(1-\sigma(\langle e_{v_{i}}^{\prime}, e_{v_{k}}^{\prime} \rangle))}_{\text{负样本特征推开}} + \underbrace{\sum_{v_{j}\in \mathcal{N}_{a}^{(t)}(v_{i})}\mathcal{L}_{c}(v_{i}, v_{j})}_{\text{链路预测分类损失}} \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:6.676801em;vertical-align:-3.1267560000000003em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.300005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.250005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.550045em;"><span style="top:-0.7499750000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-1.8999850000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-2.4949950000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-3.090005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-3.6850150000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-4.280025em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-4.3100249999999996em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-5.550045em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.050045em;"><span></span></span></span></span></span></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:0.07675100000000024em;"><span class="pstrut" style="height:3.050005em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">正样本特征拉近</span></span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span class="svg-align" style="top:-0.6015799999999998em;"><span class="pstrut" style="height:3.050005em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.592635em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0590857142857142em;"><span style="top:-2.188485714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span style="top:-3.059085714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34722857142857144em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.800425em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4484250000000003em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.1267560000000003em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:0.04203100000000015em;"><span class="pstrut" style="height:3.050005em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">负样本特征推开</span></span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span class="svg-align" style="top:-0.6362999999999999em;"><span class="pstrut" style="height:3.050005em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.5926349999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0590857142857142em;"><span style="top:-2.3769714285714283em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span style="top:-3.059085714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29762857142857146em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.765705em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35285999999999995em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.413705em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.0920360000000002em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:0.0310109999999999em;"><span class="pstrut" style="height:3.050005em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">链路预测分类损失</span></span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span class="svg-align" style="top:-0.6473200000000001em;"><span class="pstrut" style="height:3.050005em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3.0500050000000005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.5926349999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0590857142857142em;"><span style="top:-2.3769714285714283em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.059085714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15874285714285716em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.754685em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.402685em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.081016em;"><span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.550045em;"><span style="top:-0.7499750000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-1.8999850000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-2.4949950000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-3.090005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-3.6850150000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-4.280025em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-4.3100249999999996em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-5.550045em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.050045em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>我们可以将这个复杂的公式拆分为三个核心功能模块：</p><ol><li><span style="color: #BB8ED0; font-weight: bold;">正样本表示学习 (Positive Samples)</span>：</li></ol><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>j</mi></msub><mo>∈</mo><msubsup><mi mathvariant="script">N</mi><mi>b</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></munder><mo>−</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>σ</mi><mo stretchy="false">(</mo><mo stretchy="false">⟨</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>j</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">⟩</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{v_{j}\in \mathcal{N}_{b}^{(t)}(v_{i})}-log(\sigma(\langle e_{v_{i}}^{\prime}, e_{v_{j}}^{\prime} \rangle))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.8504300000000002em;vertical-align:-1.800425em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.592635em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0590857142857142em;"><span style="top:-2.188485714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span style="top:-3.059085714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34722857142857144em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.800425em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.44432em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p>这里 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="script">N</mi><mi>b</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathcal{N}_{b}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3461079999999999em;vertical-align:-0.30130799999999996em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.398692em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span style="top:-3.2197999999999998em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span></span></span></span> 是通过固定长度随机游走确定的邻居节点集合。 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mo>⋅</mo><mo separator="true">,</mo><mo>⋅</mo><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle \cdot, \cdot \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⟨</span><span class="mord">⋅</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">⋅</span><span class="mclose">⟩</span></span></span></span> 是两个特征向量的内积。通过最小化这个负对数似然，模型在强制让同一ID的节点特征在嵌入空间中靠得更近。</p><ol start="2"><li><span style="color: #BB8ED0; font-weight: bold;">负样本表示学习 (Negative Samples)</span>：</li></ol><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mi>g</mi></msub><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>k</mi></msub><mo>∈</mo><msubsup><mi mathvariant="script">N</mi><mi>g</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></munder><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>σ</mi><mo stretchy="false">(</mo><mo stretchy="false">⟨</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>i</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo separator="true">,</mo><msubsup><mi>e</mi><msub><mi>v</mi><mi>k</mi></msub><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">⟩</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">w_g \sum_{v_{k}\in\mathcal{N}_{g}^{(t)}(v_{i})}log(1-\sigma(\langle e_{v_{i}}^{\prime}, e_{v_{k}}^{\prime} \rangle))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.81571em;vertical-align:-1.765705em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.5926349999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0590857142857142em;"><span style="top:-2.3769714285714283em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span style="top:-3.059085714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29762857142857146em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.765705em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.154752em;vertical-align:-0.35285999999999995em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34709999999999996em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35285999999999995em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="script">N</mi><mi>g</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathcal{N}_{g}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2974999999999999em;vertical-align:-0.2526999999999999em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834080000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2526999999999999em;"><span></span></span></span></span></span></span></span></span></span> 是随机抽取的负样本节点。超参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">w_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>是<strong>负采样比例</strong> (Negative Sampling Ratio)，用于平衡正负样本的权重。这一项负责将不同 ID 的节点在特征空间中推开。</p><ol start="3"><li><span style="color: #BB8ED0; font-weight: bold;">分类器损失 (Classifier Loss)</span>：</li></ol><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><mo>∑</mo><mrow><msub><mi>v</mi><mi>j</mi></msub><mo>∈</mo><msubsup><mi mathvariant="script">N</mi><mi>a</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></munder><msub><mi mathvariant="script">L</mi><mi>c</mi></msub><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{v_{j}\in \mathcal{N}_{a}^{(t)}(v_{i})}\mathcal{L}_{c}(v_{i}, v_{j})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.80469em;vertical-align:-1.754685em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.5926349999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0590857142857142em;"><span style="top:-2.3769714285714283em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.059085714285714em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15874285714285716em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.754685em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">L</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是链路分类器的损失 10。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="script">N</mi><mi>a</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathcal{N}_{a}^{(t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.161392em;vertical-align:-0.11659199999999997em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834080000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.11659199999999997em;"><span></span></span></span></span></span></span></span></span></span> 是正负样本的并集。这一项直接监督最终的分类结果，确保了经过注意力机制增强后的特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">e&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 能够直接服务于最后的 ID 匹配任务。</p><h3 id="模型训练"><a class="markdownIt-Anchor" href="#模型训练"></a> 模型训练</h3><p>我们先凝练一下前两章做了什么。</p><ul><li><p><span style="color: #BB8ED0; font-weight: bold;">时空注意力特征增强</span>：<span style="color: #89986D; font-weight: bold;">该节通过串联结构注意力（SAL）与时序注意力（TAL），实现了对原始特征的深度提纯。SAL 结合摄像头位置编码，在空间维度聚合邻域信息以捕捉相机间的拓扑关系；TAL 则在时间维度利用带掩码的自注意力机制，建模目标特征随时间演变的动态规律并确保在线跟踪的因果性。两者协同将不稳定的视觉快照转化为具备时空鲁棒性的高维节点嵌入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">e&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>。</span></p></li><li><p><span style="color: #BB8ED0; font-weight: bold;">身份关联与模型损失函数定义</span>：<span style="color: #89986D; font-weight: bold;">该节将数据关联任务重构为动态图上的链路预测问题 ，利用节点嵌入的哈达玛积配合 Softmax 分类器计算关联概率 。为驱动模型演进，定义了耦合“表示学习”与“分类精度”的联合损失函数 ，通过正样本拉近、负样本推开及分类误差监督三重约束。</span></p></li></ul><p>最后是训练部分，模型的核心在于<span style="color: #BB8ED0; font-weight: bold;">联合学习（Joint Learning）</span>，即同时训练自注意力模块和链路分类器。</p><p>模型将数据切分为大小为 3 的<strong>时空块（Chunks）</strong>，模拟过去-现在的时间跨度进行预测训练。每一个时空块实际上是一个微缩的动态图演化序列：模型利用前两个时间步（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>−</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">t-2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>）已建立的图结构和节点特征作为历史上下文，来预测当前步（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span>）新加入节点的身份分配。</p><p>最终的模型，是一个以 <span style="color: #89986D; font-weight: bold;">2层SAL + 2层TAL + 1层全连接分类器 </span>为核心的动态图神经网络。它是以 DeepSORT 产生的局部轨迹为输入，在 Tensorflow 环境下利用 Adam 优化器完成最终训练的。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;论文精读 DyGLIP: A Dynamic Graph Model with Link Prediction forAccurate Multi-Camera Multiple Object Tracking&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>基于Cesium的三维视锥绘制与画面模拟</title>
    <link href="https://atffang.github.io/2025/12/22/%E5%9F%BA%E4%BA%8ECesium%E7%9A%84%E4%B8%89%E7%BB%B4%E8%A7%86%E9%94%A5%E7%BB%98%E5%88%B6%E4%B8%8E%E7%94%BB%E9%9D%A2%E6%A8%A1%E6%8B%9F/"/>
    <id>https://atffang.github.io/2025/12/22/%E5%9F%BA%E4%BA%8ECesium%E7%9A%84%E4%B8%89%E7%BB%B4%E8%A7%86%E9%94%A5%E7%BB%98%E5%88%B6%E4%B8%8E%E7%94%BB%E9%9D%A2%E6%A8%A1%E6%8B%9F/</id>
    <published>2025-12-22T06:41:48.000Z</published>
    <updated>2026-01-10T14:29:05.775Z</updated>
    
    <content type="html"><![CDATA[<p>基于Cesium的三维视锥绘制与画面模拟</p><span id="more"></span><p>有朋友咨询我cesium下的视锥绘制与监控视角模拟是如何实现的，这里以JavaScript为例，给出一些示例代码。前置条件是，创建了Cesium的Viewer，而为了观察更加真实的模拟视角，可以向地图添加3dtiles。<br /><img src="https://atffang.github.io/2025/12/22/基于Cesium的三维视锥绘制与画面模拟/视锥1.jpg"/><br /><img src="https://atffang.github.io/2025/12/22/基于Cesium的三维视锥绘制与画面模拟/视锥2.jpg"/></p><p><strong>空间定位参数</strong>：共同确定了视锥体的顶点位置及其在三维地球坐标系中的指向。</p><ul><li><strong>Position (Lon, Lat, Alt)</strong>：视锥体的<strong>顶点坐标</strong>。它是相机的光心位置，即所有视线的汇聚点。在 Cesium 中通常使用经纬度和高度</li><li><strong>Orientation (Heading, Pitch, Roll)</strong>：视锥体的*<ul><li><strong>Heading</strong>：决定水平旋转（左右看）</li><li><strong>Pitch</strong>：决定俯仰角度（上下看），通常监控视角为负值。</li><li><strong>Roll</strong>：决定相机的侧倾（</li></ul></li></ul><p><strong>镜头几何参数</strong>：定义了视锥体截面的形状，模拟了不同焦距镜头产生的视觉效果。</p><ul><li><strong>FOV (Field of View - 视场角)</strong>：通常指<strong>垂直方向的张角</strong>。FOV 越大，画面容纳的内容越多（广角镜头）；FOV 越小，画面越窄（长焦镜头）。</li><li><strong>Aspect Ratio (宽高比)</strong>：即视野截面的<strong>宽度与高度之比</strong>。它必须与你的显示画布（Canvas）或视频流（如 16:9）一致，否则画面会产生拉伸或压缩。</li></ul><p><strong>裁剪平面参数</strong>：定义了视锥体在视线方向上的有效渲染范围。</p><ul><li><strong>Near (近裁剪面)</strong>：距离相机的最近可见距离。小于此距离的物体会被切掉（防止相机穿模）。</li><li><strong>Far (远裁剪面)</strong>：距离相机的最远可见距离。超过此距离的物体将不再渲染，这直接影响渲染性能和地平线的可见度。</li></ul><p>绘制流程首先通过 <code>Cesium.Cartesian3.fromDegrees</code> 将经纬度高度转换为空间位置，随后利用 <code>HeadingPitchRoll</code> 结合 <strong>-90 度的坐标系偏移校准</strong>生成四元数，以确定视锥在地球表面的精确指向。<br />接着实例化 <code>PerspectiveFrustum</code> 来定义透视矩阵的核心属性（如张角、宽高比及远近平面），并基于此数学模型分别创建 <code>FrustumGeometry</code>（填充体）和 <code>FrustumOutlineGeometry</code>（轮廓线）两个几何实例。<br />最后，通过设置 <code>ColorGeometryInstanceAttribute</code> 定义颜色与透明度，将实例封装进 <code>Primitive</code> 中并同步添加到场景集合 <code>viewer.scene.primitives</code>，从而在三维空间中渲染出一个代表相机监控范围的半透明四棱台。</p><p>给出实现绘制视锥的代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cesium 视锥体（传感器/相机视野）可视化工具</span></span><br><span class="line"><span class="comment"> * 适用场景：相机监控范围模拟、多目标跟踪(MTMC)视野展示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FrustumVisualizer</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建并添加一个视锥体到场景中</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Cesium.Viewer</span>&#125; <span class="variable">viewer</span> - Cesium 视图实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">params</span> - 配置参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; params.lon - 经度 (度)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; params.lat - 纬度 (度)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; params.alt - 高度 (米)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; [params.heading=0] - 偏航角 (0为正北，顺时针为正)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; [params.pitch=-30] - 俯仰角 (负数向下看)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; [params.vfov=60] - 垂直视场角 (度)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; [params.aspectRatio=1.77] - 宽高比 (16/9 ≈ 1.77)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; [params.near=0.1] - 近裁剪面距离 (米)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; [params.far=50] - 远裁剪面距离 (米)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Cesium.Color</span>&#125; [params.color] - 视锥颜色</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; 包含 fill 和 outline 两个 Primitive 对象的实例，用于后续销毁</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createFrustum</span>(<span class="params">viewer, params</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 提取参数并设置默认值</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      lon, lat, alt,</span><br><span class="line">      heading = <span class="number">0</span>,</span><br><span class="line">      pitch = -<span class="number">30</span>,</span><br><span class="line">      vfov = <span class="number">60</span>,</span><br><span class="line">      aspectRatio = <span class="number">16</span> / <span class="number">9</span>,</span><br><span class="line">      near = <span class="number">0.5</span>,</span><br><span class="line">      far = <span class="number">50</span>,</span><br><span class="line">      color = <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span></span><br><span class="line">    &#125; = params;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 空间位置计算：将经纬度转换为 Cesium 笛卡尔空间坐标 (XYZ)</span></span><br><span class="line">    <span class="keyword">const</span> position = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(lon, lat, alt);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 姿态计算 (Orientation)</span></span><br><span class="line">    <span class="comment">// 注意：Cesium 默认 FrustumGeometry 的朝向是沿局部 Z 轴负方向</span></span><br><span class="line">    <span class="comment">// 为了符合地图常规（Heading 0指向北），需要进行 -90 度的坐标系偏移校准</span></span><br><span class="line">    <span class="keyword">const</span> hpr = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">HeadingPitchRoll</span>(</span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(heading - <span class="number">90</span>), <span class="comment">// 调整 Heading 使 0 度指向北方</span></span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(pitch - <span class="number">90</span>),   <span class="comment">// 调整 Pitch 使 0 度水平，负值向下</span></span><br><span class="line">      <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">0</span>)             <span class="comment">// Roll 滚动角</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将位置和旋转角度转换为四元数（Quaternion），这是 Cesium 定位几何体的标准方式</span></span><br><span class="line">    <span class="keyword">const</span> orientationQuat = <span class="title class_">Cesium</span>.<span class="property">Transforms</span>.<span class="title function_">headingPitchRollQuaternion</span>(position, hpr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 定义视锥几何属性 (Frustum Definition)</span></span><br><span class="line">    <span class="keyword">const</span> frustum = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerspectiveFrustum</span>(&#123;</span><br><span class="line">      <span class="attr">fov</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(vfov), <span class="comment">// 弧度单位的视场角</span></span><br><span class="line">      <span class="attr">aspectRatio</span>: <span class="number">1.0</span> / aspectRatio,   <span class="comment">// 注意：Cesium 的几何宽高比通常取倒数</span></span><br><span class="line">      <span class="attr">near</span>: near,</span><br><span class="line">      <span class="attr">far</span>: far</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 创建“填充体”几何实例</span></span><br><span class="line">    <span class="keyword">const</span> fillInstance = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">      <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">FrustumGeometry</span>(&#123;</span><br><span class="line">        <span class="attr">frustum</span>: frustum,</span><br><span class="line">        <span class="attr">origin</span>: position,</span><br><span class="line">        <span class="attr">orientation</span>: orientationQuat,</span><br><span class="line">        <span class="attr">vertexFormat</span>: <span class="title class_">Cesium</span>.<span class="property">VertexFormat</span>.<span class="property">POSITION_ONLY</span> <span class="comment">// 仅需位置信息，提高渲染效率</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">attributes</span>: &#123;</span><br><span class="line">        <span class="comment">// 设置实例颜色属性</span></span><br><span class="line">        <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(color.<span class="title function_">withAlpha</span>(<span class="number">0.25</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 创建“轮廓线”几何实例</span></span><br><span class="line">    <span class="keyword">const</span> outlineInstance = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">GeometryInstance</span>(&#123;</span><br><span class="line">      <span class="attr">geometry</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">FrustumOutlineGeometry</span>(&#123;</span><br><span class="line">        <span class="attr">frustum</span>: frustum,</span><br><span class="line">        <span class="attr">origin</span>: position,</span><br><span class="line">        <span class="attr">orientation</span>: orientationQuat</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">attributes</span>: &#123;</span><br><span class="line">        <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">ColorGeometryInstanceAttribute</span>.<span class="title function_">fromColor</span>(color.<span class="title function_">withAlpha</span>(<span class="number">0.8</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 将几何体作为 Primitive 添加到场景</span></span><br><span class="line">    <span class="comment">// Primitive 比 Entity 更底层，适合高频创建或大量展示</span></span><br><span class="line">    <span class="keyword">const</span> fillPrimitive = viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">      <span class="attr">geometryInstances</span>: fillInstance,</span><br><span class="line">      <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">        <span class="attr">closed</span>: <span class="literal">true</span>,      <span class="comment">// 封闭几何体</span></span><br><span class="line">        <span class="attr">translucent</span>: <span class="literal">true</span>  <span class="comment">// 开启透明支持</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">asynchronous</span>: <span class="literal">false</span>  <span class="comment">// 同步创建，防止第一帧不显示</span></span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> outlinePrimitive = viewer.<span class="property">scene</span>.<span class="property">primitives</span>.<span class="title function_">add</span>(<span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Primitive</span>(&#123;</span><br><span class="line">      <span class="attr">geometryInstances</span>: outlineInstance,</span><br><span class="line">      <span class="attr">appearance</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerInstanceColorAppearance</span>(&#123;</span><br><span class="line">        <span class="attr">flat</span>: <span class="literal">true</span>,        <span class="comment">// 线条使用扁平着色，不计算光照</span></span><br><span class="line">        <span class="attr">translucent</span>: <span class="literal">true</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">asynchronous</span>: <span class="literal">false</span></span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回对象，方便外部管理（如：removal）</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">fill</span>: fillPrimitive, <span class="attr">outline</span>: outlinePrimitive &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在你的主逻辑文件中，直接传入坐标和旋转参数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设你已经初始化了 viewer</span></span><br><span class="line"><span class="keyword">const</span> cameraOptions = &#123;</span><br><span class="line">  <span class="attr">lon</span>: <span class="number">121.45</span>,       <span class="comment">// 经度</span></span><br><span class="line">  <span class="attr">lat</span>: <span class="number">31.22</span>,        <span class="comment">// 纬度</span></span><br><span class="line">  <span class="attr">alt</span>: <span class="number">10</span>,          <span class="comment">// 离地高度 10 米</span></span><br><span class="line">  <span class="attr">heading</span>: <span class="number">45</span>,       <span class="comment">// 朝向东北</span></span><br><span class="line">  <span class="attr">pitch</span>: -<span class="number">45</span>,        <span class="comment">// 向下俯冲 45 度看地面</span></span><br><span class="line">  <span class="attr">vfov</span>: <span class="number">50</span>,          <span class="comment">// 视野范围</span></span><br><span class="line">  <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">AQUA</span> <span class="comment">// 也可以自定义颜色</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用并存储返回的对象</span></span><br><span class="line"><span class="keyword">const</span> myFrustum = <span class="title class_">FrustumVisualizer</span>.<span class="title function_">createFrustum</span>(viewer, cameraOptions);</span><br></pre></td></tr></table></figure><p>模拟流程首先根据传感器坐标设定相机的 <code>destination</code> 目标位置，随后调用 <code>viewer.camera.flyTo</code> 并传入原始的航向角（Heading）与俯仰角（Pitch），启动平滑飞行过渡以对准观察方向。<br />在相机飞抵指定点后，最关键的一步是<strong>手动覆盖 <code>viewer.camera.frustum</code> 属性</strong>，通过 <code>new Cesium.PerspectiveFrustum</code> 强制修改相机的投影矩阵。通过同步垂直视场角（fov）、画布宽高比（aspectRatio）以及远近裁剪面，使当前屏幕显示的渲染画面与之前在场景中绘制的红色视锥几何体在数学投影上完全重合。<br />给出模拟视锥视角的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将场景相机定位至指定传感器视角，并同步镜头参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Cesium.Viewer</span>&#125; <span class="variable">viewer</span> - Cesium 视图实例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">props</span> - 传感器参数对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.lon - 经度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.lat - 纬度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.alt - 高度 (米)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.heading - 偏航角 (度)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.pitch - 俯仰角 (度)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.vfov - 垂直视场角 (度)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.aspectRatio - 宽高比</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.near - 近裁剪面距离</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; props.far - 远裁剪面距离</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">goToCameraView</span>(<span class="params">viewer, props</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!viewer || !props) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 计算相机目标位置 (Cartesian3 笛卡尔坐标)</span></span><br><span class="line">  <span class="keyword">const</span> destination = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">    props.<span class="property">lon</span>, </span><br><span class="line">    props.<span class="property">lat</span>, </span><br><span class="line">    props.<span class="property">alt</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 执行相机飞行定位</span></span><br><span class="line">  viewer.<span class="property">camera</span>.<span class="title function_">flyTo</span>(&#123;</span><br><span class="line">    <span class="attr">destination</span>: destination,</span><br><span class="line">    <span class="attr">orientation</span>: &#123;</span><br><span class="line">      <span class="comment">// Cesium 相机默认 0 度指向正北，无需像几何体那样做 -90 度校准</span></span><br><span class="line">      <span class="attr">heading</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(props.<span class="property">heading</span>),</span><br><span class="line">      <span class="attr">pitch</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(props.<span class="property">pitch</span>),</span><br><span class="line">      <span class="attr">roll</span>: <span class="number">0.0</span> <span class="comment">// 保持水平，不翻转</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">duration</span>: <span class="number">1.5</span> <span class="comment">// 飞行持续时间（秒）</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 同步相机的视锥体（Lens Parameters）</span></span><br><span class="line">  <span class="comment">// 核心逻辑：将虚拟相机的“镜头”修改为与绘制的视锥几何完全一致</span></span><br><span class="line">  viewer.<span class="property">camera</span>.<span class="property">frustum</span> = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PerspectiveFrustum</span>(&#123;</span><br><span class="line">    <span class="comment">// 将垂直视场角从度转换为弧度</span></span><br><span class="line">    <span class="attr">fov</span>: <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(props.<span class="property">vfov</span>),</span><br><span class="line">    <span class="comment">// 画面宽高比，决定了横向视野的开阔度</span></span><br><span class="line">    <span class="attr">aspectRatio</span>: props.<span class="property">aspectRatio</span>,</span><br><span class="line">    <span class="comment">// 决定相机能看到的最近和最远距离</span></span><br><span class="line">    <span class="attr">near</span>: props.<span class="property">near</span>,</span><br><span class="line">    <span class="attr">far</span>: props.<span class="property">far</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;基于Cesium的三维视锥绘制与画面模拟&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="https://atffang.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>从0开始学JAVA 4 JAVA线程方法汇总</title>
    <link href="https://atffang.github.io/2025/12/22/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/"/>
    <id>https://atffang.github.io/2025/12/22/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/</id>
    <published>2025-12-22T02:37:17.000Z</published>
    <updated>2026-01-10T14:21:39.860Z</updated>
    
    <content type="html"><![CDATA[<p>万字长文梳理JAVA线程方法的基础应用</p><span id="more"></span><h3 id="第一章多线程基础"><a class="markdownIt-Anchor" href="#第一章多线程基础"></a> 第一章：多线程基础</h3><p>在 Java 中，线程（Thread）是操作系统调度的最小单元。理解多线程，首先要从如何启动它、它经历过哪些状态、以及我们如何控制它开始。</p><h4 id="线程的创建方式"><a class="markdownIt-Anchor" href="#线程的创建方式"></a> 线程的创建方式</h4><p>虽然最终都是通过 <code>Thread.start()</code> 启动，但 Java 提供了<strong>三种主要的任务定义方式</strong>：</p><ul><li><strong>继承 <code>Thread</code> 类</strong>：<ul><li><strong>做法</strong>：定义一个类继承 <code>Thread</code> 并重写 <code>run()</code> 方法。</li><li><strong>缺点</strong>：Java 是单继承的，继承了 Thread 就不能再继承其他类（如 BaseService），灵活性差。</li></ul></li></ul><p>我们直接new一个Tread类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">            <span class="built_in">super</span>.run();  </span><br><span class="line">            System.out.println(<span class="string">&quot;run: &quot;</span> + <span class="built_in">this</span>.getState());</span><br><span class="line">              </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">  </span><br><span class="line">    System.out.println(<span class="string">&quot;main: &quot;</span> + thread.getState());  </span><br><span class="line">    thread.start();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>实现 <code>Runnable</code> 接口</strong>（推荐）：<ul><li><strong>做法</strong>：实现 <code>run()</code> 方法，并将其作为参数传递给 <code>Thread</code> 构造函数。</li><li><strong>优点</strong>：解耦了“任务逻辑”与“线程资源”。多个线程可以执行同一个 <code>Runnable</code> 实例，适合资源共享。</li></ul></li></ul><p><strong><code>Runnable</code> 接口</strong>。<code>Runnable</code> 是 Java 中一个功能性的接口，它定义了一个 <code>run()</code> 方法。实现这个接口的类（如 <code>TaskRunnable</code>）表示一个任务，这个任务可以被一个线程执行。</p><p><strong><code>Thread</code> 与 <code>Runnable</code></strong>：<code>Thread</code> 类用于表示一个执行的线程，但它并不直接定义要做什么。<code>Thread</code> 需要一个 <code>Runnable</code> 对象，来确定线程启动后应该执行什么样的任务。所以，<code>Thread</code> 会将一个 <code>Runnable</code> 对象传给其构造方法，这样线程就知道了执行什么任务。</p><p>我们实现一个<code>runnable接口</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">    <span class="type">TaskRunnable</span> <span class="variable">taskRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskRunnable</span>();  </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(taskRunnable);  </span><br><span class="line">    thread.start();  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);  </span><br><span class="line">        taskRunnable.cancel();  </span><br><span class="line">          </span><br><span class="line">    &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TaskRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">boolean</span> cancel;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (cancel)&#123;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span>&#123;  </span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);  </span><br><span class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            System.out.println(<span class="string">&quot;running&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;  </span><br><span class="line">        cancel = <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>实现 <code>Callable</code> 接口</strong>：<ul><li><strong>做法</strong>：实现 <code>call()</code> 方法，配合 <code>FutureTask</code> 或线程池使用。</li><li><strong>核心区别</strong>：<code>call()</code> 方法<strong>有返回值</strong>且<strong>允许抛出异常</strong>，而 <code>run()</code> 不行。</li></ul></li></ul><p>我们来实现一个<code>Callable</code> 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CallableBaseDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 定义任务：实现 Callable 接口，泛型 String 是返回值的类型</span></span><br><span class="line">        Callable&lt;String&gt; myTask = <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>); <span class="comment">// 模拟耗时操作</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;任务执行完毕：这是从子线程返回的结果！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 包装任务：由于 Thread 构造方法只接收 Runnable，</span></span><br><span class="line">        <span class="comment">// 我们需要用 FutureTask 包装一下。FutureTask 实现了 Runnable 接口。</span></span><br><span class="line">        FutureTask&lt;String&gt; futureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(myTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 启动线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(futureTask);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;主线程：已经启动子线程，我现在可以做点别的事...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 获取结果：get() 方法会阻塞当前线程，直到子线程执行完毕并返回结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> futureTask.get(); </span><br><span class="line">        System.out.println(<span class="string">&quot;主线程收到的结果: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>综上，三种实现方式的区别在于：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>Thread</strong></th><th><strong>Runnable</strong></th><th><strong>Callable</strong></th></tr></thead><tbody><tr><td><strong>继承性</strong></td><td>限制单继承</td><td>无限制</td><td>无限制</td></tr><tr><td><strong>返回值</strong></td><td>无</td><td>无</td><td>有 (Future获取)</td></tr><tr><td><strong>异常抛出</strong></td><td>只能内部捕获</td><td>只能内部捕获</td><td>允许 throws 抛出</td></tr></tbody></table><h4 id="线程的生命周期与状态转换-state-machine"><a class="markdownIt-Anchor" href="#线程的生命周期与状态转换-state-machine"></a> 线程的生命周期与状态转换 (State Machine)</h4><p>Java 线程在生命周期内并不是一直占着 CPU 不放，它会在多种状态间切换。通过 <code>thread.getState()</code> 可以获取以下六种状态：</p><ol><li><p><strong>NEW (新建)</strong>：<code>new Thread()</code> 之后，调用 <code>start()</code> 之前。</p></li><li><p><strong>RUNNABLE (可运行)</strong>：调用了 <code>start()</code>。在 Java 中，就绪（Ready）和运行中（Running）统称为“可运行”。</p></li><li><p><strong>BLOCKED (阻塞)</strong>：等待获取 <code>synchronized</code> 锁。</p></li><li><p><strong>WAITING (等待)</strong>：调用了 <code>wait()</code>、<code>join()</code> 或 <code>LockSupport.park()</code>。需要被其他线程显式唤醒。</p></li><li><p><strong>TIMED_WAITING (超时等待)</strong>：调用了 <code>sleep(ms)</code>、<code>wait(ms)</code> 等。时间到了自动苏醒。</p></li><li><p><strong>TERMINATED (终止)</strong>：<code>run()</code> 方法执行完毕或因异常退出。</p></li></ol><img src="https://atffang.github.io/2025/12/22/JAVA多线程方法汇总/线程的生命周期.png"/><h4 id="基础控制方法"><a class="markdownIt-Anchor" href="#基础控制方法"></a> 基础控制方法</h4><p>这一节介绍的是 Java <code>Thread</code> 类中提供的几个核心控制方法，它们决定了线程在执行过程中的行为。</p><h5 id="1-sleeplong-millis"><a class="markdownIt-Anchor" href="#1-sleeplong-millis"></a> 1. sleep(long millis)</h5><p><code>sleep</code> 是静态方法，使当前线程进入 <strong>TIMED_WAITING</strong> 状态，暂停执行一段时间。</p><ul><li><strong>锁的行为</strong>：线程在睡眠时<strong>不会释放</strong>它持有的任何锁（Monitor Lock）。</li><li><strong>异常处理</strong>：睡眠中的线程如果被中断，会抛出 <code>InterruptedException</code>。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>); <span class="comment">// 暂停1秒</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="comment">// 线程在休眠中被中断时的处理逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-yield"><a class="markdownIt-Anchor" href="#2-yield"></a> 2. yield()</h5><p><code>yield</code> 也是静态方法，它表示当前线程愿意让出 CPU 的使用权。</p><ul><li><strong>调度结果</strong>：调用后，线程从“运行中”变为“就绪”状态。</li><li><strong>局限性</strong>：这只是一个“建议”，线程调度器可能会忽略它。如果当前没有其他同优先级的线程，该线程可能立即再次获得 CPU。</li><li><strong>锁的行为</strong>：同样不会释放锁。</li></ul><h5 id="3-join"><a class="markdownIt-Anchor" href="#3-join"></a> 3. join()</h5><p><code>join</code> 是成员方法，用于同步多个线程的执行顺序。</p><ul><li><strong>作用</strong>：如果在线程 A 中调用 <code>B.join()</code>，则 A 线程会进入 <strong>WAITING</strong> 状态，直到 B 线程执行完毕。</li><li><strong>原理</strong>：底层调用的是 <code>Object.wait()</code> 方法，因此调用者会释放掉 B 线程对象的锁。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">/* 耗时任务 */</span> &#125;);</span><br><span class="line">t1.start();</span><br><span class="line">t1.join(); <span class="comment">// 主线程在此阻塞，直到 t1 彻底运行结束</span></span><br></pre></td></tr></table></figure><h5 id="4-interrupt"><a class="markdownIt-Anchor" href="#4-interrupt"></a> 4. interrupt()</h5><p>Java 采用的是协作式的中断机制，而不是暴力停止。</p><ul><li><strong>interrupt()</strong>：将目标线程的中断标志位设为 <code>true</code>。</li><li><strong>isInterrupted()</strong>：实例方法，判断线程是否被中断。</li><li><strong>静态 interrupted()</strong>：检查当前线程的中断状态，并<strong>清除</strong>标志位。</li><li><strong>特殊情况</strong>：如果线程正阻塞在 <code>sleep</code>、<code>wait</code>、<code>join</code> 等方法上，<code>interrupt()</code> 会使这些方法抛出异常，并自动清除中断状态（变回 <code>false</code>）。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">    <span class="comment">// 执行业务逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-守护线程-daemon-thread"><a class="markdownIt-Anchor" href="#5-守护线程-daemon-thread"></a> 5. 守护线程 (Daemon Thread)</h5><p>Java 中的线程分为“用户线程”和“守护线程”</p><ul><li><strong>定义</strong>：守护线程是为用户线程服务的（如 GC 垃圾回收）。</li><li><strong>退出机制</strong>：当 JVM 中所有的用户线程都运行结束时，守护线程会随 JVM 一起直接退出，无论其任务是否完成。</li><li><strong>限制</strong>：必须在 <code>thread.start()</code> 之前调用 <code>setDaemon(true)</code>。</li></ul><p>举个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">daemonThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;  </span><br><span class="line">            <span class="built_in">super</span>.run();  </span><br><span class="line">                System.out.println(getName() + <span class="string">&quot; &quot;</span> + System.currentTimeMillis());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">  </span><br><span class="line">    daemonThread.setName(<span class="string">&quot;B&quot;</span>);  </span><br><span class="line">    daemonThread.setDaemon(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">    daemonThread.start();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第二章线程安全与内存模型-safety-jmm"><a class="markdownIt-Anchor" href="#第二章线程安全与内存模型-safety-jmm"></a> 第二章：线程安全与内存模型 (Safety &amp; JMM)</h3><p>线程安全的核心在于：当多个线程访问一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，调用这个对象的行为都可以获得正确的结果，那这个对象就是线程安全的。</p><h4 id="什么是线程安全"><a class="markdownIt-Anchor" href="#什么是线程安全"></a> 什么是线程安全？</h4><p>要实现线程安全，必须保证并发编程的三大特性：</p><ol><li><p><strong>原子性 (Atomicity)</strong>：一个或多个操作，要么全部执行且在执行过程中不被任何因素打断，要么全部不执行。</p><ul><li><em>典型问题</em>：<code>i++</code> 包含读、加、写三步，在多线程下不具备原子性。</li></ul></li><li><p><strong>可见性 (Visibility)</strong>：当一个线程修改了共享变量的值，其他线程能够立即得知这个修改。</p><ul><li><em>原因</em>：JMM 规定线程有工作内存，修改变量后不会立即同步到主内存。</li></ul></li><li><p><strong>有序性 (Ordering)</strong>：程序执行的顺序按照代码的先后顺序执行。</p><ul><li><em>原因</em>：编译器和处理器为了优化性能，往往会对指令进行<strong>重排序</strong>。</li></ul></li></ol><h4 id="synchronized-关键字"><a class="markdownIt-Anchor" href="#synchronized-关键字"></a> <code>synchronized</code> 关键字</h4><p><code>synchronized</code> 是一种互斥锁，它通过控制多个线程对共享资源的访问，一次只允许一个线程执行，从而同时保证了原子性、可见性和有序性。</p><p><code>synchronized</code> 底层依赖 JVM 的 <strong>Monitor（监视器锁）</strong>。编译后会生成 <code>monitorenter</code> 和 <code>monitorexit</code> 指令。每个对象头中都有 Mark Word，记录了锁的状态（偏向锁、轻量级锁、重量级锁）。</p><p>下面是两个不同的应用：</p><p><code>synchronized</code> 方法<br />在一个方法上使用 <code>synchronized</code>，可以保证同一时刻只能有一个线程访问该方法。这对于涉及共享资源的操作很有用，防止多个线程同时修改资源导致状态不一致。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">someMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 同步的代码块</span></span><br><span class="line">    <span class="comment">// 执行一些对共享资源的操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>synchronized</code> 代码块<br />有时候我们并不需要整个方法都保持同步，而是只需要某部分代码在执行时是互斥的。此时，我们可以使用 <strong><code>synchronized</code> 代码块</strong>。通过指定一个对象锁来控制代码块的同步。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (锁对象) &#123;</span><br><span class="line">    <span class="comment">// 需要同步的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>锁对象</code>：它可以是任意对象，通常是一个共享对象。<code>synchronized</code> 关键字会将该对象作为锁，只允许一个线程在同一时间进入该代码块。</p></li><li><p>如果多个线程试图同时进入该同步代码块，它们必须等待其他线程释放该锁。</p></li><li><p><strong>方法级锁</strong>：当你用 <code>synchronized</code> 修饰一个方法时，锁的粒度是<strong>方法级别</strong>的。只有一个线程能访问方法中的同步部分。</p></li><li><p><strong>代码块级锁</strong>：使用 <code>synchronized</code> 代码块时，锁的粒度是<strong>代码块级别</strong>的。它只锁定特定的资源，而不是整个方法，这样可以提高性能，因为不必要的代码部分不会被同步。</p></li></ul><p><code>wait()</code> 方法使当前线程进入 <strong>等待状态</strong>，直到另一个线程发出通知（通过 <code>notify()</code> 或 <code>notifyAll()</code>）。当线程调用 <code>wait()</code> 时，它会释放当前持有的对象锁，并且进入 <strong>等待队列</strong>，直到被其他线程唤醒。</p><p><code>wait()</code> 必须在 <strong>同步代码块</strong> 或 <strong>同步方法</strong> 中调用，因为它需要获得对象的监视器锁（即 <code>synchronized</code> 锁）。当线程在同步方法或同步代码块中调用 <code>wait()</code> 时，它会释放对象的锁，允许其他线程获得锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (someObject) &#123;</span><br><span class="line">    <span class="keyword">while</span> (conditionNotMet) &#123;</span><br><span class="line">        someObject.wait();  <span class="comment">// 线程在条件不满足时等待</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行后续操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>notify()</code> 方法唤醒 <strong>一个等待中的线程</strong>。当线程调用 <code>notify()</code> 时，它会从等待队列中随机选择一个线程，并将其唤醒，唤醒后的线程会尝试重新获取对象锁，获得锁后才会继续执行。</p><ul><li><code>notify()</code> 必须在 <strong>同步代码块</strong> 或 <strong>同步方法</strong> 中调用。</li><li>被唤醒的线程不会立即执行，而是进入 <strong>可运行状态</strong>，等待获取对象锁。</li></ul><p><code>notifyAll()</code> 方法唤醒 <strong>所有等待中的线程</strong>。与 <code>notify()</code> 不同的是，<code>notifyAll()</code> 会唤醒所有等待该对象锁的线程。所有唤醒的线程会争夺锁，只有获得锁的线程才会继续执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SharedBuffer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生产者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(<span class="type">int</span> value)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (data != -<span class="number">1</span>) &#123;  <span class="comment">// 如果数据已存在，生产者等待</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        data = value;  <span class="comment">// 生产数据</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Produced: &quot;</span> + value);</span><br><span class="line">        notify();  <span class="comment">// 唤醒消费者</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (data == -<span class="number">1</span>) &#123;  <span class="comment">// 如果数据为空，消费者等待</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumed: &quot;</span> + data);</span><br><span class="line">        data = -<span class="number">1</span>;  <span class="comment">// 消费数据</span></span><br><span class="line">        notify();  <span class="comment">// 唤醒生产者</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WaitNotifyExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SharedBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedBuffer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生产者线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    buffer.produce(i);</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);  <span class="comment">// 模拟生产的时间</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消费者线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    buffer.consume();</span><br><span class="line">                    Thread.sleep(<span class="number">150</span>);  <span class="comment">// 模拟消费的时间</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="volatile-关键字"><a class="markdownIt-Anchor" href="#volatile-关键字"></a> <code>volatile</code> 关键字</h4><p><code>volatile</code> 是 Java 提供的最轻量级的同步机制，它保证了<strong>可见性</strong>和<strong>有序性</strong>，但<strong>不保证原子性</strong>。</p><ul><li><strong>可见性原理</strong>：写一个 <code>volatile</code> 变量时，JMM 会把该线程对应的工作内存值立即刷新到主内存；读时，会使本地内存失效，直接从主内存读取。</li><li><strong>禁止重排序</strong>：通过插入<strong>内存屏障</strong>，确保编译器不会为了优化而改变指令顺序。</li></ul><p>为了举例，我们介绍java中的<strong>双重检查锁定</strong>（Double-Checked Locking,<strong>DCL</strong>）,主要是为了解决单例模式（Singleton）在多线程环境下的性能和安全平衡问题。</p><p>如果没有 DCL，我们最简单的同步写法是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="literal">null</span>) instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每次调用 <code>getInstance()</code> 都要加锁，而实际上只有第一次创建实例时才需要同步，后续读取直接返回即可。加锁是非常重的操作，这会严重拖慢性能。那么，我们可以先判断是否为 null，如果不为 null 直接返回；如果为 null，再进入同步块创建对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// 必须加 volatile，防止指令重排导致拿到尚未初始化的对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>(); </span><br><span class="line">                    <span class="comment">// 这里包含三步：1.分配空间 2.初始化 3.指向地址</span></span><br><span class="line">                    <span class="comment">// 重排序可能导致：1 -&gt; 3 -&gt; 2，使得其他线程拿到非 null 但未初始化的对象</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来看 原来的<code>instance = new Singleton();</code> 这一行。在 JVM 层面，它其实被分成了 <strong>3 个步骤</strong>执行：</p><ol><li><strong>分配内存空间</strong>（给这个对象找块地方）。</li><li><strong>初始化对象</strong>（执行构造函数里的逻辑）。</li><li><strong>将 instance 变量指向分配的内存地址</strong>（此时 instance 不再是 null 了）。</li></ol><p><strong>问题出在编译器的优化上</strong>： 由于步骤 2 和步骤 3 之间没有必然的依赖关系，编译器或 CPU 可能会为了提高效率进行<strong>指令重排序</strong>，把顺序变成： <strong>1（分配内存） -&gt; 3（指向地址） -&gt; 2（初始化对象）</strong>。</p><p>这会导致下面发生的灾难场景：</p><ol><li><strong>线程 A</strong> 进入同步块，执行 <code>instance = new Singleton()</code>。</li><li>由于重排序，线程 A 先执行了步骤 3（指向地址），此时 <code>instance</code> 已经<strong>不是 null</strong> 了，但步骤 2（初始化）<strong>还没完成</strong>。</li><li>就在这一瞬间，<strong>线程 B</strong> 调用 <code>getInstance()</code>，它判断 <code>instance != null</code>，于是开心地直接把这个 instance 拿去用了。</li><li>结果线程 B 在使用对象时，发现由于还没初始化，内部属性全是空的，直接报出 <strong>空指针异常（NPE）</strong> 或逻辑错误。</li></ol><p>在 <code>instance</code> 变量上加上 <code>volatile</code> 关键字后，会发挥两个核心作用：</p><ol><li><strong>禁止指令重排序</strong>：它会插入一个“内存屏障”，强制保证执行顺序必须是 <code>1 -&gt; 2 -&gt; 3</code>。这样当线程 B 拿到对象时，它一定已经是初始化完成的。</li><li><strong>保证可见性</strong>：一旦线程 A 完成了对象的创建，线程 B 能够立即从主内存中看到 <code>instance</code> 的最新值。</li></ol><h4 id="原子类-atomic"><a class="markdownIt-Anchor" href="#原子类-atomic"></a> 原子类 <code>Atomic</code></h4><p>对于简单的数值运算，使用 <code>synchronized</code> 太重，频繁的线程上下文切换会损耗性能。<code>Atomic</code> 系列工具类（如 <code>AtomicInteger</code>）采用 <strong>CAS (Compare And Swap)</strong> 机制实现。</p><ul><li><strong>CAS 原理</strong>：包含三个参数：变量内存地址 (V)、预期原值 (A) 和新值 (B)。<ul><li>只有当 V 的实际值等于 A 时，才将 V 修改为 B。否则说明变量已被修改，当前线程会通过自旋（死循环）不断尝试，直到成功。</li></ul></li></ul><p>从概念上来说，<strong>原子变量 = 操作不可被打断的变量</strong><br />对它的操作要么全部执行完，要么完全不执行，<strong>不会被线程切换中断</strong>，因此天然线程安全，不需要 synchronized。</p><p>对于普通变量操作，如i++，看起来是一句，但实际上包含三个步骤：</p><ol><li>读取 i</li><li>i + 1</li><li>写回 i</li></ol><p>如果两个线程同时执行，就可能出现：</p><ul><li>两个线程都读到旧值</li><li>最终只加一次</li></ul><p>这就出现了典型的 <strong>竞态条件（Race Condition）</strong><br />举个简单的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">    count.incrementAndGet(); <span class="comment">// 等同于非原子的 count++</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="线程封闭-threadlocal"><a class="markdownIt-Anchor" href="#线程封闭-threadlocal"></a> 线程封闭 (<code>ThreadLocal</code>)</h4><p>如果说锁是解决“如何同步访问共享数据”，那么 <code>ThreadLocal</code> 则是“如何不共享数据”。它为每个线程提供一份独立的变量副本，实现线程间的数据隔离。</p><ul><li><strong>核心用途</strong>：解决数据库连接、Session 管理等场景下的线程安全问题。<br />举个简单的例子</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; localValue = ThreadLocal.withInitial(() -&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            localValue.set(<span class="number">10</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; : &quot;</span> + localValue.get());</span><br><span class="line">        &#125;, <span class="string">&quot;Thread-A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            localValue.set(<span class="number">20</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; : &quot;</span> + localValue.get());</span><br><span class="line">        &#125;, <span class="string">&quot;Thread-B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第三章juc-显式锁-explicit-locks"><a class="markdownIt-Anchor" href="#第三章juc-显式锁-explicit-locks"></a> 第三章：JUC 显式锁 (Explicit Locks)</h3><p>在 Java 并发工具包（JUC）中，<code>java.util.concurrent.locks</code> 提供了比 <code>synchronized</code> 更灵活、更强大的锁定机制。<code>synchronized</code> 又被称为内置锁，其不需要程序员过多的手动操作，而基于<code>Lock</code>接口实现的为显式锁，需要程序员一些手动操作才能执行。</p><h4 id="lock-接口与-reentrantlock"><a class="markdownIt-Anchor" href="#lock-接口与-reentrantlock"></a> <code>Lock</code> 接口与 <code>ReentrantLock</code></h4><p><code>ReentrantLock</code> 是最常用的显式锁，它不仅完全覆盖了 <code>synchronized</code> 的功能，还提供了许多高级特性:</p><ul><li><strong>手动规范</strong>：使用显式锁必须遵循特定的模板。由于它不会自动释放锁，为了防止死锁，<strong>必须</strong>在 <code>finally</code> 块中调用 <code>unlock()</code>。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>可重入性</strong>：同一个线程可以多次获得同一把锁，内部通过计数器实现。</p></li><li><p><strong>可中断性</strong>：使用 <code>lockInterruptibly()</code> 获取锁时，如果线程正在等待锁，它可以响应中断信号并停止等待。</p></li><li><p><strong>公平锁与非公平锁</strong>：构造函数支持传入 <code>boolean</code> 值。公平锁会严格按照线程排队的顺序给锁，而非公平锁（默认）允许插队，通常拥有更高的吞吐量。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>); <span class="comment">// 公平锁</span></span><br></pre></td></tr></table></figure><ul><li><strong>可轮询获取锁（tryLock）</strong>: 线程可以“试一试”拿锁，拿不到直接走，不会阻塞。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lock.tryLock(<span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 拿到锁才执行</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 拿不到锁，执行别的逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>举个简单的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">lock.lock(); <span class="comment">// 阻塞式获取</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 临界区代码</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock(); <span class="comment">// 必须在 finally 中释放</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试获取锁：拿不到就走，不阻塞</span></span><br><span class="line"><span class="keyword">if</span> (lock.tryLock()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">/* 业务逻辑 */</span> &#125; <span class="keyword">finally</span> &#123; lock.unlock(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="readwritelock-读写锁"><a class="markdownIt-Anchor" href="#readwritelock-读写锁"></a> <code>ReadWriteLock</code> 读写锁</h4><p>在很多场景下，数据是“读多写少”的。如果用普通的互斥锁，多个线程同时读也会互相排队，效率低下。<code>ReentrantReadWriteLock</code> 实现了“读写分离”。读写锁是对普通互斥锁的升级，允许多个线程同时读，但写操作只能有一个，并且写时不能读，即：</p><ul><li><strong>读读不互斥</strong>（并发度高）</li><li><strong>读写互斥</strong></li><li><strong>写写互斥</strong></li></ul><p><strong>ReentrantReadWriteLock</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReadWriteLock</span> <span class="variable">rwLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line"><span class="type">Lock</span> <span class="variable">readLock</span> <span class="operator">=</span> rwLock.readLock();</span><br><span class="line"><span class="type">Lock</span> <span class="variable">writeLock</span> <span class="operator">=</span> rwLock.writeLock();</span><br></pre></td></tr></table></figure><p>多个线程可以同时拿：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">readLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 读取共享数据</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只有一个线程能拿：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">writeLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 修改共享数据</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是一个简单的读写锁的示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantReadWriteLockDEMO</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">readLock</span> <span class="operator">=</span> readWriteLock.readLock();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">writeLock</span>  <span class="operator">=</span> readWriteLock.writeLock();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;  </span><br><span class="line">        readLock.lock();  </span><br><span class="line">        <span class="keyword">try</span>&#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> map.get(key);  </span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; get &quot;</span> + key + <span class="string">&quot; &quot;</span> + val);  </span><br><span class="line">            <span class="keyword">return</span> val;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            readLock.unlock();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String key, String val)</span> &#123;  </span><br><span class="line">        writeLock.lock();  </span><br><span class="line">        <span class="keyword">try</span>&#123;  </span><br><span class="line">            map.put(key, val);  </span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; put &quot;</span> + key + <span class="string">&quot; &quot;</span> + val);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            writeLock.unlock();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">        <span class="type">ReentrantReadWriteLockDEMO</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLockDEMO</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cache.get(<span class="string">&quot;name&quot;</span>);  </span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cache.get(<span class="string">&quot;name&quot;</span>);  </span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">            <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">                cache.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;value-&quot;</span> + (cnt++));  </span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">500</span>); &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        t1.start();  </span><br><span class="line">        t2.start();  </span><br><span class="line">        t3.start();  </span><br><span class="line">        t1.join();  </span><br><span class="line">        t2.join();  </span><br><span class="line">        t3.join();   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="condition-机制"><a class="markdownIt-Anchor" href="#condition-机制"></a> <code>Condition</code> 机制</h4><p><code>Condition</code> 是为了配合 <code>Lock</code> 使用的，它用来替代 <code>Object.wait()/notify()</code>。它的最大优势在于：<strong>一个锁可以关联多个 Condition（条件变量）</strong>。</p><p>在 <code>synchronized</code> 中，所有的线程都挤在一个等待队列里，调用 <code>notifyAll()</code> 会唤醒所有人。而 <code>Condition</code> 可以实现“精准唤醒”。</p><p>在 synchronized 里我们用：<br />•wait()<br />•notify()<br />•notifyAll()</p><p>在 显式锁（ReentrantLock） 中，我们不能再用它们，要用：<br />•await() 代替 wait()<br />•signal() 代替 notify()<br />•signalAll() 代替 notifyAll()</p><p>一个典型的应用场景是<strong>生产消费者模型</strong>， 我们可以创建两个条件：<code>notFull</code>（不满）和 <code>notEmpty</code>（不空）。生产者只唤醒等待 <code>notEmpty</code> 的消费者，互不干扰。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Depot</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == MAX) &#123;</span><br><span class="line">                notFull.await();   <span class="comment">// 等待仓库有空位</span></span><br><span class="line">            &#125;</span><br><span class="line">            count++;</span><br><span class="line">            System.out.println(<span class="string">&quot;生产，总数 = &quot;</span> + count);</span><br><span class="line">            notEmpty.signal();     <span class="comment">// 唤醒等待取货的线程</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                notEmpty.await();  <span class="comment">// 等待仓库非空</span></span><br><span class="line">            &#125;</span><br><span class="line">            count--;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费，总数 = &quot;</span> + count);</span><br><span class="line">            notFull.signal();      <span class="comment">// 唤醒等待生产的线程</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="锁的降级-写锁-读锁"><a class="markdownIt-Anchor" href="#锁的降级-写锁-读锁"></a> 锁的降级 (写锁 -&gt; 读锁)</h4><p>锁降级是指：<strong>线程持有写锁 -&gt; 获取读锁 -&gt; 释放写锁</strong>。</p><p>这么做主要是为了保证数据的<strong>可见性</strong>和<strong>原子性</strong>。如果你先释放写锁再获取读锁，在中间的空隙，数据可能被其他线程修改了。通过锁降级，线程可以无缝地从“修改者”切换为“观察者”，且在这个过程中，数据不会被他人篡改。</p><p>下面是一个简单的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">writeLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 修改数据</span></span><br><span class="line">    <span class="comment">// 2. 降级：在释放写锁前先获取读锁</span></span><br><span class="line">    readLock.lock();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeLock.unlock(); <span class="comment">// 3. 释放写锁，此时依然持有读锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 4. 使用数据</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readLock.unlock(); <span class="comment">// 5. 最后释放读锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第四章并发协作工具类-synchronization-tools"><a class="markdownIt-Anchor" href="#第四章并发协作工具类-synchronization-tools"></a> 第四章：并发协作工具类 (Synchronization Tools)</h3><p>JUC（Java 并发工具包）除了提供锁之外，还提供了一系列非常有用的协作工具。如果说锁是解决资源竞争的，那么这些工具就是解决线程配合的。</p><h4 id="倒计时器-countdownlatch"><a class="markdownIt-Anchor" href="#倒计时器-countdownlatch"></a> 倒计时器 <code>CountDownLatch</code></h4><p>CountDownLatch 是一个同步工具类，用来让一个或多个线程等待其他线程完成任务。<br />就像一个倒计时器：<br />•初始有一个计数 count<br />•每次调用 countDown()，计数减 1<br />•当计数变成 0 时，所有在 await() 等待的线程都会继续执行</p><p>典型场景：等待多个任务都完成后继续执行<br />例如：<br />•主线程启动 3 个子线程<br />•每个子线程完成后执行 countDown()<br />•主线程调用 await()，一直等待所有子线程完成<br />•所有子线程完成后，主线程继续执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">taskCount</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(taskCount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; taskCount; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;子线程 &quot;</span> + id + <span class="string">&quot; 开始任务&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span> + id * <span class="number">500</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;子线程 &quot;</span> + id + <span class="string">&quot; 完成任务&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123; &#125;</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown(); <span class="comment">// 计数 -1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;主线程等待所有子任务完成...&quot;</span>);</span><br><span class="line">        latch.await(); <span class="comment">// 等待 count 变为 0</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;所有子任务完成，主线程继续执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="循环栅栏-cyclicbarrier"><a class="markdownIt-Anchor" href="#循环栅栏-cyclicbarrier"></a> 循环栅栏 <code>CyclicBarrier</code></h4><p><strong>CyclicBarrier 是一种同步屏障，让一组线程必须等到“全部都到达屏障点”，然后同时继续执行。</strong><br />特点：<br />•屏障点（barrier）可以重复使用（循环 cyclic）<br />•线程到达 barrier 后会阻塞<br />•当所有线程都到达后，自动释放所有线程</p><p>假设要 3 个线程同时开始下一步：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程 &quot;</span> + id + <span class="string">&quot; 到达屏障点&quot;</span>);</span><br><span class="line">                    barrier.await(); <span class="comment">// 阻塞，直到 3 个线程都调用</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;线程 &quot;</span> + id + <span class="string">&quot; 通过屏障，继续执行&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">线程 0 到达屏障点</span><br><span class="line">线程 2 到达屏障点</span><br><span class="line">线程 1 到达屏障点</span><br><span class="line">（满足3个线程到达）</span><br><span class="line">线程 2 通过屏障，继续执行</span><br><span class="line">线程 1 通过屏障，继续执行</span><br><span class="line">线程 0 通过屏障，继续执行</span><br></pre></td></tr></table></figure><p>CyclicBarrier 与 CountDownLatch 的区别</p><table><thead><tr><th><strong>特性</strong></th><th><strong>CyclicBarrier</strong></th><th><strong>CountDownLatch</strong></th></tr></thead><tbody><tr><td>作用</td><td>让多个线程“集合，然后一起继续”</td><td>让线程等待其他线程做完某件事</td></tr><tr><td>是否可重用</td><td>✔ 可重复使用（cyclic）</td><td>❌ 不能重置（一次性）</td></tr><tr><td>是否所有线程都会等待</td><td>✔ 是</td><td>❌ 通常只有一个或少量线程等待</td></tr><tr><td>调用方法</td><td>await()</td><td>await() + countDown()</td></tr><tr><td>谁减计数</td><td>每个线程调用 await() 都算一个到达</td><td>调用 countDown() 的线程</td></tr><tr><td>信号方向</td><td>大家互相等待</td><td>一些线程等待，另一些负责 countDown</td></tr></tbody></table><h4 id="信号量-semaphore"><a class="markdownIt-Anchor" href="#信号量-semaphore"></a> 信号量 <code>Semaphore</code></h4><p>**Semaphore（信号量）**是Java 并发编程里一个非常核心的同步工具，主要用于控制同时访问某个资源的线程数量。</p><p>Semaphore = 一个“许可证”计数器，用来限制并发访问数量。<br />比如你有 3 台打印机，但有 10 个线程要打印文件。<br />Semaphore(3) 就相当于发 3 张“许可证”，同时只允许 3 个线程使用打印机。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>); <span class="comment">// 有 3 个许可证</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        semaphore.acquire(); <span class="comment">// 请求一个许可证，如果没有就阻塞</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 开始打印...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>); <span class="comment">// 模拟任务</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 打印结束&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        semaphore.release(); <span class="comment">// 释放一个许可证</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Semaphore 常用方法</p><table><thead><tr><th><strong>方法</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>acquire()</td><td>获取一个许可证，没有则阻塞</td></tr><tr><td>acquire(int n)</td><td>一次获取 n 个许可证</td></tr><tr><td>tryAcquire()</td><td>尝试获取，不阻塞，获取不到返回 false</td></tr><tr><td>release()</td><td>释放许可证</td></tr><tr><td>availablePermits()</td><td>查看剩余许可证数量</td></tr></tbody></table><p>Semaphore vs Lock / synchronized</p><table><thead><tr><th><strong>对比对象</strong></th><th><strong>Semaphore</strong></th><th><strong>Lock / synchronized</strong></th></tr></thead><tbody><tr><td>核心用途</td><td>限制并发数量</td><td>同一时间只有一个线程进入临界区（互斥）</td></tr><tr><td>支持多少线程同时进入</td><td><strong>多个</strong>（取决于 permits）</td><td><strong>只能 1 个</strong></td></tr><tr><td>是否可作为锁使用</td><td>可以（permits=1 时类似 mutex）</td><td>是锁</td></tr></tbody></table><p>公平/非公平</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>, <span class="literal">true</span>); <span class="comment">// 公平，按排队顺序</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>, <span class="literal">false</span>); <span class="comment">// 非公平（默认），速度更快</span></span><br></pre></td></tr></table></figure><h4 id="阶段同步-phaser"><a class="markdownIt-Anchor" href="#阶段同步-phaser"></a> 阶段同步 <code>Phaser</code></h4><p>Phaser 是 Java 并发里 <strong>最灵活、可重用、可动态注册线程的“阶段同步器”</strong><br />可以理解为：一个可以分成很多阶段（phase）的同步器，每个阶段都要所有“参与者”到齐后才能进入下一阶段，并且参与者数量还可以动态增减。</p><table><thead><tr><th><strong>工具</strong></th><th><strong>问题</strong></th></tr></thead><tbody><tr><td><strong>CountDownLatch</strong></td><td>一次性等待，不能复用，不能动态增加线程</td></tr><tr><td><strong>CyclicBarrier</strong></td><td>可复用，但是参与线程数固定，不能动态变化</td></tr><tr><td><strong>Phaser</strong></td><td>✔ 可复用 ✔ 可多阶段 ✔ 可动态增加/减少线程 ✔ 更灵活</td></tr></tbody></table><p>基础使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">3</span>); <span class="comment">// 3 个参与者</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 执行阶段1&quot;</span>);</span><br><span class="line">        phaser.arriveAndAwaitAdvance();  <span class="comment">// 等别人</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 执行阶段2&quot;</span>);</span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 执行阶段3&quot;</span>);</span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T1 执行阶段1</span><br><span class="line">T2 执行阶段1</span><br><span class="line">T3 执行阶段1</span><br><span class="line">--- 阶段1结束 ---</span><br><span class="line">T1 执行阶段2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>核心方法：</p><table><thead><tr><th><strong>方法</strong></th><th><strong>意义</strong></th></tr></thead><tbody><tr><td>arrive()</td><td>到达当前阶段，不等待</td></tr><tr><td>arriveAndAwaitAdvance()</td><td>到达并等待其他线程（最常用）</td></tr><tr><td>arriveAndDeregister()</td><td>到达后退出，不再参加后续阶段</td></tr></tbody></table><p>phaser可以动态注册线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phaser.register(); <span class="comment">// 新线程加入同步控制</span></span><br></pre></td></tr></table></figure><p>一个例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">1</span>); <span class="comment">// main 是 1 个参与者</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    Phaser ph;</span><br><span class="line">    Player(Phaser ph) &#123; <span class="built_in">this</span>.ph = ph; ph.register(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 准备进入游戏&quot;</span>);</span><br><span class="line">        ph.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 加载地图&quot;</span>);</span><br><span class="line">        ph.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 加载角色&quot;</span>);</span><br><span class="line">        ph.arriveAndAwaitAdvance();</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 完成所有加载&quot;</span>);</span><br><span class="line">        ph.arriveAndDeregister();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Phaser</span> <span class="variable">ph</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">1</span>); <span class="comment">// main</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(ph), <span class="string">&quot;玩家1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(ph), <span class="string">&quot;玩家2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    ph.arriveAndAwaitAdvance(); <span class="comment">// 主线程同步各阶段</span></span><br><span class="line">    ph.arriveAndAwaitAdvance();</span><br><span class="line">    ph.arriveAndAwaitAdvance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="数据交换-exchanger"><a class="markdownIt-Anchor" href="#数据交换-exchanger"></a> 数据交换 <code>Exchanger</code></h4><p><code>Exchanger</code> 用于两个线程之间的数据交换。它提供一个同步点，在这个点，两个线程可以交换彼此的数据。</p><ul><li><strong>核心逻辑</strong>：当一个线程调用 <code>exchange()</code> 时，它会阻塞直到第二个线程也调用该方法。然后两个线程交换数据并返回。</li><li><strong>特性</strong>：只能成对使用（2个线程）。</li><li><strong>场景</strong>：两个流水线环节的数据传递，或者遗传算法中的交叉操作。</li></ul><p>一个简单的示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;A线程数据&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> exchanger.exchange(data);</span><br><span class="line">        System.out.println(<span class="string">&quot;A 得到：&quot;</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;B线程数据&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> exchanger.exchange(data);</span><br><span class="line">        System.out.println(<span class="string">&quot;B 得到：&quot;</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure><h3 id="第五章线程池架构-executor-framework"><a class="markdownIt-Anchor" href="#第五章线程池架构-executor-framework"></a> 第五章：线程池架构 (Executor Framework)</h3><p>在实际生产开发中，我们几乎从不手动 <code>new Thread()</code>。为了节省系统资源并提高响应速度，我们会使用线程池来管理线程。</p><h4 id="为什么要用线程池"><a class="markdownIt-Anchor" href="#为什么要用线程池"></a> 为什么要用线程池？</h4><p>创建一个 Java 线程需要调用操作系统的内核 API，这是一个昂贵的操作。</p><ul><li><strong>降低资源消耗</strong>：通过池化技术重复利用已创建的线程，减少线程创建和销毁的性能开销。</li><li><strong>提高响应速度</strong>：任务到达时，无需等待线程创建即可立即执行。</li><li><strong>提高线程的可管理性</strong>：线程是稀缺资源，使用线程池可以统一分配、调优和监控，防止无限制创建线程导致系统崩溃（OOM）。</li></ul><h4 id="threadpoolexecutor-核心参数"><a class="markdownIt-Anchor" href="#threadpoolexecutor-核心参数"></a> <code>ThreadPoolExecutor</code> 核心参数</h4><p>所有的线程池底层都是 <code>ThreadPoolExecutor</code>，包含七个核心的参数：</p><table><thead><tr><th><strong>参数</strong></th><th><strong>名称</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><code>corePoolSize</code></td><td><strong>核心线程数</strong></td><td>线程池中常驻的“保底”线程数量，即使它们闲着也不会被销毁。</td></tr><tr><td><code>maximumPoolSize</code></td><td><strong>最大线程数</strong></td><td>线程池允许创建的最大线程总量。</td></tr><tr><td><code>keepAliveTime</code></td><td><strong>存活时间</strong></td><td>当线程数大于核心线程数时，多余的空闲线程能活多久。</td></tr><tr><td><code>unit</code></td><td><strong>时间单位</strong></td><td><code>keepAliveTime</code> 的时间单位（秒、毫秒等）。</td></tr><tr><td><code>workQueue</code></td><td><strong>任务队列</strong></td><td>存放待执行任务的阻塞队列（BlockingQueue）。</td></tr><tr><td><code>threadFactory</code></td><td><strong>线程工厂</strong></td><td>用于创建新线程，通常在这里给线程起个有意义的名字。</td></tr><tr><td><code>handler</code></td><td><strong>拒绝策略</strong></td><td>当队列满了且线程数达到最大值时，如何处理新来的任务。</td></tr></tbody></table><h4 id="线程池工作流程与拒绝策略"><a class="markdownIt-Anchor" href="#线程池工作流程与拒绝策略"></a> 线程池工作流程与拒绝策略</h4><p>线程池的处理逻辑遵循“<strong>先核心，再队列，后最大</strong>”的原则：</p><ol><li><strong>提交任务</strong>：如果当前线程数 &lt; <code>corePoolSize</code>，直接创建新线程执行。</li><li><strong>进入队列</strong>：如果线程数 ≥ <code>corePoolSize</code>，任务进入 <code>workQueue</code> 排队。</li><li><strong>尝试扩容</strong>：如果队列满了且线程数 &lt; <code>maximumPoolSize</code>，创建非核心线程执行。</li><li><strong>触发拒绝</strong>：如果队列满了且线程数 = <code>maximumPoolSize</code>，执行拒绝策略。</li></ol><p><strong>JDK 自带的四种拒绝策略：</strong></p><ul><li><strong>AbortPolicy</strong>（默认）：直接抛出 <code>RejectedExecutionException</code> 异常，阻止系统正常工作。</li><li><strong>CallerRunsPolicy</strong>：“谁提交谁执行”。让提交任务的线程（比如主线程）自己去跑这个任务，从而降低任务提交速度。</li><li><strong>DiscardPolicy</strong>：直接丢弃任务，不予任何处理也不报错。</li><li><strong>DiscardOldestPolicy</strong>：丢弃队列里最老的一个任务，尝试再次提交当前任务。</li></ul><h4 id="工厂类-executors"><a class="markdownIt-Anchor" href="#工厂类-executors"></a> 工厂类 <code>Executors</code></h4><p>常用方法：<br />•Executors.newFixedThreadPool(n)：固定大小线程池<br />•Executors.newCachedThreadPool()：弹性线程池<br />•Executors.newSingleThreadExecutor()：单线程<br />•Executors.newScheduledThreadPool(n)：定时任务线程池</p><h5 id="executorservice线程池接口"><a class="markdownIt-Anchor" href="#executorservice线程池接口"></a> ExecutorService（线程池接口）</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Executor</span><br><span class="line">  │</span><br><span class="line">  ├── ExecutorService</span><br><span class="line">  │        │</span><br><span class="line">  │        └── AbstractExecutorService</span><br><span class="line">  │                │</span><br><span class="line">  │                └── ThreadPoolExecutor  ← 普通线程池核心</span><br><span class="line">  │</span><br><span class="line">  └── ScheduledExecutorService</span><br><span class="line">           │</span><br><span class="line">           └── ScheduledThreadPoolExecutor ← 定时任务线程池核心</span><br></pre></td></tr></table></figure><p>常用方法：<br />•submit()：提交任务<br />•shutdown()：优雅关闭<br />•shutdownNow()：强制终止</p><h5 id="scheduledexecutorservice"><a class="markdownIt-Anchor" href="#scheduledexecutorservice"></a> <strong>ScheduledExecutorService</strong></h5><p>用于执行定时任务、周期任务。<br />包含：<br /><code>schedule()</code><br /><code>scheduleAtFixedRate()</code><br /><code>scheduleWithFixedDelay()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个具有2个线程的定时任务线程池</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">scheduler</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 延迟 3 秒执行一次任务</span></span><br><span class="line">        scheduler.schedule(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务 A：延迟 3 秒执行 -&gt; &quot;</span> + System.currentTimeMillis());</span><br><span class="line">        &#125;, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 每隔 2 秒执行一次任务（固定频率）</span></span><br><span class="line">        scheduler.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务 B：每隔 2 秒执行 -&gt; &quot;</span> + System.currentTimeMillis());</span><br><span class="line">        &#125;, <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 程序不退出，保持执行</span></span><br><span class="line">        <span class="comment">// 若想停止，稍后调用 scheduler.shutdown();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="forkjoinpool-分治思想"><a class="markdownIt-Anchor" href="#forkjoinpool-分治思想"></a> <code>ForkJoinPool</code> (分治思想)</h4><p>ForkJoinPool 是一种专门用于“分而治之（Fork）+ 合并结果（Join）”的高效并行计算线程池，它用来处理大量可以拆分的任务，自动进行任务窃取（work-stealing）以提升 CPU 利用率。</p><p>你一般只需要继承：<br />•RecursiveAction（void 任务）<br />•RecursiveTask（有返回值任务）</p><p>大数组求和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SumTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span>[] arr;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> start, end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SumTask</span><span class="params">(<span class="type">long</span>[] arr, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.arr = arr;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> end - start;</span><br><span class="line">        <span class="keyword">if</span> (length &lt;= THRESHOLD) &#123; <span class="comment">// 小任务直接算</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) sum += arr[i];</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> start + length / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">SumTask</span> <span class="variable">left</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(arr, start, mid);</span><br><span class="line">        <span class="type">SumTask</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(arr, mid, end);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分裂</span></span><br><span class="line">        left.fork();</span><br><span class="line">        right.fork();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合并</span></span><br><span class="line">        <span class="keyword">return</span> left.join() + right.join();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span>[] arr = <span class="keyword">new</span> <span class="title class_">long</span>[<span class="number">1000000</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) arr[i] = i;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> pool.invoke(<span class="keyword">new</span> <span class="title class_">SumTask</span>(arr, <span class="number">0</span>, arr.length));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;总和：&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="future"><a class="markdownIt-Anchor" href="#future"></a> Future</h4><p>Future 表示一个异步计算的结果，你可以在提交任务后立即得到 Future 对象，以后再从这个对象中取结果。<br />其接口为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span>;</span><br><span class="line">    V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line">    V <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">         <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>future的最常见来源：线程池的 <strong>submit()</strong> 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;Integer&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>得到的 future 就是异步结果句柄。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;String&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 模拟耗时任务</span></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;任务完成&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;我先做点别的事...&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到结果（阻塞）</span></span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get();</span><br><span class="line"></span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我先做点别的事...</span><br><span class="line">任务完成</span><br></pre></td></tr></table></figure><p>因此，future可以 通过 get() 方法获取异步执行的结果（阻塞等待）。<br />同时，也可以通过cancel取消任务，通过isDone判断任务是否完成，通过get(timeout)等待固定时间，如果任务还没完成，则抛 TimeoutException。</p><h3 id="第六章异步编程-asynchronous-programming"><a class="markdownIt-Anchor" href="#第六章异步编程-asynchronous-programming"></a> 第六章：异步编程 (Asynchronous Programming)</h3><h4 id="future-的局限性"><a class="markdownIt-Anchor" href="#future-的局限性"></a> <code>Future</code> 的局限性</h4><p>虽然 <code>Future</code> 开启了异步执行的先河，但它在处理复杂业务逻辑时非常笨拙：</p><ul><li><strong>阻塞等待</strong>：要获取结果只能调用 <code>get()</code>，如果子线程没跑完，主线程必须在此阻塞，这实际上把异步变成了同步等待。</li><li><strong>轮询耗能</strong>：如果不阻塞，就得用 <code>isDone()</code> 开启死循环轮询，极度消耗 CPU。</li><li><strong>无法回调</strong>：无法表达“任务完成后自动执行下一步”的逻辑。</li><li><strong>编排困难</strong>：很难将多个 <code>Future</code> 的结果组合在一起，代码会嵌套得非常难看（回调地狱）。</li></ul><h4 id="completablefuture"><a class="markdownIt-Anchor" href="#completablefuture"></a> <code>CompletableFuture</code></h4><p>JDK 8 引入的 <code>CompletableFuture</code> 是异步编程的里程碑。它实现了 <code>Future</code> 和 <code>CompletionStage</code> 两个接口，支持任务的回调、组合和链式编排。</p><h5 id="异步任务的启动与执行策略"><a class="markdownIt-Anchor" href="#异步任务的启动与执行策略"></a> 异步任务的启动与执行策略</h5><p>任务的启动通常依赖于静态工厂方法。<code>supplyAsync</code> 用于启动具有返回值的异步计算，而 <code>runAsync</code> 则适用于仅需执行特定动作且无需返回结果的场景。在资源调度层面，若不指定 <code>Executor</code>，这些任务默认由 <code>ForkJoinPool.commonPool()</code> 承载，但在生产环境下，通常建议传入自定义线程池以实现业务间的资源隔离与监控。</p><h5 id="异步链路的回调处理机制"><a class="markdownIt-Anchor" href="#异步链路的回调处理机制"></a> 异步链路的回调处理机制</h5><p>在任务完成后，<code>CompletableFuture</code> 支持通过链式调用定义回调逻辑。<code>thenApply</code> 方法能够获取前一阶段的执行结果并对其进行转换，产生一个新的返回值，从而构建出流水线式的处理链路。与之相对，<code>thenAccept</code> 仅用于消费前序任务的结果而不产生新的输出，而 <code>thenRun</code> 则完全忽略结果，仅在任务完成这一特定时机触发后续动作。</p><h5 id="多任务的逻辑编排与协同"><a class="markdownIt-Anchor" href="#多任务的逻辑编排与协同"></a> 多任务的逻辑编排与协同</h5><p>针对复杂的并发场景，<code>CompletableFuture</code> 提供了强大的编排能力。对于存在先后依赖关系的串行任务，<code>thenCompose</code> 可以将前一个任务的输出平滑传递给下一个异步任务；而对于互不依赖、需并行执行的任务，<code>thenCombine</code> 支持在两个任务全部完成后对其结果进行聚合。在更宏观的层面，<code>allOf</code> 提供了阻塞式同步机制，确保所有并行的异步任务全部完成后再向下执行，而 <code>anyOf</code> 则实现了竞争逻辑，只要其中任意一个任务率先完成即返回其结果。</p><h5 id="异步链路的异常捕获与容错"><a class="markdownIt-Anchor" href="#异步链路的异常捕获与容错"></a> 异步链路的异常捕获与容错</h5><p>异步编程中的异常传播与传统同步代码有所不同，需要专门的兜底机制。<code>exceptionally</code> 方法类似于同步代码中的 catch 块，能够在链路出现异常时拦截错误并返回一个预设的默认值，确保后续链路不会因未捕获的异常而中断。此外，<code>handle</code> 方法提供了更全面的控制，无论前序任务是正常结束还是抛出异常，它均能接收到执行结果或异常对象，并进行统一的处理与转换。</p><p>举一个链式流水线的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;查询商品ID:123&quot;</span>)</span><br><span class="line">    .thenApply(id -&gt; <span class="string">&quot;获取商品价格: $99&quot;</span>) <span class="comment">// 链式处理</span></span><br><span class="line">    .thenCombine(CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;获取优惠券: -$10&quot;</span>), </span><br><span class="line">        (price, coupon) -&gt; price + <span class="string">&quot; &quot;</span> + coupon) <span class="comment">// 组合两个异步任务</span></span><br><span class="line">    .thenAccept(finalResult -&gt; System.out.println(<span class="string">&quot;最终报价: &quot;</span> + finalResult))</span><br><span class="line">    .exceptionally(e -&gt; &#123; </span><br><span class="line">        System.err.println(<span class="string">&quot;出错: &quot;</span> + e.getMessage()); </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h4 id="completionservice"><a class="markdownIt-Anchor" href="#completionservice"></a> <code>CompletionService</code></h4><p><code>CompletionService&lt;V&gt;</code> 是一个接口，用于 提交异步任务并按完成顺序获取结果。它结合了 Executor（线程池）和 BlockingQueue 的功能。任务完成顺序与提交顺序可能不同，使用 CompletionService 可以 按照完成顺序 获取任务结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletionServiceExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        CompletionService&lt;String&gt; service = <span class="keyword">new</span> <span class="title class_">ExecutorCompletionService</span>&lt;&gt;(pool);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交任务</span></span><br><span class="line">        service.submit(() -&gt; &#123; Thread.sleep(<span class="number">300</span>); <span class="keyword">return</span> <span class="string">&quot;Task 1&quot;</span>; &#125;);</span><br><span class="line">        service.submit(() -&gt; &#123; Thread.sleep(<span class="number">100</span>); <span class="keyword">return</span> <span class="string">&quot;Task 2&quot;</span>; &#125;);</span><br><span class="line">        service.submit(() -&gt; &#123; Thread.sleep(<span class="number">200</span>); <span class="keyword">return</span> <span class="string">&quot;Task 3&quot;</span>; &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 按完成顺序获取结果</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Future&lt;String&gt; future = service.take();  <span class="comment">// 阻塞直到有任务完成</span></span><br><span class="line">            System.out.println(future.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第七章并发容器-concurrent-collections"><a class="markdownIt-Anchor" href="#第七章并发容器-concurrent-collections"></a> 第七章：并发容器 (Concurrent Collections)</h3><h4 id="concurrenthashmap-原理"><a class="markdownIt-Anchor" href="#concurrenthashmap-原理"></a> <code>ConcurrentHashMap</code> 原理</h4><p><code>ConcurrentHashMap</code> 是为了解决 <code>Hashtable</code> 全局锁定导致并发效率低下的问题而设计的。在 Java 8 及其后续版本中，它舍弃了早期版本中的分段锁（Segment）设计，转而采用 <strong>Node 数组 + 链表 + 红黑树</strong> 的结构，并结合 <strong>CAS（Compare-And-Swap）</strong> 和 <strong>synchronized</strong> 实现更细粒度的锁控制。</p><p>在执行读操作时，<code>ConcurrentHashMap</code> 完全不加锁，通过 <code>volatile</code> 关键字保证了数据的可见性，这使得它在读取密集的场景下表现极佳。在执行写操作时，它仅锁定当前正在操作的哈希桶（即 Node 数组的头节点），而不是整个 Map。这种“局部锁定”的策略允许多个线程同时对不同的哈希桶进行写入。此外，当链表长度超过阈值（默认为 8）且数组容量大于 64 时，链表会转化为红黑树，以保证在高碰撞情况下的查询效率仍能维持在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>。</p><h4 id="copyonwritearraylist"><a class="markdownIt-Anchor" href="#copyonwritearraylist"></a> <code>CopyOnWriteArrayList</code></h4><p><code>CopyOnWriteArrayList</code> 采用了一种极其独特的“写时复制”（Copy-On-Write）策略。它的核心思想是：当你对容器进行修改（添加、删除、设置元素）时，它并不直接修改当前数组，而是先将原数组拷贝一份副本，在副本上完成修改操作，最后再将原数组的引用指向这个新副本。</p><p>这种机制带来了显著的特性：<strong>读操作完全无锁且不阻塞</strong>。当一个线程在遍历列表时，即使有另一个线程正在进行修改，遍历线程看到的依然是修改前的旧数组镜像，因此它天然地解决了并发修改异常（<code>ConcurrentModificationException</code>）。然而，这种设计也存在明显的权衡，即每次修改都会导致数组拷贝，内存开销较大。因此，它仅适用于<strong>读多写极少</strong>且对实时性要求不是极高的场景（例如配置白名单或监听器列表）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写操作示例：内部会加锁并复制数组</span></span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="string">&quot;data&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 读操作示例：直接读取引用，性能极高</span></span><br><span class="line"><span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> list.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h4 id="阻塞队列-blockingqueue-全家桶"><a class="markdownIt-Anchor" href="#阻塞队列-blockingqueue-全家桶"></a> 阻塞队列 <code>BlockingQueue</code> 全家桶</h4><p><code>BlockingQueue</code> 是实现“生产者-消费者”模型的灵魂组件。它与普通队列的区别在于支持<strong>阻塞机制</strong>：当队列为空时，尝试取出的线程会被阻塞直到有数据可用；当队列满时，尝试存入的线程会被阻塞直到队列出现空位。</p><p>JUC 提供了多种不同特性的实现类。<code>ArrayBlockingQueue</code> 基于定长数组，强制要求设置初始容量，适合任务量稳定的系统。<code>LinkedBlockingQueue</code> 基于链表，默认容量为 <code>Integer.MAX_VALUE</code>，如果不设限可能会导致内存溢出。<code>SynchronousQueue</code> 则更为特殊，它不存储任何元素，每一个插入操作必须等待另一个线程的移除操作，是线程间“手递手”传递数据的桥梁。此外，还有支持优先级的 <code>PriorityBlockingQueue</code> 和处理延迟任务的 <code>DelayQueue</code>。这些队列通过内部的 <code>ReentrantLock</code> 和 <code>Condition</code> 机制，优雅地解决了线程间的同步调度问题。</p><h3 id="第八章-死锁"><a class="markdownIt-Anchor" href="#第八章-死锁"></a> 第八章 死锁</h3><p>在多线程环境下，<strong>死锁（Deadlock）</strong> 是最令人头疼的并发问题之一。它发生在两个或多个线程互相持有对方所需的资源，导致所有相关线程都进入无限期的等待状态。</p><h4 id="死锁的四大必要条件"><a class="markdownIt-Anchor" href="#死锁的四大必要条件"></a> 死锁的四大必要条件</h4><p>根据经典操作系统理论，死锁的发生必须同时满足以下四个条件。如果能破坏其中任何一个，死锁就不会发生：</p><ol><li><strong>互斥条件（Mutual Exclusion）</strong>：<br />资源是独占的。在某一时刻，一个资源（如一个对象锁）只能被一个线程持有。如果其他线程请求该资源，必须等待直到持有者释放。</li><li><strong>占有且等待（Hold and Wait）</strong>：<br />一个线程已经持有了至少一个资源，但又提出了新的资源请求，而该资源正被其他线程占有。此时请求线程阻塞，但对自己已获得的资源保持不放。</li><li><strong>不可剥夺（No Preemption）</strong>：<br />线程已获得的资源在未使用完之前，不能被其他线程强行夺走，只能由该线程在完成任务后主动释放。</li><li><strong>循环等待（Circular Wait）</strong>：<br />存在一个线程的资源循环链。例如，线程 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">T1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">1</span></span></span></span> 等待 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">T2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">2</span></span></span></span> 占有的资源，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">T2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">2</span></span></span></span> 等待 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">T3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">3</span></span></span></span> 的资源……最后 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">Tn</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">n</span></span></span></span> 又在等待 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">T1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">1</span></span></span></span> 占有的资源。</li></ol><p>举个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">lockA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="type">Object</span> <span class="variable">lockB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 t1：先拿 A，再拿 B</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lockA) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125; <span class="comment">// 确保 t2 拿到了 B</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lockB) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1 acquired both locks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 t2：先拿 B，再拿 A</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lockB) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125; <span class="comment">// 确保 t1 拿到了 A</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lockA) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2 acquired both locks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure><p>在这个例子中，Thread.sleep(100) 是产生死锁的关键催化剂。它保证了 t1 锁住 lockA 的同时，t2 有足够的时间锁住 lockB。此时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">t1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">1</span></span></span></span> 试图获取 lockB 时会因为“互斥”被阻塞，同时它“占有且等待”着 lockA；<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">t2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">2</span></span></span></span> 同理。由于锁是“不可剥夺”的，最终形成了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mn>1</mn><mo>→</mo><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>B</mi><mo>→</mo><mi>t</mi><mn>2</mn><mo>→</mo><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>A</mi><mo>→</mo><mi>t</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">t1 \rightarrow lockB \rightarrow t2 \rightarrow lockA \rightarrow t1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">1</span></span></span></span> 的循环等待。</p><p><strong>如何排查死锁？</strong><br />当程序突然“卡死”且 CPU 占用率极低时，极有可能是发生了死锁。你可以使用 JDK 自带的工具进行检测：</p><ol><li><strong><code>jcmd / jps</code></strong>：获取运行中的 Java 进程 ID。</li><li><strong><code>jstack &lt;pid&gt;</code></strong>：打印线程堆栈。如果存在死锁，<code>jstack</code> 会在末尾明确提示 <code>Found one Java-level deadlock</code>，并详细列出是哪些线程在哪个对象上互相折磨。</li></ol><p><strong>如何预防死锁？</strong></p><ol><li><strong>固定加锁顺序</strong>（破坏循环等待）：这是最常用的方案。让 <code>t1</code> 和 <code>t2</code> 都按照“先拿 A 再拿 B”的顺序去竞争，这样就不会形成环路。</li><li><strong>尝试性获取锁</strong>（破坏不可剥夺）：使用 <code>ReentrantLock</code> 的 <code>tryLock(long time, TimeUnit unit)</code> 方法。如果线程在规定时间内拿不到下一把锁，就主动释放已经拿到的锁，退回并重试。</li><li><strong>减小锁粒度</strong>：尽量不要在一个同步块中嵌套另一个同步块。</li></ol><h3 id="第九章-thread内存泄漏"><a class="markdownIt-Anchor" href="#第九章-thread内存泄漏"></a> 第九章 Thread内存泄漏</h3><p>在多线程开发中，除了死锁，另一个隐蔽且高发的陷阱是 <strong>ThreadLocal 导致的内存泄漏</strong>。这通常发生在长生命周期的线程（如线程池中的线程）中。</p><h4 id="threadlocal-内存泄漏的根源"><a class="markdownIt-Anchor" href="#threadlocal-内存泄漏的根源"></a> ThreadLocal 内存泄漏的根源</h4><p><code>ThreadLocal</code> 的原理是为每个线程维护一个私有的 <code>ThreadLocalMap</code>。这个 Map 的特殊之处在于它的内部结构：其 <strong>Key（ThreadLocal 实例）是弱引用（WeakReference）</strong>，而 <strong>Value（存储的数据）是强引用</strong>。</p><p>这种设计的初衷是为了保护内存：当外部不再持有 <code>ThreadLocal</code> 实例的强引用时，Key 会在下一次 GC 时被回收，变成 <code>null</code>。然而，问题也就此产生。虽然 Key 消失了，但 <strong>Value 依然被线程的 <code>ThreadLocalMap</code> 以强引用的方式持有</strong>。</p><p>如果这个线程是普通线程，执行完任务就销毁了，那么整个 Map 都会被回收。但现代应用几乎都在使用<strong>线程池</strong>。线程池中的线程是高度复用的，这意味着：</p><ol><li>线程永远不会结束。</li><li><code>ThreadLocalMap</code> 里的那块 Value 内存会一直被占用。</li><li>由于 Key 变成了 <code>null</code>，你再也没有办法通过正常途径访问到这块 Value，它成了一块“幽灵内存”。</li></ol><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalLeakDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;<span class="type">byte</span>[]&gt; localData = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟一个固定大小为 5 的线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            pool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// 每个任务占用 5MB 内存</span></span><br><span class="line">                localData.set(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>]);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 设置了数据&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 注意：这里没有调用 localData.remove()</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上述代码中，虽然任务执行完了，但由于线程池里的线程没死，每个线程持有的 5MB 字节数组会一直驻留在内存中。如果任务不断提交，内存占用会持续攀升，最终导致 <code>OutOfMemoryError</code>。</p><p>使用 <code>jvisualvm</code> 或 <code>MAT</code> (Memory Analyzer Tool) 查看堆转储（Heap Dump）。如果你发现 <code>ThreadLocalMap</code> 里的 <code>Entry</code> 数量异常多，且其 <code>value</code> 字段占用了大量内存，基本可以确定是泄漏。</p><p>在代码中使用 <code>ThreadLocal</code> 时，务必遵循 <code>try-finally</code> 模式，在 <code>finally</code> 块中调用 <code>remove()</code> 方法。这会清除当前线程 Map 中对应的 Entry。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    localData.set(value);</span><br><span class="line">    <span class="comment">// 执行业务逻辑</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 关键：任务结束前一定要清理，尤其是在线程池环境下</span></span><br><span class="line">    localData.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;万字长文梳理JAVA线程方法的基础应用&lt;/p&gt;</summary>
    
    
    
    <category term="编程学习-java" scheme="https://atffang.github.io/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0-java/"/>
    
    
  </entry>
  
  <entry>
    <title>MTMCT方向的度量学习梳理</title>
    <link href="https://atffang.github.io/2025/12/21/MTMCT%E6%96%B9%E5%90%91%E7%9A%84%E5%BA%A6%E9%87%8F%E5%AD%A6%E4%B9%A0%E6%A2%B3%E7%90%86/"/>
    <id>https://atffang.github.io/2025/12/21/MTMCT%E6%96%B9%E5%90%91%E7%9A%84%E5%BA%A6%E9%87%8F%E5%AD%A6%E4%B9%A0%E6%A2%B3%E7%90%86/</id>
    <published>2025-12-21T07:11:01.000Z</published>
    <updated>2026-01-10T14:28:46.194Z</updated>
    
    <content type="html"><![CDATA[<p>MTMCT方向的度量学习梳理。</p><span id="more"></span><h3 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h3><p>在以行人重识别（Person Re-Identification, ReID）为代表的一些视觉任务中，测试阶段出现的类别（即具体的行人身份或目标ID）在训练阶段是未知的。这从根本上要求模型具备提取具备强判别力（Discriminative）且高泛化性特征的能力，而非单纯地记忆训练集中的类别标签。</p><p><strong>度量学习，Metric Learning</strong> 正是解决这一核心矛盾的关键技术途径。其本质旨在通过深度神经网络构建一个非线性的<strong>特征映射函数</strong>，将存在于高维像素空间的原始数据投影至低维的<strong>嵌入空间</strong>（Embedding Space）或流形（Manifold）上。在此度量空间中，<strong>距离度量</strong>（如欧氏距离或余弦相似度）直接对应于样本间的语义相似度。</p><p>理想的度量学习模型应当满足两个基本几何约束：</p><ul><li><strong>同类样本在特征空间中高度紧凑</strong>（Intra-class Compactness）</li><li><strong>异类样本在特征空间中尽可能分离</strong>（Inter-class Separability）</li></ul><h4 id="问题定义"><a class="markdownIt-Anchor" href="#问题定义"></a> 问题定义</h4><p>从数学角度形式化地看，度量学习的目标是学习一个参数化的映射函数：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>θ</mi></msub><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">f_\theta: \mathcal{X} \rightarrow \mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8991079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">\mathcal{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span></span></span></span> 为输入图像空间，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> 维特征向量空间。</p><p>对于任意给定的三元组样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_a, x_p, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">x_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为锚点样本，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">x_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 为与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">x_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 同一身份的正样本，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">x_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为不同身份的负样本，度量学习旨在优化参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>，使得在映射后的特征空间中满足：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>p</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>≪</mo><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(f_\theta(x_a), f_\theta(x_p)) \ll D(f_\theta(x_a), f_\theta(x_n))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo separator="true">,</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(\cdot, \cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span> 为预定义的距离度量函数。</p><h4 id="当前优化的方向"><a class="markdownIt-Anchor" href="#当前优化的方向"></a> 当前优化的方向</h4><p>首先是传统损失函数的优化瓶颈，以最经典的 Softmax 为例，Softmax 交叉熵损失函数虽然在概率空间能够有效区分训练类别，但在特征空间并未施加显式的距离约束，导致学习到的特征在类内分布较为松散。</p><p>具体来说，Softmax 的目标是最大化正确类别的后验概率。在数学上，只要特征向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{f}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 在正确类别权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">w</mi><msub><mi>y</mi><mi>i</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf{w}_{y_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 方向上的投影比在其他类别方向上的投影稍微大一点，Loss 就会减小。也就是说，只要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 被分到了类 A，哪怕它仅仅跨过了决策边界一点点，模型也认为任务完成了。但在度量学习任务中，不仅 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 要被分到类 A，而且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 必须尽可能靠近类 A 的中心，并且远离类 B。</p><p>其次是<strong>困难样本挖掘</strong>的策略设计。在海量训练数据中，绝大多数样本对包含的梯度信息极其微弱，即模型已能轻易区分大部分不同类别，只有少数位于决策边界附近的<strong>困难样本</strong>对模型的优化具有实质性贡献。如何高效地筛选出这些高价值样本，同时避免因标注噪声导致的模型坍塌，是设计高效度量学习系统的关键。</p><p>此外，特征空间的几何结构选择亦至关重要。早期的研究多基于欧氏空间进行度量，但近年来的研究表明，将特征归一化并约束在超球面上，利用角度距离代替欧氏距离往往更加有效。</p><p>具体来说，在传统的欧氏空间（欧氏距离）中，特征向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">f</mi></mrow><annotation encoding="application/x-tex">\mathbf{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span></span></span></span> 的长度（范数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi mathvariant="bold">f</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|\mathbf{f}\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="mord">∥</span></span></span></span>）代表了模型对该样本的置信度或显著性，在某个方面可以理解为图像的清晰度。在计算欧氏距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="bold">f</mi><mn>1</mn></msub><mo>−</mo><msub><mi mathvariant="bold">f</mi><mn>2</mn></msub><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\| \mathbf{f}_1 - \mathbf{f}_2 \|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∥</span></span></span></span> 时，模长的差异会掩盖方向的相似性。模型可能会因为两张图片的“清晰度”相近而认为它们是同一个人。</p><p>而超球面（Hypersphere）的解法：通过归一化，将所有特征映射到模长为 1 的超球面上。模型被迫只通过“方向”来判别身份，消除了图像质量、光照等因素带来的幅值干扰。</p><h3 id="相关工作reid与mtmct方向"><a class="markdownIt-Anchor" href="#相关工作reid与mtmct方向"></a> 相关工作（REID与MTMCT方向）</h3><h4 id="深度度量学习范式"><a class="markdownIt-Anchor" href="#深度度量学习范式"></a> 深度度量学习范式</h4><p><strong>深度度量学习</strong>（Deep Metric Learning, <strong>DML</strong>）旨在通过深度神经网络将语义相似的图像映射到邻近的特征空间。根据优化目标的构建方式，现有的主流方法可大致划分为基于样本对（Pair-based）的方法和基于代理（Proxy-based）的方法两大类。</p><p><strong>基于样本对</strong>的方法直接在样本之间构建约束。早期的开创性工作如 <strong>Siamese Network</strong>（孪生网络）引入了<strong>对比损失</strong>（Contrastive Loss），该方法接受一对样本作为输入，通过拉近正样本对距离并推远负样本对距离来学习特征表示。</p><h5 id="contrastive-loss"><a class="markdownIt-Anchor" href="#contrastive-loss"></a> Contrastive Loss</h5><p>假设有一对输入样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_i, x_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其对应的特征嵌入为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。我们定义这两者在特征空间中的欧氏距离为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi mathvariant="normal">∥</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo><msub><mi mathvariant="normal">∥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">d_{ij} = \| f(x_i) - f(x_j) \|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>为了区分样本对的关系，定义标签 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">y \in \{0, 1\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span>：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 表示同类样本（Positive Pair）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 表示异类样本（Negative Pair）</li></ul><p>对比损失函数的标准形式如下：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo fence="true">[</mo><mi>y</mi><mo>⋅</mo><msubsup><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><mn>0</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(d_{ij}) = \frac{1}{2} \left[ y \cdot d_{ij}^2 + (1 - y) \cdot \max(m - d_{ij}, 0)^2 \right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span></span></p><p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">m &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 是一个预设的阈值（Margin）。</p><p>这个公式不是很好理解，我们拆解<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>的两种情况：</p><ul><li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 时，同类拉近，公式简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\mathcal{L} = \frac{1}{2} d_{ij}^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2398799999999999em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span>。这是一个二次函数，其最小值在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d_{ij}=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 处取得。无论正样本对靠得有多近，损失函数始终施加一个向心的拉力，让他们可以更加靠近。</li><li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 时（异类推远）公式简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><mn>0</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\mathcal{L} = \frac{1}{2} \max(m - d_{ij}, 0)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1002159999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>。这是一个分段函数。只有当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&lt;</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">d_{ij} &lt; m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> 时，损失才大于 0。如果两个不同类别的样本离得足够远（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>≥</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">d_{ij} \ge m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>），模型认为它们已经安全，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">Loss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span></span></span></span> 变为 0，不产生任何斥力。如果它们靠得太近（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&lt;</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">d_{ij} &lt; m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>），损失函数会产生一个斥力，将它们推开，直到距离至少为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>。</li></ul><h5 id="triplet-loss"><a class="markdownIt-Anchor" href="#triplet-loss"></a> Triplet Loss</h5><p>对比损失是二元的，它孤立地看正对（Positive Pair）或负对（Negative Pair）。其数学局限在于：</p><ul><li>它迫使所有正对的距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 趋近于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></li><li>它迫使所有负对的距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 必须大于固定值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span></li></ul><p>FaceNet 提出的<strong>三元组损失</strong>（Triplet Loss）将约束关系扩展至三元组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mi>n</mi><mi>c</mi><mi>h</mi><mi>o</mi><mi>r</mi><mo separator="true">,</mo><mi>P</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo separator="true">,</mo><mi>N</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(Anchor, Positive, Negative)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span>，不再强制要求正负样本对的绝对距离，而是关注它们之间的相对距离差。这种相对约束极大地提升了模型在人脸识别和行人重识别等开集任务中的判别能力，成为该领域的经典基准。</p><p>三元组损失的函数定义为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo><mo>−</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>+</mo><mi>α</mi><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{L} = \max(d(a, p) - d(a, n) + \alpha, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span></p><p>在三元组约束下，模型不再局限于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d(a, p) \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>。只要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 小一个间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> 即可。比如，如果某人的特征本身较分散（例如姿态多变），模型允许其 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 稍大（如 0.5），只要负样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 被推到更远（如 1.0）即可。</p><h4 id="困难样本挖掘策略"><a class="markdownIt-Anchor" href="#困难样本挖掘策略"></a> 困难样本挖掘策略</h4><p>在度量学习的训练过程中，样本的选择策略对模型性能的影响往往大于损失函数本身。由于深度网络具有强大的拟合能力，随着训练的进行，绝大多数随机采样的三元组均满足距离约束，这些无效样本不仅浪费计算资源，还会导致梯度消失，使得模型无法进一步优化决策边界。</p><p>为了解决这一梯度稀疏问题，<strong>困难样本挖掘</strong>（Hard Negative Mining）成为必然选择。经典的挖掘策略倾向于寻找那些使得损失函数值最大的“最难”样本。Hermans 等人在行人重识别任务中系统性地验证了多种采样策略，并提出了 Batch Hard（TriHard）采样方法。</p><p>该方法不再依赖全数据集的离线挖掘，而是动态地在每个训练批次（Batch）内，针对每一个 Anchor 样本，选取距离最远的正样本和距离最近的负样本构建三元组。这种在线（Online）挖掘策略在保证训练稳定性的同时，显著提升了模型对外观相似个体的区分能力，目前已成为 ReID 领域的标准配置。</p><h5 id="batch-hard-trihard"><a class="markdownIt-Anchor" href="#batch-hard-trihard"></a> Batch Hard (TriHard)</h5><p>定义一个 Batch 的构成：随机抽取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> 个身份（ID），每个身份抽取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 张图片。Batch 总量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>P</mi><mo>×</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">N = P \times K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>。<br />对于 Batch 中的任意一个锚点样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">x_a^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.071664em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>（属于身份 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span>），TriHard 损失函数的数学表达式为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mrow><mi>B</mi><mi>H</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>P</mi></munderover><munderover><mo>∑</mo><mrow><mi>a</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mrow><mo fence="true">[</mo><mover><mover><mrow><munder><mo><mi>max</mi><mo>⁡</mo></mo><mrow><mi>p</mi><mo>=</mo><mn>1</mn><mo>…</mo><mi>K</mi></mrow></munder><mi>d</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>p</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏞</mo></mover><mtext>最难正样本距离</mtext></mover><mo>−</mo><munder><munder><mrow><munder><mo><mi>min</mi><mo>⁡</mo></mo><mstyle scriptlevel="1"><mtable rowspacing="0.1em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo>=</mo><mn>1</mn><mo>…</mo><mi>P</mi><mo separator="true">,</mo><mi>n</mi><mo>=</mo><mn>1</mn><mo>…</mo><mi>K</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo mathvariant="normal">≠</mo><mi>i</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></munder><mi>d</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>n</mi><mi>j</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>最难负样本距离</mtext></munder><mo>+</mo><mi>α</mi><mo fence="true">]</mo></mrow><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_{BH} = \sum_{i=1}^{P} \sum_{a=1}^{K} \left[ \overbrace{\max_{p=1 \dots K} d(f(x_a^i), f(x_p^i))}^{\text{最难正样本距离}} - \underbrace{\min_{\substack{j=1 \dots P, n=1 \dots K \\ j \neq i}} d(f(x_a^i), f(x_n^j))}_{\text{最难负样本距离}} + \alpha \right]_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:6.192007em;vertical-align:-2.937017em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.882887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.267113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2549900000000003em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.1999800000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-2.79598em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.39198em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.9879800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.0139700000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-5.25499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.2009950000000003em;"><span style="top:-3.5226640000000002em;"><span class="pstrut" style="height:3.5226640000000002em;"></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5226640000000002em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.43055999999999994em;"><span style="top:-2.3556690000000002em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="minner mtight">…</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.880439em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.874664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span class="svg-align" style="top:-3.974664em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M6 548l-6-6v-35l6-11c56-104 135.3-181.3 238-232 57.3-28.7 117-45 179-50h399577v120H403c-43.3 7-81 15-113 26-100.7 33-179.7 91-237 174-2.7 5-6 9-10 13-.7 1-7.3 1-20 1H6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M200428 334c-100.7-8.3-195.3-44-280-108-55.3-42-101.7-93-139-153l-9-14c-2.7 4-5.7 8.7-9 14-53.3 86.7-123.7 153-211 199-66.7 36-137.3 56.3-212 62H0V214h199568c178.3-11.7 311.7-78.3 403-201 6-8 9.7-12 11-12 .7-.7 6.7-1 18-1s17.3.3 18 1c1.3 0 5 4 11 12 44.7 59.3 101.3 106.3 170 141s145.3 54.3 229 60h199572v120z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M400000 542l-6 6h-17c-12.7 0-19.3-.3-20-1-4-4-7.3-8.3-10-13-35.3-51.3-80.8-93.8-136.5-127.5s-117.2-55.8-184.5-66.5c-.7 0-2-.3-4-1-18.7-2.7-76-4.3-172-5H0V214h399571l6 1c124.7 8 235 61.7 331 161 31.3 33.3 59.7 72.7 85 118l7 13v35z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.880439em;"><span></span></span></span></span></span></span><span style="top:-5.245328000000001em;"><span class="pstrut" style="height:3.5226640000000002em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">最难正样本距离</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.880439em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746640000000001em;"><span style="top:-0.171014em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">最难负样本距离</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746640000000001em;"><span class="svg-align" style="top:-0.849345em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6678600000000001em;"><span style="top:-2.0406725000000003em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.133325em;"><span style="top:-3.149995em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="minner mtight">…</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="minner mtight">…</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span><span style="top:-2.261115em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel mtight"></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6333249999999999em;"><span></span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5026549999999999em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.150655em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.828986em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2549900000000003em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.1999800000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-2.79598em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.39198em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.9879800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.0139700000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-5.25499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-2.470355em;"><span style="top:0.17868599999999982em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.937017em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>我们在之前一篇文章中详细解释了这一方法，其核心概念为类内差异的最大化，和类间距离的最小化。</p><ul><li><strong>最大化类内差异</strong>（Max-Pooling in Positives）：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>max</mi><mo>⁡</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\max d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 找到了当前 ID 下分布最散的样本。这是在优化该类别的半径，强制将离群点（Outliers）拉回中心。</li><li><strong>最小化类间距离</strong>（Min-Pooling in Negatives）：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\min d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 找到了距离当前类别最近的异类。这是在探测决策边界。只有通过推开这些“最近邻”的异类，才能在特征空间中腾出足够的缓冲区。</li></ul><h3 id="序列深度度量学习方法"><a class="markdownIt-Anchor" href="#序列深度度量学习方法"></a> 序列深度度量学习方法</h3><h4 id="集合空间的映射形式化"><a class="markdownIt-Anchor" href="#集合空间的映射形式化"></a> 集合空间的映射形式化</h4><p>在基于序列的度量学习中，输入对象不再是单一的样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">x \in \mathcal{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span></span></span></span>，而是一个包含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 帧图像的序列集合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">S</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{S} = \{x_1, x_2, \dots, x_T\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 为变量。</p><p>数学上，我们的目标是学习一个非线性映射函数</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo>:</mo><msup><mi mathvariant="script">X</mi><mi>T</mi></msup><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\Phi: \mathcal{X}^T \rightarrow \mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Φ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8991079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p><p>将高维的图像序列张量投影为低维的固定长度嵌入向量。<br />这一映射过程必须满足两个关键的数学性质：</p><ul><li><strong>置换不变性</strong>（Permutation Invariance）： 对于集合模型而言，特征表示不应受输入帧顺序的影响（除非显式建模动作信息），即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Phi(x_1, x_2) = \Phi(x_2, x_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li><li><strong>尺寸不变性</strong>（Size Invariance）： 无论输入序列长度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 是 5 帧还是 50 帧，输出特征向量的维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> 必须恒定。为此，序列度量学习通常采用“<strong>编码-聚合</strong>”（Encode-Aggregate）的二阶段数学范式：首先通过 CNN 骨干网络 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">f_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 将每一帧映射为帧级特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>t</mi></msub><mo>=</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">v_t = f_\theta(x_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，随后通过时序聚合函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span> 生成最终的序列表征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">e</mi><mo>=</mo><mi>G</mi><mo stretchy="false">(</mo><mo stretchy="false">{</mo><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>v</mi><mi>T</mi></msub><mo stretchy="false">}</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{e} = G(\{v_1, \dots, v_T\})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">e</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span><span class="mclose">)</span></span></span></span>。</li></ul><h4 id="基于注意力的时序聚合机制"><a class="markdownIt-Anchor" href="#基于注意力的时序聚合机制"></a> 基于注意力的时序聚合机制</h4><p>最朴素的聚合函数是<strong>时间平均池化</strong>（Temporal Average Pooling, TAP），即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><mo>∑</mo><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">G_{avg} = \frac{1}{T}\sum v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。然而，从信息论角度看，序列中的每一帧所含有的“身份信息量”是不均匀的（例如，遮挡帧的信息熵极高，包含大量噪声）。</p><p>为了最大化特征信噪比，现代方法（Quality Aware Network for Set to Set Recognition）引入了**注意力机制（Attention Mechanism）**作为一种可学习的加权算子。</p><p>数学上，这等价于学习一个评分函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(v_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，用于估计第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 帧的特征质量。加权聚合过程定义为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">e</mi><mrow><mi>a</mi><mi>t</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msub><mi>α</mi><mi>t</mi></msub><mo>⋅</mo><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{e}_{att} = \sum_{t=1}^{T} \alpha_t \cdot v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">e</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0954490000000003em;vertical-align:-1.267113em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.882887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.267113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 需满足概率单纯形约束（Sum-to-one），通常通过 Softmax 函数获得：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>α</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi>T</mi></msup><mi>tanh</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">W</mi><mi>a</mi></msub><msub><mi>v</mi><mi>t</mi></msub><mo>+</mo><msub><mi mathvariant="bold">b</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>τ</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi>T</mi></msup><mi>tanh</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">W</mi><mi>a</mi></msub><msub><mi>v</mi><mi>τ</mi></msub><mo>+</mo><msub><mi mathvariant="bold">b</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha_t = \frac{\exp(\mathbf{w}^T \tanh(\mathbf{W}_a v_t + \mathbf{b}_a))}{\sum_{\tau=1}^{T} \exp(\mathbf{w}^T \tanh(\mathbf{W}_a v_\tau + \mathbf{b}_a))}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.689272em;vertical-align:-1.170941em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.128769em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.767331em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">tanh</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">tanh</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.170941em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>此处，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">W</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">b</mi><mi>a</mi></msub><mo separator="true">,</mo><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{W}_a, \mathbf{b}_a, \mathbf{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span></span></span></span> 均为参与反向传播优化的参数。该数学结构迫使模型在特征空间中自动进行“去噪”，梯度下降过程会抑制那些与身份主向量正交的噪声分量的权重。</p><h4 id="集合间距离度量与优化目标"><a class="markdownIt-Anchor" href="#集合间距离度量与优化目标"></a> 集合间距离度量与优化目标</h4><p>定义了序列特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><mi mathvariant="script">S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Phi(\mathcal{S})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="mclose">)</span></span></span></span> 后，核心问题在于如何定义两个集合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{S}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">S</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{S}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 之间的度量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(\mathcal{S}_i, \mathcal{S}_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><ul><li><strong>聚合嵌入距离</strong>（Aggregated Embedding Distance）：最直接的方法是在聚合后的特征向量上计算欧氏距离：</li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">∥</mi><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo><msub><mi mathvariant="normal">∥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D(\mathcal{S}_i, \mathcal{S}_j) = \| \Phi(\mathcal{S}_i) - \Phi(\mathcal{S}_j) \|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>这种方法计算效率最高，且完全兼容标准的 Triplet Loss。<br /></br></p><ul><li><strong>最小点集距离</strong>（Minimum Set Distance）：为了解决聚合带来的信息平滑问题，可以保留帧级特征，定义两个集合的距离为“最佳匹配帧”之间的距离：</li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo><mi>min</mi><mo>⁡</mo></mo><mrow><msub><mi>v</mi><mi>n</mi></msub><mo>∈</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>m</mi></msub><mo>∈</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub></mrow></munder><mi mathvariant="normal">∥</mi><msub><mi>v</mi><mi>n</mi></msub><mo>−</mo><msub><mi>v</mi><mi>m</mi></msub><msub><mi mathvariant="normal">∥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D_{min}(\mathcal{S}_i, \mathcal{S}_j) = \min_{v_n \in \mathcal{S}_i, v_m \in \mathcal{S}_j} \| v_n - v_m \|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.691651em;vertical-align:-0.941651em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-2.355669em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.941651em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>这种非参数化的度量方式在数学上允许序列在局部进行对齐，对于处理视角剧烈变化（如从正面逐渐转到背面）的序列具有更强的几何解释性。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;MTMCT方向的度量学习梳理。&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://atffang.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
  </entry>
  
  <entry>
    <title>实验室安全检测系统2</title>
    <link href="https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/"/>
    <id>https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/</id>
    <published>2025-11-13T12:41:07.000Z</published>
    <updated>2026-01-10T14:28:01.846Z</updated>
    
    <content type="html"><![CDATA[<p>花了一个下午的时间修改了一下项目结构，简单记录一下</p><span id="more"></span><p>上次介绍了一下参与的一个横向中的一个模块，最近花了一点时间梳理了一下结构，简单记录一下。功能并没有增加，还是比较简单的。</p><h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3><img src="https://atffang.github.io/2025/11/13/实验室安全检测系统2/结构.png"/><p>系统由三个功能层组成：</p><ul><li><strong>infra</strong>：基础功能层，包括config（配置加载）、logging（日志打印）、messagequeues（消息队列）</li><li><strong>data</strong>：负责数据部分功能，主要包括frameprocessor（视频流相关）、database（minio与postgresql数据库的增删改查接口）。连接的psql数据库和minio由docker实现。</li><li><strong>core</strong>：核心业务层，包括prepocess（负责加载识别模型加载前需要预加载的数据）、modelloader（加载识别模型，定义识别方法（pridict）、输出识别结果、postprocess（后处理，主要为每日数据迁移任务））</li></ul><h4 id="1-infra"><a class="markdownIt-Anchor" href="#1-infra"></a> 1. infra</h4><h5 id="11-config"><a class="markdownIt-Anchor" href="#11-config"></a> 1.1 config</h5><p>读取根目录下的<code>config.yaml</code>文件，提供加载各类配置的接口，<code>config</code>文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -------- 数据库配置 --------</span></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5434</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">&quot;labcamera&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- MinIO配置 --------</span></span><br><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">&quot;localhost:9000&quot;</span></span><br><span class="line">  <span class="attr">access_key:</span> <span class="string">&quot;minioadmin&quot;</span></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">&quot;minioadmin&quot;</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">&quot;detection-results&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 事件映射表 --------</span></span><br><span class="line"><span class="attr">event:</span></span><br><span class="line">  <span class="attr">event_dict:</span></span><br><span class="line">    <span class="attr">coat:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">nightsingle:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">channeloccupancy:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 模型参数配置 --------</span></span><br><span class="line"><span class="attr">model:</span></span><br><span class="line">  <span class="attr">coatdetecter:</span> <span class="string">&quot;coatdetecter.json&quot;</span></span><br><span class="line">  <span class="attr">nightsingledetecter:</span> <span class="string">&quot;nightsingledetecter.json&quot;</span></span><br><span class="line">  <span class="attr">channeloccupancydetecter:</span> <span class="string">&quot;channeloccupancydetecter.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 监控流配置 --------</span></span><br><span class="line"><span class="attr">rtsp:</span></span><br><span class="line">  <span class="attr">server_ip:</span> <span class="string">&quot;***.***.***.***&quot;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">  <span class="attr">channel_num:</span> <span class="number">256</span></span><br><span class="line">  <span class="attr">stream_type:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 启动时间配置 --------</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="attr">&quot;main_program&quot;:</span></span><br><span class="line">    <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;05:00&quot;</span></span><br><span class="line">    <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">  <span class="attr">&quot;summary_program&quot;:</span></span><br><span class="line">    <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">    <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;05:00&quot;</span></span><br></pre></td></tr></table></figure><h5 id="12-logging"><a class="markdownIt-Anchor" href="#12-logging"></a> 1.2 logging</h5><p>日志模块</p><h5 id="13-messagequeues"><a class="markdownIt-Anchor" href="#13-messagequeues"></a> 1.3 messagequeues</h5><p>消息队列模块，首先在<code>PhotoMessage.py</code>中定义了两个类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoMessage</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    表示视频流处理管线中的单帧消息对象。  </span></span><br><span class="line"><span class="string">    用于封装单帧图像及其关联的上下文信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    属性说明：</span></span><br><span class="line"><span class="string">        photo_id (str): 帧的唯一标识符（默认使用 UUID 自动生成）。</span></span><br><span class="line"><span class="string">        camera_id (str): 摄像头设备编号或标识。</span></span><br><span class="line"><span class="string">        room_id (str): 拍摄帧所在的物理位置或房间标识。</span></span><br><span class="line"><span class="string">        photo_path (Path): 帧图像文件的路径或内存引用。</span></span><br><span class="line"><span class="string">        timestamp (datetime): 帧捕获的时间戳（若未提供则自动生成）。</span></span><br><span class="line"><span class="string">        metadata (Dict[str, Any]): 附加的处理上下文信息。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    camera_id: <span class="built_in">str</span></span><br><span class="line">    room_id: <span class="built_in">str</span></span><br><span class="line">    photo_path: Path</span><br><span class="line">    task_id: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    photo_id: <span class="built_in">str</span> = field(default_factory=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    timestamp: datetime = field(default_factory=datetime.now)</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DetectionResult</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    表示单帧图像检测（识别）结果的数据结构。  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    属性说明：</span></span><br><span class="line"><span class="string">        ifwarning (bool): 是否触发告警（True 表示异常或警告）。</span></span><br><span class="line"><span class="string">        image (Optional[Image.Image]): 检测后的处理图像或标注结果。</span></span><br><span class="line"><span class="string">        description (str): 检测结果的文本描述信息。</span></span><br><span class="line"><span class="string">        timestamp (Optional[datetime]): 检测结果生成的时间戳。</span></span><br><span class="line"><span class="string">        task_id (int): 关联的任务标识符。</span></span><br><span class="line"><span class="string">        room_id (str): 检测帧所在的物理房间标识。</span></span><br><span class="line"><span class="string">        camera_id (str): 对应的摄像头编号。</span></span><br><span class="line"><span class="string">        alarm_category (str): 告警类型或类别（默认值为 &#x27;unknow&#x27;）。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ifwarning: <span class="built_in">bool</span> = <span class="literal">False</span>, image: <span class="type">Optional</span>[Image.Image] = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                 description: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, timestamp: <span class="type">Optional</span>[datetime] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 task_id: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 room_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, camera_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, alarm_category: <span class="built_in">str</span> = <span class="string">&quot;unknow&quot;</span></span>):</span><br><span class="line">        ifwarning = ifwarning</span><br><span class="line">        self.image = image</span><br><span class="line">        self.description = description</span><br><span class="line">        self.timestamp = timestamp</span><br><span class="line">        self.room_id = room_id</span><br><span class="line">        self.camera_id = camera_id</span><br><span class="line">        self.alarm_category = alarm_category</span><br><span class="line">        self.task_id = task_id</span><br></pre></td></tr></table></figure><p>并在<code>MessageQueue.py</code>中定义了一个全局消息队列<code>GlobalMessageQueue()</code>，用于存放<code>PhotoMessage</code>，并确保其线程安全。并实现：</p><ul><li><code>put_message(self, msg: PhotoMessage) -&gt; bool</code></li><li><code>get_message(self) -&gt; Optional[PhotoMessage]</code></li><li><code>persist_messages(self, file_path: Path) -&gt; int</code></li><li><code>load_messages(self, file_path: Path) -&gt; int</code></li><li>……</li></ul><p>等方法。</p><h4 id="2data"><a class="markdownIt-Anchor" href="#2data"></a> 2.Data</h4><h5 id="21-frameprocessor"><a class="markdownIt-Anchor" href="#21-frameprocessor"></a> 2.1 frameprocessor</h5><p>负责视频流处理。首先在<code>rtsp_client.py</code>中定义了实现：</p><ul><li>登录视频服务器获取 Token</li><li>定时保活</li><li>注册播放通道</li><li>获取指定摄像头的 RTSP URL</li><li>登出释放 Token</li></ul><p>功能的RTSPClient 类，并定义了其线程实现<code>RTSPServiceThread(threading.Thread)</code>，该线程启动后运行逻辑为：</p><ul><li>登录并注册播放通道</li><li>循环执行 keep_alive 保活</li><li>异常处理后自动登出</li></ul><p>随后在<code>get_rtsp.py</code>定义了<code>CaptureThread(threading.Thread)</code>的摄像头抓帧线程，管理 RTSP 流保活和帧捕获。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CaptureThread</span>(threading.Thread):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    摄像头抓帧线程，管理 RTSP 流保活和帧捕获。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        rtsp_config (dict): RTSP 配置</span></span><br><span class="line"><span class="string">        rtsp_thread (RTSPServiceThread): RTSP 服务线程</span></span><br><span class="line"><span class="string">        db_conn: 数据库连接对象</span></span><br><span class="line"><span class="string">        running (bool): 线程运行状态</span></span><br><span class="line"><span class="string">        camera_list (List[Dict[str, Any]]): 当前任务摄像头列表</span></span><br><span class="line"><span class="string">        wait_rtsp (int): 两次摄像头抓帧间隔（秒）</span></span><br><span class="line"><span class="string">        round_rtsp (int): 每轮抓帧最小总间隔（秒）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(daemon=<span class="literal">True</span>)</span><br><span class="line">        self.rtsp_config = RTSP_CONFIG</span><br><span class="line">        self.rtsp_thread = RTSPServiceThread(RTSP_CONFIG)</span><br><span class="line">        self.db_conn = <span class="literal">None</span></span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.camera_list: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = []</span><br><span class="line">        self.wait_rtsp = <span class="number">1</span></span><br><span class="line">        self.round_rtsp = <span class="number">600</span></span><br></pre></td></tr></table></figure><p>线程主逻辑：</p><ul><li>启动 RTSP 服务线程（自动保活）</li><li>连接数据库获取摄像头列表</li><li>循环抓取摄像头单帧图像并发送到消息队列</li></ul><h5 id="22-database"><a class="markdownIt-Anchor" href="#22-database"></a> 2.2 database</h5><p>database模块基于分层式架构模式（entity、repository、service三层）</p><ul><li>entity：实体层，定义了数据库中各个表对应的实体类，如<code>Camera</code>、<code>Results</code>、<code>ResultsTemp</code>。</li><li>repository：数据访问层，负责与数据库进行交互，提供数据持久化和检索功能，如<code>CameraRepository</code>、<code>ResultsRepository</code>、<code>ResultsTempRepository</code>。</li><li>service：业务逻辑层，负责处理业务逻辑，如<code>CameraService</code>、<code>ResultsMigrationService</code>、<code>ResultsNightService</code>、<code>ResultsTempSaverService</code>，这部分负责提供数据库部分的各个接口，给其他组件调用，实现解耦。</li></ul><p>我们以数据暂存为例，其需求是每次检测完成后，暂存数据到t_results_temp表中，因此，我们需要先定义一个<strong>ResultsTemp</strong>的Entity：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResultsEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;t_results&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    task_id = Column(String(<span class="number">100</span>))</span><br><span class="line">    event_id = Column(Integer)</span><br><span class="line">    description = Column(Text)</span><br><span class="line">    time1 = Column(TIMESTAMP)</span><br><span class="line">    time2 = Column(TIMESTAMP)</span><br><span class="line">    picture1 = Column(String(<span class="number">255</span>))</span><br><span class="line">    picture2 = Column(String(<span class="number">255</span>))</span><br><span class="line">    picture3 = Column(String(<span class="number">255</span>))</span><br></pre></td></tr></table></figure><p>随后，定义一层数据访问层<strong>ResultsTempRepository</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> entity.ResultsTemp <span class="keyword">import</span> ResultsTempEntity</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResultsTempRepository</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, session: Session</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert</span>(<span class="params">self, entity: ResultsTempEntity</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_all</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_task</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_by_event_and_date</span>(<span class="params">self, event_ids, date_str</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_batch</span>(<span class="params">self, records</span>):</span><br></pre></td></tr></table></figure><p>最后，定义一个Service：<strong>ResultsTempSaverService</strong> 来提供服务接口：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataSaverService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Service 层：处理检测结果保存（数据库 + MinIO 上传）&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_detection_result</span>(<span class="params">self, result: DetectionResult</span>):</span><br></pre></td></tr></table></figure><p>那么，在其他组件中调用<code>save_detection_result</code>即可。</p><h4 id="3-core"><a class="markdownIt-Anchor" href="#3-core"></a> 3. Core</h4><h5 id="31-preprocess"><a class="markdownIt-Anchor" href="#31-preprocess"></a> 3.1 preprocess</h5><p>里面放一些预处理函数，比如从数据库下载通道范围。然后我们在<code>detect.py</code>中在启动识别线程前调用即可。比如说我在<code>detect.py</code>里面调用的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.preprocess <span class="keyword">import</span> LoadChannelRange</span><br><span class="line"><span class="comment"># 首先下载摄像头范围数据</span></span><br><span class="line">LoadChannelRange.save()</span><br></pre></td></tr></table></figure><h5 id="32-modelloader"><a class="markdownIt-Anchor" href="#32-modelloader"></a> 3.2 modelloader</h5><p><strong>重点</strong></p><p>modeller部分负责加载模型，并实现识别功能。<br />对于一个识别功能模块，首先，我们需要在modelloader/config中添加一个配置json文件，比如：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;coatdetecter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yolo11s&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pt&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core/modelloader/model/yolo11s.pt&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mobilenet_v2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core/modelloader/model/coat_classifier_final.pth&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>并将其添加到根目录下的<code>config.yaml</code>文件中的 模型参数配置 部分。<br />并且按照&quot;weight_path&quot;的路径正确将权重模型存放在相应的路径。</p><p>随后，我们在在modelloader/functionmodel定义一个模型识别类，我在这个路径下的<code>base_detector.py</code>提供了一个抽象类:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseDetector</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Detector 示例模板</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    子类必须实现 load 方法，返回 predict 函数：</span></span><br><span class="line"><span class="string">        predict(message: PhotoMessage, image_input: np.ndarray) -&gt; Optional[DetectionResult]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    predict 函数必须：</span></span><br><span class="line"><span class="string">    1. 接受 PhotoMessage 和 np.ndarray（BGR 图像）</span></span><br><span class="line"><span class="string">    2. 返回 DetectionResult 或 None</span></span><br><span class="line"><span class="string">    3. 对图像操作应使用 copy()，避免并行冲突</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">model_pipeline: <span class="built_in">list</span>, device</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化模型，返回 predict 函数。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> 在这里实现你的模型初始化逻辑</span></span><br><span class="line">        <span class="comment"># 初始化逻辑示例：</span></span><br><span class="line">        <span class="comment"># parent_dir = Path(__file__).resolve().parents[3]</span></span><br><span class="line">        <span class="comment"># yolo_path = parent_dir / model_pipeline[0][&quot;weight_path&quot;]</span></span><br><span class="line">        <span class="comment"># yolo_model = YOLO(yolo_path).to(device)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">message: PhotoMessage, image_input: np.ndarray</span>) -&gt; <span class="type">Optional</span>[DetectionResult]:</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            对输入图像执行检测，返回 DetectionResult 或 None。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> 在这里实现你的检测逻辑</span></span><br><span class="line">            image = image_input.copy()</span><br><span class="line">            <span class="comment"># 检测逻辑示例：</span></span><br><span class="line">            <span class="comment"># for box in detected_boxes:</span></span><br><span class="line">            <span class="comment">#     crop = image[...]</span></span><br><span class="line">            <span class="comment">#     pred = classify(crop)</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果有异常情况,则构造并返回DetectionResult：</span></span><br><span class="line">            <span class="comment"># return DetectionResult(...)</span></span><br><span class="line">            <span class="comment"># 如果没有异常情况，返回None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> predict</span><br></pre></td></tr></table></figure><p>基于这个抽象类的要求，实现一个具体的识别类，比如我在<code>coat_detector.py</code>中实现了一个<code>CoatDetector(BaseDetector)</code>类。</p><p>同时，在<code>modelloader.py</code>中，提供了一个工厂类<code>ModelLoader</code>，用于加载模型，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelLoader</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    模型加载工厂类，统一根据模型名称返回预测函数。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    MODEL_MAP: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Callable</span>[[<span class="type">Any</span>, torch.device], <span class="type">Any</span>]] = &#123;</span><br><span class="line">        <span class="string">&quot;coatdetecter&quot;</span>: CoatDetector.load,</span><br><span class="line">        <span class="string">&quot;nightsingledetecter&quot;</span>: NightSingleDetector.load,</span><br><span class="line">        <span class="string">&quot;channeloccupancydetecter&quot;</span>: ChannelOccupancyDetector.load</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loader</span>(<span class="params">model_name: <span class="built_in">str</span>, model_pipeline: <span class="type">Any</span>, device: torch.device</span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据模型名称加载对应的检测模型，并返回预测函数。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            model_name (str): 模型名称，如 &quot;coatdetecter&quot;。</span></span><br><span class="line"><span class="string">            model_pipeline (Any): 模型权重路径或配置列表。</span></span><br><span class="line"><span class="string">            device (torch.device): 模型运行设备。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Callable: 用于执行预测的函数，输入为 image/message，输出 DetectionResult。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValueError: 如果模型名称不在支持列表中。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            load_func = ModelLoader.MODEL_MAP[model_name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Model &#x27;<span class="subst">&#123;model_name&#125;</span>&#x27; is not supported.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> load_func(model_pipeline, device)</span><br></pre></td></tr></table></figure><p>为了加载刚刚的模型，我们把模型名字和模型类.load函数加载在<code>MODEL_MAP</code>中</p><p>再同时，在<code>modelloader.py</code>中，还提供了一个<code>IdentificationModel</code>类，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IdentificationModel</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        self.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">        self.name = config[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        self.pipeline = config[<span class="string">&quot;pipeline&quot;</span>]</span><br><span class="line">        self.predict = self._loadmodel()</span><br></pre></td></tr></table></figure><p>这个<code>IdentificationModel</code>类，调用了工厂类<code>ModelLoader</code>的<code>loader</code>方法，将模型加载到<code>predict</code>中，然后我们就可以直接调用实例化后的<code>IdentificationModel</code>类的<code>predict</code>方法进行识别了。这里其实逻辑比较混乱，读者完全可以将这两个类合并。</p><p>了解完这些后，我们最终定义一个消费者线程类，该类首先基于config文件，初始化一个<code>IdentificationModel</code>实例列表，然后对于<code>messagequeue</code>中的每个<code>PhotoMessage</code>，遍历调用每个<code>IdentificationModel</code>实例的<code>pridict()</code>方法进行识别，并调用<code>data.service</code>暴露的存储接口进行存储。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoConsumer</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_list: <span class="type">List</span>[<span class="built_in">dict</span>], poll_interval: <span class="built_in">float</span> = <span class="number">1</span>, max_workers: <span class="built_in">int</span> = <span class="number">4</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        多线程消费者：从 global_mq 获取消息，读取图片，执行模型推理，并删除图片。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param config_list: 一组 config 字典（每个配置一个模型）</span></span><br><span class="line"><span class="string">        :param poll_interval: 轮询间隔秒数</span></span><br><span class="line"><span class="string">        :param max_workers: 并发处理的最大线程数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(daemon=<span class="literal">True</span>)</span><br><span class="line">        self.poll_interval = poll_interval</span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.db = DataSaver()</span><br><span class="line">        self.executor = ThreadPoolExecutor(max_workers=max_workers)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化模型列表</span></span><br><span class="line">        self.modellist = [IdentificationModel(config) <span class="keyword">for</span> config <span class="keyword">in</span> config_list]</span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> self.modellist:</span><br><span class="line">            logger.info(model)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="string">&quot;&quot;&quot;停止线程并关闭线程池&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;主线程循环获取消息并交由线程池处理&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, message: PhotoMessage</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理单条消息的识别与存储&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>最后定义一个<code>start_photo_consumer_concurrent()</code>函数用于启动模型消费者，有detect.py调用，其中，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer = PhotoConsumer(config_list, max_workers=<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>其中，<code>max_workers</code>为启用的消费者线程数</p><h5 id="33-postprocess"><a class="markdownIt-Anchor" href="#33-postprocess"></a> 3.3 postprocess</h5><p>里面放一天的识别结束后的操作，比如说将识别结果数据梳理后从t_results_temp表迁移到t_results表，并删除t_results_temp表中的数据。preprocess和postprocess里面的操作大多数被封装为了data.database.service里面的服务接口，只要调用就行了。值得关注的是，preprocess在<code>detect.py</code>中被调用，而postprocess在<code>main.py</code>中被调用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.postprocess.migration_runner <span class="keyword">import</span> DailyMigrationTask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 归纳程序控制</span></span><br><span class="line">summary_start = str_to_time(config[<span class="string">&quot;summary_program&quot;</span>][<span class="string">&quot;start&quot;</span>])</span><br><span class="line">summary_end = str_to_time(config[<span class="string">&quot;summary_program&quot;</span>][<span class="string">&quot;end&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> in_time_range(summary_start, summary_end, now):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> started_summary:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] 启动归纳程序&quot;</span>)</span><br><span class="line">        task = DailyMigrationTask()</span><br><span class="line">        task.run()</span><br><span class="line">        started_summary = <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> started_summary <span class="keyword">and</span> summary_proc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] 关闭归纳程序&quot;</span>)</span><br><span class="line">        started_summary = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">60</span>)</span><br></pre></td></tr></table></figure><h3 id="架构"><a class="markdownIt-Anchor" href="#架构"></a> 架构</h3><img src="https://atffang.github.io/2025/11/13/实验室安全检测系统2/架构.png"/>现在没有设计多GPU，也暂时没有必要。]]></content>
    
    
    <summary type="html">&lt;p&gt;花了一个下午的时间修改了一下项目结构，简单记录一下&lt;/p&gt;</summary>
    
    
    
    <category term="作品" scheme="https://atffang.github.io/categories/%E4%BD%9C%E5%93%81/"/>
    
    
  </entry>
  
  <entry>
    <title>DeepSort (SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC)</title>
    <link href="https://atffang.github.io/2025/11/12/deepsort/"/>
    <id>https://atffang.github.io/2025/11/12/deepsort/</id>
    <published>2025-11-12T05:23:19.000Z</published>
    <updated>2026-01-10T14:31:52.107Z</updated>
    
    <content type="html"><![CDATA[<p>梳理摄像头行人追踪经典论文SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC中的方法。</p><span id="more"></span><h1 id="simple-online-and-realtime-tracking-with-a-deep-association-metric"><a class="markdownIt-Anchor" href="#simple-online-and-realtime-tracking-with-a-deep-association-metric"></a> Simple online and realtime tracking with a deep association metric</h1><p><strong>作者</strong>：Nicolai Wojke, Alex Bewley, Dietrich Paulus</p><hr /><h3 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h3><p>Simple Online and Realtime Tracking (SORT) is a pragmatic approach to multiple object tracking with a focus on simple, effective algorithms. In this paper, we integrate appearance information to improve the performance of SORT. Due to this extension we are able to track objects through longer periods of occlusions, effectively reducing the number of identity switches. In spirit of the original framework we place much of the computational complexity into an offline pre-training stage where we learn a deep association metric on a largescale person re-identification dataset. During online application, we establish measurement-to-track associations using nearest neighbor queries in visual appearance space. Experimental evaluation shows that our extensions reduce the number of identity switches by 45%, achieving overall competitive performance at high frame rates.</p><h3 id="1-训练阶段"><a class="markdownIt-Anchor" href="#1-训练阶段"></a> 1. 训练阶段</h3><h4 id="11-数据来源"><a class="markdownIt-Anchor" href="#11-数据来源"></a> 1.1 数据来源</h4><ul><li>使用 MARS 数据集：1.1 M 图像，1261 名行人，跨相机跨时段。</li><li>训练集/验证集拆分：按身份划成 631/630 两组用于训练和验证，保证 ID 不重叠。</li><li>增广：水平翻转、随机擦除、颜色扰动、256×128 LetterBox。</li></ul><h4 id="12-网络结构"><a class="markdownIt-Anchor" href="#12-网络结构"></a> 1.2 网络结构</h4><img src="/2025/11/12/deepsort/deepsort1.jpg" class="" title="sucessful"><p>输入 (3,256,128) 的图像</p><ul><li><strong>Conv1 3×3/1 32 通道</strong></li><li><strong>Conv2 3×3/1 32 通道</strong></li><li><strong>MaxPool 3×3/2</strong></li><li><strong>6 个残差块（通道 32→64→128，下采样 2 次）</strong></li><li><strong>GAP（全局平均池化） (128,8,4) → 128 维向量</strong></li><li><strong>Dense10 128-D</strong></li><li><strong>BatchNorm1d + L2 归一化 → 单位球面输出</strong></li></ul><h4 id="13-损失与训练协议"><a class="markdownIt-Anchor" href="#13-损失与训练协议"></a> 1.3 损失与训练协议</h4><p><strong>batch-hard 三元组损失</strong>的核心思想是，在一个 mini-batch 里，只留最难的样本去推/拉网络，忽略其余轻松样本，避免梯度被大量简单对淹没。batch-hard的 batch 构造过程如下</p><ul><li>先随机抽 P=18 个行人身份（可以理解为 18 个人）</li><li>对每个人，再从不同相机、不同帧里各抓 4 张图，共 18×4=72 张图</li></ul><p>对任意一张<strong>锚图</strong>：</p><ul><li>找出同身份里外观最不像锚的那张图（同身份中余弦距离最大），作为<strong>最难正样本</strong></li><li>找出异身份里外观最像锚的那张图（同身份中余弦距离最小），作为<strong>最难负样本</strong></li></ul><p>只保留这一对难样本计算损失，其余全部忽略。损失函数引用了文章 <em>Simple online and realtime tracking with a deep association metric</em> 中的计算方法。</p><p><strong>损失函数</strong>：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mrow><mi mathvariant="normal">B</mi><mi mathvariant="normal">H</mi></mrow></msub><mo stretchy="false">(</mo><mi>θ</mi><mo separator="true">;</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>P</mi></munderover><munderover><mo>∑</mo><mrow><mi>a</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mrow><mo fence="true">[</mo><mi>m</mi><mo>+</mo><munder><mo><mi>max</mi><mo>⁡</mo></mo><mstyle scriptlevel="1"><mtable rowspacing="0.1em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>p</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>K</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>p</mi><mo mathvariant="normal">≠</mo><mi>a</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></munder><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>p</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>−</mo><munder><mo><mi>min</mi><mo>⁡</mo></mo><mstyle scriptlevel="1"><mtable rowspacing="0.1em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>P</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo mathvariant="normal">≠</mo><mi>i</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></munder><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>n</mi><mi>j</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\mathrm{BH}}(\theta; X) = \sum_{i=1}^{P} \sum_{a=1}^{K} \left[ m + \max_{\substack{p=1,\dots,K \\ p \neq a}} D(f_\theta(x_a^i), f_\theta(x_p^i)) - \min_{\substack{j=1,\dots,P \\ j \neq i}} D(f_\theta(x_a^i), f_\theta(x_n^j)) \right]_+ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">B</span><span class="mord mathrm mtight">H</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.7090609999999997em;vertical-align:-1.658051em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.882887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.267113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.43056000000000005em;"><span style="top:-2.0406725000000003em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.133325em;"><span style="top:-3.149995em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span><span style="top:-2.261115em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel mtight"></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6333249999999999em;"><span></span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5026549999999999em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.874664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6678600000000001em;"><span style="top:-2.0406725000000003em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.133325em;"><span style="top:-3.149995em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span><span style="top:-2.261115em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel mtight"></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6333249999999999em;"><span></span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5026549999999999em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-1.191389em;"><span style="top:-1.1002800000000001em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.658051em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中：<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>：batch 中身份（person）数量<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>：每个身份的图像数<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">x_a^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.071664em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>：第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> 个身份的第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span> 张图像（anchor）<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>p</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">x_p^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2077719999999998em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>：与 anchor 同身份的最远正样本（hardest positive）<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>n</mi><mi>j</mi></msubsup></mrow><annotation encoding="application/x-tex">x_n^j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.071664em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>：与 anchor 异身份的最近负样本（hardest negative）<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><mo separator="true">⋅</mo><mo separator="true">,</mo><mo separator="true">⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(·,·)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mclose">)</span></span></span></span>：欧氏距离（作者明确使用 非平方 欧氏距离）<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>：margin，取 0.2<br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo separator="true">⋅</mo><msub><mo stretchy="false">]</mo><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">[·]_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.25833100000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>：ReLU，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mo separator="true">⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">max(0, ·)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mclose">)</span></span></span></span></p><p>我们来拆解一下这个公式。</p><ol><li><strong>外层双重求和</strong><br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>P</mi></msubsup><msubsup><mo>∑</mo><mrow><mi>a</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></msubsup></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{P} \sum_{a=1}^{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2809409999999999em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span></span></span></span><br />一次 mini-batch 里有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> 个身份，每人 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 张图；对每张图 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span> 都当一次锚点，共 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>×</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">P×K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 个锚点。</li><li><strong>最难正样本项</strong><br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo><mi>max</mi><mo>⁡</mo></mo><mstyle scriptlevel="1"><mtable rowspacing="0.1em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>p</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>K</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>p</mi><mo mathvariant="normal">≠</mo><mi>a</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></msub><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>p</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\max_{\substack{p=1,\dots,K \\ p \neq a}} D(f_\theta(x_a^i), f_\theta(x_p^i))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.716519em;vertical-align:-0.8918549999999998em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3447999999999998em;margin-right:0.05em;"><span class="pstrut" style="height:2.7933274999999997em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.133325em;"><span style="top:-3.149995em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span><span style="top:-2.261115em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel mtight"></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6333249999999999em;"><span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8918549999999998em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><br />在同身份 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> 的其余 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 张图里，找距离最大的那张作为硬正样本（<strong>hardest positive</strong>）。作用是把同身份最远的点拉进来，防止簇内松散。</li><li><strong>最难负样本项</strong><br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo><mi>min</mi><mo>⁡</mo></mo><mstyle scriptlevel="1"><mtable rowspacing="0.1em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>P</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo mathvariant="normal">≠</mo><mi>i</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></msub><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>n</mi><mi>j</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\min_{\substack{j=1,\dots,P \\ j \neq i}} D(f_\theta(x_a^i), f_\theta(x_n^j))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.716519em;vertical-align:-0.8918549999999998em;"></span><span class="mop"><span class="mop">min</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3447999999999998em;margin-right:0.05em;"><span class="pstrut" style="height:2.7933274999999997em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.133325em;"><span style="top:-3.149995em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span><span style="top:-2.261115em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel mtight"></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6333249999999999em;"><span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8918549999999998em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><br />在 所有异身份 图里，找距离最小的那张作为硬负样本（<strong>hardest negative</strong>）。作用是把最迷惑人的异类推远，增大类间 margin。</li><li><strong>Hinge项</strong><br /><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>m</mi><mo>+</mo><mo stretchy="false">(</mo><mi>h</mi><mi>a</mi><mi>r</mi><mi>d</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>p</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo stretchy="false">)</mo><mtext>−</mtext><mo stretchy="false">(</mo><mi>h</mi><mi>a</mi><mi>r</mi><mi>d</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo stretchy="false">)</mo><msub><mo stretchy="false">]</mo><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">[m + (hardest positive) − (hardest negative)]_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mord">−</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.25833100000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span><br />当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>a</mi><mi>r</mi><mi>d</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>p</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">hardest positive</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span></span></span></span> 比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>a</mi><mi>r</mi><mi>d</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">hardest negative</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span></span></span></span> 远（或近得不够）时， <strong>hinge</strong> 项为正，损失产生梯度，否则为 0，损失为 0。</li></ol><p><strong>训练协议</strong>：</p><ul><li>优化器：Adam</li><li>学习率：0.0001</li><li>mini-batch：72</li><li>epoch：1000</li><li>保存频率：每 100 个 epoch 保存一次</li></ul><hr /><h3 id="2-识别流程"><a class="markdownIt-Anchor" href="#2-识别流程"></a> 2. 识别流程</h3><h4 id="21-输入检测"><a class="markdownIt-Anchor" href="#21-输入检测"></a> 2.1 输入检测</h4><p>检测器给出 (u,v,w,h) + 置信；置信 &lt;0.3 的直接丢弃。该文章的检测器来自于<em>Poi: Multiple object tracking with high performance detection and appearance feature</em>，是一个Faster R-CNN 在私有+公开行人数据集上重新训练的一个强检测器。</p><h4 id="22-特征提取"><a class="markdownIt-Anchor" href="#22-特征提取"></a> 2.2 特征提取</h4><ol><li>框图等比缩放到 256×128，侧补灰条；</li><li>每个通道减去 ImageNet 均值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">μ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">μ</span></span></span></span> ，再除以标准差 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">σ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span> ，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mi>r</mi></msub><mi>a</mi><mi>w</mi><mi mathvariant="normal">/</mi><mn>255.0</mn><mo>−</mo><mi>μ</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>σ</mi></mrow><annotation encoding="application/x-tex">x = (x_raw / 255.0 - μ) / σ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">/</span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">μ</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span>；</li><li>前向冻结 CNN → 128-D → L2 归一化 → 单位向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">r_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>。把 RGB 图像压成 128 维单位超球面向量</li></ol><h4 id="23-运动预测与门控"><a class="markdownIt-Anchor" href="#23-运动预测与门控"></a> 2.3 运动预测与门控</h4><p>目标：在下一帧到来之前，用“常速模型”估计每个轨迹的新位置，并给出一个置信椭圆——只有检测框落在这个椭圆内，才允许参与后续匹配。整个流程分为三步：状态定义 → 预测 → Mahalanobis 门控。</p><ol><li><strong>状态向量与观测</strong><br />采用图像平面上的 8 维常速模型。<br /><strong>状态</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">[</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo separator="true">,</mo><mi>γ</mi><mo separator="true">,</mo><mi>h</mi><mo separator="true">,</mo><mover accent="true"><mi>u</mi><mo>˙</mo></mover><mo separator="true">,</mo><mover accent="true"><mi>v</mi><mo>˙</mo></mover><mo separator="true">,</mo><mover accent="true"><mi>γ</mi><mo>˙</mo></mover><mo separator="true">,</mo><mover accent="true"><mi>h</mi><mo>˙</mo></mover><mo stretchy="false">]</mo><mtext>ᵀ</mtext></mrow><annotation encoding="application/x-tex">x = [u, v, γ, h, u̇, v̇, γ̇, ḣ]ᵀ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1813em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11111000000000001em;"><span class="mord">˙</span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11111000000000001em;"><span class="mord">˙</span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.13889em;"><span class="mord">˙</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">h</span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.13889em;"><span class="mord">˙</span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord">ᵀ</span></span></span></span><br />– <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(u,v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>：框中心像素坐标<br />– <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>=</mo><mi>w</mi><mi mathvariant="normal">/</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">γ = w/h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span>：宽高比<br />– <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>：高度像素<br />– 带点项为对应一阶导数（速度）</li></ol><p>1.2 <strong>观测</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mo stretchy="false">[</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo separator="true">,</mo><mi>γ</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">]</mo><mtext>ᵀ</mtext></mrow><annotation encoding="application/x-tex">z = [u, v, γ, h]ᵀ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mclose">]</span><span class="mord">ᵀ</span></span></span></span></p><ol start="2"><li><strong>预测阶段</strong><br />对已存在轨迹 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>：<br />用<strong>上帧估计</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>P</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x̂_{k-1}, P_{k-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 做先验预测</li></ol><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>k</mi><mo>−</mo><mn>1</mn><mo>=</mo><mi>F</mi><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mrow><mi>k</mi><mo>−</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">x̂_k|k-1 = F x̂_{k-1|k-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.04964em;vertical-align:-0.3551999999999999em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span></span></span></span></span></p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>k</mi><mo>−</mo><mn>1</mn><mo>=</mo><mi>F</mi><msub><mi>P</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mi>F</mi><mtext>ᵀ</mtext><mo>+</mo><mi>Q</mi></mrow><annotation encoding="application/x-tex">P_k|k-1 = F P_{k-1|k-1} Fᵀ + Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.03853em;vertical-align:-0.3551999999999999em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord">ᵀ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span></span> 为状态转移矩阵，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span></span></span></span> 为过程噪声协方差矩阵。<br /><strong>预测输出</strong><br />均值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><mi>H</mi><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y_i = H x̂_k|k-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> → 4-D 框 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo separator="true">,</mo><mi>γ</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(u,v,γ,h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span><br />协方差 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub><mo>=</mo><mi>H</mi><msub><mi>P</mi><mi>k</mi></msub><mi mathvariant="normal">∣</mi><mi>k</mi><mo>−</mo><mn>1</mn><mi>H</mi><mtext>ᵀ</mtext><mo>+</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">S_i = H P_k|k-1 Hᵀ + R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord">ᵀ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></p><ol start="3"><li><strong>门控阶段</strong><br />对新检测框 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>j</mi></msub><mo>=</mo><mo stretchy="false">(</mo><msub><mi>u</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>γ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>h</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d_j = (u_j, v_j, γ_j, h_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，计算到预测分布的 平方 <strong>Mahalanobis</strong> 距离：</li></ol><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>d</mi><mo stretchy="false">(</mo></msup><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msub><mi>d</mi><mi>j</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mtext>ᵀ</mtext><msubsup><mi>S</mi><mi>i</mi><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mo stretchy="false">(</mo><msub><mi>d</mi><mi>j</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d^(1)(i,j) = (d_j - y_i)ᵀ S_i^{-1} (d_j - y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.150216em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">ᵀ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.433005em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.266995em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>4-D 观测空间下，平方 Mahalanobis 距离服从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>χ</mi><mtext>²</mtext></mrow><annotation encoding="application/x-tex">χ²</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">χ</span><span class="mord">²</span></span></span></span> 分布，获取95 % 置信区域对应的阈值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>95</mn></msub></mrow><annotation encoding="application/x-tex">t_{95}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">9</span><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，若 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>d</mi><mo stretchy="false">(</mo></msup><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>t</mi><mn>95</mn></msub></mrow><annotation encoding="application/x-tex">d^(1)(i,j) &lt; t_{95}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">9</span><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 则认为通过门控，允许进入匈牙利成本矩阵。</p><h4 id="24-外观匹配与门控"><a class="markdownIt-Anchor" href="#24-外观匹配与门控"></a> 2.4 外观匹配与门控</h4><p>目的：把程度低的配对直接踢掉，减少匈牙利矩阵的歧义，同时让轨迹在遮挡后靠外貌重新找回身份。<br /><strong>循环画廊</strong>（Circular Gallery）<br />每条轨迹 k 维护一个 固定长度 100 的列表 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>k</mi></msub><mo>=</mo><mo stretchy="false">[</mo><msup><mi>r</mi><mo stretchy="false">(</mo></msup><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msup><mi>r</mi><mo stretchy="false">(</mo></msup><mn>100</mn><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">R_k = [r^(1), …, r^(100)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span>，元素是 128-D 单位向量（L2 归一化后），来自过去 100 次成功匹配的检测特征。每成功匹配一次，把新特征 push 进队尾，超出 100 则 pop 队头<br /><strong>最小余弦距离计算</strong><br />对新检测 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>，先提取 128-D 单位向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">r_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，然后与画廊逐向量求余弦相似度</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo><mi>l</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mi>r</mi><mi>j</mi><mi>T</mi></msubsup><msubsup><mi>r</mi><mi>k</mi><mo stretchy="false">(</mo></msubsup><mi>l</mi><mo stretchy="false">)</mo><mo>∈</mo><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">sim(l) = r_j^T r_k^(l)          ∈ [-1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.427908em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.891331em;"><span style="top:-2.4530000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.3986920000000005em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013079999999999em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>d</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mi>m</mi><mi>i</mi><msub><mi>n</mi><mi>l</mi></msub><mrow><mn>1</mn><mo>−</mo><mi>s</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo><mi>l</mi><mo stretchy="false">)</mo></mrow><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">d^{(2)}(i,j) = min_l { 1 - sim(l) } ∈ [0, 2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span></span></span></span></span></p><p>取最小距离, 即最像的那个历史向量。<br />3. <strong>硬门控</strong>（Hard Gating）</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>b</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>d</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>≤</mo><mn>0.2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">b^{(2)}_{i,j}=\begin{cases}1,&amp;d^{(2)}(i,j)\leq0.2\\0,&amp;\text{otherwise}\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4577719999999998em;vertical-align:-0.412972em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231360000000004em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.412972em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><h4 id="25-成本矩阵与级联"><a class="markdownIt-Anchor" href="#25-成本矩阵与级联"></a> 2.5 成本矩阵与级联</h4><p>两轮门控（运动 + 外观）都通过后，该 (轨迹 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span>, 检测 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>) 对才被允许进入匈牙利算法的成本矩阵。接下来顺序如下：</p><ol><li><strong>构造成本矩阵 C</strong><br />仅保留 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>b</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">b^{(1)}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>b</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">b^{(2)}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 的配对<br />元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">C_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> = 外观余弦距离<br />未通过门控的位置填 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">∞</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord">∞</span></span></span></span>，确保匈牙利不会选中</li><li><strong>匈牙利最优分配</strong><br />在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> 上求解最小成本匹配<br />输出：最优 (轨迹→检测) 列表 + 未匹配轨迹 + 未匹配检测</li><li><strong>Kalman 更新 / 新建轨迹 / 删除轨迹</strong><br />匹配成功的：用对应检测框做 Kalman 更新，并把其 128-D 特征压入轨迹 gallery<br />未匹配检测：初始化暂定轨迹，需连续 3 帧成功关联才转正<br />未匹配轨迹：age +1，超过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{lost}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>（默认 30）帧即删除<br />循环结束：下一帧到来时，用更新后的轨迹状态回到第 1 步预测阶段。</li></ol><hr />]]></content>
    
    
    <summary type="html">&lt;p&gt;梳理摄像头行人追踪经典论文SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC中的方法。&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://atffang.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
  </entry>
  
  <entry>
    <title>Features for Multi-Target Multi-Camera Tracking and Re-Identification</title>
    <link href="https://atffang.github.io/2025/11/11/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBFMTMCRI/"/>
    <id>https://atffang.github.io/2025/11/11/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBFMTMCRI/</id>
    <published>2025-11-11T03:33:07.000Z</published>
    <updated>2026-01-10T14:29:12.453Z</updated>
    
    <content type="html"><![CDATA[<p>梳理MTMC问题经典论文Features for Multi-Target Multi-Camera Tracking and Re-Identification中的方法。</p><span id="more"></span><h1 id="features-for-multi-target-multi-camera-tracking-and-re-identification"><a class="markdownIt-Anchor" href="#features-for-multi-target-multi-camera-tracking-and-re-identification"></a> Features for Multi-Target Multi-Camera Tracking and Re-Identification</h1><p><strong>作者</strong>：Ergys Ristani, Carlo Tomasi (Duke University)</p><h3 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h3><p>Multi-Target Multi-Camera Tracking (MTMCT) tracks many people through video taken from several cameras. Person Re-Identification (Re-ID) retrieves from a gallery images of people similar to a person query image. We learn good features for both MTMCT and Re-ID with a convolutional neural network. Our contributions include an adaptive weighted triplet loss for training and a new technique for hard-identity mining. Our method outperforms the state of the art both on the DukeMTMC benchmarks for tracking, and on the Market-1501 and DukeMTMC-ReID benchmarks for Re-ID. We examine the correlation between good Re-ID and good MTMCT scores, and perform ablation studies to elucidate the contributions of the main components of our system.</p><h2 id="1-任务定义与整体思路"><a class="markdownIt-Anchor" href="#1-任务定义与整体思路"></a> 1. 任务定义与整体思路</h2><p>MTMCT 的目标是，给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 路无重叠视域的视频流 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><mrow><mi>V</mi><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>V</mi><mi>n</mi></mrow></mrow><annotation encoding="application/x-tex">V={V1,…,Vn}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">n</span></span></span></span></span>，输出每个人在全局时空中的完整轨迹 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mrow><mi>T</mi><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>T</mi><mi>l</mi></mrow></mrow><annotation encoding="application/x-tex">T={T1,…,Tl}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span></span>。<br />Re-ID 的目标是：给定查询图 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>，在跨相机图库 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span> 中按相似度降序返回同身份图像。</p><p>作者提出只学习特征，不学习关联：</p><ul><li>训练阶段：用改进的加权三元组损失（AWTL）+ 困难身份挖掘（HNM）在纯 Re-ID 协议下训练 128-D 外观特征；</li><li>测试阶段：用相关聚类（Correlation Clustering）一次性把全部检测关联成跨相机轨迹；</li><li>检测器与特征解耦，整体 pipeline 通过三阶段递进，即检测 → 单相机轨迹 → 跨相机轨迹。</li></ul><hr /><h2 id="2-训练外观特征学习"><a class="markdownIt-Anchor" href="#2-训练外观特征学习"></a> 2. 训练：外观特征学习</h2><h3 id="21-三元组损失的通用形式"><a class="markdownIt-Anchor" href="#21-三元组损失的通用形式"></a> 2.1 三元组损失的通用形式</h3><p>在行人 Re-ID 任务里，我们把一张含有某个人全身（或可见大部分身体）的 bounding-box 图像叫做一个 样本（或 patch、embedding）。</p><p>训练时，输入网络的图像三元组如下：<br />· 先随机选 一个身份 ID-a（比如张三）。<br />· 从 ID-a 当天被不同相机拍到的所有框图里，随机抽 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 张（论文 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">K=4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>）。这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 张里的任意一张就叫 锚点图像 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">xa</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">a</span></span></span></span>（anchor）。<br />· 同属 ID-a 的其余框图都叫 正样本图像 xp（positive）——它们和 xa 同身份，只是视角、光照、姿态或遮挡不同。<br />再从 其它任何身份（李雷、韩梅…）的框图里随机抽若干张，叫 负样本图像 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>n</mi><mtext>（</mtext><mi>n</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mtext>）</mtext></mrow><annotation encoding="application/x-tex">xn（negative）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">（</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">）</span></span></span></span>，它们和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">xa</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">a</span></span></span></span> 身份不同。</p><p>对锚点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">xa</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">a</span></span></span></span>，设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span> 为正样本集，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N(a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span> 为负样本集，定义</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>L</mi><mn>3</mn></msub><mo>=</mo><msub><mrow><mo fence="true">[</mo><mi>m</mi><mo>+</mo><munder><mo>∑</mo><mrow><msub><mi>x</mi><mi>p</mi></msub><mo>∈</mo><mi>P</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow></munder><msub><mi>w</mi><mi>p</mi></msub><mi>d</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>p</mi></msub><mo stretchy="false">)</mo><mo>−</mo><munder><mo>∑</mo><mrow><msub><mi>x</mi><mi>n</mi></msub><mo>∈</mo><mi>N</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow></munder><msub><mi>w</mi><mi>n</mi></msub><mi>d</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">L_3=\left[m+\sum_{x_p\in P(a)}w_pd(x_a,x_p)-\sum_{x_n\in N(a)}w_nd(x_a,x_n)\right]_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.7090609999999997em;vertical-align:-1.658051em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.808995em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">a</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.538325em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.808995em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">a</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-1.191389em;"><span style="top:-1.1002800000000001em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.658051em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mo separator="true">⋅</mo><mo separator="true">,</mo><mo separator="true">⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(·,·)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mclose">)</span></span></span></span> 为欧氏距离，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">m=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。关键在权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mtext>ₚ</mtext><mo separator="true">,</mo><mi>w</mi><mtext>ₙ</mtext></mrow><annotation encoding="application/x-tex">{wₚ, wₙ}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">ₚ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord">ₙ</span></span></span></span></span> 的设计。</p><h3 id="22-自适应权重awtl"><a class="markdownIt-Anchor" href="#22-自适应权重awtl"></a> 2.2 自适应权重（AWTL）</h3><p>与 Batch-Hard 仅给最难样本赋 1、其余 0 不同，作者提出 softmax 式连续权重：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mi>p</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mi>d</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>p</mi></msub><mo stretchy="false">)</mo></mrow></msup><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>P</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow></munder><msup><mi>e</mi><mrow><mi>d</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mspace width="1em"/><msub><mi>w</mi><mi>n</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mi>d</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow></msup><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>N</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow></munder><msup><mi>e</mi><mrow><mo>−</mo><mi>d</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">w_p=\frac{e^{d(x_a,x_p)}}{\sum_{x\in P(a)}e^{d(x_a,x)}},\quad w_n=\frac{e^{-d(x_a,x_n)}}{\sum_{x\in N(a)}e^{-d(x_a,x)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.74371em;vertical-align:-1.17871em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.2960000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.22528999999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">a</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.47471em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.17871em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.74371em;vertical-align:-1.17871em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.2960000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.22528999999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">a</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.47471em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">d</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">d</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.17871em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>Batch-Hard的缺点：</p><ul><li>梯度只来自两张图，其余样本被浪费；</li><li>如果“最难”样本是离群帧（遮挡、误检），网络会被强行拉向错误方向；</li><li>权重是 0/1 硬分配，无法兼顾多个难样本。</li></ul><p>自适应权重的优势：</p><ul><li>hardest 样本若是离群，权重不会独大；</li><li>多个难分样本同时获得梯度，训练更稳定。</li></ul><h3 id="23-困难身份挖掘hnm"><a class="markdownIt-Anchor" href="#23-困难身份挖掘hnm"></a> 2.3 困难身份挖掘（HNM）</h3><p>训练集身份数大时，随机 PK 采样很难碰到真正困难的身份。作者维护两个池：</p><ul><li>Hard-Identity-Pool H：对当前锚点，全局特征距离最大的 H=50 个身份；</li><li>Random-Pool：其余身份。</li></ul><p>每个 mini-batch 中，除锚身份外的 P–1 个身份以 0.5/0.5 概率从上述两池抽取，再各随机选 K=4 张图。<br />实践：网络先 warm-up 5 k 次迭代，用此刻特征离线计算一次 H，之后固定到训练结束。</p><h3 id="24-网络结构与增强"><a class="markdownIt-Anchor" href="#24-网络结构与增强"></a> 2.4 网络结构与增强</h3><p>训练样本：含行人的边框图 + 身份编号</p><ol><li><strong>骨架：ImageNet 预训练 ResNet-50</strong>：</li></ol><ul><li>输入形状：(B, 3, 256, 128)</li><li>输出：<strong>pool5</strong> 特征图 (B, 2048, 8, 4)（原始 ImageNet 是 7×7，这里是 8×4，因为行人图高宽比 2:1）</li><li>只保留“卷积+BN+ReLU”部分，把全局平均池化（GAP）和 1000-D fc 全部丢掉；确保得到空间维度 8×4 的 2048 通道卷积特征。</li></ul><ol start="2"><li><strong>全局最大池化（GMP）或平均池化（GAP）</strong></li></ol><ul><li>使用Global Average Pooling（GAP）或者 Global Max Pooling（GMP）把 (B, 2048, 8, 4) 的特征图压成 (B, 2048, 1, 1)，再 flatten 成 (B, 2048) 向量。把空间信息压成固定长度向量</li></ul><ol start="3"><li><strong>第一全连接</strong></li></ol><ul><li>全连接层：把 2048 维向量映射到 1024 维。</li><li>加 BatchNorm1d(缓解内部协变量偏移)</li><li>加 ReLU(引入非线性)</li></ul><ol start="4"><li><strong>第二全连接</strong></li></ol><ul><li>1024 → 128（嵌入层）</li><li>直接输出 128-D 向量，保证嵌入空间是线性的，方便后面算欧氏距离</li></ul><ol start="5"><li><strong>L₂ 归一化</strong></li></ol><ul><li>把每个 128-D 向量拉成单位球面：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>‖</mtext><mi>x</mi><mtext>‖₂</mtext><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">‖x‖₂ = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord">‖</span><span class="mord mathnormal">x</span><span class="mord">‖</span><span class="mord">₂</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></li></ul><ol start="6"><li><strong>最终输出</strong></li></ol><ul><li>把网络输出的 128-D 单位向量组织成三元组$ (xa, xp, xn)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，算欧氏距离</mtext></mrow><annotation encoding="application/x-tex">，算欧氏距离</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">算</span><span class="mord cjk_fallback">欧</span><span class="mord cjk_fallback">氏</span><span class="mord cjk_fallback">距</span><span class="mord cjk_fallback">离</span></span></span></span> d(·,·)$，再代入自适应加权三元组损失，得到梯度并回传。</li></ul><p>上述方法的伪代码为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">model.train()</span><br><span class="line">optim.zero_grad()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 1. 前向拿到 128-D 单位向量 =====</span></span><br><span class="line">embs = model(imgs)          <span class="comment"># (B, 128)  已在模型里 L2-normalize</span></span><br><span class="line">embs = embs.view(P, K, <span class="number">128</span>) <span class="comment"># (P, K, 128) 方便按身份切片</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 2. 逐身份构造三元组 =====</span></span><br><span class="line">loss_batch = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(P):               <span class="comment"># 每个身份当一次锚</span></span><br><span class="line">    xa = embs[i, <span class="number">0</span>]              <span class="comment"># 选该身份第 1 张当锚（可随机）</span></span><br><span class="line">    xp = embs[i, <span class="number">1</span>:]             <span class="comment"># 同身份其余 K-1 张 = 正</span></span><br><span class="line">    xn = embs[torch.arange(P)!=i] <span class="comment"># 其余 (P-1) 个身份 = 负</span></span><br><span class="line">    xn = xn.view(-<span class="number">1</span>, <span class="number">128</span>)        <span class="comment"># 拉平成 ((P-1)*K, 128)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 3. 算欧氏距离 =====</span></span><br><span class="line">    d_ap = torch.cdist(xa.unsqueeze(<span class="number">0</span>), xp)  <span class="comment"># (1, K-1)</span></span><br><span class="line">    d_an = torch.cdist(xa.unsqueeze(<span class="number">0</span>), xn)  <span class="comment"># (1, (P-1)*K)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 4. 自适应权重 =====</span></span><br><span class="line">    w_p = F.softmax(d_ap, dim=<span class="number">1</span>)             <span class="comment"># 正样本权重 (1, K-1)</span></span><br><span class="line">    w_n = F.softmax(-d_an, dim=<span class="number">1</span>)            <span class="comment"># 负样本权重 (1, (P-1)*K)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 5. 加权三元组损失 =====</span></span><br><span class="line">    pos_term = (w_p * d_ap).<span class="built_in">sum</span>()</span><br><span class="line">    neg_term = (w_n * d_an).<span class="built_in">sum</span>()</span><br><span class="line">    loss_i = F.relu(m + pos_term - neg_term) <span class="comment"># m=1 论文设置</span></span><br><span class="line">    loss_batch += loss_i</span><br><span class="line"></span><br><span class="line">loss = loss_batch / P          <span class="comment"># 平均到每个锚</span></span><br><span class="line">loss.backward()</span><br><span class="line">optim.step()</span><br></pre></td></tr></table></figure><hr /><h2 id="3-测试mtmc-跟踪-pipeline"><a class="markdownIt-Anchor" href="#3-测试mtmc-跟踪-pipeline"></a> 3. 测试：MTMC 跟踪 pipeline</h2><p>整体流程见下图</p><img src="/2025/11/11/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBFMTMCRI/image.png" class="" title="sucessful"><h3 id="31-输入检测"><a class="markdownIt-Anchor" href="#31-输入检测"></a> 3.1 输入检测</h3><p>采用公开 OpenPose 人体检测器（基于 PAF，在 Part Affinity 上直接监督），输出每帧边界框。</p><h3 id="32-特征提取"><a class="markdownIt-Anchor" href="#32-特征提取"></a> 3.2 特征提取</h3><p>检测给出的任意高宽比框先被等比缩放到高 256 像素、宽 128 像素（不足两侧补灰条），再做 ImageNet 均值-方差归一化；固定权重的 ResNet-50 卷积基提取 2048-D 全局特征，经 2048→1024→128 两层全连接（带 BN 与 ReLU）并 L₂ 归一化后，输出 128 维单位向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mtext>ᵢ</mtext></mrow><annotation encoding="application/x-tex">xᵢ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mord">ᵢ</span></span></span></span>，供后续关联使用。</p><h3 id="33-相似度计算"><a class="markdownIt-Anchor" href="#33-相似度计算"></a> 3.3 相似度计算</h3><ol><li><strong>外观相关度</strong>：</li></ol><ul><li>先离线在训练集上统计所有正/负对的平均距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mtext>ₚ</mtext><mo separator="true">,</mo><mi>μ</mi><mtext>ₙ</mtext></mrow><annotation encoding="application/x-tex">μₚ, μₙ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">μ</span><span class="mord">ₚ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">μ</span><span class="mord">ₙ</span></span></span></span>，令阈值<br />  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mtext>ₐ</mtext><mo>=</mo><mo stretchy="false">(</mo><mi>μ</mi><mtext>ₚ</mtext><mo>+</mo><mi>μ</mi><mtext>ₙ</mtext><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">tₐ = (μₚ + μₙ)/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">ₐ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">μ</span><span class="mord">ₚ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">μ</span><span class="mord">ₙ</span><span class="mclose">)</span><span class="mord">/</span><span class="mord">2</span></span></span></span>  (≤1)</li><li>则对任意一对检测,外观相关度为：<br />  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>A</mi></msubsup><mo>=</mo><mo stretchy="false">(</mo><mi>t</mi><mtext>ₐ–</mtext><mi>d</mi><mo stretchy="false">(</mo><mi>x</mi><mtext>ᵢ</mtext><mo separator="true">,</mo><mi>x</mi><mtext>ⱼ</mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>t</mi><mtext>ₐ</mtext></mrow><annotation encoding="application/x-tex">w_{ij}^{A} = (tₐ – d(xᵢ,xⱼ))/tₐ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.236103em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord">ₐ</span><span class="mord">–</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">ᵢ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">x</span><span class="mord">ⱼ</span><span class="mclose">)</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal">t</span><span class="mord">ₐ</span></span></span></span> <br />值域 (−∞,1]，同身份期望为正，异身份期望为负。</li></ul><ol start="2"><li><strong>运动相关度</strong>：</li></ol><ul><li>离线：用训练集里已知的短轨迹，按“常速模型”向前、向后各预测 10 帧，得到预测框与真实框的 IoU 误差，统计出能把“同一轨迹对”与“不同轨迹对”分开的误差阈值$ t_m$ 和缩放因子 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">α</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></li><li>在线：对两条待关联轨迹，用各自最近 5 帧估速度，采用线性匀速模型,前向-后向双向预测，得误差 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>m</mi></msub><mo>=</mo><msub><mi>e</mi><mi>f</mi></msub><mo>+</mo><msub><mi>e</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">e_m = e_f + e_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。<br />在训练集上拟合阈值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">t_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 及缩放 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">α</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span>，令<br />  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow><mi>M</mi></msubsup><mo>=</mo><mi>α</mi><mo stretchy="false">(</mo><msub><mi>t</mi><mi>m</mi></msub><mtext>–</mtext><msub><mi>e</mi><mi>m</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">w_{ij}^{M} = α(t_m – e_m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.236103em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">–</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>  若 e_m 可计算；否则$ –∞$<br />为正，鼓励关联，为负，拒绝不可能跳跃</li></ul><ol start="3"><li><p>时间折扣：<br />对时间差 Δt 的两检测，引入指数衰减， 惩罚“时间隔得太远”的边<br />  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><mtext>–</mtext><mi>β</mi><mi mathvariant="normal">Δ</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{ij} = exp(–βΔt)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord">–</span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></p></li><li><p>最终边权<br />  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>W</mi><mi>A</mi></msup><mo>+</mo><msup><mi>W</mi><mi>M</mi></msup><mo stretchy="false">)</mo><mo>⊙</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">W = (W^{A} + W^{M}) ⊙ D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> <br />其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⊙</mo></mrow><annotation encoding="application/x-tex">⊙</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">⊙</span></span></span></span> 为逐元素乘。</p></li></ol><h3 id="34-相关聚类优化"><a class="markdownIt-Anchor" href="#34-相关聚类优化"></a> 3.4 相关聚类优化</h3><ol><li><p><strong>构造无向图</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo>=</mo><mo stretchy="false">(</mo><mi>V</mi><mo separator="true">,</mo><mi>E</mi><mo separator="true">,</mo><mi>W</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G=(V,E,W)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> 为所有检测节点(每一帧的每个检测框就是一个节点，带属性 ⟨t, x, y, w, h, 128-D 向量⟩。)，边权 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> 如上(正值 → 鼓励同簇；负值 → 鼓励异簇)。</p></li><li><p><strong>目标函数</strong>：最大化一致边的总权重，给每条边一个二进制变量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mi>j</mi><mo>∈</mo><mrow><mn>0</mn><mo separator="true">,</mo><mn>1</mn></mrow></mrow><annotation encoding="application/x-tex">x_ij ∈ {0,1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span></span></span></span></span></p></li></ol><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x_{ij} = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> ⇒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 同身份（放在同一簇）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x_{ij} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> ⇒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 不同身份（分属两簇）<br />整数规划就是</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mi mathvariant="normal">Σ</mi><msub><mi>w</mi><mi>i</mi></msub><mi>j</mi><msub><mi>x</mi><mi>i</mi></msub><mi>j</mi></mrow><annotation encoding="application/x-tex">max Σ w_ij x_ij</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord">Σ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span><br />尽量多地把正值边收进簇里，把负值边踢到簇外</li></ul><ol start="3"><li><strong>约束条件</strong>：</li></ol><ul><li>传递性：<br />  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><mo>≤</mo><mn>1</mn><mo>+</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{ij} + x_{jk} ≤ 1 + x_{ik}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.922078em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br />即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo separator="true">,</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">i,j,k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 三者中，若 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i,j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 同身份，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i,k,j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 同身份，必须满足传递性。</li></ul><ol start="4"><li><strong>求解方法</strong>：<br />求解整数规划：</li></ol><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>∗</mo><mo>=</mo><mi>a</mi><mi>r</mi><mi>g</mi><mi>m</mi><mi>a</mi><msub><mi>x</mi><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∈</mo><mrow><mn>0</mn><mo separator="true">,</mo><mn>1</mn></mrow></mrow></msub><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>∈</mo><mi>E</mi></mrow></munder><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mtext> </mtext><mi>s</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">.</mi><mtext> </mtext><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><mo>≤</mo><mn>1</mn><mo>+</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X* = argmax_{x_{ij}∈{0,1}} ∑_{(i,j)∈E} w_{ij}x_{ij}   s.t. x_{ij}+x_{jk} ≤ 1+x_{ik}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord">∗</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.5660100000000003em;vertical-align:-1.516005em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110800000000004em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.808995em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"> </span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord"> </span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.922078em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>等价于最大一致子图问题，NP-hard，但现有启发式（如 SA、Greedy Agglomerative）在千级节点上足够高效。  解中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>=1 表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i,j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 同身份，由此得到全局身份标签。</p><h3 id="35-后处理"><a class="markdownIt-Anchor" href="#35-后处理"></a> 3.5 后处理</h3><ul><li>线性插值：对同一轨迹 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><msub><mi>t</mi><mi>g</mi></msub><mi>a</mi><mi>p</mi><mo>≤</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">0 &lt; t_gap ≤ 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.922078em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> s 的漏检做线性插补；</li><li>低置信修剪：若轨迹检测置信均值 &lt; 0 或长度 &lt; 5 帧，则丢弃。</li></ul><h3 id="36-三级层次推理降低复杂度"><a class="markdownIt-Anchor" href="#36-三级层次推理降低复杂度"></a> 3.6 三级层次推理降低复杂度</h3><ol><li>Tracklet 级：1 s 不重叠滑动窗内用贪心最近邻生成短轨迹；</li><li>单相机级：10 s 滑动窗（50 % 重叠）内把 tracklet 作为节点，重复 3.3-3.4 步骤；</li><li>跨相机级：1.5 min 滑动窗，把单相机轨迹作为节点，重复 3.3-3.4 步骤，得到最终跨相机 ID。</li></ol><hr />]]></content>
    
    
    <summary type="html">&lt;p&gt;梳理MTMC问题经典论文Features for Multi-Target Multi-Camera Tracking and Re-Identification中的方法。&lt;/p&gt;</summary>
    
    
    
    <category term="算法" scheme="https://atffang.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
  </entry>
  
  <entry>
    <title>基于三维模型的监控画面模拟与深度标定工具开发</title>
    <link href="https://atffang.github.io/2025/11/05/%E5%9F%BA%E4%BA%8E%E4%B8%89%E7%BB%B4%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9B%91%E6%8E%A7%E7%94%BB%E9%9D%A2%E6%A8%A1%E6%8B%9F%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%A0%87%E5%AE%9A%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/"/>
    <id>https://atffang.github.io/2025/11/05/%E5%9F%BA%E4%BA%8E%E4%B8%89%E7%BB%B4%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9B%91%E6%8E%A7%E7%94%BB%E9%9D%A2%E6%A8%A1%E6%8B%9F%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%A0%87%E5%AE%9A%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/</id>
    <published>2025-11-05T11:07:07.000Z</published>
    <updated>2026-01-10T14:27:45.719Z</updated>
    
    <content type="html"><![CDATA[<p>基于三维模型的监控画面模拟与深度标定工具开发。基于Vue + vite + electron + cesium的桌面端软件。</p><span id="more"></span><p>最近做的方向有这样一个需求：计算研究区域的众多监控摄像头画面对应的深度图，即能够得到画面上像素点对应的真实世界坐标。因此，开发了一款基于Electron+Vue的，依赖Cesium可视化研究区域三维模型（3dtiles）的桌面端软件Oculus，并模拟监控画面与视锥，以此做到真实画面与三维模型匹配，从而得到真实画面深度。</p><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/操作过程.gif"/><p>Oculus的主页面如下：<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/主页.jpg"/></p><p>通过查询并点击右侧的摄像头信息滚动栏或者点击左侧地图中的摄像头图标，可以索引到该摄像头的位置，并在地图右上角弹出具体信息，软件右上角出现摄像头画面。</p><p>继续点击右侧栏的相应摄像头编辑按钮，打开编辑窗口如下。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/视锥画面.png"/></p><p>左侧为摄像头基础参数编辑区域，包括经纬度与高程，航向角、俯仰角，垂直视场角，宽高比，远近平面距离。修改后，右侧视锥也会随着参数变化实时渲染。</p><p>点击切换为监控视角，即可观察到模拟监控视角画面，通过调整参数，达到和监控画面几乎一样的视域，同时，为了辅助对比，真实画面与模拟画面相应的位置存在五个辅助锚定点。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/模拟画面.png"/></p><p>在调整好参数后，可以点击生成稀疏深度按钮，软件将选取画面上2000个点，计算其真实的三维坐标，并下载，同时下载的还有真实摄像头画面。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/深度标定.png"/></p><p>为了检测生成的点是否正确，我们将其倒入cesium中，同时加载和上文相同的三维模型，效果如下：<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/标定点01.png"/></p><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/标定点02.png"/><p>这样的效果证明，我们标定的坐标基本上是正确的，后续可以通过高程筛选z值，或者通过分布筛选，以选取符合目的的点。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/z值区间.png"/></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;基于三维模型的监控画面模拟与深度标定工具开发。基于Vue + vite + electron + cesium的桌面端软件。&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="https://atffang.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>Datahader.Networks 绘制bundling flow</title>
    <link href="https://atffang.github.io/2025/11/01/Datahader.Networks%20%E7%BB%98%E5%88%B6bundling%20flow/"/>
    <id>https://atffang.github.io/2025/11/01/Datahader.Networks%20%E7%BB%98%E5%88%B6bundling%20flow/</id>
    <published>2025-11-01T11:16:07.000Z</published>
    <updated>2026-01-10T14:27:40.383Z</updated>
    
    <content type="html"><![CDATA[<p>Datahader.Networks 绘制bundling flow</p><span id="more"></span><p>详细文档参见 <a href="https://datashader.org/user_guide/Networks.html">https://datashader.org/user_guide/Networks.html</a></p><p>我们曾经介绍了绘制普通流的方式，实际上仅仅是基于贝塞尔曲线做了插值，绘制了类似于“飞机航线”的流线。使用简单的arcgis插件，也可以绘制很不错直观的流图，比如下面我画的中国人口流动图：<br /><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/中国人口流动.png"/></p><p>但是这种流绘制方式虽然最为直观、表达最为准确，但有时候（特别是边权差异不大的时候）像进了盘丝洞，从图上无法提炼出太多的信息，因此，甲方要求我对小红书上一个博主绘制的具有聚集效应的流图进行复现，我先试了js库d3:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">generateSegments</span>(<span class="params">nodes, links</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> bundle = &#123; <span class="attr">nodes</span>: [], <span class="attr">links</span>: [], <span class="attr">paths</span>: [] &#125;;</span><br><span class="line">  bundle.<span class="property">nodes</span> = nodes.<span class="title function_">map</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123; d.<span class="property">fx</span> = d.<span class="property">x</span>; d.<span class="property">fy</span> = d.<span class="property">y</span>; <span class="keyword">return</span> d; &#125;);</span><br><span class="line"></span><br><span class="line">  links.<span class="title function_">forEach</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> length = <span class="title function_">distance</span>(d.<span class="property">source</span>, d.<span class="property">target</span>);</span><br><span class="line">    <span class="keyword">let</span> total = <span class="title class_">Math</span>.<span class="title function_">round</span>(scales.<span class="title function_">segments</span>(length));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> xscale = d3.<span class="title function_">scaleLinear</span>().<span class="title function_">domain</span>([<span class="number">0</span>, total + <span class="number">1</span>]).<span class="title function_">range</span>([d.<span class="property">source</span>.<span class="property">x</span>, d.<span class="property">target</span>.<span class="property">x</span>]);</span><br><span class="line">    <span class="keyword">let</span> yscale = d3.<span class="title function_">scaleLinear</span>().<span class="title function_">domain</span>([<span class="number">0</span>, total + <span class="number">1</span>]).<span class="title function_">range</span>([d.<span class="property">source</span>.<span class="property">y</span>, d.<span class="property">target</span>.<span class="property">y</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> source = d.<span class="property">source</span>;</span><br><span class="line">    <span class="keyword">let</span> local = [source];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">1</span>; j &lt;= total; j++) &#123;</span><br><span class="line">      <span class="keyword">let</span> target = &#123; <span class="attr">x</span>: <span class="title function_">xscale</span>(j), <span class="attr">y</span>: <span class="title function_">yscale</span>(j) &#125;;</span><br><span class="line">      local.<span class="title function_">push</span>(target);</span><br><span class="line">      bundle.<span class="property">nodes</span>.<span class="title function_">push</span>(target);</span><br><span class="line">      bundle.<span class="property">links</span>.<span class="title function_">push</span>(&#123; source, target &#125;);</span><br><span class="line">      source = target;</span><br><span class="line">    &#125;</span><br><span class="line">    local.<span class="title function_">push</span>(d.<span class="property">target</span>);</span><br><span class="line">    bundle.<span class="property">links</span>.<span class="title function_">push</span>(&#123; source, <span class="attr">target</span>: d.<span class="property">target</span> &#125;);</span><br><span class="line">    bundle.<span class="property">paths</span>.<span class="title function_">push</span>(local);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> bundle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大概实现了下面的场景：<br /><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/js.png"/></p><p>不过这种绘制方法仍然无法达到类似的效果，遂抛弃之，找到了该博主处理流数据的库：<strong>datashader</strong>，接下来我们详细讲讲如何利用datashader.Networks进行绘制，先看看user guide中对该部分的简介：</p><p>The point and line-segment plotting provided by Datashader can be put together in different ways to visualize specific types of data. For instance, network graph data, i.e., networks of nodes connected by edges, can very naturally be represented by points and lines. Here we will show examples of using Datashader’s graph-specific plotting tools, focusing on how to visualize very large graphs while allowing any portion of the rendering pipeline to replaced with components suitable for specific problems.</p><p>Datashader 使用 <strong>Hammer et al. (2009)</strong> 提出的 “Force-Directed Edge Bundling (FDEB)” 算法的改进版，让相似或空间上邻近的边“靠拢”成平滑的流线（bundles），既保持结构关系，又提升可读性。</p><p>具体来说，对于每条边，他们会被拆分为多个小段（segments），每个 segment 是一个可移动的控制点。每个控制点会受到几种力的作用：</p><ul><li><ol><li><strong>内部张力 (Tension)</strong></li></ol></li><li><ol start="2"><li><strong>相似边吸引力 (Attractive force)</strong></li></ol></li><li><ol start="3"><li><strong>带宽控制 (Bandwidth)</strong></li></ol></li></ul><p>通过多次迭代，方法使得带宽逐次变小，使得流互相靠近，形成束状结构。</p><p>我们来复现一下user guide提供的示例代码<br />导入包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datashader <span class="keyword">as</span> ds</span><br><span class="line"><span class="keyword">import</span> datashader.transfer_functions <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> datashader.layout <span class="keyword">import</span> random_layout, circular_layout, forceatlas2_layout</span><br><span class="line"><span class="keyword">from</span> datashader.bundling <span class="keyword">import</span> connect_edges, hammer_bundle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br></pre></td></tr></table></figure><p>随机生成边与节点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">np.random.seed(<span class="number">0</span>)</span><br><span class="line">n=<span class="number">100</span></span><br><span class="line">m=<span class="number">20000</span></span><br><span class="line"></span><br><span class="line">nodes = pd.DataFrame([<span class="string">&quot;node&quot;</span>+<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)], columns=[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">edges = pd.DataFrame(np.random.randint(<span class="number">0</span>,<span class="built_in">len</span>(nodes), size=(m, <span class="number">2</span>)), columns=[<span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;target&#x27;</span>])</span><br><span class="line"></span><br><span class="line">circular = circular_layout(nodes, uniform=<span class="literal">False</span>)</span><br><span class="line">randomloc = random_layout(nodes)</span><br></pre></td></tr></table></figure><p>生成布局与定义一些绘制函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cvsopts = <span class="built_in">dict</span>(plot_height=<span class="number">400</span>, plot_width=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nodesplot</span>(<span class="params">nodes, name=<span class="literal">None</span>, canvas=<span class="literal">None</span>, cat=<span class="literal">None</span></span>):</span><br><span class="line">    canvas = ds.Canvas(**cvsopts) <span class="keyword">if</span> canvas <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> canvas</span><br><span class="line">    aggregator=<span class="literal">None</span> <span class="keyword">if</span> cat <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> ds.count_cat(cat)</span><br><span class="line">    agg=canvas.points(nodes,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,aggregator)</span><br><span class="line">    <span class="keyword">return</span> tf.spread(tf.shade(agg, cmap=[<span class="string">&quot;#FF3333&quot;</span>]), px=<span class="number">3</span>, name=name)</span><br><span class="line">    </span><br><span class="line">forcedirected = forceatlas2_layout(nodes, edges)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edgesplot</span>(<span class="params">edges, name=<span class="literal">None</span>, canvas=<span class="literal">None</span></span>):</span><br><span class="line">    canvas = ds.Canvas(**cvsopts) <span class="keyword">if</span> canvas <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> canvas</span><br><span class="line">    <span class="keyword">return</span> tf.shade(canvas.line(edges, <span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>, agg=ds.count()), name=name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">graphplot</span>(<span class="params">nodes, edges, name=<span class="string">&quot;&quot;</span>, canvas=<span class="literal">None</span>, cat=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> canvas <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        xr = nodes.x.<span class="built_in">min</span>(), nodes.x.<span class="built_in">max</span>()</span><br><span class="line">        yr = nodes.y.<span class="built_in">min</span>(), nodes.y.<span class="built_in">max</span>()</span><br><span class="line">        canvas = ds.Canvas(x_range=xr, y_range=yr, **cvsopts)</span><br><span class="line"></span><br><span class="line">    np = nodesplot(nodes, name + <span class="string">&quot; nodes&quot;</span>, canvas, cat)</span><br><span class="line">    ep = edgesplot(edges, name + <span class="string">&quot; edges&quot;</span>, canvas)</span><br><span class="line">    <span class="keyword">return</span> tf.stack(ep, np, how=<span class="string">&quot;over&quot;</span>, name=name)</span><br></pre></td></tr></table></figure><p>绘制：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd = circular</span><br><span class="line">fd = forcedirected</span><br><span class="line"></span><br><span class="line">cd_d = graphplot(cd, connect_edges(cd,edges), <span class="string">&quot;Circular layout&quot;</span>)</span><br><span class="line">fd_d = graphplot(fd, connect_edges(fd,edges), <span class="string">&quot;Force-directed&quot;</span>)</span><br><span class="line">cd_b = graphplot(cd, hammer_bundle(cd,edges), <span class="string">&quot;Circular layout, bundled&quot;</span>)</span><br><span class="line">fd_b = graphplot(fd, hammer_bundle(fd,edges), <span class="string">&quot;Force-directed, bundled&quot;</span>)</span><br><span class="line"></span><br><span class="line">tf.Images(cd_d,fd_d,cd_b,fd_b).cols(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/exam.png"/><p>还是挺方便的。接下来我们使用自己的数据进行绘制。必要的数据包括node（包含name与xy坐标）和edge（包含代表od的source和target，可自行选择是否加上weight）。<br />导入包：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> datashader.bundling <span class="keyword">import</span> hammer_bundle</span><br><span class="line"><span class="keyword">import</span> pyproj</span><br><span class="line"><span class="keyword">import</span> geopandas <span class="keyword">as</span> gpd</span><br><span class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> LineString</span><br></pre></td></tr></table></figure><p>加载数据，并映射一下字段名到其要求的值，并且投影坐标以绘制。这里有一个非常坑的要点：<br /><strong>node 的 index（pandas.dataframe的index）才是和 edge 的 source 与 target 匹配的 key ，而不是 name 字段。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">china_edge = pd.read_csv(<span class="string">&quot;/Users/fangtianyao/Desktop/其他/flowdata/edge_1.csv&quot;</span>)</span><br><span class="line">china_node = pd.read_csv(<span class="string">&quot;/Users/fangtianyao/Desktop/其他/flowdata/node_with_name.csv&quot;</span>)</span><br><span class="line">nodes = china_node[[<span class="string">&#x27;iata&#x27;</span>, <span class="string">&#x27;longitude&#x27;</span>, <span class="string">&#x27;latitude&#x27;</span>]].rename(</span><br><span class="line">    columns=&#123;<span class="string">&#x27;iata&#x27;</span>: <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;longitude&#x27;</span>: <span class="string">&#x27;x84&#x27;</span>, <span class="string">&#x27;latitude&#x27;</span>: <span class="string">&#x27;y84&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line">edges = china_edge[[<span class="string">&#x27;origin&#x27;</span>, <span class="string">&#x27;destination&#x27;</span>, <span class="string">&#x27;count&#x27;</span>]].rename(</span><br><span class="line">    columns=&#123;<span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;destination&#x27;</span>: <span class="string">&#x27;target&#x27;</span>, <span class="string">&#x27;count&#x27;</span>: <span class="string">&#x27;weight&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">proj = pyproj.Transformer.from_crs(<span class="string">&quot;EPSG:4326&quot;</span>, <span class="string">&quot;EPSG:3857&quot;</span>, always_xy=<span class="literal">True</span>)</span><br><span class="line">nodes[<span class="string">&#x27;x&#x27;</span>], nodes[<span class="string">&#x27;y&#x27;</span>] = proj.transform(nodes[<span class="string">&#x27;x84&#x27;</span>], nodes[<span class="string">&#x27;y84&#x27;</span>])</span><br><span class="line">layout = nodes.copy()</span><br><span class="line">layout.index = layout[<span class="string">&#x27;name&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">layout.index.name = <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>调用<code>hammer_bundle</code>计算：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundled_edges = hammer_bundle(layout, edges, decay=decay, initial_bandwidth=bw)</span><br></pre></td></tr></table></figure><p>这里的 <code>decay</code> 和 <code>bw</code> 是两个0-1的参数，这里我们先分别取0.5。</p><p>计算得到的 <code>bundled_edges </code> 是一个包含所有扭曲过后的边的所有构成点的df，每条边的点之间用一个空行相隔。打印给你看看。</p><table><thead><tr><th></th><th>x</th><th>y</th><th>weight</th></tr></thead><tbody><tr><td>1301138</td><td>1.257390e+07</td><td>2.951534e+06</td><td>7.0</td></tr><tr><td>1301139</td><td>1.258085e+07</td><td>2.914048e+06</td><td>7.0</td></tr><tr><td>1301140</td><td>1.258971e+07</td><td>2.877599e+06</td><td>7.0</td></tr><tr><td>1301141</td><td>1.264494e+07</td><td>2.852891e+06</td><td>7.0</td></tr><tr><td>1301142</td><td>NaN</td><td>NaN</td><td>NaN</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>为了绘制，我们使用该数据创建 GeoDataFrame：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lines = []</span><br><span class="line">current_points = []</span><br><span class="line">current_weight = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx, row <span class="keyword">in</span> bundled_edges.iterrows():</span><br><span class="line">    <span class="keyword">if</span> pd.isna(row[<span class="string">&#x27;x&#x27;</span>]) <span class="keyword">or</span> pd.isna(row[<span class="string">&#x27;y&#x27;</span>]):</span><br><span class="line">        <span class="comment"># 遇到空行，生成上一条边</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(current_points) &gt;= <span class="number">2</span>:</span><br><span class="line">            line = LineString(current_points)</span><br><span class="line">            lines.append(&#123;<span class="string">&#x27;weight&#x27;</span>: current_weight, <span class="string">&#x27;geometry&#x27;</span>: line&#125;)</span><br><span class="line">        current_points = []</span><br><span class="line">        current_weight = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        current_points.append((row[<span class="string">&#x27;x&#x27;</span>], row[<span class="string">&#x27;y&#x27;</span>]))</span><br><span class="line">        <span class="comment"># 假设 weight 相同，取第一个点的 weight</span></span><br><span class="line">        <span class="keyword">if</span> current_weight <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            current_weight = row[<span class="string">&#x27;weight&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(current_points) &gt;= <span class="number">2</span>:</span><br><span class="line">    line = LineString(current_points)</span><br><span class="line">    lines.append(&#123;<span class="string">&#x27;weight&#x27;</span>: current_weight, <span class="string">&#x27;geometry&#x27;</span>: line&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 GeoDataFrame</span></span><br><span class="line">gdf = gpd.GeoDataFrame(lines, crs=<span class="string">&quot;EPSG:3857&quot;</span>)</span><br></pre></td></tr></table></figure><p>我们用这个数据绘制流在地图上：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> geopandas <span class="keyword">as</span> gpd</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> Point</span><br><span class="line"><span class="keyword">import</span> contextily <span class="keyword">as</span> ctx</span><br><span class="line"></span><br><span class="line">nodes_gdf = gpd.GeoDataFrame(</span><br><span class="line">    nodes,</span><br><span class="line">    geometry=[Point(xy) <span class="keyword">for</span> xy <span class="keyword">in</span> <span class="built_in">zip</span>(nodes[<span class="string">&#x27;x&#x27;</span>], nodes[<span class="string">&#x27;y&#x27;</span>])],</span><br><span class="line">    crs=<span class="string">&quot;EPSG:3857&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">edges_gdf = gdf.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算线宽</span></span><br><span class="line">min_width = <span class="number">0.2</span></span><br><span class="line">max_width = <span class="number">5.0</span></span><br><span class="line">weights = edges_gdf[<span class="string">&#x27;weight&#x27;</span>].astype(<span class="built_in">float</span>)</span><br><span class="line">line_widths = min_width + (weights - weights.<span class="built_in">min</span>()) / (weights.<span class="built_in">max</span>() - weights.<span class="built_in">min</span>()) * (max_width - min_width)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘图</span></span><br><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">10</span>), dpi=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 画边</span></span><br><span class="line">edges_gdf.plot(ax=ax, linewidth=line_widths, edgecolor=<span class="string">&#x27;#305669&#x27;</span>, alpha=<span class="number">0.6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 画节点</span></span><br><span class="line">nodes_gdf.plot(ax=ax, color=<span class="string">&#x27;#0C2B4E&#x27;</span>, markersize=<span class="number">15</span>, alpha=<span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加底图</span></span><br><span class="line">ctx.add_basemap(ax, source=ctx.providers.OpenStreetMap.Mapnik, crs=nodes_gdf.crs)</span><br><span class="line"></span><br><span class="line">ax.set_title(<span class="string">&quot;fty&quot;</span>, fontsize=<span class="number">16</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Longitude&quot;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Latitude&quot;</span>)</span><br><span class="line">plt.axis(<span class="string">&#x27;equal&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/part.png"/><p>为了比较不同 <code>decay</code> 和 <code>bw</code> 参数组合的效果，我做了一个小组合测试，读者可以自己进行测试，亦可以参考下user guide里面基于随机数据做的测试。<br /><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/final.png"/></p><p>还是不错的吧😌</p><p>最后给出封装好的函数，该函数用于对空间网络数据执行基于 Hammer 算法 的边捆绑（Edge Bundling）操作，以减少边的视觉交叉并增强整体结构的空间可读性。<br />输入参数<br />•edge_path (str)：边数据文件路径，要求为 CSV 格式，包含源节点、目标节点及权重等字段。<br />•node_path (str)：节点数据文件路径，要求为 CSV 格式，包含节点唯一标识及经纬度坐标字段。<br />•nodes_id_col (str)：节点文件中表示节点唯一编号的列名，默认 “node_id” <strong>务必是int类型！！！</strong>。<br />•node_lon_col (str)：节点经度列名，默认 “lon”。<br />•node_lat_col (str)：节点纬度列名，默认 “lat”。<br />•edge_source_col (str)：边文件中表示起点节点的列名，默认 “source” 和上面的node_id匹配，<strong>务必是int类型！！！</strong>。<br />•edge_target_col (str)：边文件中表示终点节点的列名，默认 “target” 和上面的node_id匹配，<strong>务必是int类型！！！</strong>。<br />•weight_col (str)：边文件中表示权重（如流量、强度）的列名，默认 “weight”。<br />•decay (float)：Hammer 算法的衰减参数，控制边的收敛速度（0–1之间）。<br />•bw (float)：初始带宽参数，控制捆绑的紧密程度（0–1之间）。<br />•input_crs (str)：输入数据的坐标参考系，默认 “EPSG:4326”（WGS84）。<br />•output (bool)：是否输出文件，默认 True。<br />•output_format (Literal[“geojson”, “shp”])：输出文件格式，默认 “geojson”。<br />•output_path (Optional[str])：输出文件保存路径，若为 None，则仅返回结果不保存。<br />输出结果<br />•返回值 (geopandas.GeoDataFrame)：<br />函数返回一个包含边捆绑后几何结果的 GeoDataFrame，其属性包括原始边的全部字段及对应的空间几何 (LineString)。结果的坐标参考系为 “EPSG:4326”，可直接用于 GIS 可视化或空间分析。<br />若设置 output=True，则函数还会在指定路径下导出相应的 GeoJSON 或 Shapefile 文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> geopandas <span class="keyword">as</span> gpd</span><br><span class="line"><span class="keyword">import</span> pyproj</span><br><span class="line"><span class="keyword">from</span> datashader.bundling <span class="keyword">import</span> hammer_bundle</span><br><span class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> LineString</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">import</span> copy</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">perform_edge_bundling</span><span class="params">(</span></span><br><span class="line"><span class="params">    edge_path: str,</span></span><br><span class="line"><span class="params">    node_path: str,</span></span><br><span class="line"><span class="params">    nodes_id_col: str = <span class="string">&quot;node_id&quot;</span>,</span></span><br><span class="line"><span class="params">    node_lon_col: str = <span class="string">&quot;lon&quot;</span>,</span></span><br><span class="line"><span class="params">    node_lat_col: str = <span class="string">&quot;lat&quot;</span>,</span></span><br><span class="line"><span class="params">    edge_source_col: str = <span class="string">&quot;source&quot;</span>,</span></span><br><span class="line"><span class="params">    edge_target_col: str = <span class="string">&quot;target&quot;</span>,</span></span><br><span class="line"><span class="params">    weight_col: str = <span class="string">&quot;weight&quot;</span>,</span></span><br><span class="line"><span class="params">    decay: <span class="type">float</span> = <span class="number">0.5</span>,</span></span><br><span class="line"><span class="params">    bw: <span class="type">float</span> = <span class="number">0.5</span>,</span></span><br><span class="line"><span class="params">    input_crs: str = <span class="string">&quot;EPSG:4326&quot;</span>,</span></span><br><span class="line"><span class="params">    output: bool = True,</span></span><br><span class="line"><span class="params">    output_format: Literal[<span class="string">&quot;geojson&quot;</span>, <span class="string">&quot;shp&quot;</span>] = <span class="string">&quot;geojson&quot;</span>,</span></span><br><span class="line"><span class="params">    output_path: Optional[str] = None,</span></span><br><span class="line"><span class="params">)</span> -&gt; gpd.GeoDataFrame:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Perform force-directed edge bundling using the Hammer algorithm</span></span><br><span class="line"><span class="string">    on spatial graph data, and export the result as a geospatial file.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    edge_path : str</span></span><br><span class="line"><span class="string">        Path to the CSV file containing edge data.</span></span><br><span class="line"><span class="string">    node_path : str</span></span><br><span class="line"><span class="string">        Path to the CSV file containing node data.</span></span><br><span class="line"><span class="string">    nodes_id_col : str, default &quot;node_id&quot;</span></span><br><span class="line"><span class="string">        Column name for node identifiers in the node CSV.</span></span><br><span class="line"><span class="string">    node_lon_col : str, default &quot;lon&quot;</span></span><br><span class="line"><span class="string">        Column name for node longitude.</span></span><br><span class="line"><span class="string">    node_lat_col : str, default &quot;lat&quot;</span></span><br><span class="line"><span class="string">        Column name for node latitude.</span></span><br><span class="line"><span class="string">    edge_source_col : str, default &quot;source&quot;</span></span><br><span class="line"><span class="string">        Column name for edge source node ID.</span></span><br><span class="line"><span class="string">    edge_target_col : str, default &quot;target&quot;</span></span><br><span class="line"><span class="string">        Column name for edge target node ID.</span></span><br><span class="line"><span class="string">    weight_col : str, default &quot;weight&quot;</span></span><br><span class="line"><span class="string">        Column name for edge weights.</span></span><br><span class="line"><span class="string">    decay : float, default 0.5</span></span><br><span class="line"><span class="string">        Decay parameter of the hammer_bundle algorithm (0 &lt; decay &lt; 1).</span></span><br><span class="line"><span class="string">    bw : float, default 0.5</span></span><br><span class="line"><span class="string">        Initial bandwidth parameter of hammer_bundle (controls bundle tightness).</span></span><br><span class="line"><span class="string">    input_crs : str, default &quot;EPSG:4326&quot;</span></span><br><span class="line"><span class="string">        Coordinate reference system (CRS) of the input node coordinates.</span></span><br><span class="line"><span class="string">        Usually &quot;EPSG:4326&quot; for WGS84 or &quot;EPSG:3857&quot; for Web Mercator.</span></span><br><span class="line"><span class="string">    output : bool, default True</span></span><br><span class="line"><span class="string">        Whether to save the output file.</span></span><br><span class="line"><span class="string">    output_format : &#123;&quot;geojson&quot;, &quot;shp&quot;&#125;, default &quot;geojson&quot;</span></span><br><span class="line"><span class="string">        Desired output file format.</span></span><br><span class="line"><span class="string">    output_path : str, optional</span></span><br><span class="line"><span class="string">        Path to save the output file. If None, the file will not be written.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    gdf : geopandas.GeoDataFrame</span></span><br><span class="line"><span class="string">        GeoDataFrame containing bundled edge geometries and their weights,</span></span><br><span class="line"><span class="string">        projected in WGS84 (EPSG:4326).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises</span></span><br><span class="line"><span class="string">    ------</span></span><br><span class="line"><span class="string">    FileNotFoundError</span></span><br><span class="line"><span class="string">        If either `edge_path` or `node_path` does not exist.</span></span><br><span class="line"><span class="string">    ValueError</span></span><br><span class="line"><span class="string">        If required columns are missing in the provided CSVs.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[1/6] 读取节点与边文件...&quot;</span>)</span><br><span class="line">    edges = pd.read_csv(edge_path)</span><br><span class="line">    edges_copy = copy.deepcopy(edges)</span><br><span class="line">    nodes = pd.read_csv(node_path)</span><br><span class="line"></span><br><span class="line">    print(f<span class="string">&quot;节点数: &#123;len(nodes)&#125;, 边数: &#123;len(edges)&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[2/6] 检查输入字段有效性...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> col in [nodes_id_col, node_lon_col, node_lat_col]:</span><br><span class="line">        <span class="keyword">if</span> col not in nodes.columns:</span><br><span class="line">            raise <span class="title function_">ValueError</span><span class="params">(f<span class="string">&quot;Missing required column &#x27;&#123;col&#125;&#x27; in node file.&quot;</span>)</span></span><br><span class="line">    <span class="keyword">for</span> col in [edge_source_col, edge_target_col, weight_col]:</span><br><span class="line">        <span class="keyword">if</span> col not in edges.columns:</span><br><span class="line">            raise <span class="title function_">ValueError</span><span class="params">(f<span class="string">&quot;Missing required column &#x27;&#123;col&#125;&#x27; in edge file.&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    edges = edges[[edge_source_col, edge_target_col, weight_col]].rename(</span><br><span class="line">        columns=&#123;edge_source_col: <span class="string">&#x27;source&#x27;</span>, edge_target_col: <span class="string">&#x27;target&#x27;</span>, weight_col: <span class="string">&#x27;weight&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    nodes = nodes[[nodes_id_col, node_lon_col, node_lat_col]]</span><br><span class="line"></span><br><span class="line">    edges[<span class="string">&quot;source&quot;</span>] = edges[<span class="string">&quot;source&quot;</span>].astype(<span class="type">int</span>)</span><br><span class="line">    edges[<span class="string">&quot;target&quot;</span>] = edges[<span class="string">&quot;target&quot;</span>].astype(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[3/6] 坐标转换为 EPSG:3857 ...&quot;</span>)</span><br><span class="line">    proj_to_3857 = pyproj.Transformer.from_crs(input_crs, <span class="string">&quot;EPSG:3857&quot;</span>, always_xy=True)</span><br><span class="line">    nodes[<span class="string">&quot;x&quot;</span>], nodes[<span class="string">&quot;y&quot;</span>] = proj_to_3857.transform(nodes[node_lon_col], nodes[node_lat_col])</span><br><span class="line"></span><br><span class="line">    layout = nodes.rename(columns=&#123;nodes_id_col: <span class="string">&quot;name&quot;</span>&#125;)[[<span class="string">&quot;name&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>]]</span><br><span class="line">    layout.index = layout[<span class="string">&quot;name&quot;</span>].astype(<span class="type">int</span>)</span><br><span class="line">    layout.index.name = None</span><br><span class="line"></span><br><span class="line">    <span class="title function_">print</span><span class="params">(<span class="string">&quot;[4/6] 执行 Hammer 边捆绑算法 ...&quot;</span>)</span></span><br><span class="line">    bundled = hammer_bundle(layout, edges, decay=decay, initial_bandwidth=bw)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[5/6] 构造捆绑线段 ...&quot;</span>)</span><br><span class="line">    lines = []</span><br><span class="line">    current_points = []</span><br><span class="line">    edge_index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, row in bundled.iterrows():</span><br><span class="line">        <span class="keyword">if</span> pd.isna(row[<span class="string">&quot;x&quot;</span>]) or pd.isna(row[<span class="string">&quot;y&quot;</span>]):</span><br><span class="line">            <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(current_points)</span> &gt;= <span class="number">2</span> and edge_index &lt; len(edges_copy):</span><br><span class="line">                edge_attrs = edges_copy.iloc[edge_index].to_dict()</span><br><span class="line">                edge_attrs[<span class="string">&quot;geometry&quot;</span>] = LineString(current_points)</span><br><span class="line">                lines.append(edge_attrs)</span><br><span class="line">            current_points = []</span><br><span class="line">            edge_index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            current_points.append((row[<span class="string">&quot;x&quot;</span>], row[<span class="string">&quot;y&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(current_points)</span> &gt;= <span class="number">2</span> and edge_index &lt; len(edges_copy):</span><br><span class="line">        edge_attrs = edges_copy.iloc[edge_index].to_dict()</span><br><span class="line">        edge_attrs[<span class="string">&quot;geometry&quot;</span>] = LineString(current_points)</span><br><span class="line">        lines.append(edge_attrs)</span><br><span class="line"></span><br><span class="line">    gdf = gpd.GeoDataFrame(lines, crs=<span class="string">&quot;EPSG:3857&quot;</span>)</span><br><span class="line">    gdf = gdf.to_crs(<span class="string">&quot;EPSG:4326&quot;</span>)</span><br><span class="line"></span><br><span class="line">    print(f<span class="string">&quot;生成 GeoDataFrame，共 &#123;len(gdf)&#125; 条边。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> output:</span><br><span class="line">        print(<span class="string">&quot;[6/6] 输出结果文件&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> output_path:</span><br><span class="line">            <span class="keyword">if</span> output_format == <span class="string">&quot;geojson&quot;</span>:</span><br><span class="line">                gdf.to_file(output_path, driver=<span class="string">&quot;GeoJSON&quot;</span>)</span><br><span class="line">            elif output_format == <span class="string">&quot;shp&quot;</span>:</span><br><span class="line">                gdf.to_file(output_path, driver=<span class="string">&quot;ESRI Shapefile&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                raise <span class="title function_">ValueError</span><span class="params">(<span class="string">&quot;Unsupported output format. Use &#x27;geojson&#x27; or &#x27;shp&#x27;.&quot;</span>)</span></span><br><span class="line">            </span><br><span class="line">            print(f<span class="string">&quot;文件已保存至: &#123;output_path&#125;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;未提供输出路径，未保存文件。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> gdf</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Datahader.Networks 绘制bundling flow&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="https://atffang.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>obsidain基于s3的多端同步</title>
    <link href="https://atffang.github.io/2025/10/18/obsidain%E5%9F%BA%E4%BA%8Es3%E7%9A%84%E5%A4%9A%E7%AB%AF%E5%90%8C%E6%AD%A5/"/>
    <id>https://atffang.github.io/2025/10/18/obsidain%E5%9F%BA%E4%BA%8Es3%E7%9A%84%E5%A4%9A%E7%AB%AF%E5%90%8C%E6%AD%A5/</id>
    <published>2025-10-18T13:44:05.000Z</published>
    <updated>2026-01-10T14:27:36.246Z</updated>
    
    <content type="html"><![CDATA[<p>obsidain基于s3的多端同步。</p><span id="more"></span><p>安利大家一个obsidian非常好用的插件 <strong>Remotely save</strong> ，他可以基于多个云服务厂商，比如 onedrive 与 google drvie 进行多端同步，就不需要买obsidian自己的云服务了。不过我在使用学校邮箱的onedrive进行验证的时候出现了一些问题导致无法继续，不得已使用最基础的s3服务。</p><p>首先，在obsidian的第三方库仓库中下载Remotely save，查看其设置，在第一个选择远程选项中可以选择多种云存储的方式，由于我使用自己的云服务器进行存储与同步，选择第一项S3或兼容S3的服务。</p><p>存储位置我使用了之前99一年买的阿里云挂壁大学生服务器，阿里对大学生没得说，从服务器到大模型token额度，都对学生开放了优惠甚至部分免费的福利。</p><p>在linux云服务器上安装minio，开放9000端口，并新建bucket，保存ID和Key，将上述信息填入Remotely save的，包括服务地址（<a href="http://xxx.xxx.xxx.xxx:9000">http://xxx.xxx.xxx.xxx:9000</a>），区域（填us-east-1就ok），Access Key ID，Secret Access Key，Bucket name，点击检查测试连接即可。</p><p>点击Remotely save的刷新按钮，即可便捷的上传或下拉这个仓库了，超级方便，并且可以在选项中设置打开自动更新，关闭自动更新和每隔一段时间自动更新。</p><img src="https://atffang.github.io/2025/10/18/obsidain基于s3的多端同步/多端同步.jpg"/>]]></content>
    
    
    <summary type="html">&lt;p&gt;obsidain基于s3的多端同步。&lt;/p&gt;</summary>
    
    
    
    <category term="或许用得到的tips" scheme="https://atffang.github.io/categories/%E6%88%96%E8%AE%B8%E7%94%A8%E5%BE%97%E5%88%B0%E7%9A%84tips/"/>
    
    
  </entry>
  
  <entry>
    <title>基于AIS数据进行船舶轨迹分段合成的一点思路</title>
    <link href="https://atffang.github.io/2025/08/29/%E5%9F%BA%E4%BA%8EAIS%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%88%B9%E8%88%B6%E8%BD%A8%E8%BF%B9%E5%88%86%E6%AE%B5%E5%90%88%E6%88%90%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%B7%AF/"/>
    <id>https://atffang.github.io/2025/08/29/%E5%9F%BA%E4%BA%8EAIS%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%88%B9%E8%88%B6%E8%BD%A8%E8%BF%B9%E5%88%86%E6%AE%B5%E5%90%88%E6%88%90%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%B7%AF/</id>
    <published>2025-08-29T02:33:07.000Z</published>
    <updated>2026-01-10T14:27:28.116Z</updated>
    
    <content type="html"><![CDATA[<p>介绍一下本科毕设里关于基于AIS数据进行船舶轨迹合成部分的一点思路，非专业，仅分享</p><span id="more"></span><h3 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h3><p>契机是我一位老师最近中了关于海运的面上，突然想起我本科毕业论文做的也是相关的数据分析。当然只是一点很简单的工作，毕竟只是本科的毕业设计。</p><h3 id="ais数据获取"><a class="markdownIt-Anchor" href="#ais数据获取"></a> AIS数据获取</h3><p>自动识别系统（Automatic Identification System，AIS）是安装在船舶上的一套自动追踪系统，通过岸基或星基设备接收船舶唯一标识符号、坐标、类型以及航行状态等数据，并且由连续的船舶AIS数据可合成船舶轨迹。</p><p>第一步数据获取就卡了很久。定毕设题目那会儿，即2023年冬天，有幸参加了第一届的信息地理学大会，听了三四个关于AIS数据和船舶轨迹分析的报告，都有提到他们获取的AIS数据，一些研究人员手里一年的数据量都是十亿级别的，让我有种莫名的错觉，觉得获取局部一段时间内的AIS数据并不是什么难事。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/001.jpg"/><br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/002.jpg"/><br />事实证明，我想的太简单了。先是尝试寻找开源数据未果，开始咨询数据供应商。但是这些商业公司的服务对象一般是船运相关企业和少量的科研人员，对我这样的个体户，上千上万的起步价尚且不能接受，何况数据需求在起步价内无法满足。兜兜转转十天，终于让我找到了活菩萨网站<a href="https://datalastic.com/">https://datalastic.com/</a></p><p>其实他们的定价同样贵的离谱，月订阅费用高达数千欧元，但他提供了一个几十欧元的一周体验计划，我没有犹豫就买了这根救命稻草。有了api一切都好说，唯一的问题是其相关API只能请求一个坐标特定范围内的AIS数据，这给数据获取的策略与后期数据合成都增加了不小的难度。我只能先将研究区域划分为几十个圆，在获取这些圆心范围内的数据。大概爬取了3-4天后，从datalastic网站获取了区域内AIS记录72,9499条，包含船舶的uuid（唯一标识符）、mmsi、坐标以及速度等有效信息，并汇总数据集包含的船舶，获取了每条船舶的国籍、类型、排水量等信息，具体下表所示。</p><table><thead><tr><th>AIS记录字段</th><th>AIS记录字段含义</th><th><strong>船舶信息字段</strong></th><th><strong>船舶信息字段含义</strong></th></tr></thead><tbody><tr><td>uuid</td><td>通用唯一识别码</td><td>uuid</td><td>通用唯一识别码</td></tr><tr><td>lat</td><td>纬度（度）</td><td>name</td><td>名称</td></tr><tr><td>lon</td><td>经度（度）</td><td>mmsi</td><td>海事服务身份码</td></tr><tr><td>speed</td><td>速度（节）</td><td>imo</td><td>国际海事组织号码</td></tr><tr><td>course</td><td>航向</td><td>country_iso</td><td>注册国代码</td></tr><tr><td>heading</td><td>船首向</td><td>type</td><td>类型</td></tr><tr><td>destination</td><td>目的地</td><td>gross_tonnage</td><td>总吨位</td></tr><tr><td>last_pos_epoch</td><td>时间戳</td><td>deadweight</td><td>最大载运量</td></tr><tr><td>last_pos_utc</td><td>时间戳（世界时间）</td><td>length</td><td>船体长度</td></tr><tr><td></td><td></td><td>speed_max</td><td>最大航速（节）</td></tr><tr><td>navstat</td><td>导航状态</td><td>home_port</td><td>注册港</td></tr><tr><td>distance_nm</td><td>距目的地距离（海里）</td><td>year_built</td><td>建造年份</td></tr><tr><td></td><td></td><td>breadth</td><td>船体宽度</td></tr></tbody></table><p>大概分布如下图：<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/003.jpg"/><br />将其注入数据库，并通过uuid字段与船舶信息数据库建立连接。</p><h3 id="船舶轨迹合成"><a class="markdownIt-Anchor" href="#船舶轨迹合成"></a> 船舶轨迹合成</h3><p>由于用于合成船舶轨迹的AIS记录时间跨度较长，绝大多数船舶在区域内并不仅完成了一次航行任务，而是涵盖了多条航线。因此，通过AIS记录直接合成的船舶轨迹存在航迹复杂、重复等问题。为了更好地获得航行特征，研究将轨迹从港口出发，直至到达另一港口的航段定义为船舶的一条分段轨迹。而在给定的时间内，可能无法捕捉到一些船舶的起始港口或终点港口，因此被起始时间或终止时间截断的轨迹，也被称为该船舶的一条分段轨迹。</p><p>因此，通过AIS记录合成分段轨迹的前提是区分船舶的状态，即航行状态或驻留状态。在某一船舶的一组根据时间排序的AIS记录中，有四种可能的分段轨迹：</p><ul><li>由该组数据最早的AIS记录点开始，至下一个处于驻留状态的AIS记录点结束的分段轨迹。</li><li>由该组数据最早的AIS记录点开始，至该组数据最晚的AIS记录点结束的分段轨迹。</li><li>该组某个处于驻留状态，且下一个记录点处于航行状态的AIS记录点开始，至下一个处于驻留状态的AIS记录点结束的分段轨迹。</li><li>该组某个处于驻留状态，且下一个记录点处于航行状态的AIS记录点开始，至该组数据最晚的AIS记录点结束的分段轨迹。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/004.jpg"/><br />上图展示了通过判断某一船舶AIS记录点航行状态，从而合成船舶分段轨迹的步骤。虽然AIS记录提供了导航状态字段，用以判断船舶是否处于航行状态，但该字段存在大量数据缺失、错误问题。此外，研究认为，虽然在港口附近的上传的AIS记录点显示船舶处于航行状态，但该船舶的实际行为多表现为停留或在较小的范围内徘徊，因此应当被归类为驻留。因此，AIS记录的导航状态字段并不能提供准确的判别依据，研究采用支持向量机（Support Vector Machine, 下文简称SVM）方法判定AIS记录点的状态。</li></ul><p>SVM是一种可以有效处理分类问题的机器学习算法，目标是在数据集中找到一个最优的决策边界（亦称为超平面），这个决策边界能够以最大间隔分开不同类别的数据点。</p><p>由于SVM是一种监督分类方法，因此，研究手动标注了2000个AIS数据点的航行状态，并使用坐标、航速、航向以及船首向作为特征向量，使用70%的标注数据集作为训练集训练SVM模型，同时通过比较剩下30%的数据构成的测试集检测各个核函数的区分效果，包括线性核函数、多项式核函数、径向基函数核以及Sigmoid核函数，并确定了最佳核函数。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/005.jpg"/><br />从图中可以看出，船舶驻留记录点多聚集于海岸港口，与实际情况相符。然而，由于模型仍存在一些误差，可能将一些处于航行状态的AIS记录点被识别为驻留状态，而一些处于驻留状态的航行点被识别为航行状态，导致原本连续的航行AIS记录被打断，导致船舶的分段轨迹错误地在该节点上分裂，或是从船舶驻留在港口及周边区域时识别出多余轨迹。因此，研究需要识别并修正这些错误的状态点。研究使用一个大小为3x1的滑动窗口遍历按时间排序的船舶状态记录点，如果窗口内第一个状态记录与第三个状态记录相同，但第二个状态记录与前后都不同，则修正该记录。</p><p>在完成数据修正后，即可合成船舶轨迹,即分段的坐标时间序列。图中©展示了某船舶的AIS记录分段轨迹合成，在合成过程中，研究删除了船舶状态为驻留的记录，并连接连续的船舶状态为航行的记录，完成了一段完整轨迹的分割。使用该方法完成2023年9月27日至10月6日，以及10月10日至10月19日区域的全部AIS记录分段轨迹合成，其效果如下图所示。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/006.png"/></p><h3 id="船舶轨迹压缩"><a class="markdownIt-Anchor" href="#船舶轨迹压缩"></a> 船舶轨迹压缩</h3><p>Douglas-Peucker算法（以下简称DP算法）是一种用于曲线近似和抽稀的算法。它的主要思想是在给定的曲线中，通过保留一些重要的数据点，来近似表示原始曲线，从而实现曲线的简化。由于研究提供的轨迹数据集数据量较大，轨迹节点较多，因此在轨迹聚类前，对轨迹数据集进行压缩处理能够有效提高聚类效率，而大量实验证明，DP算法适用于轨迹数据的压缩。下图展示了DP算法对于一条轨迹压缩的过程。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/007.png"/><br />DP算法的基本思路如下：</p><ul><li>在目标曲线的起点和终点之间，找到一条直线，作为曲线的初始近似。</li><li>计算其他所有点到该直线的距离，找到距离最大的点（即垂直距离最大的点）。</li><li>如果这个最大距离超过了预先设定的阈值（即所谓的抽稀阈值），则将该点加入到结果集合中，并将曲线划分为两个子曲线。</li><li>对两个子曲线分别递归地应用上述过程，直到所有点都被处理完毕。</li><li></li></ul><p>通过这个过程，DP算法可以在一定程度上保留曲线的形状特征，同时减少数据点的数量，从而实现曲线的简化。DP算法的阈值决定了简化后的曲线与原始曲线之间的最大允许误差，是影响算法压缩结果的唯一参数。</p><p>Zhao等人的实验]表明，对于统一阈值压缩而言，在以一个固定的步长增加阈值的过程中，使用轨迹节点数变化率相对较低、较为平稳的一定范围内的阈值，对相似度量性能有一定程度的提升，他们称该范围为“稳定阶段”。为此，研究计算了0-1000米阈值范围内，以10米为步长的轨迹平均节点数负增长率以及轨迹平均长度负增长率，得到数据集的6个“稳定阶段”，如下图所示。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/008.jpg"/><br />为了尽可能保全轨迹结构，研究选取了处于第一个稳定阶段的压缩阈值350m。在该阈值下，经压缩，数据集中每条轨迹的平均节点数减少至原来的44%，但平均轨迹长度仍保持在原来的98%，这说明该压缩算法在大幅度减少轨迹节点数量的同时，较好地保存了轨迹原有的形态特征。</p><h3 id="后记"><a class="markdownIt-Anchor" href="#后记"></a> 后记</h3><p>上述的AIS数据获取-分段轨迹合成-轨迹压缩构成是当时毕业设计的数据预处理部分，后续继续进行了聚类、分析等操作，这部分以后有机会再讲吧。现在回看我的毕业设计的后续部分也是稀奇古怪的，譬如修改DTW距离计算方式来消除长度导致的相关性，用一堆概率分布拟合计算最优聚类参数等等，现在觉得似乎不够严谨，但也不太清楚有什么更好的改进方法，看来水平没有进步。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;介绍一下本科毕设里关于基于AIS数据进行船舶轨迹合成部分的一点思路，非专业，仅分享&lt;/p&gt;</summary>
    
    
    
    <category term="作品" scheme="https://atffang.github.io/categories/%E4%BD%9C%E5%93%81/"/>
    
    
  </entry>
  
  <entry>
    <title>实验室安全检测系统</title>
    <link href="https://atffang.github.io/2025/07/19/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/"/>
    <id>https://atffang.github.io/2025/07/19/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/</id>
    <published>2025-07-19T02:25:37.000Z</published>
    <updated>2026-01-10T14:27:32.073Z</updated>
    
    <content type="html"><![CDATA[<p>最近参与了一个横向，项目架构与基础代码大概稳定下来了，浅浅记录一下。</p><span id="more"></span><h3 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h3><p>实际上这个项目在技术上并不难，甚至比许多工作简单的多，但让人头疼的主要是三点：</p><ul><li>典型小作坊做派，前端、数据库、识别系统、模型全要做，没有明确的职责分工</li><li>内网开发，测试也很困难，每天要骑个电瓶车去update</li><li>需求含混不清，一会说用这个一会说用那个，为此接入数据的逻辑改了n遍</li></ul><h3 id="系统需求与架构"><a class="markdownIt-Anchor" href="#系统需求与架构"></a> 系统需求与架构</h3><p>领导需要一个接入监控系统，实施监测各个实验室实验人员操作规范性，并归纳总结的系统，现在已在接入了一百余个监控设备，后续将推广至一千余个设备，其大致架构如下图所示：<br /><img src="https://atffang.github.io/2025/07/19/实验室安全检测系统/架构.png"/><br />按照该架构，重点的内容为监控轮询与帧识别两部分，程序将以设定的轮询间隔依次通过厂商提供的SDK访问摄像头并截图，将截图与包括摄像头基础信息、时间等的元数据交予消息队列并分发给多个识别设备进行图像识别。在试运行版本中，整个体系都在一台一张gpu的设备上运行。图像识别完成后，将识别结果汇总后存入数据库中。</p><h3 id="任务模型训练"><a class="markdownIt-Anchor" href="#任务模型训练"></a> 任务模型训练</h3><p>甲方提出了识别实验室实验人员不穿白大褂、夜间单人做实验、消防通道占用、废液桶是否盖盖子、通风橱开启是否规范等等。这些需求有的可以直接调用YOLO模型，有的则需要自行训练模型。</p><p>以<strong>实验人员穿着</strong>为例，首先基于YOLOv11模型提取多张监控截图中的人物边框并裁减，使用自己设计的标注工具进行是否穿着实验服装的正负样本标注，约两千余张。使用该数据，基于<strong>MobileNetV2</strong>模型训练我们需求的分类模型。</p><p><strong>MobileNetV2</strong> 是 Google 在 2018 年提出的一种轻量级卷积神经网络架构，我们将其迁移至我们的任务上。具体任务流程与要点如下：</p><ol><li>按照8：2划分数据集</li><li>加载 ImageNet 上预训练好的权重</li><li>将MobileNetV2 的最后一层 <code>nn.Sequential</code>替换为输出 2 类</li><li>任务采用交叉熵损失函数， Adam优化器，训练 epochs=10, batchsize=32, lr=1e-4<br />最终，分类模型的Accuracy为0.9850，达到了预期需求。</li></ol><p>整体模型首先使用yolo11s识别人，置信阈值设置为0.4，随后使用自己训练的二分类模型进行是否穿白大褂的判别，在后续的测试中，发现其基本可以满足需求，但仍对穿着白色T恤的实验人员有漏检情况，需要后续对模型进行改进。</p><h3 id="producer模块设计"><a class="markdownIt-Anchor" href="#producer模块设计"></a> Producer模块设计</h3><p>读取数据库中当日需要访问的摄像头的id，基于摄像头厂商提供的监控rtsp视频流Python SDK，轮询摄像头获取rtsp url。一开始使用opencv链接流并截取帧，但是截取效率和内存占用都很不理想，后来就直接改用了<strong>ffmpeg</strong>截取，在处理速度和内存占用上都优化了许多。</p><p>由于仍存在一定的等待时间，采用线程池提交任务，大概逻辑如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用线程池提交任务</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    futures = [executor.submit(ffmpeg_cut, *task) <span class="keyword">for</span> task <span class="keyword">in</span> tasks]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = future.result() </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Task raised an exception: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>在截取完成图像后，保存至本地并将元数据加入消息队列。</p><h3 id="消息队列设计"><a class="markdownIt-Anchor" href="#消息队列设计"></a> 消息队列设计</h3><p>在单机任务中，任务队列由Python维护，设计一个PhotoMessage类如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoMessage</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        photo_id: 帧的唯一标识符（默认使用 UUID）</span></span><br><span class="line"><span class="string">camera_id: 摄像头的标识符</span></span><br><span class="line"><span class="string">room_id: 物理位置的标识符</span></span><br><span class="line"><span class="string">photo_path: 帧在文件系统中的路径或内存引用</span></span><br><span class="line"><span class="string">timestamp: 帧的捕获时间（如果未提供则自动生成）</span></span><br><span class="line"><span class="string">metadata: 附加的处理上下文信息（如模型输出等）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    camera_id: <span class="built_in">str</span></span><br><span class="line">    room_id: <span class="built_in">str</span></span><br><span class="line">    photo_path: Path</span><br><span class="line">    photo_id: <span class="built_in">str</span> = field(default_factory=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    timestamp: datetime = field(default_factory=datetime.now)</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_json</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="comment"># ……</span></span><br></pre></td></tr></table></figure><p>其中，有如 photo_id 是运行时生成一个唯一值（不能提前固定成某个默认字符串）。如果你写 photo_id: str = str(uuid.uuid4())，那么所有对象都会默认用<strong>同一个 UUID</strong>（因为默认值只会在类定义时求一次值）。而default_factory 会在每次创建对象时调用 lambda 生成新的值。在 dataclass 中，<strong>凡是带副作用的默认值（当前时间、UUID、列表、字典等）都应使用 default_factory</strong>，否则会引发不可预测的行为或共享状态。</p><p>为了表示队列，设计一个GlobalMessageQueue类如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalMessageQueue</span>():</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">            cls._instance._queue = queue.LifoQueue(maxsize=<span class="number">10000</span>)</span><br><span class="line">            cls._instance._persist_file = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put_message</span>(<span class="params">self, msg: PhotoMessage</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        存入消息到队列</span></span><br><span class="line"><span class="string">        :param msg: PhotoMessage实例</span></span><br><span class="line"><span class="string">        :return: 是否成功入队</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._queue.put_nowait(msg)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> queue.Full:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;WARNING: 消息队列已满，丢弃最早的消息&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self._queue.get_nowait()  <span class="comment"># 丢弃最旧消息</span></span><br><span class="line">                self._queue.put_nowait(msg)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> queue.Empty:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_message</span>(<span class="params">self</span>) -&gt; <span class="type">Optional</span>[PhotoMessage]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        非阻塞获取消息</span></span><br><span class="line"><span class="string">        :return: PhotoMessage实例或None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._queue.get_nowait()</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">persist_messages</span>(<span class="params">self, file_path: Path</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        持久化队列到磁盘</span></span><br><span class="line"><span class="string">        :param file_path: 存储文件路径</span></span><br><span class="line"><span class="string">        :return: 持久化的消息数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_messages</span>(<span class="params">self, file_path: Path</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        从磁盘加载消息到队列</span></span><br><span class="line"><span class="string">        :param file_path: 存储文件路径</span></span><br><span class="line"><span class="string">        :return: 加载的消息数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_persist_file</span>(<span class="params">self, file_path: Path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置自动持久化文件路径&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;析构时自动持久化&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取当前队列的大小</span></span><br><span class="line"><span class="string">        :return: 队列中消息的数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br></pre></td></tr></table></figure><p>该类 GlobalMessageQueue 实现了线程安全的<strong>全局单例消息队列</strong>，使用 LifoQueue 存储 PhotoMessage 实例，支持消息的入队、出队、磁盘持久化和加载，并在对象销毁时自动保存队列内容，防止数据丢失。</p><p>当然，在多设备并行处理中，可使用Redis作为多设备共享的消息队列。</p><h3 id="consumer模块设计"><a class="markdownIt-Anchor" href="#consumer模块设计"></a> Consumer模块设计</h3><p>首先，我们定义一个父类BaseModel，规范了模型对于图像输入的预处理方式。配置从指定config中读取，规范模型的名称、权重文件位置、预处理方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        self.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">        self.name = config[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        self.preprocess = config[<span class="string">&quot;preprocess&quot;</span>]</span><br><span class="line">        self.pipeline = config[<span class="string">&quot;pipeline&quot;</span>]</span><br><span class="line"></span><br><span class="line">        self._build_preprocess_method()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 预处理类</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_preprocess_method</span>(<span class="params">self</span>):</span><br><span class="line">        preprocess = self.preprocess</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">preprocess_image</span>(<span class="params">self, message: PhotoMessage</span>):</span><br><span class="line">            <span class="comment"># 调用_crop和_resize的逻辑</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> image</span><br><span class="line">        </span><br><span class="line">        self.preprocess_image = MethodType(preprocess_image, self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_crop</span>(<span class="params">self, message: PhotoMessage, image: Image.Image</span>):</span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_resize</span>(<span class="params">self, message: PhotoMessage, image: Image.Image</span>):</span><br><span class="line">        <span class="keyword">return</span> image.resize(self.preprocess[<span class="string">&quot;size&quot;</span>])</span><br></pre></td></tr></table></figure><p>随后继承该类，定义一个IdentificationModel子类，新增一个_loadmodel功能，需要返回一个predict方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IdentificationModel</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(config)</span><br><span class="line">        self.predict = self._loadmodel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_loadmodel</span>(<span class="params">self</span>):</span><br><span class="line">        predict = ModelLoader.loader(self.name, self.pipeline, self.device)</span><br><span class="line">        <span class="keyword">return</span> predict</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure><p>由于当前模型都暂时只需要一个predict方法，因此，暂时只使用该子类。可以注意到，IdentificationModel类使用了一个ModelLoader类，该类负责每个具体的识别模型的predict逻辑，返回每个模型中我们需要的predict函数，由于过于冗长，不做展示。</p><p>基于上述类，consumer线程可以很轻松的从配置文件中加载模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.modellist = []</span><br><span class="line"><span class="keyword">for</span> config <span class="keyword">in</span> config_list:</span><br><span class="line">    self.modellist.append(IdentificationModel(config))</span><br></pre></td></tr></table></figure><p>并逐个调用模型对图片进行识别：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> model <span class="keyword">in</span> self.modellist:                </span><br><span class="line">    photo = model.preprocess_image(message)</span><br><span class="line">    output = model.predict(message, photo)</span><br></pre></td></tr></table></figure><p>当然，在consumer内部也采用了多线程的设计，此处不再赘述。</p><h3 id="存储模块设计"><a class="markdownIt-Anchor" href="#存储模块设计"></a> 存储模块设计</h3><p>存储模块负责将识别结果整理后存入Postgresql数据库，识别结果图片存入Minio桶容器，之间通过唯一的uuid相关联，此处不多赘述。</p><h3 id="容器化部署"><a class="markdownIt-Anchor" href="#容器化部署"></a> 容器化部署</h3><p>由于本项目涉及到深度学习环境以及redis、minio、psql等工具，因此，使用docker部署是最快速最安全的方式。但是这里有个大坑！我原本基于dockerfile构建了带cuda驱动、nvcc、python环境以及ffmpeg等的容器，但是发现，由于windows上的docker是机遇wsl实现的，和本机之间存在网络的隔离，在容器内运行的python程序读不到局域网下的rtsp流。本人当即表示烦。<br />无奈，只能暂时线把主要程序放在宿主机上执行，redis、minio、psql使用docker部署。该项目的docker-compose如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_minio</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">minioadmin</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio-init:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/mc</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      /bin/sh -c &quot;</span></span><br><span class="line"><span class="string">      sleep 5;</span></span><br><span class="line"><span class="string">      mc alias set local http://minio:9000 minioadmin minioadmin;</span></span><br><span class="line"><span class="string">      mc mb -p local/detection-results;</span></span><br><span class="line"><span class="string">      mc policy set public local/detection-results;</span></span><br><span class="line"><span class="string">      exit 0;</span></span><br><span class="line"><span class="string">      &quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:17</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">labcamera</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5434:5432&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./initdb:/docker-entrypoint-initdb.d</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">pgdata:</span></span><br><span class="line">  <span class="attr">minio_data:</span></span><br></pre></td></tr></table></figure><p>其中，在labsecurity_postgres容器中，我指定了数据库初始化的文件位置，即/initdb，只要在该文件夹下放置.sql，容器初始化时即可根据该sql文件建立数据库，不要太方便。而容器间、宿主机和容器间也可以通过端口相互访问，例如，在其他容器内通过<code>minio:9000</code>，在本机中可以通过<code>http://localhost:9001/</code>访问。</p><p>通过 <code>docker compose up -d</code> 可以一键部署容器，通过 <code>docker ps` -a</code> 查看部署情况。此外，按照原计划，深度学习环境也会部署在容器内，这里做个记录，首先，构建 .Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">12.8</span>.<span class="number">0</span>-cudnn-runtime-ubuntu22.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y python3 python3-pip</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install torch==2.6.0 torchvision==0.21.0 torchaudio==2.6.0 --index-url https://download.pytorch.org/whl/cu126</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./app /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;main.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>可以看到，该文件指定了安装cuda驱动和python，并根据requirements安装好需要的python包。在docker- compose中加上：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span>  </span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_app</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./app:/app</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br></pre></td></tr></table></figure><p>容器能看到本机的 <code>./app</code> 目录，点击vscode左下方的&gt;&lt;，选择Attach to Running Container，进入python容器，就可以愉快的开发了。</p><h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3><p>这算是我参与的算是比较完整的横向了，但是也没什么好总结的，懒得总结。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近参与了一个横向，项目架构与基础代码大概稳定下来了，浅浅记录一下。&lt;/p&gt;</summary>
    
    
    
    <category term="作品" scheme="https://atffang.github.io/categories/%E4%BD%9C%E5%93%81/"/>
    
    
  </entry>
  
  <entry>
    <title>从0开始学java 03 ：观察者模式</title>
    <link href="https://atffang.github.io/2025/07/09/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java3/"/>
    <id>https://atffang.github.io/2025/07/09/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java3/</id>
    <published>2025-07-09T08:24:45.000Z</published>
    <updated>2026-01-10T14:21:20.746Z</updated>
    
    <content type="html"><![CDATA[<p>生活所迫呀。</p><span id="more"></span><p><strong>观察者模式</strong>是一种行为型设计模式，它定义了一种<strong>对象之间一对多的依赖关系</strong>，使得当一个对象的状态发生改变时，所有依赖它的对象都会自动收到通知并更新。</p><p>为什么要用观察者模式？我们有下面几个原因：</p><ul><li><strong>解耦通知逻辑</strong>：观察者模式的核心价值在于：<strong>发布者（被观察者）和订阅者（观察者）之间是解耦的</strong>。  发布者无需知道观察者是谁、做什么，只需要在状态发生变化时“通知大家”；观察者则只关心“是否订阅了该对象”，无需知道发布者的具体业务逻辑。</li><li><strong>自动通知，避免轮询</strong>：在没有观察者模式的情况下，我们可能需要让每个组件不断检查（轮询）状态的变化。这不仅效率低，还容易写出重复、混乱的代码。</li><li><strong>事件驱动架构的基础</strong>：现代前后端框架（如 React、Vue、Java Swing、Spring）中大量使用观察者模式或其变种（发布-订阅模式）来构建响应式系统。</li></ul><h3 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h3><p>我们还是以实际的需求入手，举一个最经典的例子：</p><p>你正在开发一个气象站系统，它能实时监测温度、湿度、气压等数据。现在有多个布告板（显示面板）希望<strong>自动接收到最新的天气数据并显示</strong>，比如：</p><ul><li>当前天气布告板（CurrentConditionsDisplay）</li><li>统计布告板（StatisticsDisplay）</li><li>预报布告板（ForecastDisplay）<br />一旦气象站更新数据，<strong>所有布告板都应立即更新并展示最新信息</strong>。</li></ul><p>首先，我们需要定义一个被观察者接口<strong>Subject</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subject</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerObserver</span><span class="params">(Observer o)</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeObserver</span><span class="params">(Observer o)</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其规范了三项功能：</p><ul><li>注册观察者</li><li>删除观察者</li><li>通知所有的观察者</li></ul><p>当然，我们也需要定义布告板观察者接口<strong>Observer</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Observer</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">float</span> temp, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>额外的，我们定义一个展示接口<strong>DisplayElement</strong>，当布告板需要显示时，调用方法<strong>display()</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DisplayElement</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义完接口后，我们需要定义类来实现主题了。首先，定义一个实现<strong>被观察者</strong>接口<strong>Subject</strong>的类<strong>WeatherData</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherData</span> <span class="keyword">implements</span> <span class="title class_">Subject</span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> ArrayList observers;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> temperature;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> humidity;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> pressure;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WeatherData</span><span class="params">()</span>&#123;  </span><br><span class="line">        observers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerObserver</span><span class="params">(Observer o)</span>&#123;  </span><br><span class="line">        observers.add(o);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeObserver</span><span class="params">(Observer o)</span>&#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> observers.indexOf(o);  </span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>)&#123;  </span><br><span class="line">            observers.remove(i);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt;observers.size(); i++)&#123;  </span><br><span class="line">            <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> (Observer) observers.get(i);  </span><br><span class="line">            observer.update(temperature, humidity, pressure);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 一旦新数据来了，调用此方法  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMeasurements</span><span class="params">(<span class="type">float</span> temperature, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span>&#123;  </span><br><span class="line">        <span class="built_in">this</span>.temperature = temperature;  </span><br><span class="line">        <span class="built_in">this</span>.humidity = humidity;  </span><br><span class="line">        <span class="built_in">this</span>.pressure = pressure;  </span><br><span class="line">        notifyObservers();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随后，定义<strong>布告板（观察者）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title class_">Observer</span>, DisplayElement &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CurrentConditionsDisplay</span><span class="params">(Subject weatherData)</span> &#123;</span><br><span class="line">        weatherData.registerObserver(<span class="built_in">this</span>); <span class="comment">// 注册自己</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">float</span> temperature, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.temperature = temperature;</span><br><span class="line">        <span class="built_in">this</span>.humidity = humidity;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前天气：温度 = &quot;</span> + temperature + <span class="string">&quot;°C，湿度 = &quot;</span> + humidity + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试一下这个程序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherStation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WeatherData</span> <span class="variable">weatherData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WeatherData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">CurrentConditionsDisplay</span> <span class="variable">currentDisplay</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentConditionsDisplay</span>(weatherData);</span><br><span class="line"></span><br><span class="line">        weatherData.setMeasurements(<span class="number">30.4f</span>, <span class="number">65.2f</span>, <span class="number">1013.1f</span>);</span><br><span class="line">        weatherData.setMeasurements(<span class="number">28.9f</span>, <span class="number">70.1f</span>, <span class="number">1012.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="java内置写法"><a class="markdownIt-Anchor" href="#java内置写法"></a> java内置写法</h3><p>Java 在早期（JDK 1.0）就内置了对观察者模式的支持：</p><ul><li><code>java.util.Observable</code>：被观察者（Subject）</li><li><code>java.util.Observer</code>：观察者（Observer）</li></ul><p>还是使用上面气象站的例子，首先，我们继承内置的类<strong>Observable</strong>定义一个<strong>被观察者（WeatherData）</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherData</span> <span class="keyword">extends</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> humidity;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> pressure;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMeasurements</span><span class="params">(<span class="type">float</span> temperature, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.temperature = temperature;</span><br><span class="line">        <span class="built_in">this</span>.humidity = humidity;</span><br><span class="line">        <span class="built_in">this</span>.pressure = pressure;</span><br><span class="line"></span><br><span class="line">        setChanged(); <span class="comment">// 标记状态已更新</span></span><br><span class="line">        notifyObservers(); <span class="comment">// 通知所有观察者（无参数版本）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getTemperature</span><span class="params">()</span> &#123; <span class="keyword">return</span> temperature; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getHumidity</span><span class="params">()</span> &#123; <span class="keyword">return</span> humidity; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getPressure</span><span class="params">()</span> &#123; <span class="keyword">return</span> pressure; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setChanged()</code>是 <code>Observable</code> 提供的方法，<strong>必须调用</strong>这个方法，告诉系统“我准备好通知别人了”。如果不调用 <code>setChanged()</code>，后续的 <code>notifyObservers()</code> 什么都不会发生。<br /><code>notifyObservers()</code>：遍历当前注册的所有观察者（通过 <code>addObserver()</code> 添加的），并依次调用它们的 <code>update()</code> 方法。默认参数为 <code>null</code>，也可以使用 <code>notifyObservers(Object arg)</code> 传递数据。</p><p>随后，继承内置类<strong>Observer</strong>定义一个<strong>观察者（布告板）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Observer;</span><br><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Observable o, Object arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> WeatherData) &#123;</span><br><span class="line">            <span class="type">WeatherData</span> <span class="variable">wd</span> <span class="operator">=</span> (WeatherData) o;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前天气：温度 = &quot;</span> + wd.getTemperature() + <span class="string">&quot;°C，湿度 = &quot;</span> + wd.getHumidity() + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>update(Observable o, Object arg)</code>： 当被观察者调用 <code>notifyObservers()</code> 时，<strong>每个注册的观察者的 <code>update()</code> 方法都会被执行</strong>。参数 <code>o</code> 是被观察者对象本身（即 <code>WeatherData</code>）。参数 <code>arg</code> 是通过 <code>notifyObservers(arg)</code> 传递的附加数据（如果调用的是 <code>notifyObservers()</code>，则为 <code>null</code>）。</p><p>注册观察者、更新数据、触发通知：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherStation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WeatherData</span> <span class="variable">weatherData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WeatherData</span>();  <span class="comment">// 创建被观察者</span></span><br><span class="line">        <span class="type">CurrentConditionsDisplay</span> <span class="variable">display</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentConditionsDisplay</span>(); <span class="comment">// 创建观察者</span></span><br><span class="line"></span><br><span class="line">        weatherData.addObserver(display);  <span class="comment">// 注册观察者到被观察者内部列表</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟一次天气数据更新</span></span><br><span class="line">        weatherData.setMeasurements(<span class="number">25.6f</span>, <span class="number">65.0f</span>, <span class="number">1012.0f</span>);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然 Java 提供了这个内置机制，但它有一些明显缺陷，因此在 JDK 9 后已标记为过时（Deprecated）。 缺点如下：</p><ul><li><code>Observable</code> 是一个类，不是接口，<strong>限制了继承</strong>（Java 不支持多继承）</li><li>内部方法如 <code>setChanged()</code> 并非自动调用，容易遗漏</li><li><code>update()</code> 方法传参设计不灵活</li><li>不支持泛型</li></ul><p>因此，实际上用我们一开始写的方式自定义 <code>Subject</code> 和 <code>Observer</code> 接口是最清晰和通用的方式。哈哈。<br />当我们在大型项目中，面临越来越复杂的模块通信、异步响应、数据流处理需求时，传统的观察者模式（无论是自定义接口还是 Java 原生的 <code>Observer/Observable</code>）都可能显得不够灵活、不够强大，可能需要涉及到事件驱动架构（EDA）或响应式编程，在后面的章节中，我们会讲到。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;生活所迫呀。&lt;/p&gt;</summary>
    
    
    
    <category term="编程学习-java" scheme="https://atffang.github.io/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0-java/"/>
    
    
  </entry>
  
  <entry>
    <title>进程守护</title>
    <link href="https://atffang.github.io/2025/07/08/%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4/"/>
    <id>https://atffang.github.io/2025/07/08/%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4/</id>
    <published>2025-07-08T07:34:03.000Z</published>
    <updated>2026-01-10T14:27:23.716Z</updated>
    
    <content type="html"><![CDATA[<p>持久化的python服务</p><span id="more"></span><p><strong>进程守护</strong>指的是让一个程序<strong>在后台持续运行</strong>，<strong>具有自我恢复能力</strong>（崩溃自动重启），<strong>随系统启动自动启动</strong>，并可通过命令进行控制。</p><h3 id="1-linux下systemd-持久守护-python-程序"><a class="markdownIt-Anchor" href="#1-linux下systemd-持久守护-python-程序"></a> 1. linux下systemd 持久守护 Python 程序</h3><p>创建systemd服务配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/myscript.service</span><br></pre></td></tr></table></figure><p>内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=My Persistent Python Script</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/python3 /home/user/run_my_job.py</span><br><span class="line">WorkingDirectory=/home/user</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">User=your_linux_username</span><br><span class="line">StandardOutput=append:/var/log/myscript.log</span><br><span class="line">StandardError=append:/var/log/myscript.err</span><br><span class="line">Environment=PYTHONUNBUFFERED=1</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>启用并启动服务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reexec</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable myscript.service</span><br><span class="line">sudo systemctl start myscript.service</span><br></pre></td></tr></table></figure><p>查看日志和状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status myscript.service</span><br><span class="line">sudo <span class="built_in">tail</span> -f /var/log/myscript.log</span><br></pre></td></tr></table></figure><p>通过命令进行控制：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop myscript.service</span><br><span class="line">sudo systemctl restart myscript.service</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> myscript.service</span><br></pre></td></tr></table></figure><h3 id="2-跨平台python进程管理工具supervisord"><a class="markdownIt-Anchor" href="#2-跨平台python进程管理工具supervisord"></a> 2. 跨平台python进程管理工具supervisord</h3><p><strong>supervisord</strong> 是一个用 Python 编写的进程管理工具， 它可以监控、启动、停止、重启你python脚本在内的进程。可以直接利用pip下载：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install supervisor</span><br></pre></td></tr></table></figure><p>Supervisor 由两个核心组件组成：</p><ul><li>supervisord守护进程：负责读取配置、启动/监控任务</li><li>supervisorctl命令行客户端：用于查看状态、重启任务等</li></ul><p>使用时，首先生成一个默认的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf &gt; supervisord.conf</span><br></pre></td></tr></table></figure><p>将需要守护的进程添加到配置文件中：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:my_script]</span></span><br><span class="line"><span class="attr">command</span>=python3 /home/user/scripts/my_script.py</span><br><span class="line"><span class="attr">directory</span>=/home/user/scripts</span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/my_script.out.log</span><br><span class="line"><span class="attr">stderr_logfile</span>=/var/log/my_script.err.log</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>参数</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>command</td><td>要执行的命令</td></tr><tr><td>directory</td><td>工作目录</td></tr><tr><td>autostart</td><td>启动 supervisord 时自动启动</td></tr><tr><td>autorestart</td><td>异常退出后是否自动重启</td></tr><tr><td>startsecs</td><td>启动后运行多少秒才算成功</td></tr><tr><td>stdout_logfile</td><td>标准输出日志路径</td></tr><tr><td>stderr_logfile</td><td>错误日志路径</td></tr><tr><td>启动supervisord守护进程：</td><td></td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord -c supervisord.conf</span><br></pre></td></tr></table></figure><p>和systemd一样，supervisord也有一些管理任务的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl -c supervisord.conf status</span><br><span class="line">supervisorctl -c supervisord.conf restart my_script</span><br><span class="line">supervisorctl -c supervisord.conf stop my_script</span><br></pre></td></tr></table></figure><p>也可以利用supervisord进行不同gpu任务分发，不同gpu上运行不同进程并守护的骚操作，首先，在你的模型任务代码中加上通过参数指定gpu的逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--gpu&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">0</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">f&quot;cuda:<span class="subst">&#123;args.gpu&#125;</span>&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">model.to(device)</span><br></pre></td></tr></table></figure><p>然后，指定不同的gpu进行进程守护：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[program:worker1]</span><br><span class="line"><span class="built_in">command</span>=python3 /opt/scripts/train_model.py --gpu 0</span><br><span class="line"></span><br><span class="line">[program:worker2]</span><br><span class="line"><span class="built_in">command</span>=python3 /opt/scripts/train_model.py --gpu 1</span><br></pre></td></tr></table></figure><h3 id="3-docker-restart-policy"><a class="markdownIt-Anchor" href="#3-docker-restart-policy"></a> 3. Docker + restart policy</h3><p>Docker 提供了一种机制叫做 restart policy（重启策略），用来控制当容器退出或系统重启时，是否自动重启该容器。<br />对于一个Dockerfile，可以加上 --restart always运行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t my-capture .</span><br><span class="line">docker run -d --name my_capture_container --restart always my-capture</span><br></pre></td></tr></table></figure><p>这个容器中的 Python 脚本崩溃时自动重启。</p><p>当然，在docker-compose.yml 中可以这样配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">camera_worker:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br></pre></td></tr></table></figure><p>当然，如果想要在linux中开机自启动容器，除了上面的，只要再使得docker自动启动即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><p>这个命令会把 Docker 服务注册到 systemd 中，下次系统启动时会自动启动 Docker 服务, 也就自动拉起了 --restart always 的容器。</p><p>设置完之后，你可以检查一下重启策略是否配置好：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect your_container_name | grep -i restart</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;持久化的python服务&lt;/p&gt;</summary>
    
    
    
    <category term="其他" scheme="https://atffang.github.io/categories/%E5%85%B6%E4%BB%96/"/>
    
    
  </entry>
  
  <entry>
    <title>浅试docker：为 AI 项目构建高可维护的开发环境</title>
    <link href="https://atffang.github.io/2025/06/30/%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>https://atffang.github.io/2025/06/30/%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2025-06-30T12:49:55.000Z</published>
    <updated>2026-01-10T14:27:14.888Z</updated>
    
    <content type="html"><![CDATA[<p>浅试docker：为 AI 项目构建高可维护的开发环境</p><span id="more"></span><p>我的需求是一个带cuda驱动的python容器，redis容器、psql容器、minio容器，因此，我指定docker-compose和dockerfile，他们之间的区别如下表：</p><table><thead><tr><th>方面</th><th>Dockerfile</th><th>Docker Compose</th></tr></thead><tbody><tr><td>核心作用</td><td>定义单个镜像的构建过程，描述从基础镜像开始，安装软件、拷贝文件、配置环境等步骤，生成自定义镜像。</td><td>定义多个容器的编排和运行，指定哪些镜像或 Dockerfile 要启动，容器之间如何连接、挂载卷、端口映射等。</td></tr><tr><td>工作方式</td><td>通过 docker build 从 Dockerfile 构建镜像。</td><td>通过 docker-compose up 根据配置启动一个或多个容器。</td></tr><tr><td>是否拉取镜像</td><td>可以基于已有镜像（FROM xxx），也可以从头开始构建。</td><td>可以使用已有镜像（image: xxx）或基于 Dockerfile 构建镜像（build: xxx）。</td></tr><tr><td>功能范围</td><td>只负责镜像构建（静态），镜像里包含运行环境和文件。</td><td>负责多容器应用的启动与管理（动态），包括网络、依赖关系、环境变量等。</td></tr><tr><td>示例</td><td>写一个 Python 镜像，安装依赖，拷贝代码。</td><td>启动数据库、缓存、Python 服务容器，并让它们协同工作。</td></tr></tbody></table><p>编写<strong>Docker-compose:</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span>  </span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_app</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./app:/app</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_minio</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">minioadmin</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:17</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">labdb</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">labuser</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">labpass</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5432:5432&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pgdata:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">pgdata:</span></span><br><span class="line">  <span class="attr">minio_data:</span></span><br></pre></td></tr></table></figure><p>编写<strong>Dockerfile:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia<span class="operator">/</span>cuda:<span class="number">12.8</span><span class="number">.0</span><span class="operator">-</span>cudnn<span class="operator">-</span>runtime<span class="operator">-</span>ubuntu22<span class="number">.04</span></span><br><span class="line"></span><br><span class="line">RUN apt<span class="operator">-</span><span class="keyword">get</span> <span class="keyword">update</span> <span class="operator">&amp;&amp;</span> apt<span class="operator">-</span><span class="keyword">get</span> install <span class="operator">-</span>y python3 python3<span class="operator">-</span>pip</span><br><span class="line"></span><br><span class="line">WORKDIR <span class="operator">/</span>app</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> requirements.txt .</span><br><span class="line"></span><br><span class="line">RUN pip install torch<span class="operator">=</span><span class="operator">=</span><span class="number">2.6</span><span class="number">.0</span> torchvision<span class="operator">=</span><span class="operator">=</span><span class="number">0.21</span><span class="number">.0</span> torchaudio<span class="operator">=</span><span class="operator">=</span><span class="number">2.6</span><span class="number">.0</span> <span class="comment">--index-url https://download.pytorch.org/whl/cu126</span></span><br><span class="line">RUN pip install <span class="comment">--no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> .<span class="operator">/</span>app <span class="operator">/</span>app</span><br><span class="line"></span><br><span class="line">CMD [&quot;python3&quot;, &quot;main.py&quot;]</span><br></pre></td></tr></table></figure><p>例如，在python中通过<code>minio:9000</code>，在本机中可以通过<code>http://localhost:9001/</code>访问。</p><h3 id="docker快速构建"><a class="markdownIt-Anchor" href="#docker快速构建"></a> docker快速构建</h3><ol><li>下载docker desktop，对于分盘的windows电脑，建议迁移一下docker位置</li><li>换源，我这里修改配置文件为：</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;gc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;defaultKeepStorage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://docker.xuanyuan.me&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol start="3"><li><p>构建镜像：<code>docker compose build</code></p></li><li><p>启动容器服务：<code>docker compose up -d</code> 没有下载过dockert-compose中的容器的会先下载</p></li><li><p>查看服务状态：<code>docker ps</code> -a<br /><img src="https://gcnaq17oc64n.feishu.cn/space/api/box/stream/download/asynccode/?code=NGI2NTJlZWU1OTExOGMzODgwMjAzZTM1NGJiMjhkNWNfZnA5ZE9tZHlwdWdhT3BOZjVtcVhzckd2Uk9Ma2pwdVRfVG9rZW46T2hBc2JGaHRHbzAyMEV4ZjAwZWMzSFYxbkloXzE3NTEyODkwNzk6MTc1MTI5MjY3OV9WNA" alt="" /></p></li><li><p>进入python容器：<code>docker exec -it labsecurity_app bash</code></p></li><li><p>测试一下cuda环境是否可用，运行脚本：</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="built_in">print</span>(torch.cuda.is_available())</span><br><span class="line"><span class="built_in">print</span>(torch.cuda.get_device_name(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><ol start="8"><li>结束所有服务： <code>docker-compose stop</code> 开始所有服务：<code>docker-compose start</code></li><li>我在docker-compose里面挂载了：</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">    - ./app:/app</span><br></pre></td></tr></table></figure><p>容器能看到本机的 <code>./app</code> 目录，点击vscode左下方的&gt;&lt;，选择Attach to Running Container，进入python容器，就可以愉快的开发了</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;浅试docker：为 AI 项目构建高可维护的开发环境&lt;/p&gt;</summary>
    
    
    
    <category term="其他" scheme="https://atffang.github.io/categories/%E5%85%B6%E4%BB%96/"/>
    
    
  </entry>
  
</feed>
