<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Tianyao&#39; s BLOG</title>
  
  <subtitle>Tianyao</subtitle>
  <link href="https://atffang.github.io/atom.xml" rel="self"/>
  
  <link href="https://atffang.github.io/"/>
  <updated>2025-12-22T04:19:08.893Z</updated>
  <id>https://atffang.github.io/</id>
  
  <author>
    <name>Fang Tianyao</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从0开始学JAVA 4 JAVA线程方法汇总</title>
    <link href="https://atffang.github.io/2025/12/22/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/"/>
    <id>https://atffang.github.io/2025/12/22/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/</id>
    <published>2025-12-22T02:37:17.000Z</published>
    <updated>2025-12-22T04:19:08.893Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h3 id="第一章多线程基础"><a class="markdownIt-Anchor" href="#第一章多线程基础"></a> 第一章：多线程基础</h3><p>在 Java 中，线程（Thread）是操作系统调度的最小单元。理解多线程，首先要从如何启动它、它经历过哪些状态、以及我们如何控制它开始。</p><h4 id="线程的创建方式"><a class="markdownIt-Anchor" href="#线程的创建方式"></a> 线程的创建方式</h4><p>虽然最终都是通过 <code>Thread.start()</code> 启动，但 Java 提供了<strong>三种主要的任务定义方式</strong>：</p><ul><li><strong>继承 <code>Thread</code> 类</strong>：<ul><li><strong>做法</strong>：定义一个类继承 <code>Thread</code> 并重写 <code>run()</code> 方法。</li><li><strong>缺点</strong>：Java 是单继承的，继承了 Thread 就不能再继承其他类（如 BaseService），灵活性差。</li></ul></li></ul><p>我们直接new一个Tread类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">            <span class="built_in">super</span>.run();  </span><br><span class="line">            System.out.println(<span class="string">&quot;run: &quot;</span> + <span class="built_in">this</span>.getState());</span><br><span class="line">              </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">  </span><br><span class="line">    System.out.println(<span class="string">&quot;main: &quot;</span> + thread.getState());  </span><br><span class="line">    thread.start();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>实现 <code>Runnable</code> 接口</strong>（推荐）：<ul><li><strong>做法</strong>：实现 <code>run()</code> 方法，并将其作为参数传递给 <code>Thread</code> 构造函数。</li><li><strong>优点</strong>：解耦了“任务逻辑”与“线程资源”。多个线程可以执行同一个 <code>Runnable</code> 实例，适合资源共享。</li></ul></li></ul><p><strong><code>Runnable</code> 接口</strong>。<code>Runnable</code> 是 Java 中一个功能性的接口，它定义了一个 <code>run()</code> 方法。实现这个接口的类（如 <code>TaskRunnable</code>）表示一个任务，这个任务可以被一个线程执行。</p><p><strong><code>Thread</code> 与 <code>Runnable</code></strong>：<code>Thread</code> 类用于表示一个执行的线程，但它并不直接定义要做什么。<code>Thread</code> 需要一个 <code>Runnable</code> 对象，来确定线程启动后应该执行什么样的任务。所以，<code>Thread</code> 会将一个 <code>Runnable</code> 对象传给其构造方法，这样线程就知道了执行什么任务。</p><p>我们实现一个<code>runnable接口</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">    <span class="type">TaskRunnable</span> <span class="variable">taskRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskRunnable</span>();  </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(taskRunnable);  </span><br><span class="line">    thread.start();  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);  </span><br><span class="line">        taskRunnable.cancel();  </span><br><span class="line">          </span><br><span class="line">    &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TaskRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">boolean</span> cancel;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (cancel)&#123;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span>&#123;  </span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);  </span><br><span class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            System.out.println(<span class="string">&quot;running&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;  </span><br><span class="line">        cancel = <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>实现 <code>Callable</code> 接口</strong>：<ul><li><strong>做法</strong>：实现 <code>call()</code> 方法，配合 <code>FutureTask</code> 或线程池使用。</li><li><strong>核心区别</strong>：<code>call()</code> 方法<strong>有返回值</strong>且<strong>允许抛出异常</strong>，而 <code>run()</code> 不行。</li></ul></li></ul><p>我们来实现一个<code>Callable</code> 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CallableBaseDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 定义任务：实现 Callable 接口，泛型 String 是返回值的类型</span></span><br><span class="line">        Callable&lt;String&gt; myTask = <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>); <span class="comment">// 模拟耗时操作</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;任务执行完毕：这是从子线程返回的结果！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 包装任务：由于 Thread 构造方法只接收 Runnable，</span></span><br><span class="line">        <span class="comment">// 我们需要用 FutureTask 包装一下。FutureTask 实现了 Runnable 接口。</span></span><br><span class="line">        FutureTask&lt;String&gt; futureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(myTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 启动线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(futureTask);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;主线程：已经启动子线程，我现在可以做点别的事...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 获取结果：get() 方法会阻塞当前线程，直到子线程执行完毕并返回结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> futureTask.get(); </span><br><span class="line">        System.out.println(<span class="string">&quot;主线程收到的结果: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>综上，三种实现方式的区别在于：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>Thread</strong></th><th><strong>Runnable</strong></th><th><strong>Callable</strong></th></tr></thead><tbody><tr><td><strong>继承性</strong></td><td>限制单继承</td><td>无限制</td><td>无限制</td></tr><tr><td><strong>返回值</strong></td><td>无</td><td>无</td><td>有 (Future获取)</td></tr><tr><td><strong>异常抛出</strong></td><td>只能内部捕获</td><td>只能内部捕获</td><td>允许 throws 抛出</td></tr></tbody></table><h4 id="线程的生命周期与状态转换-state-machine"><a class="markdownIt-Anchor" href="#线程的生命周期与状态转换-state-machine"></a> 线程的生命周期与状态转换 (State Machine)</h4><p>Java 线程在生命周期内并不是一直占着 CPU 不放，它会在多种状态间切换。通过 <code>thread.getState()</code> 可以获取以下六种状态：</p><ol><li><p><strong>NEW (新建)</strong>：<code>new Thread()</code> 之后，调用 <code>start()</code> 之前。</p></li><li><p><strong>RUNNABLE (可运行)</strong>：调用了 <code>start()</code>。在 Java 中，就绪（Ready）和运行中（Running）统称为“可运行”。</p></li><li><p><strong>BLOCKED (阻塞)</strong>：等待获取 <code>synchronized</code> 锁。</p></li><li><p><strong>WAITING (等待)</strong>：调用了 <code>wait()</code>、<code>join()</code> 或 <code>LockSupport.park()</code>。需要被其他线程显式唤醒。</p></li><li><p><strong>TIMED_WAITING (超时等待)</strong>：调用了 <code>sleep(ms)</code>、<code>wait(ms)</code> 等。时间到了自动苏醒。</p></li><li><p><strong>TERMINATED (终止)</strong>：<code>run()</code> 方法执行完毕或因异常退出。</p></li></ol><img src="https://atffang.github.io/2025/12/22/JAVA多线程方法汇总/线程的生命周期.png"/><h4 id="基础控制方法-sleep-yield-join-interrupt-守护线程"><a class="markdownIt-Anchor" href="#基础控制方法-sleep-yield-join-interrupt-守护线程"></a> 基础控制方法 (<code>sleep</code>, <code>yield</code>, <code>join</code>, <code>interrupt</code>, 守护线程)</h4><p>这一节介绍的是 Java <code>Thread</code> 类中提供的几个核心控制方法，它们决定了线程在执行过程中的行为。</p><h5 id="1-sleeplong-millis"><a class="markdownIt-Anchor" href="#1-sleeplong-millis"></a> 1. sleep(long millis)</h5><p><code>sleep</code> 是静态方法，使当前线程进入 <strong>TIMED_WAITING</strong> 状态，暂停执行一段时间。</p><ul><li><strong>锁的行为</strong>：线程在睡眠时<strong>不会释放</strong>它持有的任何锁（Monitor Lock）。</li><li><strong>异常处理</strong>：睡眠中的线程如果被中断，会抛出 <code>InterruptedException</code>。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>); <span class="comment">// 暂停1秒</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="comment">// 线程在休眠中被中断时的处理逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-yield"><a class="markdownIt-Anchor" href="#2-yield"></a> 2. yield()</h5><p><code>yield</code> 也是静态方法，它表示当前线程愿意让出 CPU 的使用权。</p><ul><li><strong>调度结果</strong>：调用后，线程从“运行中”变为“就绪”状态。</li><li><strong>局限性</strong>：这只是一个“建议”，线程调度器可能会忽略它。如果当前没有其他同优先级的线程，该线程可能立即再次获得 CPU。</li><li><strong>锁的行为</strong>：同样不会释放锁。</li></ul><h5 id="3-join"><a class="markdownIt-Anchor" href="#3-join"></a> 3. join()</h5><p><code>join</code> 是成员方法，用于同步多个线程的执行顺序。</p><ul><li><strong>作用</strong>：如果在线程 A 中调用 <code>B.join()</code>，则 A 线程会进入 <strong>WAITING</strong> 状态，直到 B 线程执行完毕。</li><li><strong>原理</strong>：底层调用的是 <code>Object.wait()</code> 方法，因此调用者会释放掉 B 线程对象的锁。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">/* 耗时任务 */</span> &#125;);</span><br><span class="line">t1.start();</span><br><span class="line">t1.join(); <span class="comment">// 主线程在此阻塞，直到 t1 彻底运行结束</span></span><br></pre></td></tr></table></figure><h5 id="4-interrupt"><a class="markdownIt-Anchor" href="#4-interrupt"></a> 4. interrupt()</h5><p>Java 采用的是协作式的中断机制，而不是暴力停止。</p><ul><li><strong>interrupt()</strong>：将目标线程的中断标志位设为 <code>true</code>。</li><li><strong>isInterrupted()</strong>：实例方法，判断线程是否被中断。</li><li><strong>静态 interrupted()</strong>：检查当前线程的中断状态，并<strong>清除</strong>标志位。</li><li><strong>特殊情况</strong>：如果线程正阻塞在 <code>sleep</code>、<code>wait</code>、<code>join</code> 等方法上，<code>interrupt()</code> 会使这些方法抛出异常，并自动清除中断状态（变回 <code>false</code>）。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">    <span class="comment">// 执行业务逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-守护线程-daemon-thread"><a class="markdownIt-Anchor" href="#5-守护线程-daemon-thread"></a> 5. 守护线程 (Daemon Thread)</h5><p>Java 中的线程分为“用户线程”和“守护线程”</p><ul><li><strong>定义</strong>：守护线程是为用户线程服务的（如 GC 垃圾回收）。</li><li><strong>退出机制</strong>：当 JVM 中所有的用户线程都运行结束时，守护线程会随 JVM 一起直接退出，无论其任务是否完成。</li><li><strong>限制</strong>：必须在 <code>thread.start()</code> 之前调用 <code>setDaemon(true)</code>。</li></ul><p>举个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">daemonThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;  </span><br><span class="line">            <span class="built_in">super</span>.run();  </span><br><span class="line">                System.out.println(getName() + <span class="string">&quot; &quot;</span> + System.currentTimeMillis());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">  </span><br><span class="line">    daemonThread.setName(<span class="string">&quot;B&quot;</span>);  </span><br><span class="line">    daemonThread.setDaemon(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">    daemonThread.start();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第二章线程安全与内存模型-safety-jmm"><a class="markdownIt-Anchor" href="#第二章线程安全与内存模型-safety-jmm"></a> 第二章：线程安全与内存模型 (Safety &amp; JMM)</h3><p>线程安全的核心在于：当多个线程访问一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，调用这个对象的行为都可以获得正确的结果，那这个对象就是线程安全的。</p><h4 id="什么是线程安全"><a class="markdownIt-Anchor" href="#什么是线程安全"></a> 什么是线程安全？</h4><p>要实现线程安全，必须保证并发编程的三大特性：</p><ol><li><p><strong>原子性 (Atomicity)</strong>：一个或多个操作，要么全部执行且在执行过程中不被任何因素打断，要么全部不执行。</p><ul><li><em>典型问题</em>：<code>i++</code> 包含读、加、写三步，在多线程下不具备原子性。</li></ul></li><li><p><strong>可见性 (Visibility)</strong>：当一个线程修改了共享变量的值，其他线程能够立即得知这个修改。</p><ul><li><em>原因</em>：JMM 规定线程有工作内存，修改变量后不会立即同步到主内存。</li></ul></li><li><p><strong>有序性 (Ordering)</strong>：程序执行的顺序按照代码的先后顺序执行。</p><ul><li><em>原因</em>：编译器和处理器为了优化性能，往往会对指令进行<strong>重排序</strong>。</li></ul></li></ol><h4 id="synchronized-关键字"><a class="markdownIt-Anchor" href="#synchronized-关键字"></a> <code>synchronized</code> 关键字</h4><p><code>synchronized</code> 是一种互斥锁，它通过控制多个线程对共享资源的访问，一次只允许一个线程执行，从而同时保证了原子性、可见性和有序性。</p><p><code>synchronized</code> 底层依赖 JVM 的 <strong>Monitor（监视器锁）</strong>。编译后会生成 <code>monitorenter</code> 和 <code>monitorexit</code> 指令。每个对象头中都有 Mark Word，记录了锁的状态（偏向锁、轻量级锁、重量级锁）。</p><p>下面是两个不同的应用：</p><p><code>synchronized</code> 方法<br />在一个方法上使用 <code>synchronized</code>，可以保证同一时刻只能有一个线程访问该方法。这对于涉及共享资源的操作很有用，防止多个线程同时修改资源导致状态不一致。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">someMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 同步的代码块</span></span><br><span class="line">    <span class="comment">// 执行一些对共享资源的操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>synchronized</code> 代码块<br />有时候我们并不需要整个方法都保持同步，而是只需要某部分代码在执行时是互斥的。此时，我们可以使用 <strong><code>synchronized</code> 代码块</strong>。通过指定一个对象锁来控制代码块的同步。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (锁对象) &#123;</span><br><span class="line">    <span class="comment">// 需要同步的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>锁对象</code>：它可以是任意对象，通常是一个共享对象。<code>synchronized</code> 关键字会将该对象作为锁，只允许一个线程在同一时间进入该代码块。</p></li><li><p>如果多个线程试图同时进入该同步代码块，它们必须等待其他线程释放该锁。</p></li><li><p><strong>方法级锁</strong>：当你用 <code>synchronized</code> 修饰一个方法时，锁的粒度是<strong>方法级别</strong>的。只有一个线程能访问方法中的同步部分。</p></li><li><p><strong>代码块级锁</strong>：使用 <code>synchronized</code> 代码块时，锁的粒度是<strong>代码块级别</strong>的。它只锁定特定的资源，而不是整个方法，这样可以提高性能，因为不必要的代码部分不会被同步。</p></li></ul><p><code>wait()</code> 方法使当前线程进入 <strong>等待状态</strong>，直到另一个线程发出通知（通过 <code>notify()</code> 或 <code>notifyAll()</code>）。当线程调用 <code>wait()</code> 时，它会释放当前持有的对象锁，并且进入 <strong>等待队列</strong>，直到被其他线程唤醒。</p><p><code>wait()</code> 必须在 <strong>同步代码块</strong> 或 <strong>同步方法</strong> 中调用，因为它需要获得对象的监视器锁（即 <code>synchronized</code> 锁）。当线程在同步方法或同步代码块中调用 <code>wait()</code> 时，它会释放对象的锁，允许其他线程获得锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (someObject) &#123;</span><br><span class="line">    <span class="keyword">while</span> (conditionNotMet) &#123;</span><br><span class="line">        someObject.wait();  <span class="comment">// 线程在条件不满足时等待</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行后续操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>notify()</code> 方法唤醒 <strong>一个等待中的线程</strong>。当线程调用 <code>notify()</code> 时，它会从等待队列中随机选择一个线程，并将其唤醒，唤醒后的线程会尝试重新获取对象锁，获得锁后才会继续执行。</p><ul><li><code>notify()</code> 必须在 <strong>同步代码块</strong> 或 <strong>同步方法</strong> 中调用。</li><li>被唤醒的线程不会立即执行，而是进入 <strong>可运行状态</strong>，等待获取对象锁。</li></ul><p><code>notifyAll()</code> 方法唤醒 <strong>所有等待中的线程</strong>。与 <code>notify()</code> 不同的是，<code>notifyAll()</code> 会唤醒所有等待该对象锁的线程。所有唤醒的线程会争夺锁，只有获得锁的线程才会继续执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SharedBuffer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生产者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(<span class="type">int</span> value)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (data != -<span class="number">1</span>) &#123;  <span class="comment">// 如果数据已存在，生产者等待</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        data = value;  <span class="comment">// 生产数据</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Produced: &quot;</span> + value);</span><br><span class="line">        notify();  <span class="comment">// 唤醒消费者</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (data == -<span class="number">1</span>) &#123;  <span class="comment">// 如果数据为空，消费者等待</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumed: &quot;</span> + data);</span><br><span class="line">        data = -<span class="number">1</span>;  <span class="comment">// 消费数据</span></span><br><span class="line">        notify();  <span class="comment">// 唤醒生产者</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WaitNotifyExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SharedBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedBuffer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生产者线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    buffer.produce(i);</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);  <span class="comment">// 模拟生产的时间</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消费者线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    buffer.consume();</span><br><span class="line">                    Thread.sleep(<span class="number">150</span>);  <span class="comment">// 模拟消费的时间</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="volatile-关键字"><a class="markdownIt-Anchor" href="#volatile-关键字"></a> <code>volatile</code> 关键字</h4><p><code>volatile</code> 是 Java 提供的最轻量级的同步机制，它保证了<strong>可见性</strong>和<strong>有序性</strong>，但<strong>不保证原子性</strong>。</p><ul><li><strong>可见性原理</strong>：写一个 <code>volatile</code> 变量时，JMM 会把该线程对应的工作内存值立即刷新到主内存；读时，会使本地内存失效，直接从主内存读取。</li><li><strong>禁止重排序</strong>：通过插入<strong>内存屏障</strong>，确保编译器不会为了优化而改变指令顺序。</li></ul><p>为了举例，我们介绍java中的<strong>双重检查锁定</strong>（Double-Checked Locking,<strong>DCL</strong>）,主要是为了解决单例模式（Singleton）在多线程环境下的性能和安全平衡问题。</p><p>如果没有 DCL，我们最简单的同步写法是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="literal">null</span>) instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每次调用 <code>getInstance()</code> 都要加锁，而实际上只有第一次创建实例时才需要同步，后续读取直接返回即可。加锁是非常重的操作，这会严重拖慢性能。那么，我们可以先判断是否为 null，如果不为 null 直接返回；如果为 null，再进入同步块创建对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// 必须加 volatile，防止指令重排导致拿到尚未初始化的对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>(); </span><br><span class="line">                    <span class="comment">// 这里包含三步：1.分配空间 2.初始化 3.指向地址</span></span><br><span class="line">                    <span class="comment">// 重排序可能导致：1 -&gt; 3 -&gt; 2，使得其他线程拿到非 null 但未初始化的对象</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来看 原来的<code>instance = new Singleton();</code> 这一行。在 JVM 层面，它其实被分成了 <strong>3 个步骤</strong>执行：</p><ol><li><strong>分配内存空间</strong>（给这个对象找块地方）。</li><li><strong>初始化对象</strong>（执行构造函数里的逻辑）。</li><li><strong>将 instance 变量指向分配的内存地址</strong>（此时 instance 不再是 null 了）。</li></ol><p><strong>问题出在编译器的优化上</strong>： 由于步骤 2 和步骤 3 之间没有必然的依赖关系，编译器或 CPU 可能会为了提高效率进行<strong>指令重排序</strong>，把顺序变成： <strong>1（分配内存） -&gt; 3（指向地址） -&gt; 2（初始化对象）</strong>。</p><p>这会导致下面发生的灾难场景：</p><ol><li><strong>线程 A</strong> 进入同步块，执行 <code>instance = new Singleton()</code>。</li><li>由于重排序，线程 A 先执行了步骤 3（指向地址），此时 <code>instance</code> 已经<strong>不是 null</strong> 了，但步骤 2（初始化）<strong>还没完成</strong>。</li><li>就在这一瞬间，<strong>线程 B</strong> 调用 <code>getInstance()</code>，它判断 <code>instance != null</code>，于是开心地直接把这个 instance 拿去用了。</li><li>结果线程 B 在使用对象时，发现由于还没初始化，内部属性全是空的，直接报出 <strong>空指针异常（NPE）</strong> 或逻辑错误。</li></ol><p>在 <code>instance</code> 变量上加上 <code>volatile</code> 关键字后，会发挥两个核心作用：</p><ol><li><strong>禁止指令重排序</strong>：它会插入一个“内存屏障”，强制保证执行顺序必须是 <code>1 -&gt; 2 -&gt; 3</code>。这样当线程 B 拿到对象时，它一定已经是初始化完成的。</li><li><strong>保证可见性</strong>：一旦线程 A 完成了对象的创建，线程 B 能够立即从主内存中看到 <code>instance</code> 的最新值。</li></ol><h4 id="原子类-atomic"><a class="markdownIt-Anchor" href="#原子类-atomic"></a> 原子类 <code>Atomic</code></h4><p>对于简单的数值运算，使用 <code>synchronized</code> 太重，频繁的线程上下文切换会损耗性能。<code>Atomic</code> 系列工具类（如 <code>AtomicInteger</code>）采用 <strong>CAS (Compare And Swap)</strong> 机制实现。</p><ul><li><strong>CAS 原理</strong>：包含三个参数：变量内存地址 (V)、预期原值 (A) 和新值 (B)。<ul><li>只有当 V 的实际值等于 A 时，才将 V 修改为 B。否则说明变量已被修改，当前线程会通过自旋（死循环）不断尝试，直到成功。</li></ul></li></ul><p>从概念上来说，<strong>原子变量 = 操作不可被打断的变量</strong><br />对它的操作要么全部执行完，要么完全不执行，<strong>不会被线程切换中断</strong>，因此天然线程安全，不需要 synchronized。</p><p>对于普通变量操作，如i++，看起来是一句，但实际上包含三个步骤：</p><ol><li>读取 i</li><li>i + 1</li><li>写回 i</li></ol><p>如果两个线程同时执行，就可能出现：</p><ul><li>两个线程都读到旧值</li><li>最终只加一次</li></ul><p>这就出现了典型的 <strong>竞态条件（Race Condition）</strong><br />举个简单的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">    count.incrementAndGet(); <span class="comment">// 等同于非原子的 count++</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="线程封闭-threadlocal"><a class="markdownIt-Anchor" href="#线程封闭-threadlocal"></a> 线程封闭 (<code>ThreadLocal</code>)</h4><p>如果说锁是解决“如何同步访问共享数据”，那么 <code>ThreadLocal</code> 则是“如何不共享数据”。它为每个线程提供一份独立的变量副本，实现线程间的数据隔离。</p><ul><li><strong>核心用途</strong>：解决数据库连接、Session 管理等场景下的线程安全问题。<br />举个简单的例子</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; localValue = ThreadLocal.withInitial(() -&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            localValue.set(<span class="number">10</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; : &quot;</span> + localValue.get());</span><br><span class="line">        &#125;, <span class="string">&quot;Thread-A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            localValue.set(<span class="number">20</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; : &quot;</span> + localValue.get());</span><br><span class="line">        &#125;, <span class="string">&quot;Thread-B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第三章juc-显式锁-explicit-locks"><a class="markdownIt-Anchor" href="#第三章juc-显式锁-explicit-locks"></a> 第三章：JUC 显式锁 (Explicit Locks)</h3><p>在 Java 并发工具包（JUC）中，<code>java.util.concurrent.locks</code> 提供了比 <code>synchronized</code> 更灵活、更强大的锁定机制。<code>synchronized</code> 又被称为内置锁，其不需要程序员过多的手动操作，而基于<code>Lock</code>接口实现的为显式锁，需要程序员一些手动操作才能执行。</p><h4 id="lock-接口与-reentrantlock"><a class="markdownIt-Anchor" href="#lock-接口与-reentrantlock"></a> <code>Lock</code> 接口与 <code>ReentrantLock</code></h4><p><code>ReentrantLock</code> 是最常用的显式锁，它不仅完全覆盖了 <code>synchronized</code> 的功能，还提供了许多高级特性:</p><ul><li><strong>手动规范</strong>：使用显式锁必须遵循特定的模板。由于它不会自动释放锁，为了防止死锁，<strong>必须</strong>在 <code>finally</code> 块中调用 <code>unlock()</code>。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>可重入性</strong>：同一个线程可以多次获得同一把锁，内部通过计数器实现。</p></li><li><p><strong>可中断性</strong>：使用 <code>lockInterruptibly()</code> 获取锁时，如果线程正在等待锁，它可以响应中断信号并停止等待。</p></li><li><p><strong>公平锁与非公平锁</strong>：构造函数支持传入 <code>boolean</code> 值。公平锁会严格按照线程排队的顺序给锁，而非公平锁（默认）允许插队，通常拥有更高的吞吐量。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>); <span class="comment">// 公平锁</span></span><br></pre></td></tr></table></figure><ul><li><strong>可轮询获取锁（tryLock）</strong>: 线程可以“试一试”拿锁，拿不到直接走，不会阻塞。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lock.tryLock(<span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 拿到锁才执行</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 拿不到锁，执行别的逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>举个简单的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">lock.lock(); <span class="comment">// 阻塞式获取</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 临界区代码</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock(); <span class="comment">// 必须在 finally 中释放</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试获取锁：拿不到就走，不阻塞</span></span><br><span class="line"><span class="keyword">if</span> (lock.tryLock()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">/* 业务逻辑 */</span> &#125; <span class="keyword">finally</span> &#123; lock.unlock(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="readwritelock-读写锁"><a class="markdownIt-Anchor" href="#readwritelock-读写锁"></a> <code>ReadWriteLock</code> 读写锁</h4><p>在很多场景下，数据是“读多写少”的。如果用普通的互斥锁，多个线程同时读也会互相排队，效率低下。<code>ReentrantReadWriteLock</code> 实现了“读写分离”。读写锁是对普通互斥锁的升级，允许多个线程同时读，但写操作只能有一个，并且写时不能读，即：</p><ul><li><strong>读读不互斥</strong>（并发度高）</li><li><strong>读写互斥</strong></li><li><strong>写写互斥</strong></li></ul><p><strong>ReentrantReadWriteLock</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReadWriteLock</span> <span class="variable">rwLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line"><span class="type">Lock</span> <span class="variable">readLock</span> <span class="operator">=</span> rwLock.readLock();</span><br><span class="line"><span class="type">Lock</span> <span class="variable">writeLock</span> <span class="operator">=</span> rwLock.writeLock();</span><br></pre></td></tr></table></figure><p>多个线程可以同时拿：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">readLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 读取共享数据</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只有一个线程能拿：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">writeLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 修改共享数据</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是一个简单的读写锁的示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantReadWriteLockDEMO</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">readLock</span> <span class="operator">=</span> readWriteLock.readLock();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">writeLock</span>  <span class="operator">=</span> readWriteLock.writeLock();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;  </span><br><span class="line">        readLock.lock();  </span><br><span class="line">        <span class="keyword">try</span>&#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> map.get(key);  </span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; get &quot;</span> + key + <span class="string">&quot; &quot;</span> + val);  </span><br><span class="line">            <span class="keyword">return</span> val;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            readLock.unlock();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String key, String val)</span> &#123;  </span><br><span class="line">        writeLock.lock();  </span><br><span class="line">        <span class="keyword">try</span>&#123;  </span><br><span class="line">            map.put(key, val);  </span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; put &quot;</span> + key + <span class="string">&quot; &quot;</span> + val);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            writeLock.unlock();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;  </span><br><span class="line">        <span class="type">ReentrantReadWriteLockDEMO</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLockDEMO</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cache.get(<span class="string">&quot;name&quot;</span>);  </span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cache.get(<span class="string">&quot;name&quot;</span>);  </span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">            <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">                cache.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;value-&quot;</span> + (cnt++));  </span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">500</span>); &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        t1.start();  </span><br><span class="line">        t2.start();  </span><br><span class="line">        t3.start();  </span><br><span class="line">        t1.join();  </span><br><span class="line">        t2.join();  </span><br><span class="line">        t3.join();   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="condition-机制"><a class="markdownIt-Anchor" href="#condition-机制"></a> <code>Condition</code> 机制</h4><p><code>Condition</code> 是为了配合 <code>Lock</code> 使用的，它用来替代 <code>Object.wait()/notify()</code>。它的最大优势在于：<strong>一个锁可以关联多个 Condition（条件变量）</strong>。</p><p>在 <code>synchronized</code> 中，所有的线程都挤在一个等待队列里，调用 <code>notifyAll()</code> 会唤醒所有人。而 <code>Condition</code> 可以实现“精准唤醒”。</p><p>在 synchronized 里我们用：<br />•wait()<br />•notify()<br />•notifyAll()</p><p>在 显式锁（ReentrantLock） 中，我们不能再用它们，要用：<br />•await() 代替 wait()<br />•signal() 代替 notify()<br />•signalAll() 代替 notifyAll()</p><p>一个典型的应用场景是<strong>生产消费者模型</strong>， 我们可以创建两个条件：<code>notFull</code>（不满）和 <code>notEmpty</code>（不空）。生产者只唤醒等待 <code>notEmpty</code> 的消费者，互不干扰。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Depot</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == MAX) &#123;</span><br><span class="line">                notFull.await();   <span class="comment">// 等待仓库有空位</span></span><br><span class="line">            &#125;</span><br><span class="line">            count++;</span><br><span class="line">            System.out.println(<span class="string">&quot;生产，总数 = &quot;</span> + count);</span><br><span class="line">            notEmpty.signal();     <span class="comment">// 唤醒等待取货的线程</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                notEmpty.await();  <span class="comment">// 等待仓库非空</span></span><br><span class="line">            &#125;</span><br><span class="line">            count--;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费，总数 = &quot;</span> + count);</span><br><span class="line">            notFull.signal();      <span class="comment">// 唤醒等待生产的线程</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="锁的降级-写锁-读锁"><a class="markdownIt-Anchor" href="#锁的降级-写锁-读锁"></a> 锁的降级 (写锁 -&gt; 读锁)</h4><p>锁降级是指：<strong>线程持有写锁 -&gt; 获取读锁 -&gt; 释放写锁</strong>。</p><p>这么做主要是为了保证数据的<strong>可见性</strong>和<strong>原子性</strong>。如果你先释放写锁再获取读锁，在中间的空隙，数据可能被其他线程修改了。通过锁降级，线程可以无缝地从“修改者”切换为“观察者”，且在这个过程中，数据不会被他人篡改。</p><p>下面是一个简单的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">writeLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 修改数据</span></span><br><span class="line">    <span class="comment">// 2. 降级：在释放写锁前先获取读锁</span></span><br><span class="line">    readLock.lock();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeLock.unlock(); <span class="comment">// 3. 释放写锁，此时依然持有读锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 4. 使用数据</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readLock.unlock(); <span class="comment">// 5. 最后释放读锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第四章并发协作工具类-synchronization-tools"><a class="markdownIt-Anchor" href="#第四章并发协作工具类-synchronization-tools"></a> 第四章：并发协作工具类 (Synchronization Tools)</h3><p>JUC（Java 并发工具包）除了提供锁之外，还提供了一系列非常有用的协作工具。如果说锁是解决资源竞争的，那么这些工具就是解决线程配合的。</p><h4 id="倒计时器-countdownlatch"><a class="markdownIt-Anchor" href="#倒计时器-countdownlatch"></a> 倒计时器 <code>CountDownLatch</code></h4><p>CountDownLatch 是一个同步工具类，用来让一个或多个线程等待其他线程完成任务。<br />就像一个倒计时器：<br />•初始有一个计数 count<br />•每次调用 countDown()，计数减 1<br />•当计数变成 0 时，所有在 await() 等待的线程都会继续执行</p><p>典型场景：等待多个任务都完成后继续执行<br />例如：<br />•主线程启动 3 个子线程<br />•每个子线程完成后执行 countDown()<br />•主线程调用 await()，一直等待所有子线程完成<br />•所有子线程完成后，主线程继续执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">taskCount</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(taskCount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; taskCount; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;子线程 &quot;</span> + id + <span class="string">&quot; 开始任务&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span> + id * <span class="number">500</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;子线程 &quot;</span> + id + <span class="string">&quot; 完成任务&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123; &#125;</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown(); <span class="comment">// 计数 -1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;主线程等待所有子任务完成...&quot;</span>);</span><br><span class="line">        latch.await(); <span class="comment">// 等待 count 变为 0</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;所有子任务完成，主线程继续执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="循环栅栏-cyclicbarrier"><a class="markdownIt-Anchor" href="#循环栅栏-cyclicbarrier"></a> 循环栅栏 <code>CyclicBarrier</code></h4><p><strong>CyclicBarrier 是一种同步屏障，让一组线程必须等到“全部都到达屏障点”，然后同时继续执行。</strong><br />特点：<br />•屏障点（barrier）可以重复使用（循环 cyclic）<br />•线程到达 barrier 后会阻塞<br />•当所有线程都到达后，自动释放所有线程</p><p>假设要 3 个线程同时开始下一步：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程 &quot;</span> + id + <span class="string">&quot; 到达屏障点&quot;</span>);</span><br><span class="line">                    barrier.await(); <span class="comment">// 阻塞，直到 3 个线程都调用</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;线程 &quot;</span> + id + <span class="string">&quot; 通过屏障，继续执行&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">线程 0 到达屏障点</span><br><span class="line">线程 2 到达屏障点</span><br><span class="line">线程 1 到达屏障点</span><br><span class="line">（满足3个线程到达）</span><br><span class="line">线程 2 通过屏障，继续执行</span><br><span class="line">线程 1 通过屏障，继续执行</span><br><span class="line">线程 0 通过屏障，继续执行</span><br></pre></td></tr></table></figure><p>CyclicBarrier 与 CountDownLatch 的区别</p><table><thead><tr><th><strong>特性</strong></th><th><strong>CyclicBarrier</strong></th><th><strong>CountDownLatch</strong></th></tr></thead><tbody><tr><td>作用</td><td>让多个线程“集合，然后一起继续”</td><td>让线程等待其他线程做完某件事</td></tr><tr><td>是否可重用</td><td>✔ 可重复使用（cyclic）</td><td>❌ 不能重置（一次性）</td></tr><tr><td>是否所有线程都会等待</td><td>✔ 是</td><td>❌ 通常只有一个或少量线程等待</td></tr><tr><td>调用方法</td><td>await()</td><td>await() + countDown()</td></tr><tr><td>谁减计数</td><td>每个线程调用 await() 都算一个到达</td><td>调用 countDown() 的线程</td></tr><tr><td>信号方向</td><td>大家互相等待</td><td>一些线程等待，另一些负责 countDown</td></tr></tbody></table><h4 id="信号量-semaphore"><a class="markdownIt-Anchor" href="#信号量-semaphore"></a> 信号量 <code>Semaphore</code></h4><p>**Semaphore（信号量）**是Java 并发编程里一个非常核心的同步工具，主要用于控制同时访问某个资源的线程数量。</p><p>Semaphore = 一个“许可证”计数器，用来限制并发访问数量。<br />比如你有 3 台打印机，但有 10 个线程要打印文件。<br />Semaphore(3) 就相当于发 3 张“许可证”，同时只允许 3 个线程使用打印机。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>); <span class="comment">// 有 3 个许可证</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        semaphore.acquire(); <span class="comment">// 请求一个许可证，如果没有就阻塞</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 开始打印...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>); <span class="comment">// 模拟任务</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 打印结束&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        semaphore.release(); <span class="comment">// 释放一个许可证</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Semaphore 常用方法</p><table><thead><tr><th><strong>方法</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>acquire()</td><td>获取一个许可证，没有则阻塞</td></tr><tr><td>acquire(int n)</td><td>一次获取 n 个许可证</td></tr><tr><td>tryAcquire()</td><td>尝试获取，不阻塞，获取不到返回 false</td></tr><tr><td>release()</td><td>释放许可证</td></tr><tr><td>availablePermits()</td><td>查看剩余许可证数量</td></tr></tbody></table><p>Semaphore vs Lock / synchronized</p><table><thead><tr><th><strong>对比对象</strong></th><th><strong>Semaphore</strong></th><th><strong>Lock / synchronized</strong></th></tr></thead><tbody><tr><td>核心用途</td><td>限制并发数量</td><td>同一时间只有一个线程进入临界区（互斥）</td></tr><tr><td>支持多少线程同时进入</td><td><strong>多个</strong>（取决于 permits）</td><td><strong>只能 1 个</strong></td></tr><tr><td>是否可作为锁使用</td><td>可以（permits=1 时类似 mutex）</td><td>是锁</td></tr></tbody></table><p>公平/非公平</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>, <span class="literal">true</span>); <span class="comment">// 公平，按排队顺序</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>, <span class="literal">false</span>); <span class="comment">// 非公平（默认），速度更快</span></span><br></pre></td></tr></table></figure><h4 id="阶段同步-phaser"><a class="markdownIt-Anchor" href="#阶段同步-phaser"></a> 阶段同步 <code>Phaser</code></h4><p>Phaser 是 Java 并发里 <strong>最灵活、可重用、可动态注册线程的“阶段同步器”</strong><br />可以理解为：一个可以分成很多阶段（phase）的同步器，每个阶段都要所有“参与者”到齐后才能进入下一阶段，并且参与者数量还可以动态增减。</p><table><thead><tr><th><strong>工具</strong></th><th><strong>问题</strong></th></tr></thead><tbody><tr><td><strong>CountDownLatch</strong></td><td>一次性等待，不能复用，不能动态增加线程</td></tr><tr><td><strong>CyclicBarrier</strong></td><td>可复用，但是参与线程数固定，不能动态变化</td></tr><tr><td><strong>Phaser</strong></td><td>✔ 可复用 ✔ 可多阶段 ✔ 可动态增加/减少线程 ✔ 更灵活</td></tr></tbody></table><p>基础使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">3</span>); <span class="comment">// 3 个参与者</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 执行阶段1&quot;</span>);</span><br><span class="line">        phaser.arriveAndAwaitAdvance();  <span class="comment">// 等别人</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 执行阶段2&quot;</span>);</span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 执行阶段3&quot;</span>);</span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T1 执行阶段1</span><br><span class="line">T2 执行阶段1</span><br><span class="line">T3 执行阶段1</span><br><span class="line">--- 阶段1结束 ---</span><br><span class="line">T1 执行阶段2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>核心方法：</p><table><thead><tr><th><strong>方法</strong></th><th><strong>意义</strong></th></tr></thead><tbody><tr><td>arrive()</td><td>到达当前阶段，不等待</td></tr><tr><td>arriveAndAwaitAdvance()</td><td>到达并等待其他线程（最常用）</td></tr><tr><td>arriveAndDeregister()</td><td>到达后退出，不再参加后续阶段</td></tr></tbody></table><p>phaser可以动态注册线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phaser.register(); <span class="comment">// 新线程加入同步控制</span></span><br></pre></td></tr></table></figure><p>一个例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">1</span>); <span class="comment">// main 是 1 个参与者</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    Phaser ph;</span><br><span class="line">    Player(Phaser ph) &#123; <span class="built_in">this</span>.ph = ph; ph.register(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 准备进入游戏&quot;</span>);</span><br><span class="line">        ph.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 加载地图&quot;</span>);</span><br><span class="line">        ph.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 加载角色&quot;</span>);</span><br><span class="line">        ph.arriveAndAwaitAdvance();</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 完成所有加载&quot;</span>);</span><br><span class="line">        ph.arriveAndDeregister();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Phaser</span> <span class="variable">ph</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">1</span>); <span class="comment">// main</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(ph), <span class="string">&quot;玩家1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(ph), <span class="string">&quot;玩家2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    ph.arriveAndAwaitAdvance(); <span class="comment">// 主线程同步各阶段</span></span><br><span class="line">    ph.arriveAndAwaitAdvance();</span><br><span class="line">    ph.arriveAndAwaitAdvance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="数据交换-exchanger"><a class="markdownIt-Anchor" href="#数据交换-exchanger"></a> 数据交换 <code>Exchanger</code></h4><p><code>Exchanger</code> 用于两个线程之间的数据交换。它提供一个同步点，在这个点，两个线程可以交换彼此的数据。</p><ul><li><strong>核心逻辑</strong>：当一个线程调用 <code>exchange()</code> 时，它会阻塞直到第二个线程也调用该方法。然后两个线程交换数据并返回。</li><li><strong>特性</strong>：只能成对使用（2个线程）。</li><li><strong>场景</strong>：两个流水线环节的数据传递，或者遗传算法中的交叉操作。</li></ul><p>一个简单的示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;A线程数据&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> exchanger.exchange(data);</span><br><span class="line">        System.out.println(<span class="string">&quot;A 得到：&quot;</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;B线程数据&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> exchanger.exchange(data);</span><br><span class="line">        System.out.println(<span class="string">&quot;B 得到：&quot;</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure><h3 id="第五章线程池架构-executor-framework"><a class="markdownIt-Anchor" href="#第五章线程池架构-executor-framework"></a> 第五章：线程池架构 (Executor Framework)</h3><p>在实际生产开发中，我们几乎从不手动 <code>new Thread()</code>。为了节省系统资源并提高响应速度，我们会使用线程池来管理线程。</p><h4 id="为什么要用线程池"><a class="markdownIt-Anchor" href="#为什么要用线程池"></a> 为什么要用线程池？</h4><p>创建一个 Java 线程需要调用操作系统的内核 API，这是一个昂贵的操作。</p><ul><li><strong>降低资源消耗</strong>：通过池化技术重复利用已创建的线程，减少线程创建和销毁的性能开销。</li><li><strong>提高响应速度</strong>：任务到达时，无需等待线程创建即可立即执行。</li><li><strong>提高线程的可管理性</strong>：线程是稀缺资源，使用线程池可以统一分配、调优和监控，防止无限制创建线程导致系统崩溃（OOM）。</li></ul><h4 id="threadpoolexecutor-核心参数"><a class="markdownIt-Anchor" href="#threadpoolexecutor-核心参数"></a> <code>ThreadPoolExecutor</code> 核心参数</h4><p>所有的线程池底层都是 <code>ThreadPoolExecutor</code>，包含七个核心的参数：</p><table><thead><tr><th><strong>参数</strong></th><th><strong>名称</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><code>corePoolSize</code></td><td><strong>核心线程数</strong></td><td>线程池中常驻的“保底”线程数量，即使它们闲着也不会被销毁。</td></tr><tr><td><code>maximumPoolSize</code></td><td><strong>最大线程数</strong></td><td>线程池允许创建的最大线程总量。</td></tr><tr><td><code>keepAliveTime</code></td><td><strong>存活时间</strong></td><td>当线程数大于核心线程数时，多余的空闲线程能活多久。</td></tr><tr><td><code>unit</code></td><td><strong>时间单位</strong></td><td><code>keepAliveTime</code> 的时间单位（秒、毫秒等）。</td></tr><tr><td><code>workQueue</code></td><td><strong>任务队列</strong></td><td>存放待执行任务的阻塞队列（BlockingQueue）。</td></tr><tr><td><code>threadFactory</code></td><td><strong>线程工厂</strong></td><td>用于创建新线程，通常在这里给线程起个有意义的名字。</td></tr><tr><td><code>handler</code></td><td><strong>拒绝策略</strong></td><td>当队列满了且线程数达到最大值时，如何处理新来的任务。</td></tr></tbody></table><h4 id="线程池工作流程与拒绝策略"><a class="markdownIt-Anchor" href="#线程池工作流程与拒绝策略"></a> 线程池工作流程与拒绝策略</h4><p>线程池的处理逻辑遵循“<strong>先核心，再队列，后最大</strong>”的原则：</p><ol><li><strong>提交任务</strong>：如果当前线程数 &lt; <code>corePoolSize</code>，直接创建新线程执行。</li><li><strong>进入队列</strong>：如果线程数 ≥ <code>corePoolSize</code>，任务进入 <code>workQueue</code> 排队。</li><li><strong>尝试扩容</strong>：如果队列满了且线程数 &lt; <code>maximumPoolSize</code>，创建非核心线程执行。</li><li><strong>触发拒绝</strong>：如果队列满了且线程数 = <code>maximumPoolSize</code>，执行拒绝策略。</li></ol><p><strong>JDK 自带的四种拒绝策略：</strong></p><ul><li><strong>AbortPolicy</strong>（默认）：直接抛出 <code>RejectedExecutionException</code> 异常，阻止系统正常工作。</li><li><strong>CallerRunsPolicy</strong>：“谁提交谁执行”。让提交任务的线程（比如主线程）自己去跑这个任务，从而降低任务提交速度。</li><li><strong>DiscardPolicy</strong>：直接丢弃任务，不予任何处理也不报错。</li><li><strong>DiscardOldestPolicy</strong>：丢弃队列里最老的一个任务，尝试再次提交当前任务。</li></ul><h4 id="工厂类-executors"><a class="markdownIt-Anchor" href="#工厂类-executors"></a> 工厂类 <code>Executors</code></h4><p>常用方法：<br />•Executors.newFixedThreadPool(n)：固定大小线程池<br />•Executors.newCachedThreadPool()：弹性线程池<br />•Executors.newSingleThreadExecutor()：单线程<br />•Executors.newScheduledThreadPool(n)：定时任务线程池</p><h5 id="executorservice线程池接口"><a class="markdownIt-Anchor" href="#executorservice线程池接口"></a> ExecutorService（线程池接口）</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Executor</span><br><span class="line">  │</span><br><span class="line">  ├── ExecutorService</span><br><span class="line">  │        │</span><br><span class="line">  │        └── AbstractExecutorService</span><br><span class="line">  │                │</span><br><span class="line">  │                └── ThreadPoolExecutor  ← 普通线程池核心</span><br><span class="line">  │</span><br><span class="line">  └── ScheduledExecutorService</span><br><span class="line">           │</span><br><span class="line">           └── ScheduledThreadPoolExecutor ← 定时任务线程池核心</span><br></pre></td></tr></table></figure><p>常用方法：<br />•submit()：提交任务<br />•shutdown()：优雅关闭<br />•shutdownNow()：强制终止</p><h5 id="scheduledexecutorservice"><a class="markdownIt-Anchor" href="#scheduledexecutorservice"></a> <strong>ScheduledExecutorService</strong></h5><p>用于执行定时任务、周期任务。<br />包含：<br /><code>schedule()</code><br /><code>scheduleAtFixedRate()</code><br /><code>scheduleWithFixedDelay()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个具有2个线程的定时任务线程池</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">scheduler</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 延迟 3 秒执行一次任务</span></span><br><span class="line">        scheduler.schedule(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务 A：延迟 3 秒执行 -&gt; &quot;</span> + System.currentTimeMillis());</span><br><span class="line">        &#125;, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 每隔 2 秒执行一次任务（固定频率）</span></span><br><span class="line">        scheduler.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务 B：每隔 2 秒执行 -&gt; &quot;</span> + System.currentTimeMillis());</span><br><span class="line">        &#125;, <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 程序不退出，保持执行</span></span><br><span class="line">        <span class="comment">// 若想停止，稍后调用 scheduler.shutdown();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="forkjoinpool-分治思想"><a class="markdownIt-Anchor" href="#forkjoinpool-分治思想"></a> <code>ForkJoinPool</code> (分治思想)</h4><p>ForkJoinPool 是一种专门用于“分而治之（Fork）+ 合并结果（Join）”的高效并行计算线程池，它用来处理大量可以拆分的任务，自动进行任务窃取（work-stealing）以提升 CPU 利用率。</p><p>你一般只需要继承：<br />•RecursiveAction（void 任务）<br />•RecursiveTask（有返回值任务）</p><p>大数组求和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SumTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span>[] arr;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> start, end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SumTask</span><span class="params">(<span class="type">long</span>[] arr, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.arr = arr;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> end - start;</span><br><span class="line">        <span class="keyword">if</span> (length &lt;= THRESHOLD) &#123; <span class="comment">// 小任务直接算</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) sum += arr[i];</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> start + length / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">SumTask</span> <span class="variable">left</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(arr, start, mid);</span><br><span class="line">        <span class="type">SumTask</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(arr, mid, end);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分裂</span></span><br><span class="line">        left.fork();</span><br><span class="line">        right.fork();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合并</span></span><br><span class="line">        <span class="keyword">return</span> left.join() + right.join();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span>[] arr = <span class="keyword">new</span> <span class="title class_">long</span>[<span class="number">1000000</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) arr[i] = i;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> pool.invoke(<span class="keyword">new</span> <span class="title class_">SumTask</span>(arr, <span class="number">0</span>, arr.length));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;总和：&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="future"><a class="markdownIt-Anchor" href="#future"></a> Future</h4><p>Future 表示一个异步计算的结果，你可以在提交任务后立即得到 Future 对象，以后再从这个对象中取结果。<br />其接口为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span>;</span><br><span class="line">    V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line">    V <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">         <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>future的最常见来源：线程池的 <strong>submit()</strong> 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;Integer&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>得到的 future 就是异步结果句柄。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;String&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 模拟耗时任务</span></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;任务完成&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;我先做点别的事...&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到结果（阻塞）</span></span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get();</span><br><span class="line"></span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我先做点别的事...</span><br><span class="line">任务完成</span><br></pre></td></tr></table></figure><p>因此，future可以 通过 get() 方法获取异步执行的结果（阻塞等待）。<br />同时，也可以通过cancel取消任务，通过isDone判断任务是否完成，通过get(timeout)等待固定时间，如果任务还没完成，则抛 TimeoutException。</p><h3 id="第六章异步编程-asynchronous-programming"><a class="markdownIt-Anchor" href="#第六章异步编程-asynchronous-programming"></a> 第六章：异步编程 (Asynchronous Programming)</h3><h4 id="future-的局限性"><a class="markdownIt-Anchor" href="#future-的局限性"></a> <code>Future</code> 的局限性</h4><p>虽然 <code>Future</code> 开启了异步执行的先河，但它在处理复杂业务逻辑时非常笨拙：</p><ul><li><strong>阻塞等待</strong>：要获取结果只能调用 <code>get()</code>，如果子线程没跑完，主线程必须在此阻塞，这实际上把异步变成了同步等待。</li><li><strong>轮询耗能</strong>：如果不阻塞，就得用 <code>isDone()</code> 开启死循环轮询，极度消耗 CPU。</li><li><strong>无法回调</strong>：无法表达“任务完成后自动执行下一步”的逻辑。</li><li><strong>编排困难</strong>：很难将多个 <code>Future</code> 的结果组合在一起，代码会嵌套得非常难看（回调地狱）。</li></ul><h4 id="completablefuture"><a class="markdownIt-Anchor" href="#completablefuture"></a> <code>CompletableFuture</code></h4><p>JDK 8 引入的 <code>CompletableFuture</code> 是异步编程的里程碑。它实现了 <code>Future</code> 和 <code>CompletionStage</code> 两个接口，支持任务的回调、组合和链式编排。</p><h5 id="异步任务的启动与执行策略"><a class="markdownIt-Anchor" href="#异步任务的启动与执行策略"></a> 异步任务的启动与执行策略</h5><p>任务的启动通常依赖于静态工厂方法。<code>supplyAsync</code> 用于启动具有返回值的异步计算，而 <code>runAsync</code> 则适用于仅需执行特定动作且无需返回结果的场景。在资源调度层面，若不指定 <code>Executor</code>，这些任务默认由 <code>ForkJoinPool.commonPool()</code> 承载，但在生产环境下，通常建议传入自定义线程池以实现业务间的资源隔离与监控。</p><h5 id="异步链路的回调处理机制"><a class="markdownIt-Anchor" href="#异步链路的回调处理机制"></a> 异步链路的回调处理机制</h5><p>在任务完成后，<code>CompletableFuture</code> 支持通过链式调用定义回调逻辑。<code>thenApply</code> 方法能够获取前一阶段的执行结果并对其进行转换，产生一个新的返回值，从而构建出流水线式的处理链路。与之相对，<code>thenAccept</code> 仅用于消费前序任务的结果而不产生新的输出，而 <code>thenRun</code> 则完全忽略结果，仅在任务完成这一特定时机触发后续动作。</p><h5 id="多任务的逻辑编排与协同"><a class="markdownIt-Anchor" href="#多任务的逻辑编排与协同"></a> 多任务的逻辑编排与协同</h5><p>针对复杂的并发场景，<code>CompletableFuture</code> 提供了强大的编排能力。对于存在先后依赖关系的串行任务，<code>thenCompose</code> 可以将前一个任务的输出平滑传递给下一个异步任务；而对于互不依赖、需并行执行的任务，<code>thenCombine</code> 支持在两个任务全部完成后对其结果进行聚合。在更宏观的层面，<code>allOf</code> 提供了阻塞式同步机制，确保所有并行的异步任务全部完成后再向下执行，而 <code>anyOf</code> 则实现了竞争逻辑，只要其中任意一个任务率先完成即返回其结果。</p><h5 id="异步链路的异常捕获与容错"><a class="markdownIt-Anchor" href="#异步链路的异常捕获与容错"></a> 异步链路的异常捕获与容错</h5><p>异步编程中的异常传播与传统同步代码有所不同，需要专门的兜底机制。<code>exceptionally</code> 方法类似于同步代码中的 catch 块，能够在链路出现异常时拦截错误并返回一个预设的默认值，确保后续链路不会因未捕获的异常而中断。此外，<code>handle</code> 方法提供了更全面的控制，无论前序任务是正常结束还是抛出异常，它均能接收到执行结果或异常对象，并进行统一的处理与转换。</p><p>举一个链式流水线的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;查询商品ID:123&quot;</span>)</span><br><span class="line">    .thenApply(id -&gt; <span class="string">&quot;获取商品价格: $99&quot;</span>) <span class="comment">// 链式处理</span></span><br><span class="line">    .thenCombine(CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;获取优惠券: -$10&quot;</span>), </span><br><span class="line">        (price, coupon) -&gt; price + <span class="string">&quot; &quot;</span> + coupon) <span class="comment">// 组合两个异步任务</span></span><br><span class="line">    .thenAccept(finalResult -&gt; System.out.println(<span class="string">&quot;最终报价: &quot;</span> + finalResult))</span><br><span class="line">    .exceptionally(e -&gt; &#123; </span><br><span class="line">        System.err.println(<span class="string">&quot;出错: &quot;</span> + e.getMessage()); </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h4 id="completionservice"><a class="markdownIt-Anchor" href="#completionservice"></a> <code>CompletionService</code></h4><p><code>CompletionService&lt;V&gt;</code> 是一个接口，用于 提交异步任务并按完成顺序获取结果。它结合了 Executor（线程池）和 BlockingQueue 的功能。任务完成顺序与提交顺序可能不同，使用 CompletionService 可以 按照完成顺序 获取任务结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletionServiceExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        CompletionService&lt;String&gt; service = <span class="keyword">new</span> <span class="title class_">ExecutorCompletionService</span>&lt;&gt;(pool);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交任务</span></span><br><span class="line">        service.submit(() -&gt; &#123; Thread.sleep(<span class="number">300</span>); <span class="keyword">return</span> <span class="string">&quot;Task 1&quot;</span>; &#125;);</span><br><span class="line">        service.submit(() -&gt; &#123; Thread.sleep(<span class="number">100</span>); <span class="keyword">return</span> <span class="string">&quot;Task 2&quot;</span>; &#125;);</span><br><span class="line">        service.submit(() -&gt; &#123; Thread.sleep(<span class="number">200</span>); <span class="keyword">return</span> <span class="string">&quot;Task 3&quot;</span>; &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 按完成顺序获取结果</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Future&lt;String&gt; future = service.take();  <span class="comment">// 阻塞直到有任务完成</span></span><br><span class="line">            System.out.println(future.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第七章并发容器-concurrent-collections"><a class="markdownIt-Anchor" href="#第七章并发容器-concurrent-collections"></a> 第七章：并发容器 (Concurrent Collections)</h3><h4 id="concurrenthashmap-原理"><a class="markdownIt-Anchor" href="#concurrenthashmap-原理"></a> <code>ConcurrentHashMap</code> 原理</h4><p><code>ConcurrentHashMap</code> 是为了解决 <code>Hashtable</code> 全局锁定导致并发效率低下的问题而设计的。在 Java 8 及其后续版本中，它舍弃了早期版本中的分段锁（Segment）设计，转而采用 <strong>Node 数组 + 链表 + 红黑树</strong> 的结构，并结合 <strong>CAS（Compare-And-Swap）</strong> 和 <strong>synchronized</strong> 实现更细粒度的锁控制。</p><p>在执行读操作时，<code>ConcurrentHashMap</code> 完全不加锁，通过 <code>volatile</code> 关键字保证了数据的可见性，这使得它在读取密集的场景下表现极佳。在执行写操作时，它仅锁定当前正在操作的哈希桶（即 Node 数组的头节点），而不是整个 Map。这种“局部锁定”的策略允许多个线程同时对不同的哈希桶进行写入。此外，当链表长度超过阈值（默认为 8）且数组容量大于 64 时，链表会转化为红黑树，以保证在高碰撞情况下的查询效率仍能维持在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>。</p><h4 id="copyonwritearraylist"><a class="markdownIt-Anchor" href="#copyonwritearraylist"></a> <code>CopyOnWriteArrayList</code></h4><p><code>CopyOnWriteArrayList</code> 采用了一种极其独特的“写时复制”（Copy-On-Write）策略。它的核心思想是：当你对容器进行修改（添加、删除、设置元素）时，它并不直接修改当前数组，而是先将原数组拷贝一份副本，在副本上完成修改操作，最后再将原数组的引用指向这个新副本。</p><p>这种机制带来了显著的特性：<strong>读操作完全无锁且不阻塞</strong>。当一个线程在遍历列表时，即使有另一个线程正在进行修改，遍历线程看到的依然是修改前的旧数组镜像，因此它天然地解决了并发修改异常（<code>ConcurrentModificationException</code>）。然而，这种设计也存在明显的权衡，即每次修改都会导致数组拷贝，内存开销较大。因此，它仅适用于<strong>读多写极少</strong>且对实时性要求不是极高的场景（例如配置白名单或监听器列表）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写操作示例：内部会加锁并复制数组</span></span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="string">&quot;data&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 读操作示例：直接读取引用，性能极高</span></span><br><span class="line"><span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> list.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h4 id="阻塞队列-blockingqueue-全家桶"><a class="markdownIt-Anchor" href="#阻塞队列-blockingqueue-全家桶"></a> 阻塞队列 <code>BlockingQueue</code> 全家桶</h4><p><code>BlockingQueue</code> 是实现“生产者-消费者”模型的灵魂组件。它与普通队列的区别在于支持<strong>阻塞机制</strong>：当队列为空时，尝试取出的线程会被阻塞直到有数据可用；当队列满时，尝试存入的线程会被阻塞直到队列出现空位。</p><p>JUC 提供了多种不同特性的实现类。<code>ArrayBlockingQueue</code> 基于定长数组，强制要求设置初始容量，适合任务量稳定的系统。<code>LinkedBlockingQueue</code> 基于链表，默认容量为 <code>Integer.MAX_VALUE</code>，如果不设限可能会导致内存溢出。<code>SynchronousQueue</code> 则更为特殊，它不存储任何元素，每一个插入操作必须等待另一个线程的移除操作，是线程间“手递手”传递数据的桥梁。此外，还有支持优先级的 <code>PriorityBlockingQueue</code> 和处理延迟任务的 <code>DelayQueue</code>。这些队列通过内部的 <code>ReentrantLock</code> 和 <code>Condition</code> 机制，优雅地解决了线程间的同步调度问题。</p><h3 id="第八章-死锁"><a class="markdownIt-Anchor" href="#第八章-死锁"></a> 第八章 死锁</h3><p>在多线程环境下，<strong>死锁（Deadlock）</strong> 是最令人头疼的并发问题之一。它发生在两个或多个线程互相持有对方所需的资源，导致所有相关线程都进入无限期的等待状态。</p><h4 id="死锁的四大必要条件"><a class="markdownIt-Anchor" href="#死锁的四大必要条件"></a> 死锁的四大必要条件</h4><p>根据经典操作系统理论，死锁的发生必须同时满足以下四个条件。如果能破坏其中任何一个，死锁就不会发生：</p><ol><li><strong>互斥条件（Mutual Exclusion）</strong>：<br />资源是独占的。在某一时刻，一个资源（如一个对象锁）只能被一个线程持有。如果其他线程请求该资源，必须等待直到持有者释放。</li><li><strong>占有且等待（Hold and Wait）</strong>：<br />一个线程已经持有了至少一个资源，但又提出了新的资源请求，而该资源正被其他线程占有。此时请求线程阻塞，但对自己已获得的资源保持不放。</li><li><strong>不可剥夺（No Preemption）</strong>：<br />线程已获得的资源在未使用完之前，不能被其他线程强行夺走，只能由该线程在完成任务后主动释放。</li><li><strong>循环等待（Circular Wait）</strong>：<br />存在一个线程的资源循环链。例如，线程 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">T1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">1</span></span></span></span> 等待 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">T2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">2</span></span></span></span> 占有的资源，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">T2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">2</span></span></span></span> 等待 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">T3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">3</span></span></span></span> 的资源……最后 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">Tn</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">n</span></span></span></span> 又在等待 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">T1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord">1</span></span></span></span> 占有的资源。</li></ol><p>举个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">lockA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="type">Object</span> <span class="variable">lockB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 t1：先拿 A，再拿 B</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lockA) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125; <span class="comment">// 确保 t2 拿到了 B</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lockB) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1 acquired both locks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 t2：先拿 B，再拿 A</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lockB) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">100</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125; <span class="comment">// 确保 t1 拿到了 A</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lockA) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2 acquired both locks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure><p>在这个例子中，Thread.sleep(100) 是产生死锁的关键催化剂。它保证了 t1 锁住 lockA 的同时，t2 有足够的时间锁住 lockB。此时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">t1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">1</span></span></span></span> 试图获取 lockB 时会因为“互斥”被阻塞，同时它“占有且等待”着 lockA；<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">t2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">2</span></span></span></span> 同理。由于锁是“不可剥夺”的，最终形成了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mn>1</mn><mo>→</mo><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>B</mi><mo>→</mo><mi>t</mi><mn>2</mn><mo>→</mo><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>A</mi><mo>→</mo><mi>t</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">t1 \rightarrow lockB \rightarrow t2 \rightarrow lockA \rightarrow t1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord">1</span></span></span></span> 的循环等待。</p><p><strong>如何排查死锁？</strong><br />当程序突然“卡死”且 CPU 占用率极低时，极有可能是发生了死锁。你可以使用 JDK 自带的工具进行检测：</p><ol><li><strong><code>jcmd / jps</code></strong>：获取运行中的 Java 进程 ID。</li><li><strong><code>jstack &lt;pid&gt;</code></strong>：打印线程堆栈。如果存在死锁，<code>jstack</code> 会在末尾明确提示 <code>Found one Java-level deadlock</code>，并详细列出是哪些线程在哪个对象上互相折磨。</li></ol><p><strong>如何预防死锁？</strong></p><ol><li><strong>固定加锁顺序</strong>（破坏循环等待）：这是最常用的方案。让 <code>t1</code> 和 <code>t2</code> 都按照“先拿 A 再拿 B”的顺序去竞争，这样就不会形成环路。</li><li><strong>尝试性获取锁</strong>（破坏不可剥夺）：使用 <code>ReentrantLock</code> 的 <code>tryLock(long time, TimeUnit unit)</code> 方法。如果线程在规定时间内拿不到下一把锁，就主动释放已经拿到的锁，退回并重试。</li><li><strong>减小锁粒度</strong>：尽量不要在一个同步块中嵌套另一个同步块。</li></ol><h3 id="第九章-thread内存泄漏"><a class="markdownIt-Anchor" href="#第九章-thread内存泄漏"></a> 第九章 Thread内存泄漏</h3><p>在多线程开发中，除了死锁，另一个隐蔽且高发的陷阱是 <strong>ThreadLocal 导致的内存泄漏</strong>。这通常发生在长生命周期的线程（如线程池中的线程）中。</p><h4 id="threadlocal-内存泄漏的根源"><a class="markdownIt-Anchor" href="#threadlocal-内存泄漏的根源"></a> ThreadLocal 内存泄漏的根源</h4><p><code>ThreadLocal</code> 的原理是为每个线程维护一个私有的 <code>ThreadLocalMap</code>。这个 Map 的特殊之处在于它的内部结构：其 <strong>Key（ThreadLocal 实例）是弱引用（WeakReference）</strong>，而 <strong>Value（存储的数据）是强引用</strong>。</p><p>这种设计的初衷是为了保护内存：当外部不再持有 <code>ThreadLocal</code> 实例的强引用时，Key 会在下一次 GC 时被回收，变成 <code>null</code>。然而，问题也就此产生。虽然 Key 消失了，但 <strong>Value 依然被线程的 <code>ThreadLocalMap</code> 以强引用的方式持有</strong>。</p><p>如果这个线程是普通线程，执行完任务就销毁了，那么整个 Map 都会被回收。但现代应用几乎都在使用<strong>线程池</strong>。线程池中的线程是高度复用的，这意味着：</p><ol><li>线程永远不会结束。</li><li><code>ThreadLocalMap</code> 里的那块 Value 内存会一直被占用。</li><li>由于 Key 变成了 <code>null</code>，你再也没有办法通过正常途径访问到这块 Value，它成了一块“幽灵内存”。</li></ol><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalLeakDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;<span class="type">byte</span>[]&gt; localData = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟一个固定大小为 5 的线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            pool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// 每个任务占用 5MB 内存</span></span><br><span class="line">                localData.set(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>]);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 设置了数据&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 注意：这里没有调用 localData.remove()</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上述代码中，虽然任务执行完了，但由于线程池里的线程没死，每个线程持有的 5MB 字节数组会一直驻留在内存中。如果任务不断提交，内存占用会持续攀升，最终导致 <code>OutOfMemoryError</code>。</p><p>使用 <code>jvisualvm</code> 或 <code>MAT</code> (Memory Analyzer Tool) 查看堆转储（Heap Dump）。如果你发现 <code>ThreadLocalMap</code> 里的 <code>Entry</code> 数量异常多，且其 <code>value</code> 字段占用了大量内存，基本可以确定是泄漏。</p><p>在代码中使用 <code>ThreadLocal</code> 时，务必遵循 <code>try-finally</code> 模式，在 <code>finally</code> 块中调用 <code>remove()</code> 方法。这会清除当前线程 Map 中对应的 Entry。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    localData.set(value);</span><br><span class="line">    <span class="comment">// 执行业务逻辑</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 关键：任务结束前一定要清理，尤其是在线程池环境下</span></span><br><span class="line">    localData.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h3 id=&quot;第一章多线程基础&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#第一章多线程基础&quot;&gt;&lt;/a&gt; 第一章：多线程基础&lt;/h3&gt;
&lt;p&gt;在 Java 中，线程（Thread）是操作系统调度的最小</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>MTMCT方向的度量学习梳理</title>
    <link href="https://atffang.github.io/2025/12/21/MTMCT%E6%96%B9%E5%90%91%E7%9A%84%E5%BA%A6%E9%87%8F%E5%AD%A6%E4%B9%A0%E6%A2%B3%E7%90%86/"/>
    <id>https://atffang.github.io/2025/12/21/MTMCT%E6%96%B9%E5%90%91%E7%9A%84%E5%BA%A6%E9%87%8F%E5%AD%A6%E4%B9%A0%E6%A2%B3%E7%90%86/</id>
    <published>2025-12-21T07:11:01.000Z</published>
    <updated>2025-12-21T11:47:16.354Z</updated>
    
    <content type="html"><![CDATA[<p>MTMCT方向的度量学习梳理。</p><span id="more"></span><h3 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h3><p>在以行人重识别（Person Re-Identification, ReID）为代表的一些视觉任务中，测试阶段出现的类别（即具体的行人身份或目标ID）在训练阶段是未知的。这从根本上要求模型具备提取具备强判别力（Discriminative）且高泛化性特征的能力，而非单纯地记忆训练集中的类别标签。</p><p><strong>度量学习，Metric Learning</strong> 正是解决这一核心矛盾的关键技术途径。其本质旨在通过深度神经网络构建一个非线性的<strong>特征映射函数</strong>，将存在于高维像素空间的原始数据投影至低维的<strong>嵌入空间</strong>（Embedding Space）或流形（Manifold）上。在此度量空间中，<strong>距离度量</strong>（如欧氏距离或余弦相似度）直接对应于样本间的语义相似度。</p><p>理想的度量学习模型应当满足两个基本几何约束：</p><ul><li><strong>同类样本在特征空间中高度紧凑</strong>（Intra-class Compactness）</li><li><strong>异类样本在特征空间中尽可能分离</strong>（Inter-class Separability）</li></ul><h4 id="问题定义"><a class="markdownIt-Anchor" href="#问题定义"></a> 问题定义</h4><p>从数学角度形式化地看，度量学习的目标是学习一个参数化的映射函数：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>θ</mi></msub><mo>:</mo><mi mathvariant="script">X</mi><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">f_\theta: \mathcal{X} \rightarrow \mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8991079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">\mathcal{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span></span></span></span> 为输入图像空间，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> 维特征向量空间。</p><p>对于任意给定的三元组样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_a, x_p, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">x_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为锚点样本，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">x_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 为与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">x_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 同一身份的正样本，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">x_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为不同身份的负样本，度量学习旨在优化参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>，使得在映射后的特征空间中满足：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>p</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>≪</mo><mi>D</mi><mo stretchy="false">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(f_\theta(x_a), f_\theta(x_p)) \ll D(f_\theta(x_a), f_\theta(x_n))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo separator="true">,</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(\cdot, \cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span> 为预定义的距离度量函数。</p><h4 id="当前优化的方向"><a class="markdownIt-Anchor" href="#当前优化的方向"></a> 当前优化的方向</h4><p>首先是传统损失函数的优化瓶颈，以最经典的 Softmax 为例，Softmax 交叉熵损失函数虽然在概率空间能够有效区分训练类别，但在特征空间并未施加显式的距离约束，导致学习到的特征在类内分布较为松散。</p><p>具体来说，Softmax 的目标是最大化正确类别的后验概率。在数学上，只要特征向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{f}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 在正确类别权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">w</mi><msub><mi>y</mi><mi>i</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf{w}_{y_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 方向上的投影比在其他类别方向上的投影稍微大一点，Loss 就会减小。也就是说，只要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 被分到了类 A，哪怕它仅仅跨过了决策边界一点点，模型也认为任务完成了。但在度量学习任务中，不仅 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 要被分到类 A，而且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> 必须尽可能靠近类 A 的中心，并且远离类 B。</p><p>其次是<strong>困难样本挖掘</strong>的策略设计。在海量训练数据中，绝大多数样本对包含的梯度信息极其微弱，即模型已能轻易区分大部分不同类别，只有少数位于决策边界附近的<strong>困难样本</strong>对模型的优化具有实质性贡献。如何高效地筛选出这些高价值样本，同时避免因标注噪声导致的模型坍塌，是设计高效度量学习系统的关键。</p><p>此外，特征空间的几何结构选择亦至关重要。早期的研究多基于欧氏空间进行度量，但近年来的研究表明，将特征归一化并约束在超球面上，利用角度距离代替欧氏距离往往更加有效。</p><p>具体来说，在传统的欧氏空间（欧氏距离）中，特征向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">f</mi></mrow><annotation encoding="application/x-tex">\mathbf{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span></span></span></span> 的长度（范数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi mathvariant="bold">f</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|\mathbf{f}\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="mord">∥</span></span></span></span>）代表了模型对该样本的置信度或显著性，在某个方面可以理解为图像的清晰度。在计算欧氏距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="bold">f</mi><mn>1</mn></msub><mo>−</mo><msub><mi mathvariant="bold">f</mi><mn>2</mn></msub><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\| \mathbf{f}_1 - \mathbf{f}_2 \|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.10903em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∥</span></span></span></span> 时，模长的差异会掩盖方向的相似性。模型可能会因为两张图片的“清晰度”相近而认为它们是同一个人。</p><p>而超球面（Hypersphere）的解法：通过归一化，将所有特征映射到模长为 1 的超球面上。模型被迫只通过“方向”来判别身份，消除了图像质量、光照等因素带来的幅值干扰。</p><h3 id="相关工作reid与mtmct方向"><a class="markdownIt-Anchor" href="#相关工作reid与mtmct方向"></a> 相关工作（REID与MTMCT方向）</h3><h4 id="深度度量学习范式"><a class="markdownIt-Anchor" href="#深度度量学习范式"></a> 深度度量学习范式</h4><p><strong>深度度量学习</strong>（Deep Metric Learning, <strong>DML</strong>）旨在通过深度神经网络将语义相似的图像映射到邻近的特征空间。根据优化目标的构建方式，现有的主流方法可大致划分为基于样本对（Pair-based）的方法和基于代理（Proxy-based）的方法两大类。</p><p><strong>基于样本对</strong>的方法直接在样本之间构建约束。早期的开创性工作如 <strong>Siamese Network</strong>（孪生网络）引入了<strong>对比损失</strong>（Contrastive Loss），该方法接受一对样本作为输入，通过拉近正样本对距离并推远负样本对距离来学习特征表示。</p><h5 id="contrastive-loss"><a class="markdownIt-Anchor" href="#contrastive-loss"></a> Contrastive Loss</h5><p>假设有一对输入样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_i, x_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其对应的特征嵌入为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。我们定义这两者在特征空间中的欧氏距离为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi mathvariant="normal">∥</mi><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">)</mo><msub><mi mathvariant="normal">∥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">d_{ij} = \| f(x_i) - f(x_j) \|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>为了区分样本对的关系，定义标签 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">y \in \{0, 1\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">}</span></span></span></span>：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 表示同类样本（Positive Pair）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 表示异类样本（Negative Pair）</li></ul><p>对比损失函数的标准形式如下：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo stretchy="false">(</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo fence="true">[</mo><mi>y</mi><mo>⋅</mo><msubsup><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><mn>0</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(d_{ij}) = \frac{1}{2} \left[ y \cdot d_{ij}^2 + (1 - y) \cdot \max(m - d_{ij}, 0)^2 \right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span></span></p><p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">m &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 是一个预设的阈值（Margin）。</p><p>这个公式不是很好理解，我们拆解<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>的两种情况：</p><ul><li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 时，同类拉近，公式简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\mathcal{L} = \frac{1}{2} d_{ij}^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2398799999999999em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span>。这是一个二次函数，其最小值在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d_{ij}=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 处取得。无论正样本对靠得有多近，损失函数始终施加一个向心的拉力，让他们可以更加靠近。</li><li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> 时（异类推远）公式简化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><mn>0</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\mathcal{L} = \frac{1}{2} \max(m - d_{ij}, 0)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1002159999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>。这是一个分段函数。只有当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&lt;</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">d_{ij} &lt; m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> 时，损失才大于 0。如果两个不同类别的样本离得足够远（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>≥</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">d_{ij} \ge m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>），模型认为它们已经安全，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">Loss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span></span></span></span> 变为 0，不产生任何斥力。如果它们靠得太近（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>&lt;</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">d_{ij} &lt; m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>），损失函数会产生一个斥力，将它们推开，直到距离至少为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span>。</li></ul><h5 id="triplet-loss"><a class="markdownIt-Anchor" href="#triplet-loss"></a> Triplet Loss</h5><p>对比损失是二元的，它孤立地看正对（Positive Pair）或负对（Negative Pair）。其数学局限在于：</p><ul><li>它迫使所有正对的距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 趋近于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></li><li>它迫使所有负对的距离 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 必须大于固定值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span></li></ul><p>FaceNet 提出的<strong>三元组损失</strong>（Triplet Loss）将约束关系扩展至三元组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mi>n</mi><mi>c</mi><mi>h</mi><mi>o</mi><mi>r</mi><mo separator="true">,</mo><mi>P</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo separator="true">,</mo><mi>N</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(Anchor, Positive, Negative)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span>，不再强制要求正负样本对的绝对距离，而是关注它们之间的相对距离差。这种相对约束极大地提升了模型在人脸识别和行人重识别等开集任务中的判别能力，成为该领域的经典基准。</p><p>三元组损失的函数定义为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo><mo>−</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>+</mo><mi>α</mi><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{L} = \max(d(a, p) - d(a, n) + \alpha, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal">L</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span></p><p>在三元组约束下，模型不再局限于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d(a, p) \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>。只要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 比 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 小一个间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> 即可。比如，如果某人的特征本身较分散（例如姿态多变），模型允许其 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 稍大（如 0.5），只要负样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 被推到更远（如 1.0）即可。</p><h4 id="困难样本挖掘策略"><a class="markdownIt-Anchor" href="#困难样本挖掘策略"></a> 困难样本挖掘策略</h4><p>在度量学习的训练过程中，样本的选择策略对模型性能的影响往往大于损失函数本身。由于深度网络具有强大的拟合能力，随着训练的进行，绝大多数随机采样的三元组均满足距离约束，这些无效样本不仅浪费计算资源，还会导致梯度消失，使得模型无法进一步优化决策边界。</p><p>为了解决这一梯度稀疏问题，<strong>困难样本挖掘</strong>（Hard Negative Mining）成为必然选择。经典的挖掘策略倾向于寻找那些使得损失函数值最大的“最难”样本。Hermans 等人在行人重识别任务中系统性地验证了多种采样策略，并提出了 Batch Hard（TriHard）采样方法。</p><p>该方法不再依赖全数据集的离线挖掘，而是动态地在每个训练批次（Batch）内，针对每一个 Anchor 样本，选取距离最远的正样本和距离最近的负样本构建三元组。这种在线（Online）挖掘策略在保证训练稳定性的同时，显著提升了模型对外观相似个体的区分能力，目前已成为 ReID 领域的标准配置。</p><h5 id="batch-hard-trihard"><a class="markdownIt-Anchor" href="#batch-hard-trihard"></a> Batch Hard (TriHard)</h5><p>定义一个 Batch 的构成：随机抽取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> 个身份（ID），每个身份抽取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> 张图片。Batch 总量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>P</mi><mo>×</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">N = P \times K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>。<br />对于 Batch 中的任意一个锚点样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">x_a^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.071664em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.824664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>（属于身份 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span>），TriHard 损失函数的数学表达式为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mrow><mi>B</mi><mi>H</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>P</mi></munderover><munderover><mo>∑</mo><mrow><mi>a</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mrow><mo fence="true">[</mo><mover><mover><mrow><munder><mo><mi>max</mi><mo>⁡</mo></mo><mrow><mi>p</mi><mo>=</mo><mn>1</mn><mo>…</mo><mi>K</mi></mrow></munder><mi>d</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>p</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏞</mo></mover><mtext>最难正样本距离</mtext></mover><mo>−</mo><munder><munder><mrow><munder><mo><mi>min</mi><mo>⁡</mo></mo><mstyle scriptlevel="1"><mtable rowspacing="0.1em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo>=</mo><mn>1</mn><mo>…</mo><mi>P</mi><mo separator="true">,</mo><mi>n</mi><mo>=</mo><mn>1</mn><mo>…</mo><mi>K</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="1" displaystyle="false"><mrow><mi>j</mi><mo mathvariant="normal">≠</mo><mi>i</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></munder><mi>d</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>a</mi><mi>i</mi></msubsup><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>n</mi><mi>j</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mtext>最难负样本距离</mtext></munder><mo>+</mo><mi>α</mi><mo fence="true">]</mo></mrow><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_{BH} = \sum_{i=1}^{P} \sum_{a=1}^{K} \left[ \overbrace{\max_{p=1 \dots K} d(f(x_a^i), f(x_p^i))}^{\text{最难正样本距离}} - \underbrace{\min_{\substack{j=1 \dots P, n=1 \dots K \\ j \neq i}} d(f(x_a^i), f(x_n^j))}_{\text{最难负样本距离}} + \alpha \right]_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal">L</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:6.192007em;vertical-align:-2.937017em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.882887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.267113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2549900000000003em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.1999800000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-2.79598em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.39198em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.9879800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.0139700000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-5.25499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.2009950000000003em;"><span style="top:-3.5226640000000002em;"><span class="pstrut" style="height:3.5226640000000002em;"></span><span class="mord mover"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5226640000000002em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.43055999999999994em;"><span style="top:-2.3556690000000002em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="minner mtight">…</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.880439em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.874664em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span class="svg-align" style="top:-3.974664em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M6 548l-6-6v-35l6-11c56-104 135.3-181.3 238-232 57.3-28.7 117-45 179-50h399577v120H403c-43.3 7-81 15-113 26-100.7 33-179.7 91-237 174-2.7 5-6 9-10 13-.7 1-7.3 1-20 1H6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M200428 334c-100.7-8.3-195.3-44-280-108-55.3-42-101.7-93-139-153l-9-14c-2.7 4-5.7 8.7-9 14-53.3 86.7-123.7 153-211 199-66.7 36-137.3 56.3-212 62H0V214h199568c178.3-11.7 311.7-78.3 403-201 6-8 9.7-12 11-12 .7-.7 6.7-1 18-1s17.3.3 18 1c1.3 0 5 4 11 12 44.7 59.3 101.3 106.3 170 141s145.3 54.3 229 60h199572v120z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M400000 542l-6 6h-17c-12.7 0-19.3-.3-20-1-4-4-7.3-8.3-10-13-35.3-51.3-80.8-93.8-136.5-127.5s-117.2-55.8-184.5-66.5c-.7 0-2-.3-4-1-18.7-2.7-76-4.3-172-5H0V214h399571l6 1c124.7 8 235 61.7 331 161 31.3 33.3 59.7 72.7 85 118l7 13v35z'/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.880439em;"><span></span></span></span></span></span></span><span style="top:-5.245328000000001em;"><span class="pstrut" style="height:3.5226640000000002em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">最难正样本距离</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.880439em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746640000000001em;"><span style="top:-0.171014em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">最难负样本距离</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746640000000001em;"><span class="svg-align" style="top:-0.849345em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6678600000000001em;"><span style="top:-2.0406725000000003em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.133325em;"><span style="top:-3.149995em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="minner mtight">…</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span><span class="minner mtight">…</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span><span style="top:-2.261115em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel mtight"></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6333249999999999em;"><span></span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5026549999999999em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8746639999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.150655em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.828986em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2549900000000003em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.1999800000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-2.79598em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.39198em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.9879800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.0139700000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-5.25499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-2.470355em;"><span style="top:0.17868599999999982em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.937017em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>我们在之前一篇文章中详细解释了这一方法，其核心概念为类内差异的最大化，和类间距离的最小化。</p><ul><li><strong>最大化类内差异</strong>（Max-Pooling in Positives）：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>max</mi><mo>⁡</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\max d(a, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span> 找到了当前 ID 下分布最散的样本。这是在优化该类别的半径，强制将离群点（Outliers）拉回中心。</li><li><strong>最小化类间距离</strong>（Min-Pooling in Negatives）：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\min d(a, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 找到了距离当前类别最近的异类。这是在探测决策边界。只有通过推开这些“最近邻”的异类，才能在特征空间中腾出足够的缓冲区。</li></ul><h3 id="序列深度度量学习方法"><a class="markdownIt-Anchor" href="#序列深度度量学习方法"></a> 序列深度度量学习方法</h3><h4 id="集合空间的映射形式化"><a class="markdownIt-Anchor" href="#集合空间的映射形式化"></a> 集合空间的映射形式化</h4><p>在基于序列的度量学习中，输入对象不再是单一的样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">x \in \mathcal{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span></span></span></span>，而是一个包含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 帧图像的序列集合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">S</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{S} = \{x_1, x_2, \dots, x_T\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 为变量。</p><p>数学上，我们的目标是学习一个非线性映射函数</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo>:</mo><msup><mi mathvariant="script">X</mi><mi>T</mi></msup><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\Phi: \mathcal{X}^T \rightarrow \mathbb{R}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Φ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14643em;">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8991079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></p><p>将高维的图像序列张量投影为低维的固定长度嵌入向量。<br />这一映射过程必须满足两个关键的数学性质：</p><ul><li><strong>置换不变性</strong>（Permutation Invariance）： 对于集合模型而言，特征表示不应受输入帧顺序的影响（除非显式建模动作信息），即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Phi(x_1, x_2) = \Phi(x_2, x_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li><li><strong>尺寸不变性</strong>（Size Invariance）： 无论输入序列长度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> 是 5 帧还是 50 帧，输出特征向量的维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span></span></span></span> 必须恒定。为此，序列度量学习通常采用“<strong>编码-聚合</strong>”（Encode-Aggregate）的二阶段数学范式：首先通过 CNN 骨干网络 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">f_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 将每一帧映射为帧级特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>t</mi></msub><mo>=</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">v_t = f_\theta(x_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，随后通过时序聚合函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span> 生成最终的序列表征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">e</mi><mo>=</mo><mi>G</mi><mo stretchy="false">(</mo><mo stretchy="false">{</mo><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>v</mi><mi>T</mi></msub><mo stretchy="false">}</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{e} = G(\{v_1, \dots, v_T\})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">e</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span><span class="mclose">)</span></span></span></span>。</li></ul><h4 id="基于注意力的时序聚合机制"><a class="markdownIt-Anchor" href="#基于注意力的时序聚合机制"></a> 基于注意力的时序聚合机制</h4><p>最朴素的聚合函数是<strong>时间平均池化</strong>（Temporal Average Pooling, TAP），即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><mo>∑</mo><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">G_{avg} = \frac{1}{T}\sum v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。然而，从信息论角度看，序列中的每一帧所含有的“身份信息量”是不均匀的（例如，遮挡帧的信息熵极高，包含大量噪声）。</p><p>为了最大化特征信噪比，现代方法（Quality Aware Network for Set to Set Recognition）引入了**注意力机制（Attention Mechanism）**作为一种可学习的加权算子。</p><p>数学上，这等价于学习一个评分函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(v_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，用于估计第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span> 帧的特征质量。加权聚合过程定义为：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">e</mi><mrow><mi>a</mi><mi>t</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msub><mi>α</mi><mi>t</mi></msub><mo>⋅</mo><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{e}_{att} = \sum_{t=1}^{T} \alpha_t \cdot v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">e</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0954490000000003em;vertical-align:-1.267113em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.882887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.267113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 需满足概率单纯形约束（Sum-to-one），通常通过 Softmax 函数获得：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>α</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi>T</mi></msup><mi>tanh</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">W</mi><mi>a</mi></msub><msub><mi>v</mi><mi>t</mi></msub><mo>+</mo><msub><mi mathvariant="bold">b</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>τ</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi>T</mi></msup><mi>tanh</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">W</mi><mi>a</mi></msub><msub><mi>v</mi><mi>τ</mi></msub><mo>+</mo><msub><mi mathvariant="bold">b</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha_t = \frac{\exp(\mathbf{w}^T \tanh(\mathbf{W}_a v_t + \mathbf{b}_a))}{\sum_{\tau=1}^{T} \exp(\mathbf{w}^T \tanh(\mathbf{W}_a v_\tau + \mathbf{b}_a))}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.689272em;vertical-align:-1.170941em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.128769em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.767331em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">tanh</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">tanh</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.170941em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>此处，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">W</mi><mi>a</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">b</mi><mi>a</mi></msub><mo separator="true">,</mo><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{W}_a, \mathbf{b}_a, \mathbf{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span></span></span></span> 均为参与反向传播优化的参数。该数学结构迫使模型在特征空间中自动进行“去噪”，梯度下降过程会抑制那些与身份主向量正交的噪声分量的权重。</p><h4 id="集合间距离度量与优化目标"><a class="markdownIt-Anchor" href="#集合间距离度量与优化目标"></a> 集合间距离度量与优化目标</h4><p>定义了序列特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><mi mathvariant="script">S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Phi(\mathcal{S})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="mclose">)</span></span></span></span> 后，核心问题在于如何定义两个集合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{S}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">S</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{S}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 之间的度量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D(\mathcal{S}_i, \mathcal{S}_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><ul><li><strong>聚合嵌入距离</strong>（Aggregated Embedding Distance）：最直接的方法是在聚合后的特征向量上计算欧氏距离：</li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>D</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">∥</mi><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>−</mo><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo><msub><mi mathvariant="normal">∥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D(\mathcal{S}_i, \mathcal{S}_j) = \| \Phi(\mathcal{S}_i) - \Phi(\mathcal{S}_j) \|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>这种方法计算效率最高，且完全兼容标准的 Triplet Loss。<br /></br></p><ul><li><strong>最小点集距离</strong>（Minimum Set Distance）：为了解决聚合带来的信息平滑问题，可以保留帧级特征，定义两个集合的距离为“最佳匹配帧”之间的距离：</li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munder><mo><mi>min</mi><mo>⁡</mo></mo><mrow><msub><mi>v</mi><mi>n</mi></msub><mo>∈</mo><msub><mi mathvariant="script">S</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>m</mi></msub><mo>∈</mo><msub><mi mathvariant="script">S</mi><mi>j</mi></msub></mrow></munder><mi mathvariant="normal">∥</mi><msub><mi>v</mi><mi>n</mi></msub><mo>−</mo><msub><mi>v</mi><mi>m</mi></msub><msub><mi mathvariant="normal">∥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">D_{min}(\mathcal{S}_i, \mathcal{S}_j) = \min_{v_n \in \mathcal{S}_i, v_m \in \mathcal{S}_j} \| v_n - v_m \|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.691651em;vertical-align:-0.941651em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.66786em;"><span style="top:-2.355669em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.075em;">S</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.941651em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>这种非参数化的度量方式在数学上允许序列在局部进行对齐，对于处理视角剧烈变化（如从正面逐渐转到背面）的序列具有更强的几何解释性。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;MTMCT方向的度量学习梳理。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>实验室安全检测系统2</title>
    <link href="https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/"/>
    <id>https://atffang.github.io/2025/11/13/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F2/</id>
    <published>2025-11-13T12:41:07.000Z</published>
    <updated>2025-11-13T12:50:07.437Z</updated>
    
    <content type="html"><![CDATA[<p>花了一个下午的时间修改了一下项目结构，简单记录一下</p><span id="more"></span><p>上次介绍了一下参与的一个横向中的一个模块，最近花了一点时间梳理了一下结构，简单记录一下。功能并没有增加，还是比较简单的。</p><h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3><img src="https://atffang.github.io/2025/11/13/实验室安全检测系统2/结构.png"/><p>系统由三个功能层组成：</p><ul><li><strong>infra</strong>：基础功能层，包括config（配置加载）、logging（日志打印）、messagequeues（消息队列）</li><li><strong>data</strong>：负责数据部分功能，主要包括frameprocessor（视频流相关）、database（minio与postgresql数据库的增删改查接口）。连接的psql数据库和minio由docker实现。</li><li><strong>core</strong>：核心业务层，包括prepocess（负责加载识别模型加载前需要预加载的数据）、modelloader（加载识别模型，定义识别方法（pridict）、输出识别结果、postprocess（后处理，主要为每日数据迁移任务））</li></ul><h4 id="1-infra"><a class="markdownIt-Anchor" href="#1-infra"></a> 1. infra</h4><h5 id="11-config"><a class="markdownIt-Anchor" href="#11-config"></a> 1.1 config</h5><p>读取根目录下的<code>config.yaml</code>文件，提供加载各类配置的接口，<code>config</code>文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -------- 数据库配置 --------</span></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5434</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">&quot;labcamera&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- MinIO配置 --------</span></span><br><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">&quot;localhost:9000&quot;</span></span><br><span class="line">  <span class="attr">access_key:</span> <span class="string">&quot;minioadmin&quot;</span></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">&quot;minioadmin&quot;</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">&quot;detection-results&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 事件映射表 --------</span></span><br><span class="line"><span class="attr">event:</span></span><br><span class="line">  <span class="attr">event_dict:</span></span><br><span class="line">    <span class="attr">coat:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">nightsingle:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">channeloccupancy:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 模型参数配置 --------</span></span><br><span class="line"><span class="attr">model:</span></span><br><span class="line">  <span class="attr">coatdetecter:</span> <span class="string">&quot;coatdetecter.json&quot;</span></span><br><span class="line">  <span class="attr">nightsingledetecter:</span> <span class="string">&quot;nightsingledetecter.json&quot;</span></span><br><span class="line">  <span class="attr">channeloccupancydetecter:</span> <span class="string">&quot;channeloccupancydetecter.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 监控流配置 --------</span></span><br><span class="line"><span class="attr">rtsp:</span></span><br><span class="line">  <span class="attr">server_ip:</span> <span class="string">&quot;***.***.***.***&quot;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">  <span class="attr">channel_num:</span> <span class="number">256</span></span><br><span class="line">  <span class="attr">stream_type:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- 启动时间配置 --------</span></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="attr">&quot;main_program&quot;:</span></span><br><span class="line">    <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;05:00&quot;</span></span><br><span class="line">    <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">  <span class="attr">&quot;summary_program&quot;:</span></span><br><span class="line">    <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">    <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;05:00&quot;</span></span><br></pre></td></tr></table></figure><h5 id="12-logging"><a class="markdownIt-Anchor" href="#12-logging"></a> 1.2 logging</h5><p>日志模块</p><h5 id="13-messagequeues"><a class="markdownIt-Anchor" href="#13-messagequeues"></a> 1.3 messagequeues</h5><p>消息队列模块，首先在<code>PhotoMessage.py</code>中定义了两个类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoMessage</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    表示视频流处理管线中的单帧消息对象。  </span></span><br><span class="line"><span class="string">    用于封装单帧图像及其关联的上下文信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    属性说明：</span></span><br><span class="line"><span class="string">        photo_id (str): 帧的唯一标识符（默认使用 UUID 自动生成）。</span></span><br><span class="line"><span class="string">        camera_id (str): 摄像头设备编号或标识。</span></span><br><span class="line"><span class="string">        room_id (str): 拍摄帧所在的物理位置或房间标识。</span></span><br><span class="line"><span class="string">        photo_path (Path): 帧图像文件的路径或内存引用。</span></span><br><span class="line"><span class="string">        timestamp (datetime): 帧捕获的时间戳（若未提供则自动生成）。</span></span><br><span class="line"><span class="string">        metadata (Dict[str, Any]): 附加的处理上下文信息。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    camera_id: <span class="built_in">str</span></span><br><span class="line">    room_id: <span class="built_in">str</span></span><br><span class="line">    photo_path: Path</span><br><span class="line">    task_id: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    photo_id: <span class="built_in">str</span> = field(default_factory=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    timestamp: datetime = field(default_factory=datetime.now)</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DetectionResult</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    表示单帧图像检测（识别）结果的数据结构。  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    属性说明：</span></span><br><span class="line"><span class="string">        ifwarning (bool): 是否触发告警（True 表示异常或警告）。</span></span><br><span class="line"><span class="string">        image (Optional[Image.Image]): 检测后的处理图像或标注结果。</span></span><br><span class="line"><span class="string">        description (str): 检测结果的文本描述信息。</span></span><br><span class="line"><span class="string">        timestamp (Optional[datetime]): 检测结果生成的时间戳。</span></span><br><span class="line"><span class="string">        task_id (int): 关联的任务标识符。</span></span><br><span class="line"><span class="string">        room_id (str): 检测帧所在的物理房间标识。</span></span><br><span class="line"><span class="string">        camera_id (str): 对应的摄像头编号。</span></span><br><span class="line"><span class="string">        alarm_category (str): 告警类型或类别（默认值为 &#x27;unknow&#x27;）。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ifwarning: <span class="built_in">bool</span> = <span class="literal">False</span>, image: <span class="type">Optional</span>[Image.Image] = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                 description: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, timestamp: <span class="type">Optional</span>[datetime] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 task_id: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 room_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, camera_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>, alarm_category: <span class="built_in">str</span> = <span class="string">&quot;unknow&quot;</span></span>):</span><br><span class="line">        ifwarning = ifwarning</span><br><span class="line">        self.image = image</span><br><span class="line">        self.description = description</span><br><span class="line">        self.timestamp = timestamp</span><br><span class="line">        self.room_id = room_id</span><br><span class="line">        self.camera_id = camera_id</span><br><span class="line">        self.alarm_category = alarm_category</span><br><span class="line">        self.task_id = task_id</span><br></pre></td></tr></table></figure><p>并在<code>MessageQueue.py</code>中定义了一个全局消息队列<code>GlobalMessageQueue()</code>，用于存放<code>PhotoMessage</code>，并确保其线程安全。并实现：</p><ul><li><code>put_message(self, msg: PhotoMessage) -&gt; bool</code></li><li><code>get_message(self) -&gt; Optional[PhotoMessage]</code></li><li><code>persist_messages(self, file_path: Path) -&gt; int</code></li><li><code>load_messages(self, file_path: Path) -&gt; int</code></li><li>……</li></ul><p>等方法。</p><h4 id="2data"><a class="markdownIt-Anchor" href="#2data"></a> 2.Data</h4><h5 id="21-frameprocessor"><a class="markdownIt-Anchor" href="#21-frameprocessor"></a> 2.1 frameprocessor</h5><p>负责视频流处理。首先在<code>rtsp_client.py</code>中定义了实现：</p><ul><li>登录视频服务器获取 Token</li><li>定时保活</li><li>注册播放通道</li><li>获取指定摄像头的 RTSP URL</li><li>登出释放 Token</li></ul><p>功能的RTSPClient 类，并定义了其线程实现<code>RTSPServiceThread(threading.Thread)</code>，该线程启动后运行逻辑为：</p><ul><li>登录并注册播放通道</li><li>循环执行 keep_alive 保活</li><li>异常处理后自动登出</li></ul><p>随后在<code>get_rtsp.py</code>定义了<code>CaptureThread(threading.Thread)</code>的摄像头抓帧线程，管理 RTSP 流保活和帧捕获。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CaptureThread</span>(threading.Thread):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    摄像头抓帧线程，管理 RTSP 流保活和帧捕获。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        rtsp_config (dict): RTSP 配置</span></span><br><span class="line"><span class="string">        rtsp_thread (RTSPServiceThread): RTSP 服务线程</span></span><br><span class="line"><span class="string">        db_conn: 数据库连接对象</span></span><br><span class="line"><span class="string">        running (bool): 线程运行状态</span></span><br><span class="line"><span class="string">        camera_list (List[Dict[str, Any]]): 当前任务摄像头列表</span></span><br><span class="line"><span class="string">        wait_rtsp (int): 两次摄像头抓帧间隔（秒）</span></span><br><span class="line"><span class="string">        round_rtsp (int): 每轮抓帧最小总间隔（秒）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(daemon=<span class="literal">True</span>)</span><br><span class="line">        self.rtsp_config = RTSP_CONFIG</span><br><span class="line">        self.rtsp_thread = RTSPServiceThread(RTSP_CONFIG)</span><br><span class="line">        self.db_conn = <span class="literal">None</span></span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.camera_list: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = []</span><br><span class="line">        self.wait_rtsp = <span class="number">1</span></span><br><span class="line">        self.round_rtsp = <span class="number">600</span></span><br></pre></td></tr></table></figure><p>线程主逻辑：</p><ul><li>启动 RTSP 服务线程（自动保活）</li><li>连接数据库获取摄像头列表</li><li>循环抓取摄像头单帧图像并发送到消息队列</li></ul><h5 id="22-database"><a class="markdownIt-Anchor" href="#22-database"></a> 2.2 database</h5><p>database模块基于分层式架构模式（entity、repository、service三层）</p><ul><li>entity：实体层，定义了数据库中各个表对应的实体类，如<code>Camera</code>、<code>Results</code>、<code>ResultsTemp</code>。</li><li>repository：数据访问层，负责与数据库进行交互，提供数据持久化和检索功能，如<code>CameraRepository</code>、<code>ResultsRepository</code>、<code>ResultsTempRepository</code>。</li><li>service：业务逻辑层，负责处理业务逻辑，如<code>CameraService</code>、<code>ResultsMigrationService</code>、<code>ResultsNightService</code>、<code>ResultsTempSaverService</code>，这部分负责提供数据库部分的各个接口，给其他组件调用，实现解耦。</li></ul><p>我们以数据暂存为例，其需求是每次检测完成后，暂存数据到t_results_temp表中，因此，我们需要先定义一个<strong>ResultsTemp</strong>的Entity：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ResultsEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;t_results&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    task_id = Column(String(<span class="number">100</span>))</span><br><span class="line">    event_id = Column(Integer)</span><br><span class="line">    description = Column(Text)</span><br><span class="line">    time1 = Column(TIMESTAMP)</span><br><span class="line">    time2 = Column(TIMESTAMP)</span><br><span class="line">    picture1 = Column(String(<span class="number">255</span>))</span><br><span class="line">    picture2 = Column(String(<span class="number">255</span>))</span><br><span class="line">    picture3 = Column(String(<span class="number">255</span>))</span><br></pre></td></tr></table></figure><p>随后，定义一层数据访问层<strong>ResultsTempRepository</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> entity.ResultsTemp <span class="keyword">import</span> ResultsTempEntity</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResultsTempRepository</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, session: Session</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert</span>(<span class="params">self, entity: ResultsTempEntity</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_all</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_by_task</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_by_event_and_date</span>(<span class="params">self, event_ids, date_str</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_batch</span>(<span class="params">self, records</span>):</span><br></pre></td></tr></table></figure><p>最后，定义一个Service：<strong>ResultsTempSaverService</strong> 来提供服务接口：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataSaverService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Service 层：处理检测结果保存（数据库 + MinIO 上传）&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_detection_result</span>(<span class="params">self, result: DetectionResult</span>):</span><br></pre></td></tr></table></figure><p>那么，在其他组件中调用<code>save_detection_result</code>即可。</p><h4 id="3-core"><a class="markdownIt-Anchor" href="#3-core"></a> 3. Core</h4><h5 id="31-preprocess"><a class="markdownIt-Anchor" href="#31-preprocess"></a> 3.1 preprocess</h5><p>里面放一些预处理函数，比如从数据库下载通道范围。然后我们在<code>detect.py</code>中在启动识别线程前调用即可。比如说我在<code>detect.py</code>里面调用的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.preprocess <span class="keyword">import</span> LoadChannelRange</span><br><span class="line"><span class="comment"># 首先下载摄像头范围数据</span></span><br><span class="line">LoadChannelRange.save()</span><br></pre></td></tr></table></figure><h5 id="32-modelloader"><a class="markdownIt-Anchor" href="#32-modelloader"></a> 3.2 modelloader</h5><p><strong>重点</strong></p><p>modeller部分负责加载模型，并实现识别功能。<br />对于一个识别功能模块，首先，我们需要在modelloader/config中添加一个配置json文件，比如：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;coatdetecter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yolo11s&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pt&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core/modelloader/model/yolo11s.pt&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mobilenet_v2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;weight_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core/modelloader/model/coat_classifier_final.pth&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>并将其添加到根目录下的<code>config.yaml</code>文件中的 模型参数配置 部分。<br />并且按照&quot;weight_path&quot;的路径正确将权重模型存放在相应的路径。</p><p>随后，我们在在modelloader/functionmodel定义一个模型识别类，我在这个路径下的<code>base_detector.py</code>提供了一个抽象类:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseDetector</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Detector 示例模板</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    子类必须实现 load 方法，返回 predict 函数：</span></span><br><span class="line"><span class="string">        predict(message: PhotoMessage, image_input: np.ndarray) -&gt; Optional[DetectionResult]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    predict 函数必须：</span></span><br><span class="line"><span class="string">    1. 接受 PhotoMessage 和 np.ndarray（BGR 图像）</span></span><br><span class="line"><span class="string">    2. 返回 DetectionResult 或 None</span></span><br><span class="line"><span class="string">    3. 对图像操作应使用 copy()，避免并行冲突</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">model_pipeline: <span class="built_in">list</span>, device</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化模型，返回 predict 函数。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> 在这里实现你的模型初始化逻辑</span></span><br><span class="line">        <span class="comment"># 初始化逻辑示例：</span></span><br><span class="line">        <span class="comment"># parent_dir = Path(__file__).resolve().parents[3]</span></span><br><span class="line">        <span class="comment"># yolo_path = parent_dir / model_pipeline[0][&quot;weight_path&quot;]</span></span><br><span class="line">        <span class="comment"># yolo_model = YOLO(yolo_path).to(device)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">message: PhotoMessage, image_input: np.ndarray</span>) -&gt; <span class="type">Optional</span>[DetectionResult]:</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            对输入图像执行检测，返回 DetectionResult 或 None。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> 在这里实现你的检测逻辑</span></span><br><span class="line">            image = image_input.copy()</span><br><span class="line">            <span class="comment"># 检测逻辑示例：</span></span><br><span class="line">            <span class="comment"># for box in detected_boxes:</span></span><br><span class="line">            <span class="comment">#     crop = image[...]</span></span><br><span class="line">            <span class="comment">#     pred = classify(crop)</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果有异常情况,则构造并返回DetectionResult：</span></span><br><span class="line">            <span class="comment"># return DetectionResult(...)</span></span><br><span class="line">            <span class="comment"># 如果没有异常情况，返回None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> predict</span><br></pre></td></tr></table></figure><p>基于这个抽象类的要求，实现一个具体的识别类，比如我在<code>coat_detector.py</code>中实现了一个<code>CoatDetector(BaseDetector)</code>类。</p><p>同时，在<code>modelloader.py</code>中，提供了一个工厂类<code>ModelLoader</code>，用于加载模型，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelLoader</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    模型加载工厂类，统一根据模型名称返回预测函数。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    MODEL_MAP: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Callable</span>[[<span class="type">Any</span>, torch.device], <span class="type">Any</span>]] = &#123;</span><br><span class="line">        <span class="string">&quot;coatdetecter&quot;</span>: CoatDetector.load,</span><br><span class="line">        <span class="string">&quot;nightsingledetecter&quot;</span>: NightSingleDetector.load,</span><br><span class="line">        <span class="string">&quot;channeloccupancydetecter&quot;</span>: ChannelOccupancyDetector.load</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loader</span>(<span class="params">model_name: <span class="built_in">str</span>, model_pipeline: <span class="type">Any</span>, device: torch.device</span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据模型名称加载对应的检测模型，并返回预测函数。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            model_name (str): 模型名称，如 &quot;coatdetecter&quot;。</span></span><br><span class="line"><span class="string">            model_pipeline (Any): 模型权重路径或配置列表。</span></span><br><span class="line"><span class="string">            device (torch.device): 模型运行设备。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Callable: 用于执行预测的函数，输入为 image/message，输出 DetectionResult。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Raises:</span></span><br><span class="line"><span class="string">            ValueError: 如果模型名称不在支持列表中。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            load_func = ModelLoader.MODEL_MAP[model_name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Model &#x27;<span class="subst">&#123;model_name&#125;</span>&#x27; is not supported.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> load_func(model_pipeline, device)</span><br></pre></td></tr></table></figure><p>为了加载刚刚的模型，我们把模型名字和模型类.load函数加载在<code>MODEL_MAP</code>中</p><p>再同时，在<code>modelloader.py</code>中，还提供了一个<code>IdentificationModel</code>类，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IdentificationModel</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        self.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">        self.name = config[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        self.pipeline = config[<span class="string">&quot;pipeline&quot;</span>]</span><br><span class="line">        self.predict = self._loadmodel()</span><br></pre></td></tr></table></figure><p>这个<code>IdentificationModel</code>类，调用了工厂类<code>ModelLoader</code>的<code>loader</code>方法，将模型加载到<code>predict</code>中，然后我们就可以直接调用实例化后的<code>IdentificationModel</code>类的<code>predict</code>方法进行识别了。这里其实逻辑比较混乱，读者完全可以将这两个类合并。</p><p>了解完这些后，我们最终定义一个消费者线程类，该类首先基于config文件，初始化一个<code>IdentificationModel</code>实例列表，然后对于<code>messagequeue</code>中的每个<code>PhotoMessage</code>，遍历调用每个<code>IdentificationModel</code>实例的<code>pridict()</code>方法进行识别，并调用<code>data.service</code>暴露的存储接口进行存储。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoConsumer</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_list: <span class="type">List</span>[<span class="built_in">dict</span>], poll_interval: <span class="built_in">float</span> = <span class="number">1</span>, max_workers: <span class="built_in">int</span> = <span class="number">4</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        多线程消费者：从 global_mq 获取消息，读取图片，执行模型推理，并删除图片。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param config_list: 一组 config 字典（每个配置一个模型）</span></span><br><span class="line"><span class="string">        :param poll_interval: 轮询间隔秒数</span></span><br><span class="line"><span class="string">        :param max_workers: 并发处理的最大线程数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(daemon=<span class="literal">True</span>)</span><br><span class="line">        self.poll_interval = poll_interval</span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.db = DataSaver()</span><br><span class="line">        self.executor = ThreadPoolExecutor(max_workers=max_workers)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化模型列表</span></span><br><span class="line">        self.modellist = [IdentificationModel(config) <span class="keyword">for</span> config <span class="keyword">in</span> config_list]</span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> self.modellist:</span><br><span class="line">            logger.info(model)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="string">&quot;&quot;&quot;停止线程并关闭线程池&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;主线程循环获取消息并交由线程池处理&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, message: PhotoMessage</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理单条消息的识别与存储&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>最后定义一个<code>start_photo_consumer_concurrent()</code>函数用于启动模型消费者，有detect.py调用，其中，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer = PhotoConsumer(config_list, max_workers=<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>其中，<code>max_workers</code>为启用的消费者线程数</p><h5 id="33-postprocess"><a class="markdownIt-Anchor" href="#33-postprocess"></a> 3.3 postprocess</h5><p>里面放一天的识别结束后的操作，比如说将识别结果数据梳理后从t_results_temp表迁移到t_results表，并删除t_results_temp表中的数据。preprocess和postprocess里面的操作大多数被封装为了data.database.service里面的服务接口，只要调用就行了。值得关注的是，preprocess在<code>detect.py</code>中被调用，而postprocess在<code>main.py</code>中被调用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.postprocess.migration_runner <span class="keyword">import</span> DailyMigrationTask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 归纳程序控制</span></span><br><span class="line">summary_start = str_to_time(config[<span class="string">&quot;summary_program&quot;</span>][<span class="string">&quot;start&quot;</span>])</span><br><span class="line">summary_end = str_to_time(config[<span class="string">&quot;summary_program&quot;</span>][<span class="string">&quot;end&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> in_time_range(summary_start, summary_end, now):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> started_summary:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] 启动归纳程序&quot;</span>)</span><br><span class="line">        task = DailyMigrationTask()</span><br><span class="line">        task.run()</span><br><span class="line">        started_summary = <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> started_summary <span class="keyword">and</span> summary_proc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] 关闭归纳程序&quot;</span>)</span><br><span class="line">        started_summary = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">60</span>)</span><br></pre></td></tr></table></figure><h3 id="架构"><a class="markdownIt-Anchor" href="#架构"></a> 架构</h3><img src="https://atffang.github.io/2025/11/13/实验室安全检测系统2/架构.png"/>现在没有设计多GPU，也暂时没有必要。]]></content>
    
    
    <summary type="html">&lt;p&gt;花了一个下午的时间修改了一下项目结构，简单记录一下&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>DeepSort (SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC)</title>
    <link href="https://atffang.github.io/2025/11/12/deepsort/"/>
    <id>https://atffang.github.io/2025/11/12/deepsort/</id>
    <published>2025-11-12T05:23:19.000Z</published>
    <updated>2025-12-21T11:18:38.514Z</updated>
    
    <content type="html"><![CDATA[<p>梳理摄像头行人追踪经典论文SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC中的方法。</p><span id="more"></span><h3 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h3><p>Simple Online and Realtime Tracking (SORT) is a pragmatic approach to multiple object tracking with a focus on simple, effective algorithms. In this paper, we integrate appearance information to improve the performance of SORT. Due to this extension we are able to track objects through longer periods of occlusions, effectively reducing the number of identity switches. In spirit of the original framework we place much of the computational complexity into an offline pre-training stage where we learn a deep association metric on a largescale person re-identification dataset. During online application, we establish measurement-to-track associations using nearest neighbor queries in visual appearance space. Experimental evaluation shows that our extensions reduce the number of identity switches by 45%, achieving overall competitive performance at high frame rates.</p><h3 id="方法解读"><a class="markdownIt-Anchor" href="#方法解读"></a> 方法解读</h3><img src="https://atffang.github.io/2025/11/12/deepsort/deepsort.png"/>]]></content>
    
    
    <summary type="html">&lt;p&gt;梳理摄像头行人追踪经典论文SIMPLE ONLINE AND REALTIME TRACKING WITH A DEEP ASSOCIATION METRIC中的方法。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Features for Multi-Target Multi-Camera Tracking and Re-Identification</title>
    <link href="https://atffang.github.io/2025/11/11/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBFMTMCRI/"/>
    <id>https://atffang.github.io/2025/11/11/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBFMTMCRI/</id>
    <published>2025-11-11T03:33:07.000Z</published>
    <updated>2025-12-21T11:17:05.615Z</updated>
    
    <content type="html"><![CDATA[<p>梳理MTMC问题经典论文Features for Multi-Target Multi-Camera Tracking and Re-Identification中的方法。</p><span id="more"></span><h3 id="abstract"><a class="markdownIt-Anchor" href="#abstract"></a> Abstract</h3><p>Multi-Target Multi-Camera Tracking (MTMCT) tracks many people through video taken from several cameras. Person Re-Identification (Re-ID) retrieves from a gallery images of people similar to a person query image. We learn good features for both MTMCT and Re-ID with a convolutional neural network. Our contributions include an adaptive weighted triplet loss for training and a new technique for hard-identity mining. Our method outperforms the state of the art both on the DukeMTMC benchmarks for tracking, and on the Market-1501 and DukeMTMC-ReID benchmarks for Re-ID. We examine the correlation between good Re-ID and good MTMCT scores, and perform ablation studies to elucidate the contributions of the main components of our system.</p><h3 id="方法解读"><a class="markdownIt-Anchor" href="#方法解读"></a> 方法解读</h3><img src="https://atffang.github.io/2025/11/11/论文精读FMTMCRI/FMTMCRI.png"/>]]></content>
    
    
    <summary type="html">&lt;p&gt;梳理MTMC问题经典论文Features for Multi-Target Multi-Camera Tracking and Re-Identification中的方法。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>基于三维模型的监控画面模拟与深度标定工具开发</title>
    <link href="https://atffang.github.io/2025/11/05/%E5%9F%BA%E4%BA%8E%E4%B8%89%E7%BB%B4%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9B%91%E6%8E%A7%E7%94%BB%E9%9D%A2%E6%A8%A1%E6%8B%9F%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%A0%87%E5%AE%9A%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/"/>
    <id>https://atffang.github.io/2025/11/05/%E5%9F%BA%E4%BA%8E%E4%B8%89%E7%BB%B4%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9B%91%E6%8E%A7%E7%94%BB%E9%9D%A2%E6%A8%A1%E6%8B%9F%E4%B8%8E%E6%B7%B1%E5%BA%A6%E6%A0%87%E5%AE%9A%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/</id>
    <published>2025-11-05T11:07:07.000Z</published>
    <updated>2025-11-05T11:42:30.444Z</updated>
    
    <content type="html"><![CDATA[<p>基于三维模型的监控画面模拟与深度标定工具开发。基于Vue + vite + electron + cesium的桌面端软件。</p><span id="more"></span><p>最近做的方向有这样一个需求：计算研究区域的众多监控摄像头画面对应的深度图，即能够得到画面上像素点对应的真实世界坐标。因此，开发了一款基于Electron+Vue的，依赖Cesium可视化研究区域三维模型（3dtiles）的桌面端软件Oculus，并模拟监控画面与视锥，以此做到真实画面与三维模型匹配，从而得到真实画面深度。</p><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/操作过程.gif"/><p>Oculus的主页面如下：<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/主页.jpg"/></p><p>通过查询并点击右侧的摄像头信息滚动栏或者点击左侧地图中的摄像头图标，可以索引到该摄像头的位置，并在地图右上角弹出具体信息，软件右上角出现摄像头画面。</p><p>继续点击右侧栏的相应摄像头编辑按钮，打开编辑窗口如下。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/视锥画面.png"/></p><p>左侧为摄像头基础参数编辑区域，包括经纬度与高程，航向角、俯仰角，垂直视场角，宽高比，远近平面距离。修改后，右侧视锥也会随着参数变化实时渲染。</p><p>点击切换为监控视角，即可观察到模拟监控视角画面，通过调整参数，达到和监控画面几乎一样的视域，同时，为了辅助对比，真实画面与模拟画面相应的位置存在五个辅助锚定点。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/模拟画面.png"/></p><p>在调整好参数后，可以点击生成稀疏深度按钮，软件将选取画面上2000个点，计算其真实的三维坐标，并下载，同时下载的还有真实摄像头画面。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/深度标定.png"/></p><p>为了检测生成的点是否正确，我们将其倒入cesium中，同时加载和上文相同的三维模型，效果如下：<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/标定点01.png"/></p><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/标定点02.png"/><p>这样的效果证明，我们标定的坐标基本上是正确的，后续可以通过高程筛选z值，或者通过分布筛选，以选取符合目的的点。<br /><img src="https://atffang.github.io/2025/11/05/基于三维模型的监控画面模拟与深度标定工具开发/z值区间.png"/></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;基于三维模型的监控画面模拟与深度标定工具开发。基于Vue + vite + electron + cesium的桌面端软件。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Datahader.Networks 绘制bundling flow</title>
    <link href="https://atffang.github.io/2025/11/01/Datahader.Networks%20%E7%BB%98%E5%88%B6bundling%20flow/"/>
    <id>https://atffang.github.io/2025/11/01/Datahader.Networks%20%E7%BB%98%E5%88%B6bundling%20flow/</id>
    <published>2025-11-01T11:16:07.000Z</published>
    <updated>2025-11-05T11:00:19.610Z</updated>
    
    <content type="html"><![CDATA[<p>Datahader.Networks 绘制bundling flow</p><span id="more"></span><p>详细文档参见 <a href="https://datashader.org/user_guide/Networks.html">https://datashader.org/user_guide/Networks.html</a></p><p>我们曾经介绍了绘制普通流的方式，实际上仅仅是基于贝塞尔曲线做了插值，绘制了类似于“飞机航线”的流线。使用简单的arcgis插件，也可以绘制很不错直观的流图，比如下面我画的中国人口流动图：<br /><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/中国人口流动.png"/></p><p>但是这种流绘制方式虽然最为直观、表达最为准确，但有时候（特别是边权差异不大的时候）像进了盘丝洞，从图上无法提炼出太多的信息，因此，甲方要求我对小红书上一个博主绘制的具有聚集效应的流图进行复现，我先试了js库d3:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">generateSegments</span>(<span class="params">nodes, links</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> bundle = &#123; <span class="attr">nodes</span>: [], <span class="attr">links</span>: [], <span class="attr">paths</span>: [] &#125;;</span><br><span class="line">  bundle.<span class="property">nodes</span> = nodes.<span class="title function_">map</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123; d.<span class="property">fx</span> = d.<span class="property">x</span>; d.<span class="property">fy</span> = d.<span class="property">y</span>; <span class="keyword">return</span> d; &#125;);</span><br><span class="line"></span><br><span class="line">  links.<span class="title function_">forEach</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> length = <span class="title function_">distance</span>(d.<span class="property">source</span>, d.<span class="property">target</span>);</span><br><span class="line">    <span class="keyword">let</span> total = <span class="title class_">Math</span>.<span class="title function_">round</span>(scales.<span class="title function_">segments</span>(length));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> xscale = d3.<span class="title function_">scaleLinear</span>().<span class="title function_">domain</span>([<span class="number">0</span>, total + <span class="number">1</span>]).<span class="title function_">range</span>([d.<span class="property">source</span>.<span class="property">x</span>, d.<span class="property">target</span>.<span class="property">x</span>]);</span><br><span class="line">    <span class="keyword">let</span> yscale = d3.<span class="title function_">scaleLinear</span>().<span class="title function_">domain</span>([<span class="number">0</span>, total + <span class="number">1</span>]).<span class="title function_">range</span>([d.<span class="property">source</span>.<span class="property">y</span>, d.<span class="property">target</span>.<span class="property">y</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> source = d.<span class="property">source</span>;</span><br><span class="line">    <span class="keyword">let</span> local = [source];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">1</span>; j &lt;= total; j++) &#123;</span><br><span class="line">      <span class="keyword">let</span> target = &#123; <span class="attr">x</span>: <span class="title function_">xscale</span>(j), <span class="attr">y</span>: <span class="title function_">yscale</span>(j) &#125;;</span><br><span class="line">      local.<span class="title function_">push</span>(target);</span><br><span class="line">      bundle.<span class="property">nodes</span>.<span class="title function_">push</span>(target);</span><br><span class="line">      bundle.<span class="property">links</span>.<span class="title function_">push</span>(&#123; source, target &#125;);</span><br><span class="line">      source = target;</span><br><span class="line">    &#125;</span><br><span class="line">    local.<span class="title function_">push</span>(d.<span class="property">target</span>);</span><br><span class="line">    bundle.<span class="property">links</span>.<span class="title function_">push</span>(&#123; source, <span class="attr">target</span>: d.<span class="property">target</span> &#125;);</span><br><span class="line">    bundle.<span class="property">paths</span>.<span class="title function_">push</span>(local);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> bundle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大概实现了下面的场景：<br /><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/js.png"/></p><p>不过这种绘制方法仍然无法达到类似的效果，遂抛弃之，找到了该博主处理流数据的库：<strong>datashader</strong>，接下来我们详细讲讲如何利用datashader.Networks进行绘制，先看看user guide中对该部分的简介：</p><p>The point and line-segment plotting provided by Datashader can be put together in different ways to visualize specific types of data. For instance, network graph data, i.e., networks of nodes connected by edges, can very naturally be represented by points and lines. Here we will show examples of using Datashader’s graph-specific plotting tools, focusing on how to visualize very large graphs while allowing any portion of the rendering pipeline to replaced with components suitable for specific problems.</p><p>Datashader 使用 <strong>Hammer et al. (2009)</strong> 提出的 “Force-Directed Edge Bundling (FDEB)” 算法的改进版，让相似或空间上邻近的边“靠拢”成平滑的流线（bundles），既保持结构关系，又提升可读性。</p><p>具体来说，对于每条边，他们会被拆分为多个小段（segments），每个 segment 是一个可移动的控制点。每个控制点会受到几种力的作用：</p><ul><li><ol><li><strong>内部张力 (Tension)</strong></li></ol></li><li><ol start="2"><li><strong>相似边吸引力 (Attractive force)</strong></li></ol></li><li><ol start="3"><li><strong>带宽控制 (Bandwidth)</strong></li></ol></li></ul><p>通过多次迭代，方法使得带宽逐次变小，使得流互相靠近，形成束状结构。</p><p>我们来复现一下user guide提供的示例代码<br />导入包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datashader <span class="keyword">as</span> ds</span><br><span class="line"><span class="keyword">import</span> datashader.transfer_functions <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> datashader.layout <span class="keyword">import</span> random_layout, circular_layout, forceatlas2_layout</span><br><span class="line"><span class="keyword">from</span> datashader.bundling <span class="keyword">import</span> connect_edges, hammer_bundle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br></pre></td></tr></table></figure><p>随机生成边与节点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">np.random.seed(<span class="number">0</span>)</span><br><span class="line">n=<span class="number">100</span></span><br><span class="line">m=<span class="number">20000</span></span><br><span class="line"></span><br><span class="line">nodes = pd.DataFrame([<span class="string">&quot;node&quot;</span>+<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)], columns=[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">edges = pd.DataFrame(np.random.randint(<span class="number">0</span>,<span class="built_in">len</span>(nodes), size=(m, <span class="number">2</span>)), columns=[<span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;target&#x27;</span>])</span><br><span class="line"></span><br><span class="line">circular = circular_layout(nodes, uniform=<span class="literal">False</span>)</span><br><span class="line">randomloc = random_layout(nodes)</span><br></pre></td></tr></table></figure><p>生成布局与定义一些绘制函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cvsopts = <span class="built_in">dict</span>(plot_height=<span class="number">400</span>, plot_width=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nodesplot</span>(<span class="params">nodes, name=<span class="literal">None</span>, canvas=<span class="literal">None</span>, cat=<span class="literal">None</span></span>):</span><br><span class="line">    canvas = ds.Canvas(**cvsopts) <span class="keyword">if</span> canvas <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> canvas</span><br><span class="line">    aggregator=<span class="literal">None</span> <span class="keyword">if</span> cat <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> ds.count_cat(cat)</span><br><span class="line">    agg=canvas.points(nodes,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,aggregator)</span><br><span class="line">    <span class="keyword">return</span> tf.spread(tf.shade(agg, cmap=[<span class="string">&quot;#FF3333&quot;</span>]), px=<span class="number">3</span>, name=name)</span><br><span class="line">    </span><br><span class="line">forcedirected = forceatlas2_layout(nodes, edges)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edgesplot</span>(<span class="params">edges, name=<span class="literal">None</span>, canvas=<span class="literal">None</span></span>):</span><br><span class="line">    canvas = ds.Canvas(**cvsopts) <span class="keyword">if</span> canvas <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> canvas</span><br><span class="line">    <span class="keyword">return</span> tf.shade(canvas.line(edges, <span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>, agg=ds.count()), name=name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">graphplot</span>(<span class="params">nodes, edges, name=<span class="string">&quot;&quot;</span>, canvas=<span class="literal">None</span>, cat=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> canvas <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        xr = nodes.x.<span class="built_in">min</span>(), nodes.x.<span class="built_in">max</span>()</span><br><span class="line">        yr = nodes.y.<span class="built_in">min</span>(), nodes.y.<span class="built_in">max</span>()</span><br><span class="line">        canvas = ds.Canvas(x_range=xr, y_range=yr, **cvsopts)</span><br><span class="line"></span><br><span class="line">    np = nodesplot(nodes, name + <span class="string">&quot; nodes&quot;</span>, canvas, cat)</span><br><span class="line">    ep = edgesplot(edges, name + <span class="string">&quot; edges&quot;</span>, canvas)</span><br><span class="line">    <span class="keyword">return</span> tf.stack(ep, np, how=<span class="string">&quot;over&quot;</span>, name=name)</span><br></pre></td></tr></table></figure><p>绘制：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd = circular</span><br><span class="line">fd = forcedirected</span><br><span class="line"></span><br><span class="line">cd_d = graphplot(cd, connect_edges(cd,edges), <span class="string">&quot;Circular layout&quot;</span>)</span><br><span class="line">fd_d = graphplot(fd, connect_edges(fd,edges), <span class="string">&quot;Force-directed&quot;</span>)</span><br><span class="line">cd_b = graphplot(cd, hammer_bundle(cd,edges), <span class="string">&quot;Circular layout, bundled&quot;</span>)</span><br><span class="line">fd_b = graphplot(fd, hammer_bundle(fd,edges), <span class="string">&quot;Force-directed, bundled&quot;</span>)</span><br><span class="line"></span><br><span class="line">tf.Images(cd_d,fd_d,cd_b,fd_b).cols(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/exam.png"/><p>还是挺方便的。接下来我们使用自己的数据进行绘制。必要的数据包括node（包含name与xy坐标）和edge（包含代表od的source和target，可自行选择是否加上weight）。<br />导入包：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> datashader.bundling <span class="keyword">import</span> hammer_bundle</span><br><span class="line"><span class="keyword">import</span> pyproj</span><br><span class="line"><span class="keyword">import</span> geopandas <span class="keyword">as</span> gpd</span><br><span class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> LineString</span><br></pre></td></tr></table></figure><p>加载数据，并映射一下字段名到其要求的值，并且投影坐标以绘制。这里有一个非常坑的要点：<br /><strong>node 的 index（pandas.dataframe的index）才是和 edge 的 source 与 target 匹配的 key ，而不是 name 字段。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">china_edge = pd.read_csv(<span class="string">&quot;/Users/fangtianyao/Desktop/其他/flowdata/edge_1.csv&quot;</span>)</span><br><span class="line">china_node = pd.read_csv(<span class="string">&quot;/Users/fangtianyao/Desktop/其他/flowdata/node_with_name.csv&quot;</span>)</span><br><span class="line">nodes = china_node[[<span class="string">&#x27;iata&#x27;</span>, <span class="string">&#x27;longitude&#x27;</span>, <span class="string">&#x27;latitude&#x27;</span>]].rename(</span><br><span class="line">    columns=&#123;<span class="string">&#x27;iata&#x27;</span>: <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;longitude&#x27;</span>: <span class="string">&#x27;x84&#x27;</span>, <span class="string">&#x27;latitude&#x27;</span>: <span class="string">&#x27;y84&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line">edges = china_edge[[<span class="string">&#x27;origin&#x27;</span>, <span class="string">&#x27;destination&#x27;</span>, <span class="string">&#x27;count&#x27;</span>]].rename(</span><br><span class="line">    columns=&#123;<span class="string">&#x27;origin&#x27;</span>: <span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;destination&#x27;</span>: <span class="string">&#x27;target&#x27;</span>, <span class="string">&#x27;count&#x27;</span>: <span class="string">&#x27;weight&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">proj = pyproj.Transformer.from_crs(<span class="string">&quot;EPSG:4326&quot;</span>, <span class="string">&quot;EPSG:3857&quot;</span>, always_xy=<span class="literal">True</span>)</span><br><span class="line">nodes[<span class="string">&#x27;x&#x27;</span>], nodes[<span class="string">&#x27;y&#x27;</span>] = proj.transform(nodes[<span class="string">&#x27;x84&#x27;</span>], nodes[<span class="string">&#x27;y84&#x27;</span>])</span><br><span class="line">layout = nodes.copy()</span><br><span class="line">layout.index = layout[<span class="string">&#x27;name&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">layout.index.name = <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>调用<code>hammer_bundle</code>计算：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundled_edges = hammer_bundle(layout, edges, decay=decay, initial_bandwidth=bw)</span><br></pre></td></tr></table></figure><p>这里的 <code>decay</code> 和 <code>bw</code> 是两个0-1的参数，这里我们先分别取0.5。</p><p>计算得到的 <code>bundled_edges </code> 是一个包含所有扭曲过后的边的所有构成点的df，每条边的点之间用一个空行相隔。打印给你看看。</p><table><thead><tr><th></th><th>x</th><th>y</th><th>weight</th></tr></thead><tbody><tr><td>1301138</td><td>1.257390e+07</td><td>2.951534e+06</td><td>7.0</td></tr><tr><td>1301139</td><td>1.258085e+07</td><td>2.914048e+06</td><td>7.0</td></tr><tr><td>1301140</td><td>1.258971e+07</td><td>2.877599e+06</td><td>7.0</td></tr><tr><td>1301141</td><td>1.264494e+07</td><td>2.852891e+06</td><td>7.0</td></tr><tr><td>1301142</td><td>NaN</td><td>NaN</td><td>NaN</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>为了绘制，我们使用该数据创建 GeoDataFrame：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lines = []</span><br><span class="line">current_points = []</span><br><span class="line">current_weight = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx, row <span class="keyword">in</span> bundled_edges.iterrows():</span><br><span class="line">    <span class="keyword">if</span> pd.isna(row[<span class="string">&#x27;x&#x27;</span>]) <span class="keyword">or</span> pd.isna(row[<span class="string">&#x27;y&#x27;</span>]):</span><br><span class="line">        <span class="comment"># 遇到空行，生成上一条边</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(current_points) &gt;= <span class="number">2</span>:</span><br><span class="line">            line = LineString(current_points)</span><br><span class="line">            lines.append(&#123;<span class="string">&#x27;weight&#x27;</span>: current_weight, <span class="string">&#x27;geometry&#x27;</span>: line&#125;)</span><br><span class="line">        current_points = []</span><br><span class="line">        current_weight = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        current_points.append((row[<span class="string">&#x27;x&#x27;</span>], row[<span class="string">&#x27;y&#x27;</span>]))</span><br><span class="line">        <span class="comment"># 假设 weight 相同，取第一个点的 weight</span></span><br><span class="line">        <span class="keyword">if</span> current_weight <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            current_weight = row[<span class="string">&#x27;weight&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(current_points) &gt;= <span class="number">2</span>:</span><br><span class="line">    line = LineString(current_points)</span><br><span class="line">    lines.append(&#123;<span class="string">&#x27;weight&#x27;</span>: current_weight, <span class="string">&#x27;geometry&#x27;</span>: line&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 GeoDataFrame</span></span><br><span class="line">gdf = gpd.GeoDataFrame(lines, crs=<span class="string">&quot;EPSG:3857&quot;</span>)</span><br></pre></td></tr></table></figure><p>我们用这个数据绘制流在地图上：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> geopandas <span class="keyword">as</span> gpd</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> Point</span><br><span class="line"><span class="keyword">import</span> contextily <span class="keyword">as</span> ctx</span><br><span class="line"></span><br><span class="line">nodes_gdf = gpd.GeoDataFrame(</span><br><span class="line">    nodes,</span><br><span class="line">    geometry=[Point(xy) <span class="keyword">for</span> xy <span class="keyword">in</span> <span class="built_in">zip</span>(nodes[<span class="string">&#x27;x&#x27;</span>], nodes[<span class="string">&#x27;y&#x27;</span>])],</span><br><span class="line">    crs=<span class="string">&quot;EPSG:3857&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">edges_gdf = gdf.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算线宽</span></span><br><span class="line">min_width = <span class="number">0.2</span></span><br><span class="line">max_width = <span class="number">5.0</span></span><br><span class="line">weights = edges_gdf[<span class="string">&#x27;weight&#x27;</span>].astype(<span class="built_in">float</span>)</span><br><span class="line">line_widths = min_width + (weights - weights.<span class="built_in">min</span>()) / (weights.<span class="built_in">max</span>() - weights.<span class="built_in">min</span>()) * (max_width - min_width)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘图</span></span><br><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">10</span>), dpi=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 画边</span></span><br><span class="line">edges_gdf.plot(ax=ax, linewidth=line_widths, edgecolor=<span class="string">&#x27;#305669&#x27;</span>, alpha=<span class="number">0.6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 画节点</span></span><br><span class="line">nodes_gdf.plot(ax=ax, color=<span class="string">&#x27;#0C2B4E&#x27;</span>, markersize=<span class="number">15</span>, alpha=<span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加底图</span></span><br><span class="line">ctx.add_basemap(ax, source=ctx.providers.OpenStreetMap.Mapnik, crs=nodes_gdf.crs)</span><br><span class="line"></span><br><span class="line">ax.set_title(<span class="string">&quot;fty&quot;</span>, fontsize=<span class="number">16</span>)</span><br><span class="line">ax.set_xlabel(<span class="string">&quot;Longitude&quot;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&quot;Latitude&quot;</span>)</span><br><span class="line">plt.axis(<span class="string">&#x27;equal&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/part.png"/><p>为了比较不同 <code>decay</code> 和 <code>bw</code> 参数组合的效果，我做了一个小组合测试，读者可以自己进行测试，亦可以参考下user guide里面基于随机数据做的测试。<br /><img src="https://atffang.github.io/2025/11/01/Datahader.Networks 绘制bundling flow/final.png"/></p><p>还是不错的吧😌</p><p>最后给出封装好的函数，该函数用于对空间网络数据执行基于 Hammer 算法 的边捆绑（Edge Bundling）操作，以减少边的视觉交叉并增强整体结构的空间可读性。<br />输入参数<br />•edge_path (str)：边数据文件路径，要求为 CSV 格式，包含源节点、目标节点及权重等字段。<br />•node_path (str)：节点数据文件路径，要求为 CSV 格式，包含节点唯一标识及经纬度坐标字段。<br />•nodes_id_col (str)：节点文件中表示节点唯一编号的列名，默认 “node_id” <strong>务必是int类型！！！</strong>。<br />•node_lon_col (str)：节点经度列名，默认 “lon”。<br />•node_lat_col (str)：节点纬度列名，默认 “lat”。<br />•edge_source_col (str)：边文件中表示起点节点的列名，默认 “source” 和上面的node_id匹配，<strong>务必是int类型！！！</strong>。<br />•edge_target_col (str)：边文件中表示终点节点的列名，默认 “target” 和上面的node_id匹配，<strong>务必是int类型！！！</strong>。<br />•weight_col (str)：边文件中表示权重（如流量、强度）的列名，默认 “weight”。<br />•decay (float)：Hammer 算法的衰减参数，控制边的收敛速度（0–1之间）。<br />•bw (float)：初始带宽参数，控制捆绑的紧密程度（0–1之间）。<br />•input_crs (str)：输入数据的坐标参考系，默认 “EPSG:4326”（WGS84）。<br />•output (bool)：是否输出文件，默认 True。<br />•output_format (Literal[“geojson”, “shp”])：输出文件格式，默认 “geojson”。<br />•output_path (Optional[str])：输出文件保存路径，若为 None，则仅返回结果不保存。<br />输出结果<br />•返回值 (geopandas.GeoDataFrame)：<br />函数返回一个包含边捆绑后几何结果的 GeoDataFrame，其属性包括原始边的全部字段及对应的空间几何 (LineString)。结果的坐标参考系为 “EPSG:4326”，可直接用于 GIS 可视化或空间分析。<br />若设置 output=True，则函数还会在指定路径下导出相应的 GeoJSON 或 Shapefile 文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> geopandas <span class="keyword">as</span> gpd</span><br><span class="line"><span class="keyword">import</span> pyproj</span><br><span class="line"><span class="keyword">from</span> datashader.bundling <span class="keyword">import</span> hammer_bundle</span><br><span class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> LineString</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">import</span> copy</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">perform_edge_bundling</span><span class="params">(</span></span><br><span class="line"><span class="params">    edge_path: str,</span></span><br><span class="line"><span class="params">    node_path: str,</span></span><br><span class="line"><span class="params">    nodes_id_col: str = <span class="string">&quot;node_id&quot;</span>,</span></span><br><span class="line"><span class="params">    node_lon_col: str = <span class="string">&quot;lon&quot;</span>,</span></span><br><span class="line"><span class="params">    node_lat_col: str = <span class="string">&quot;lat&quot;</span>,</span></span><br><span class="line"><span class="params">    edge_source_col: str = <span class="string">&quot;source&quot;</span>,</span></span><br><span class="line"><span class="params">    edge_target_col: str = <span class="string">&quot;target&quot;</span>,</span></span><br><span class="line"><span class="params">    weight_col: str = <span class="string">&quot;weight&quot;</span>,</span></span><br><span class="line"><span class="params">    decay: <span class="type">float</span> = <span class="number">0.5</span>,</span></span><br><span class="line"><span class="params">    bw: <span class="type">float</span> = <span class="number">0.5</span>,</span></span><br><span class="line"><span class="params">    input_crs: str = <span class="string">&quot;EPSG:4326&quot;</span>,</span></span><br><span class="line"><span class="params">    output: bool = True,</span></span><br><span class="line"><span class="params">    output_format: Literal[<span class="string">&quot;geojson&quot;</span>, <span class="string">&quot;shp&quot;</span>] = <span class="string">&quot;geojson&quot;</span>,</span></span><br><span class="line"><span class="params">    output_path: Optional[str] = None,</span></span><br><span class="line"><span class="params">)</span> -&gt; gpd.GeoDataFrame:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Perform force-directed edge bundling using the Hammer algorithm</span></span><br><span class="line"><span class="string">    on spatial graph data, and export the result as a geospatial file.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    edge_path : str</span></span><br><span class="line"><span class="string">        Path to the CSV file containing edge data.</span></span><br><span class="line"><span class="string">    node_path : str</span></span><br><span class="line"><span class="string">        Path to the CSV file containing node data.</span></span><br><span class="line"><span class="string">    nodes_id_col : str, default &quot;node_id&quot;</span></span><br><span class="line"><span class="string">        Column name for node identifiers in the node CSV.</span></span><br><span class="line"><span class="string">    node_lon_col : str, default &quot;lon&quot;</span></span><br><span class="line"><span class="string">        Column name for node longitude.</span></span><br><span class="line"><span class="string">    node_lat_col : str, default &quot;lat&quot;</span></span><br><span class="line"><span class="string">        Column name for node latitude.</span></span><br><span class="line"><span class="string">    edge_source_col : str, default &quot;source&quot;</span></span><br><span class="line"><span class="string">        Column name for edge source node ID.</span></span><br><span class="line"><span class="string">    edge_target_col : str, default &quot;target&quot;</span></span><br><span class="line"><span class="string">        Column name for edge target node ID.</span></span><br><span class="line"><span class="string">    weight_col : str, default &quot;weight&quot;</span></span><br><span class="line"><span class="string">        Column name for edge weights.</span></span><br><span class="line"><span class="string">    decay : float, default 0.5</span></span><br><span class="line"><span class="string">        Decay parameter of the hammer_bundle algorithm (0 &lt; decay &lt; 1).</span></span><br><span class="line"><span class="string">    bw : float, default 0.5</span></span><br><span class="line"><span class="string">        Initial bandwidth parameter of hammer_bundle (controls bundle tightness).</span></span><br><span class="line"><span class="string">    input_crs : str, default &quot;EPSG:4326&quot;</span></span><br><span class="line"><span class="string">        Coordinate reference system (CRS) of the input node coordinates.</span></span><br><span class="line"><span class="string">        Usually &quot;EPSG:4326&quot; for WGS84 or &quot;EPSG:3857&quot; for Web Mercator.</span></span><br><span class="line"><span class="string">    output : bool, default True</span></span><br><span class="line"><span class="string">        Whether to save the output file.</span></span><br><span class="line"><span class="string">    output_format : &#123;&quot;geojson&quot;, &quot;shp&quot;&#125;, default &quot;geojson&quot;</span></span><br><span class="line"><span class="string">        Desired output file format.</span></span><br><span class="line"><span class="string">    output_path : str, optional</span></span><br><span class="line"><span class="string">        Path to save the output file. If None, the file will not be written.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    gdf : geopandas.GeoDataFrame</span></span><br><span class="line"><span class="string">        GeoDataFrame containing bundled edge geometries and their weights,</span></span><br><span class="line"><span class="string">        projected in WGS84 (EPSG:4326).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises</span></span><br><span class="line"><span class="string">    ------</span></span><br><span class="line"><span class="string">    FileNotFoundError</span></span><br><span class="line"><span class="string">        If either `edge_path` or `node_path` does not exist.</span></span><br><span class="line"><span class="string">    ValueError</span></span><br><span class="line"><span class="string">        If required columns are missing in the provided CSVs.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[1/6] 读取节点与边文件...&quot;</span>)</span><br><span class="line">    edges = pd.read_csv(edge_path)</span><br><span class="line">    edges_copy = copy.deepcopy(edges)</span><br><span class="line">    nodes = pd.read_csv(node_path)</span><br><span class="line"></span><br><span class="line">    print(f<span class="string">&quot;节点数: &#123;len(nodes)&#125;, 边数: &#123;len(edges)&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[2/6] 检查输入字段有效性...&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> col in [nodes_id_col, node_lon_col, node_lat_col]:</span><br><span class="line">        <span class="keyword">if</span> col not in nodes.columns:</span><br><span class="line">            raise <span class="title function_">ValueError</span><span class="params">(f<span class="string">&quot;Missing required column &#x27;&#123;col&#125;&#x27; in node file.&quot;</span>)</span></span><br><span class="line">    <span class="keyword">for</span> col in [edge_source_col, edge_target_col, weight_col]:</span><br><span class="line">        <span class="keyword">if</span> col not in edges.columns:</span><br><span class="line">            raise <span class="title function_">ValueError</span><span class="params">(f<span class="string">&quot;Missing required column &#x27;&#123;col&#125;&#x27; in edge file.&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    edges = edges[[edge_source_col, edge_target_col, weight_col]].rename(</span><br><span class="line">        columns=&#123;edge_source_col: <span class="string">&#x27;source&#x27;</span>, edge_target_col: <span class="string">&#x27;target&#x27;</span>, weight_col: <span class="string">&#x27;weight&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    nodes = nodes[[nodes_id_col, node_lon_col, node_lat_col]]</span><br><span class="line"></span><br><span class="line">    edges[<span class="string">&quot;source&quot;</span>] = edges[<span class="string">&quot;source&quot;</span>].astype(<span class="type">int</span>)</span><br><span class="line">    edges[<span class="string">&quot;target&quot;</span>] = edges[<span class="string">&quot;target&quot;</span>].astype(<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[3/6] 坐标转换为 EPSG:3857 ...&quot;</span>)</span><br><span class="line">    proj_to_3857 = pyproj.Transformer.from_crs(input_crs, <span class="string">&quot;EPSG:3857&quot;</span>, always_xy=True)</span><br><span class="line">    nodes[<span class="string">&quot;x&quot;</span>], nodes[<span class="string">&quot;y&quot;</span>] = proj_to_3857.transform(nodes[node_lon_col], nodes[node_lat_col])</span><br><span class="line"></span><br><span class="line">    layout = nodes.rename(columns=&#123;nodes_id_col: <span class="string">&quot;name&quot;</span>&#125;)[[<span class="string">&quot;name&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>]]</span><br><span class="line">    layout.index = layout[<span class="string">&quot;name&quot;</span>].astype(<span class="type">int</span>)</span><br><span class="line">    layout.index.name = None</span><br><span class="line"></span><br><span class="line">    <span class="title function_">print</span><span class="params">(<span class="string">&quot;[4/6] 执行 Hammer 边捆绑算法 ...&quot;</span>)</span></span><br><span class="line">    bundled = hammer_bundle(layout, edges, decay=decay, initial_bandwidth=bw)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;[5/6] 构造捆绑线段 ...&quot;</span>)</span><br><span class="line">    lines = []</span><br><span class="line">    current_points = []</span><br><span class="line">    edge_index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, row in bundled.iterrows():</span><br><span class="line">        <span class="keyword">if</span> pd.isna(row[<span class="string">&quot;x&quot;</span>]) or pd.isna(row[<span class="string">&quot;y&quot;</span>]):</span><br><span class="line">            <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(current_points)</span> &gt;= <span class="number">2</span> and edge_index &lt; len(edges_copy):</span><br><span class="line">                edge_attrs = edges_copy.iloc[edge_index].to_dict()</span><br><span class="line">                edge_attrs[<span class="string">&quot;geometry&quot;</span>] = LineString(current_points)</span><br><span class="line">                lines.append(edge_attrs)</span><br><span class="line">            current_points = []</span><br><span class="line">            edge_index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            current_points.append((row[<span class="string">&quot;x&quot;</span>], row[<span class="string">&quot;y&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(current_points)</span> &gt;= <span class="number">2</span> and edge_index &lt; len(edges_copy):</span><br><span class="line">        edge_attrs = edges_copy.iloc[edge_index].to_dict()</span><br><span class="line">        edge_attrs[<span class="string">&quot;geometry&quot;</span>] = LineString(current_points)</span><br><span class="line">        lines.append(edge_attrs)</span><br><span class="line"></span><br><span class="line">    gdf = gpd.GeoDataFrame(lines, crs=<span class="string">&quot;EPSG:3857&quot;</span>)</span><br><span class="line">    gdf = gdf.to_crs(<span class="string">&quot;EPSG:4326&quot;</span>)</span><br><span class="line"></span><br><span class="line">    print(f<span class="string">&quot;生成 GeoDataFrame，共 &#123;len(gdf)&#125; 条边。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> output:</span><br><span class="line">        print(<span class="string">&quot;[6/6] 输出结果文件&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> output_path:</span><br><span class="line">            <span class="keyword">if</span> output_format == <span class="string">&quot;geojson&quot;</span>:</span><br><span class="line">                gdf.to_file(output_path, driver=<span class="string">&quot;GeoJSON&quot;</span>)</span><br><span class="line">            elif output_format == <span class="string">&quot;shp&quot;</span>:</span><br><span class="line">                gdf.to_file(output_path, driver=<span class="string">&quot;ESRI Shapefile&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                raise <span class="title function_">ValueError</span><span class="params">(<span class="string">&quot;Unsupported output format. Use &#x27;geojson&#x27; or &#x27;shp&#x27;.&quot;</span>)</span></span><br><span class="line">            </span><br><span class="line">            print(f<span class="string">&quot;文件已保存至: &#123;output_path&#125;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;未提供输出路径，未保存文件。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> gdf</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Datahader.Networks 绘制bundling flow&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>obsidain基于s3的多端同步</title>
    <link href="https://atffang.github.io/2025/10/18/obsidain%E5%9F%BA%E4%BA%8Es3%E7%9A%84%E5%A4%9A%E7%AB%AF%E5%90%8C%E6%AD%A5/"/>
    <id>https://atffang.github.io/2025/10/18/obsidain%E5%9F%BA%E4%BA%8Es3%E7%9A%84%E5%A4%9A%E7%AB%AF%E5%90%8C%E6%AD%A5/</id>
    <published>2025-10-18T13:44:05.000Z</published>
    <updated>2025-10-19T00:50:11.759Z</updated>
    
    <content type="html"><![CDATA[<p>obsidain基于s3的多端同步。</p><span id="more"></span><p>安利大家一个obsidian非常好用的插件 <strong>Remotely save</strong> ，他可以基于多个云服务厂商，比如 onedrive 与 google drvie 进行多端同步，就不需要买obsidian自己的云服务了。不过我在使用学校邮箱的onedrive进行验证的时候出现了一些问题导致无法继续，不得已使用最基础的s3服务。</p><p>首先，在obsidian的第三方库仓库中下载Remotely save，查看其设置，在第一个选择远程选项中可以选择多种云存储的方式，由于我使用自己的云服务器进行存储与同步，选择第一项S3或兼容S3的服务。</p><p>存储位置我使用了之前99一年买的阿里云挂壁大学生服务器，阿里对大学生没得说，从服务器到大模型token额度，都对学生开放了优惠甚至部分免费的福利。</p><p>在linux云服务器上安装minio，开放9000端口，并新建bucket，保存ID和Key，将上述信息填入Remotely save的，包括服务地址（<a href="http://xxx.xxx.xxx.xxx:9000">http://xxx.xxx.xxx.xxx:9000</a>），区域（填us-east-1就ok），Access Key ID，Secret Access Key，Bucket name，点击检查测试连接即可。</p><p>点击Remotely save的刷新按钮，即可便捷的上传或下拉这个仓库了，超级方便，并且可以在选项中设置打开自动更新，关闭自动更新和每隔一段时间自动更新。</p><img src="https://atffang.github.io/2025/10/18/obsidain基于s3的多端同步/多端同步.jpg"/>]]></content>
    
    
    <summary type="html">&lt;p&gt;obsidain基于s3的多端同步。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>基于AIS数据进行船舶轨迹分段合成的一点思路</title>
    <link href="https://atffang.github.io/2025/08/29/%E5%9F%BA%E4%BA%8EAIS%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%88%B9%E8%88%B6%E8%BD%A8%E8%BF%B9%E5%88%86%E6%AE%B5%E5%90%88%E6%88%90%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%B7%AF/"/>
    <id>https://atffang.github.io/2025/08/29/%E5%9F%BA%E4%BA%8EAIS%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%88%B9%E8%88%B6%E8%BD%A8%E8%BF%B9%E5%88%86%E6%AE%B5%E5%90%88%E6%88%90%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%B7%AF/</id>
    <published>2025-08-29T02:33:07.000Z</published>
    <updated>2025-09-01T04:57:47.052Z</updated>
    
    <content type="html"><![CDATA[<p>介绍一下本科毕设里关于基于AIS数据进行船舶轨迹合成部分的一点思路，非专业，仅分享</p><span id="more"></span><h3 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h3><p>契机是我一位老师最近中了关于海运的面上，突然想起我本科毕业论文做的也是相关的数据分析。当然只是一点很简单的工作，毕竟只是本科的毕业设计。</p><h3 id="ais数据获取"><a class="markdownIt-Anchor" href="#ais数据获取"></a> AIS数据获取</h3><p>自动识别系统（Automatic Identification System，AIS）是安装在船舶上的一套自动追踪系统，通过岸基或星基设备接收船舶唯一标识符号、坐标、类型以及航行状态等数据，并且由连续的船舶AIS数据可合成船舶轨迹。</p><p>第一步数据获取就卡了很久。定毕设题目那会儿，即2023年冬天，有幸参加了第一届的信息地理学大会，听了三四个关于AIS数据和船舶轨迹分析的报告，都有提到他们获取的AIS数据，一些研究人员手里一年的数据量都是十亿级别的，让我有种莫名的错觉，觉得获取局部一段时间内的AIS数据并不是什么难事。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/001.jpg"/><br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/002.jpg"/><br />事实证明，我想的太简单了。先是尝试寻找开源数据未果，开始咨询数据供应商。但是这些商业公司的服务对象一般是船运相关企业和少量的科研人员，对我这样的个体户，上千上万的起步价尚且不能接受，何况数据需求在起步价内无法满足。兜兜转转十天，终于让我找到了活菩萨网站<a href="https://datalastic.com/">https://datalastic.com/</a></p><p>其实他们的定价同样贵的离谱，月订阅费用高达数千欧元，但他提供了一个几十欧元的一周体验计划，我没有犹豫就买了这根救命稻草。有了api一切都好说，唯一的问题是其相关API只能请求一个坐标特定范围内的AIS数据，这给数据获取的策略与后期数据合成都增加了不小的难度。我只能先将研究区域划分为几十个圆，在获取这些圆心范围内的数据。大概爬取了3-4天后，从datalastic网站获取了区域内AIS记录72,9499条，包含船舶的uuid（唯一标识符）、mmsi、坐标以及速度等有效信息，并汇总数据集包含的船舶，获取了每条船舶的国籍、类型、排水量等信息，具体下表所示。</p><table><thead><tr><th>AIS记录字段</th><th>AIS记录字段含义</th><th><strong>船舶信息字段</strong></th><th><strong>船舶信息字段含义</strong></th></tr></thead><tbody><tr><td>uuid</td><td>通用唯一识别码</td><td>uuid</td><td>通用唯一识别码</td></tr><tr><td>lat</td><td>纬度（度）</td><td>name</td><td>名称</td></tr><tr><td>lon</td><td>经度（度）</td><td>mmsi</td><td>海事服务身份码</td></tr><tr><td>speed</td><td>速度（节）</td><td>imo</td><td>国际海事组织号码</td></tr><tr><td>course</td><td>航向</td><td>country_iso</td><td>注册国代码</td></tr><tr><td>heading</td><td>船首向</td><td>type</td><td>类型</td></tr><tr><td>destination</td><td>目的地</td><td>gross_tonnage</td><td>总吨位</td></tr><tr><td>last_pos_epoch</td><td>时间戳</td><td>deadweight</td><td>最大载运量</td></tr><tr><td>last_pos_utc</td><td>时间戳（世界时间）</td><td>length</td><td>船体长度</td></tr><tr><td></td><td></td><td>speed_max</td><td>最大航速（节）</td></tr><tr><td>navstat</td><td>导航状态</td><td>home_port</td><td>注册港</td></tr><tr><td>distance_nm</td><td>距目的地距离（海里）</td><td>year_built</td><td>建造年份</td></tr><tr><td></td><td></td><td>breadth</td><td>船体宽度</td></tr></tbody></table><p>大概分布如下图：<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/003.jpg"/><br />将其注入数据库，并通过uuid字段与船舶信息数据库建立连接。</p><h3 id="船舶轨迹合成"><a class="markdownIt-Anchor" href="#船舶轨迹合成"></a> 船舶轨迹合成</h3><p>由于用于合成船舶轨迹的AIS记录时间跨度较长，绝大多数船舶在区域内并不仅完成了一次航行任务，而是涵盖了多条航线。因此，通过AIS记录直接合成的船舶轨迹存在航迹复杂、重复等问题。为了更好地获得航行特征，研究将轨迹从港口出发，直至到达另一港口的航段定义为船舶的一条分段轨迹。而在给定的时间内，可能无法捕捉到一些船舶的起始港口或终点港口，因此被起始时间或终止时间截断的轨迹，也被称为该船舶的一条分段轨迹。</p><p>因此，通过AIS记录合成分段轨迹的前提是区分船舶的状态，即航行状态或驻留状态。在某一船舶的一组根据时间排序的AIS记录中，有四种可能的分段轨迹：</p><ul><li>由该组数据最早的AIS记录点开始，至下一个处于驻留状态的AIS记录点结束的分段轨迹。</li><li>由该组数据最早的AIS记录点开始，至该组数据最晚的AIS记录点结束的分段轨迹。</li><li>该组某个处于驻留状态，且下一个记录点处于航行状态的AIS记录点开始，至下一个处于驻留状态的AIS记录点结束的分段轨迹。</li><li>该组某个处于驻留状态，且下一个记录点处于航行状态的AIS记录点开始，至该组数据最晚的AIS记录点结束的分段轨迹。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/004.jpg"/><br />上图展示了通过判断某一船舶AIS记录点航行状态，从而合成船舶分段轨迹的步骤。虽然AIS记录提供了导航状态字段，用以判断船舶是否处于航行状态，但该字段存在大量数据缺失、错误问题。此外，研究认为，虽然在港口附近的上传的AIS记录点显示船舶处于航行状态，但该船舶的实际行为多表现为停留或在较小的范围内徘徊，因此应当被归类为驻留。因此，AIS记录的导航状态字段并不能提供准确的判别依据，研究采用支持向量机（Support Vector Machine, 下文简称SVM）方法判定AIS记录点的状态。</li></ul><p>SVM是一种可以有效处理分类问题的机器学习算法，目标是在数据集中找到一个最优的决策边界（亦称为超平面），这个决策边界能够以最大间隔分开不同类别的数据点。</p><p>由于SVM是一种监督分类方法，因此，研究手动标注了2000个AIS数据点的航行状态，并使用坐标、航速、航向以及船首向作为特征向量，使用70%的标注数据集作为训练集训练SVM模型，同时通过比较剩下30%的数据构成的测试集检测各个核函数的区分效果，包括线性核函数、多项式核函数、径向基函数核以及Sigmoid核函数，并确定了最佳核函数。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/005.jpg"/><br />从图中可以看出，船舶驻留记录点多聚集于海岸港口，与实际情况相符。然而，由于模型仍存在一些误差，可能将一些处于航行状态的AIS记录点被识别为驻留状态，而一些处于驻留状态的航行点被识别为航行状态，导致原本连续的航行AIS记录被打断，导致船舶的分段轨迹错误地在该节点上分裂，或是从船舶驻留在港口及周边区域时识别出多余轨迹。因此，研究需要识别并修正这些错误的状态点。研究使用一个大小为3x1的滑动窗口遍历按时间排序的船舶状态记录点，如果窗口内第一个状态记录与第三个状态记录相同，但第二个状态记录与前后都不同，则修正该记录。</p><p>在完成数据修正后，即可合成船舶轨迹,即分段的坐标时间序列。图中©展示了某船舶的AIS记录分段轨迹合成，在合成过程中，研究删除了船舶状态为驻留的记录，并连接连续的船舶状态为航行的记录，完成了一段完整轨迹的分割。使用该方法完成2023年9月27日至10月6日，以及10月10日至10月19日区域的全部AIS记录分段轨迹合成，其效果如下图所示。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/006.png"/></p><h3 id="船舶轨迹压缩"><a class="markdownIt-Anchor" href="#船舶轨迹压缩"></a> 船舶轨迹压缩</h3><p>Douglas-Peucker算法（以下简称DP算法）是一种用于曲线近似和抽稀的算法。它的主要思想是在给定的曲线中，通过保留一些重要的数据点，来近似表示原始曲线，从而实现曲线的简化。由于研究提供的轨迹数据集数据量较大，轨迹节点较多，因此在轨迹聚类前，对轨迹数据集进行压缩处理能够有效提高聚类效率，而大量实验证明，DP算法适用于轨迹数据的压缩。下图展示了DP算法对于一条轨迹压缩的过程。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/007.png"/><br />DP算法的基本思路如下：</p><ul><li>在目标曲线的起点和终点之间，找到一条直线，作为曲线的初始近似。</li><li>计算其他所有点到该直线的距离，找到距离最大的点（即垂直距离最大的点）。</li><li>如果这个最大距离超过了预先设定的阈值（即所谓的抽稀阈值），则将该点加入到结果集合中，并将曲线划分为两个子曲线。</li><li>对两个子曲线分别递归地应用上述过程，直到所有点都被处理完毕。</li><li></li></ul><p>通过这个过程，DP算法可以在一定程度上保留曲线的形状特征，同时减少数据点的数量，从而实现曲线的简化。DP算法的阈值决定了简化后的曲线与原始曲线之间的最大允许误差，是影响算法压缩结果的唯一参数。</p><p>Zhao等人的实验]表明，对于统一阈值压缩而言，在以一个固定的步长增加阈值的过程中，使用轨迹节点数变化率相对较低、较为平稳的一定范围内的阈值，对相似度量性能有一定程度的提升，他们称该范围为“稳定阶段”。为此，研究计算了0-1000米阈值范围内，以10米为步长的轨迹平均节点数负增长率以及轨迹平均长度负增长率，得到数据集的6个“稳定阶段”，如下图所示。<br /><img src="https://atffang.github.io/2025/08/29/基于AIS数据进行船舶轨迹分段合成的一点思路/008.jpg"/><br />为了尽可能保全轨迹结构，研究选取了处于第一个稳定阶段的压缩阈值350m。在该阈值下，经压缩，数据集中每条轨迹的平均节点数减少至原来的44%，但平均轨迹长度仍保持在原来的98%，这说明该压缩算法在大幅度减少轨迹节点数量的同时，较好地保存了轨迹原有的形态特征。</p><h3 id="后记"><a class="markdownIt-Anchor" href="#后记"></a> 后记</h3><p>上述的AIS数据获取-分段轨迹合成-轨迹压缩构成是当时毕业设计的数据预处理部分，后续继续进行了聚类、分析等操作，这部分以后有机会再讲吧。现在回看我的毕业设计的后续部分也是稀奇古怪的，譬如修改DTW距离计算方式来消除长度导致的相关性，用一堆概率分布拟合计算最优聚类参数等等，现在觉得似乎不够严谨，但也不太清楚有什么更好的改进方法，看来水平没有进步。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;介绍一下本科毕设里关于基于AIS数据进行船舶轨迹合成部分的一点思路，非专业，仅分享&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>实验室安全检测系统</title>
    <link href="https://atffang.github.io/2025/07/19/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/"/>
    <id>https://atffang.github.io/2025/07/19/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/</id>
    <published>2025-07-19T02:25:37.000Z</published>
    <updated>2025-07-19T08:39:55.980Z</updated>
    
    <content type="html"><![CDATA[<p>最近参与了一个横向，项目架构与基础代码大概稳定下来了，浅浅记录一下。</p><span id="more"></span><h3 id="写在前面"><a class="markdownIt-Anchor" href="#写在前面"></a> 写在前面</h3><p>实际上这个项目在技术上并不难，甚至比许多工作简单的多，但让人头疼的主要是三点：</p><ul><li>典型小作坊做派，前端、数据库、识别系统、模型全要做，没有明确的职责分工</li><li>内网开发，测试也很困难，每天要骑个电瓶车去update</li><li>需求含混不清，一会说用这个一会说用那个，为此接入数据的逻辑改了n遍</li></ul><h3 id="系统需求与架构"><a class="markdownIt-Anchor" href="#系统需求与架构"></a> 系统需求与架构</h3><p>领导需要一个接入监控系统，实施监测各个实验室实验人员操作规范性，并归纳总结的系统，现在已在接入了一百余个监控设备，后续将推广至一千余个设备，其大致架构如下图所示：<br /><img src="https://atffang.github.io/2025/07/19/实验室安全检测系统/架构.png"/><br />按照该架构，重点的内容为监控轮询与帧识别两部分，程序将以设定的轮询间隔依次通过厂商提供的SDK访问摄像头并截图，将截图与包括摄像头基础信息、时间等的元数据交予消息队列并分发给多个识别设备进行图像识别。在试运行版本中，整个体系都在一台一张gpu的设备上运行。图像识别完成后，将识别结果汇总后存入数据库中。</p><h3 id="任务模型训练"><a class="markdownIt-Anchor" href="#任务模型训练"></a> 任务模型训练</h3><p>甲方提出了识别实验室实验人员不穿白大褂、夜间单人做实验、消防通道占用、废液桶是否盖盖子、通风橱开启是否规范等等。这些需求有的可以直接调用YOLO模型，有的则需要自行训练模型。</p><p>以<strong>实验人员穿着</strong>为例，首先基于YOLOv11模型提取多张监控截图中的人物边框并裁减，使用自己设计的标注工具进行是否穿着实验服装的正负样本标注，约两千余张。使用该数据，基于<strong>MobileNetV2</strong>模型训练我们需求的分类模型。</p><p><strong>MobileNetV2</strong> 是 Google 在 2018 年提出的一种轻量级卷积神经网络架构，我们将其迁移至我们的任务上。具体任务流程与要点如下：</p><ol><li>按照8：2划分数据集</li><li>加载 ImageNet 上预训练好的权重</li><li>将MobileNetV2 的最后一层 <code>nn.Sequential</code>替换为输出 2 类</li><li>任务采用交叉熵损失函数， Adam优化器，训练 epochs=10, batchsize=32, lr=1e-4<br />最终，分类模型的Accuracy为0.9850，达到了预期需求。</li></ol><p>整体模型首先使用yolo11s识别人，置信阈值设置为0.4，随后使用自己训练的二分类模型进行是否穿白大褂的判别，在后续的测试中，发现其基本可以满足需求，但仍对穿着白色T恤的实验人员有漏检情况，需要后续对模型进行改进。</p><h3 id="producer模块设计"><a class="markdownIt-Anchor" href="#producer模块设计"></a> Producer模块设计</h3><p>读取数据库中当日需要访问的摄像头的id，基于摄像头厂商提供的监控rtsp视频流Python SDK，轮询摄像头获取rtsp url。一开始使用opencv链接流并截取帧，但是截取效率和内存占用都很不理想，后来就直接改用了<strong>ffmpeg</strong>截取，在处理速度和内存占用上都优化了许多。</p><p>由于仍存在一定的等待时间，采用线程池提交任务，大概逻辑如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用线程池提交任务</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    futures = [executor.submit(ffmpeg_cut, *task) <span class="keyword">for</span> task <span class="keyword">in</span> tasks]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = future.result() </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Task raised an exception: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>在截取完成图像后，保存至本地并将元数据加入消息队列。</p><h3 id="消息队列设计"><a class="markdownIt-Anchor" href="#消息队列设计"></a> 消息队列设计</h3><p>在单机任务中，任务队列由Python维护，设计一个PhotoMessage类如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PhotoMessage</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        photo_id: 帧的唯一标识符（默认使用 UUID）</span></span><br><span class="line"><span class="string">camera_id: 摄像头的标识符</span></span><br><span class="line"><span class="string">room_id: 物理位置的标识符</span></span><br><span class="line"><span class="string">photo_path: 帧在文件系统中的路径或内存引用</span></span><br><span class="line"><span class="string">timestamp: 帧的捕获时间（如果未提供则自动生成）</span></span><br><span class="line"><span class="string">metadata: 附加的处理上下文信息（如模型输出等）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    camera_id: <span class="built_in">str</span></span><br><span class="line">    room_id: <span class="built_in">str</span></span><br><span class="line">    photo_path: Path</span><br><span class="line">    photo_id: <span class="built_in">str</span> = field(default_factory=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    timestamp: datetime = field(default_factory=datetime.now)</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_json</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="comment"># ……</span></span><br></pre></td></tr></table></figure><p>其中，有如 photo_id 是运行时生成一个唯一值（不能提前固定成某个默认字符串）。如果你写 photo_id: str = str(uuid.uuid4())，那么所有对象都会默认用<strong>同一个 UUID</strong>（因为默认值只会在类定义时求一次值）。而default_factory 会在每次创建对象时调用 lambda 生成新的值。在 dataclass 中，<strong>凡是带副作用的默认值（当前时间、UUID、列表、字典等）都应使用 default_factory</strong>，否则会引发不可预测的行为或共享状态。</p><p>为了表示队列，设计一个GlobalMessageQueue类如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GlobalMessageQueue</span>():</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">            cls._instance._queue = queue.LifoQueue(maxsize=<span class="number">10000</span>)</span><br><span class="line">            cls._instance._persist_file = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put_message</span>(<span class="params">self, msg: PhotoMessage</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        存入消息到队列</span></span><br><span class="line"><span class="string">        :param msg: PhotoMessage实例</span></span><br><span class="line"><span class="string">        :return: 是否成功入队</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._queue.put_nowait(msg)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> queue.Full:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;WARNING: 消息队列已满，丢弃最早的消息&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self._queue.get_nowait()  <span class="comment"># 丢弃最旧消息</span></span><br><span class="line">                self._queue.put_nowait(msg)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> queue.Empty:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_message</span>(<span class="params">self</span>) -&gt; <span class="type">Optional</span>[PhotoMessage]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        非阻塞获取消息</span></span><br><span class="line"><span class="string">        :return: PhotoMessage实例或None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._queue.get_nowait()</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">persist_messages</span>(<span class="params">self, file_path: Path</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        持久化队列到磁盘</span></span><br><span class="line"><span class="string">        :param file_path: 存储文件路径</span></span><br><span class="line"><span class="string">        :return: 持久化的消息数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_messages</span>(<span class="params">self, file_path: Path</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        从磁盘加载消息到队列</span></span><br><span class="line"><span class="string">        :param file_path: 存储文件路径</span></span><br><span class="line"><span class="string">        :return: 加载的消息数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_persist_file</span>(<span class="params">self, file_path: Path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置自动持久化文件路径&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;析构时自动持久化&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取当前队列的大小</span></span><br><span class="line"><span class="string">        :return: 队列中消息的数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ……</span></span><br></pre></td></tr></table></figure><p>该类 GlobalMessageQueue 实现了线程安全的<strong>全局单例消息队列</strong>，使用 LifoQueue 存储 PhotoMessage 实例，支持消息的入队、出队、磁盘持久化和加载，并在对象销毁时自动保存队列内容，防止数据丢失。</p><p>当然，在多设备并行处理中，可使用Redis作为多设备共享的消息队列。</p><h3 id="consumer模块设计"><a class="markdownIt-Anchor" href="#consumer模块设计"></a> Consumer模块设计</h3><p>首先，我们定义一个父类BaseModel，规范了模型对于图像输入的预处理方式。配置从指定config中读取，规范模型的名称、权重文件位置、预处理方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        self.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">        self.name = config[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        self.preprocess = config[<span class="string">&quot;preprocess&quot;</span>]</span><br><span class="line">        self.pipeline = config[<span class="string">&quot;pipeline&quot;</span>]</span><br><span class="line"></span><br><span class="line">        self._build_preprocess_method()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 预处理类</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_preprocess_method</span>(<span class="params">self</span>):</span><br><span class="line">        preprocess = self.preprocess</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">preprocess_image</span>(<span class="params">self, message: PhotoMessage</span>):</span><br><span class="line">            <span class="comment"># 调用_crop和_resize的逻辑</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> image</span><br><span class="line">        </span><br><span class="line">        self.preprocess_image = MethodType(preprocess_image, self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_crop</span>(<span class="params">self, message: PhotoMessage, image: Image.Image</span>):</span><br><span class="line">        <span class="comment"># ……</span></span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_resize</span>(<span class="params">self, message: PhotoMessage, image: Image.Image</span>):</span><br><span class="line">        <span class="keyword">return</span> image.resize(self.preprocess[<span class="string">&quot;size&quot;</span>])</span><br></pre></td></tr></table></figure><p>随后继承该类，定义一个IdentificationModel子类，新增一个_loadmodel功能，需要返回一个predict方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IdentificationModel</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(config)</span><br><span class="line">        self.predict = self._loadmodel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_loadmodel</span>(<span class="params">self</span>):</span><br><span class="line">        predict = ModelLoader.loader(self.name, self.pipeline, self.device)</span><br><span class="line">        <span class="keyword">return</span> predict</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure><p>由于当前模型都暂时只需要一个predict方法，因此，暂时只使用该子类。可以注意到，IdentificationModel类使用了一个ModelLoader类，该类负责每个具体的识别模型的predict逻辑，返回每个模型中我们需要的predict函数，由于过于冗长，不做展示。</p><p>基于上述类，consumer线程可以很轻松的从配置文件中加载模型：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.modellist = []</span><br><span class="line"><span class="keyword">for</span> config <span class="keyword">in</span> config_list:</span><br><span class="line">    self.modellist.append(IdentificationModel(config))</span><br></pre></td></tr></table></figure><p>并逐个调用模型对图片进行识别：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> model <span class="keyword">in</span> self.modellist:                </span><br><span class="line">    photo = model.preprocess_image(message)</span><br><span class="line">    output = model.predict(message, photo)</span><br></pre></td></tr></table></figure><p>当然，在consumer内部也采用了多线程的设计，此处不再赘述。</p><h3 id="存储模块设计"><a class="markdownIt-Anchor" href="#存储模块设计"></a> 存储模块设计</h3><p>存储模块负责将识别结果整理后存入Postgresql数据库，识别结果图片存入Minio桶容器，之间通过唯一的uuid相关联，此处不多赘述。</p><h3 id="容器化部署"><a class="markdownIt-Anchor" href="#容器化部署"></a> 容器化部署</h3><p>由于本项目涉及到深度学习环境以及redis、minio、psql等工具，因此，使用docker部署是最快速最安全的方式。但是这里有个大坑！我原本基于dockerfile构建了带cuda驱动、nvcc、python环境以及ffmpeg等的容器，但是发现，由于windows上的docker是机遇wsl实现的，和本机之间存在网络的隔离，在容器内运行的python程序读不到局域网下的rtsp流。本人当即表示烦。<br />无奈，只能暂时线把主要程序放在宿主机上执行，redis、minio、psql使用docker部署。该项目的docker-compose如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_minio</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">minioadmin</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio-init:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/mc</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      /bin/sh -c &quot;</span></span><br><span class="line"><span class="string">      sleep 5;</span></span><br><span class="line"><span class="string">      mc alias set local http://minio:9000 minioadmin minioadmin;</span></span><br><span class="line"><span class="string">      mc mb -p local/detection-results;</span></span><br><span class="line"><span class="string">      mc policy set public local/detection-results;</span></span><br><span class="line"><span class="string">      exit 0;</span></span><br><span class="line"><span class="string">      &quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:17</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">labcamera</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5434:5432&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./initdb:/docker-entrypoint-initdb.d</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">pgdata:</span></span><br><span class="line">  <span class="attr">minio_data:</span></span><br></pre></td></tr></table></figure><p>其中，在labsecurity_postgres容器中，我指定了数据库初始化的文件位置，即/initdb，只要在该文件夹下放置.sql，容器初始化时即可根据该sql文件建立数据库，不要太方便。而容器间、宿主机和容器间也可以通过端口相互访问，例如，在其他容器内通过<code>minio:9000</code>，在本机中可以通过<code>http://localhost:9001/</code>访问。</p><p>通过 <code>docker compose up -d</code> 可以一键部署容器，通过 <code>docker ps` -a</code> 查看部署情况。此外，按照原计划，深度学习环境也会部署在容器内，这里做个记录，首先，构建 .Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">12.8</span>.<span class="number">0</span>-cudnn-runtime-ubuntu22.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y python3 python3-pip</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install torch==2.6.0 torchvision==0.21.0 torchaudio==2.6.0 --index-url https://download.pytorch.org/whl/cu126</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./app /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;main.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>可以看到，该文件指定了安装cuda驱动和python，并根据requirements安装好需要的python包。在docker- compose中加上：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span>  </span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_app</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./app:/app</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br></pre></td></tr></table></figure><p>容器能看到本机的 <code>./app</code> 目录，点击vscode左下方的&gt;&lt;，选择Attach to Running Container，进入python容器，就可以愉快的开发了。</p><h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3><p>这算是我参与的算是比较完整的横向了，但是也没什么好总结的，懒得总结。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近参与了一个横向，项目架构与基础代码大概稳定下来了，浅浅记录一下。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>从0开始学java 03 ：观察者模式</title>
    <link href="https://atffang.github.io/2025/07/09/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java3/"/>
    <id>https://atffang.github.io/2025/07/09/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java3/</id>
    <published>2025-07-09T08:24:45.000Z</published>
    <updated>2025-07-09T08:26:01.376Z</updated>
    
    <content type="html"><![CDATA[<p>生活所迫呀。</p><span id="more"></span><p><strong>观察者模式</strong>是一种行为型设计模式，它定义了一种<strong>对象之间一对多的依赖关系</strong>，使得当一个对象的状态发生改变时，所有依赖它的对象都会自动收到通知并更新。</p><p>为什么要用观察者模式？我们有下面几个原因：</p><ul><li><strong>解耦通知逻辑</strong>：观察者模式的核心价值在于：<strong>发布者（被观察者）和订阅者（观察者）之间是解耦的</strong>。  发布者无需知道观察者是谁、做什么，只需要在状态发生变化时“通知大家”；观察者则只关心“是否订阅了该对象”，无需知道发布者的具体业务逻辑。</li><li><strong>自动通知，避免轮询</strong>：在没有观察者模式的情况下，我们可能需要让每个组件不断检查（轮询）状态的变化。这不仅效率低，还容易写出重复、混乱的代码。</li><li><strong>事件驱动架构的基础</strong>：现代前后端框架（如 React、Vue、Java Swing、Spring）中大量使用观察者模式或其变种（发布-订阅模式）来构建响应式系统。</li></ul><h3 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h3><p>我们还是以实际的需求入手，举一个最经典的例子：</p><p>你正在开发一个气象站系统，它能实时监测温度、湿度、气压等数据。现在有多个布告板（显示面板）希望<strong>自动接收到最新的天气数据并显示</strong>，比如：</p><ul><li>当前天气布告板（CurrentConditionsDisplay）</li><li>统计布告板（StatisticsDisplay）</li><li>预报布告板（ForecastDisplay）<br />一旦气象站更新数据，<strong>所有布告板都应立即更新并展示最新信息</strong>。</li></ul><p>首先，我们需要定义一个被观察者接口<strong>Subject</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subject</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerObserver</span><span class="params">(Observer o)</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeObserver</span><span class="params">(Observer o)</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其规范了三项功能：</p><ul><li>注册观察者</li><li>删除观察者</li><li>通知所有的观察者</li></ul><p>当然，我们也需要定义布告板观察者接口<strong>Observer</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Observer</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">float</span> temp, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>额外的，我们定义一个展示接口<strong>DisplayElement</strong>，当布告板需要显示时，调用方法<strong>display()</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DisplayElement</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义完接口后，我们需要定义类来实现主题了。首先，定义一个实现<strong>被观察者</strong>接口<strong>Subject</strong>的类<strong>WeatherData</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherData</span> <span class="keyword">implements</span> <span class="title class_">Subject</span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> ArrayList observers;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> temperature;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> humidity;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> pressure;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WeatherData</span><span class="params">()</span>&#123;  </span><br><span class="line">        observers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerObserver</span><span class="params">(Observer o)</span>&#123;  </span><br><span class="line">        observers.add(o);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeObserver</span><span class="params">(Observer o)</span>&#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> observers.indexOf(o);  </span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>)&#123;  </span><br><span class="line">            observers.remove(i);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">()</span>&#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt;observers.size(); i++)&#123;  </span><br><span class="line">            <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> (Observer) observers.get(i);  </span><br><span class="line">            observer.update(temperature, humidity, pressure);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 一旦新数据来了，调用此方法  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMeasurements</span><span class="params">(<span class="type">float</span> temperature, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span>&#123;  </span><br><span class="line">        <span class="built_in">this</span>.temperature = temperature;  </span><br><span class="line">        <span class="built_in">this</span>.humidity = humidity;  </span><br><span class="line">        <span class="built_in">this</span>.pressure = pressure;  </span><br><span class="line">        notifyObservers();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随后，定义<strong>布告板（观察者）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title class_">Observer</span>, DisplayElement &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> humidity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CurrentConditionsDisplay</span><span class="params">(Subject weatherData)</span> &#123;</span><br><span class="line">        weatherData.registerObserver(<span class="built_in">this</span>); <span class="comment">// 注册自己</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">float</span> temperature, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.temperature = temperature;</span><br><span class="line">        <span class="built_in">this</span>.humidity = humidity;</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前天气：温度 = &quot;</span> + temperature + <span class="string">&quot;°C，湿度 = &quot;</span> + humidity + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试一下这个程序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherStation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WeatherData</span> <span class="variable">weatherData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WeatherData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">CurrentConditionsDisplay</span> <span class="variable">currentDisplay</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentConditionsDisplay</span>(weatherData);</span><br><span class="line"></span><br><span class="line">        weatherData.setMeasurements(<span class="number">30.4f</span>, <span class="number">65.2f</span>, <span class="number">1013.1f</span>);</span><br><span class="line">        weatherData.setMeasurements(<span class="number">28.9f</span>, <span class="number">70.1f</span>, <span class="number">1012.5f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="java内置写法"><a class="markdownIt-Anchor" href="#java内置写法"></a> java内置写法</h3><p>Java 在早期（JDK 1.0）就内置了对观察者模式的支持：</p><ul><li><code>java.util.Observable</code>：被观察者（Subject）</li><li><code>java.util.Observer</code>：观察者（Observer）</li></ul><p>还是使用上面气象站的例子，首先，我们继承内置的类<strong>Observable</strong>定义一个<strong>被观察者（WeatherData）</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherData</span> <span class="keyword">extends</span> <span class="title class_">Observable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> humidity;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> pressure;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMeasurements</span><span class="params">(<span class="type">float</span> temperature, <span class="type">float</span> humidity, <span class="type">float</span> pressure)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.temperature = temperature;</span><br><span class="line">        <span class="built_in">this</span>.humidity = humidity;</span><br><span class="line">        <span class="built_in">this</span>.pressure = pressure;</span><br><span class="line"></span><br><span class="line">        setChanged(); <span class="comment">// 标记状态已更新</span></span><br><span class="line">        notifyObservers(); <span class="comment">// 通知所有观察者（无参数版本）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getTemperature</span><span class="params">()</span> &#123; <span class="keyword">return</span> temperature; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getHumidity</span><span class="params">()</span> &#123; <span class="keyword">return</span> humidity; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getPressure</span><span class="params">()</span> &#123; <span class="keyword">return</span> pressure; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setChanged()</code>是 <code>Observable</code> 提供的方法，<strong>必须调用</strong>这个方法，告诉系统“我准备好通知别人了”。如果不调用 <code>setChanged()</code>，后续的 <code>notifyObservers()</code> 什么都不会发生。<br /><code>notifyObservers()</code>：遍历当前注册的所有观察者（通过 <code>addObserver()</code> 添加的），并依次调用它们的 <code>update()</code> 方法。默认参数为 <code>null</code>，也可以使用 <code>notifyObservers(Object arg)</code> 传递数据。</p><p>随后，继承内置类<strong>Observer</strong>定义一个<strong>观察者（布告板）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Observer;</span><br><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Observable o, Object arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> WeatherData) &#123;</span><br><span class="line">            <span class="type">WeatherData</span> <span class="variable">wd</span> <span class="operator">=</span> (WeatherData) o;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前天气：温度 = &quot;</span> + wd.getTemperature() + <span class="string">&quot;°C，湿度 = &quot;</span> + wd.getHumidity() + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>update(Observable o, Object arg)</code>： 当被观察者调用 <code>notifyObservers()</code> 时，<strong>每个注册的观察者的 <code>update()</code> 方法都会被执行</strong>。参数 <code>o</code> 是被观察者对象本身（即 <code>WeatherData</code>）。参数 <code>arg</code> 是通过 <code>notifyObservers(arg)</code> 传递的附加数据（如果调用的是 <code>notifyObservers()</code>，则为 <code>null</code>）。</p><p>注册观察者、更新数据、触发通知：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherStation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">WeatherData</span> <span class="variable">weatherData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WeatherData</span>();  <span class="comment">// 创建被观察者</span></span><br><span class="line">        <span class="type">CurrentConditionsDisplay</span> <span class="variable">display</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentConditionsDisplay</span>(); <span class="comment">// 创建观察者</span></span><br><span class="line"></span><br><span class="line">        weatherData.addObserver(display);  <span class="comment">// 注册观察者到被观察者内部列表</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟一次天气数据更新</span></span><br><span class="line">        weatherData.setMeasurements(<span class="number">25.6f</span>, <span class="number">65.0f</span>, <span class="number">1012.0f</span>);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然 Java 提供了这个内置机制，但它有一些明显缺陷，因此在 JDK 9 后已标记为过时（Deprecated）。 缺点如下：</p><ul><li><code>Observable</code> 是一个类，不是接口，<strong>限制了继承</strong>（Java 不支持多继承）</li><li>内部方法如 <code>setChanged()</code> 并非自动调用，容易遗漏</li><li><code>update()</code> 方法传参设计不灵活</li><li>不支持泛型</li></ul><p>因此，实际上用我们一开始写的方式自定义 <code>Subject</code> 和 <code>Observer</code> 接口是最清晰和通用的方式。哈哈。<br />当我们在大型项目中，面临越来越复杂的模块通信、异步响应、数据流处理需求时，传统的观察者模式（无论是自定义接口还是 Java 原生的 <code>Observer/Observable</code>）都可能显得不够灵活、不够强大，可能需要涉及到事件驱动架构（EDA）或响应式编程，在后面的章节中，我们会讲到。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;生活所迫呀。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>进程守护</title>
    <link href="https://atffang.github.io/2025/07/08/%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4/"/>
    <id>https://atffang.github.io/2025/07/08/%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4/</id>
    <published>2025-07-08T07:34:03.000Z</published>
    <updated>2025-07-08T11:28:56.028Z</updated>
    
    <content type="html"><![CDATA[<p>持久化的python服务</p><span id="more"></span><p><strong>进程守护</strong>指的是让一个程序<strong>在后台持续运行</strong>，<strong>具有自我恢复能力</strong>（崩溃自动重启），<strong>随系统启动自动启动</strong>，并可通过命令进行控制。</p><h3 id="1-linux下systemd-持久守护-python-程序"><a class="markdownIt-Anchor" href="#1-linux下systemd-持久守护-python-程序"></a> 1. linux下systemd 持久守护 Python 程序</h3><p>创建systemd服务配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/myscript.service</span><br></pre></td></tr></table></figure><p>内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=My Persistent Python Script</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/python3 /home/user/run_my_job.py</span><br><span class="line">WorkingDirectory=/home/user</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">User=your_linux_username</span><br><span class="line">StandardOutput=append:/var/log/myscript.log</span><br><span class="line">StandardError=append:/var/log/myscript.err</span><br><span class="line">Environment=PYTHONUNBUFFERED=1</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>启用并启动服务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reexec</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable myscript.service</span><br><span class="line">sudo systemctl start myscript.service</span><br></pre></td></tr></table></figure><p>查看日志和状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status myscript.service</span><br><span class="line">sudo <span class="built_in">tail</span> -f /var/log/myscript.log</span><br></pre></td></tr></table></figure><p>通过命令进行控制：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop myscript.service</span><br><span class="line">sudo systemctl restart myscript.service</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> myscript.service</span><br></pre></td></tr></table></figure><h3 id="2-跨平台python进程管理工具supervisord"><a class="markdownIt-Anchor" href="#2-跨平台python进程管理工具supervisord"></a> 2. 跨平台python进程管理工具supervisord</h3><p><strong>supervisord</strong> 是一个用 Python 编写的进程管理工具， 它可以监控、启动、停止、重启你python脚本在内的进程。可以直接利用pip下载：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install supervisor</span><br></pre></td></tr></table></figure><p>Supervisor 由两个核心组件组成：</p><ul><li>supervisord守护进程：负责读取配置、启动/监控任务</li><li>supervisorctl命令行客户端：用于查看状态、重启任务等</li></ul><p>使用时，首先生成一个默认的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf &gt; supervisord.conf</span><br></pre></td></tr></table></figure><p>将需要守护的进程添加到配置文件中：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:my_script]</span></span><br><span class="line"><span class="attr">command</span>=python3 /home/user/scripts/my_script.py</span><br><span class="line"><span class="attr">directory</span>=/home/user/scripts</span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/my_script.out.log</span><br><span class="line"><span class="attr">stderr_logfile</span>=/var/log/my_script.err.log</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>参数</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>command</td><td>要执行的命令</td></tr><tr><td>directory</td><td>工作目录</td></tr><tr><td>autostart</td><td>启动 supervisord 时自动启动</td></tr><tr><td>autorestart</td><td>异常退出后是否自动重启</td></tr><tr><td>startsecs</td><td>启动后运行多少秒才算成功</td></tr><tr><td>stdout_logfile</td><td>标准输出日志路径</td></tr><tr><td>stderr_logfile</td><td>错误日志路径</td></tr><tr><td>启动supervisord守护进程：</td><td></td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord -c supervisord.conf</span><br></pre></td></tr></table></figure><p>和systemd一样，supervisord也有一些管理任务的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl -c supervisord.conf status</span><br><span class="line">supervisorctl -c supervisord.conf restart my_script</span><br><span class="line">supervisorctl -c supervisord.conf stop my_script</span><br></pre></td></tr></table></figure><p>也可以利用supervisord进行不同gpu任务分发，不同gpu上运行不同进程并守护的骚操作，首先，在你的模型任务代码中加上通过参数指定gpu的逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--gpu&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">0</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">f&quot;cuda:<span class="subst">&#123;args.gpu&#125;</span>&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">model.to(device)</span><br></pre></td></tr></table></figure><p>然后，指定不同的gpu进行进程守护：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[program:worker1]</span><br><span class="line"><span class="built_in">command</span>=python3 /opt/scripts/train_model.py --gpu 0</span><br><span class="line"></span><br><span class="line">[program:worker2]</span><br><span class="line"><span class="built_in">command</span>=python3 /opt/scripts/train_model.py --gpu 1</span><br></pre></td></tr></table></figure><h3 id="3-docker-restart-policy"><a class="markdownIt-Anchor" href="#3-docker-restart-policy"></a> 3. Docker + restart policy</h3><p>Docker 提供了一种机制叫做 restart policy（重启策略），用来控制当容器退出或系统重启时，是否自动重启该容器。<br />对于一个Dockerfile，可以加上 --restart always运行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t my-capture .</span><br><span class="line">docker run -d --name my_capture_container --restart always my-capture</span><br></pre></td></tr></table></figure><p>这个容器中的 Python 脚本崩溃时自动重启。</p><p>当然，在docker-compose.yml 中可以这样配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">camera_worker:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br></pre></td></tr></table></figure><p>当然，如果想要在linux中开机自启动容器，除了上面的，只要再使得docker自动启动即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><p>这个命令会把 Docker 服务注册到 systemd 中，下次系统启动时会自动启动 Docker 服务, 也就自动拉起了 --restart always 的容器。</p><p>设置完之后，你可以检查一下重启策略是否配置好：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect your_container_name | grep -i restart</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;持久化的python服务&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>浅试docker：为 AI 项目构建高可维护的开发环境</title>
    <link href="https://atffang.github.io/2025/06/30/%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>https://atffang.github.io/2025/06/30/%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2025-06-30T12:49:55.000Z</published>
    <updated>2025-06-30T13:14:28.909Z</updated>
    
    <content type="html"><![CDATA[<p>浅试docker：为 AI 项目构建高可维护的开发环境</p><span id="more"></span><p>我的需求是一个带cuda驱动的python容器，redis容器、psql容器、minio容器，因此，我指定docker-compose和dockerfile，他们之间的区别如下表：</p><table><thead><tr><th>方面</th><th>Dockerfile</th><th>Docker Compose</th></tr></thead><tbody><tr><td>核心作用</td><td>定义单个镜像的构建过程，描述从基础镜像开始，安装软件、拷贝文件、配置环境等步骤，生成自定义镜像。</td><td>定义多个容器的编排和运行，指定哪些镜像或 Dockerfile 要启动，容器之间如何连接、挂载卷、端口映射等。</td></tr><tr><td>工作方式</td><td>通过 docker build 从 Dockerfile 构建镜像。</td><td>通过 docker-compose up 根据配置启动一个或多个容器。</td></tr><tr><td>是否拉取镜像</td><td>可以基于已有镜像（FROM xxx），也可以从头开始构建。</td><td>可以使用已有镜像（image: xxx）或基于 Dockerfile 构建镜像（build: xxx）。</td></tr><tr><td>功能范围</td><td>只负责镜像构建（静态），镜像里包含运行环境和文件。</td><td>负责多容器应用的启动与管理（动态），包括网络、依赖关系、环境变量等。</td></tr><tr><td>示例</td><td>写一个 Python 镜像，安装依赖，拷贝代码。</td><td>启动数据库、缓存、Python 服务容器，并让它们协同工作。</td></tr></tbody></table><p>编写<strong>Docker-compose:</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span>  </span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_app</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./app:/app</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_minio</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">minioadmin</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:17</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">labsecurity_postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">labdb</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">labuser</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">labpass</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5432:5432&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pgdata:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">pgdata:</span></span><br><span class="line">  <span class="attr">minio_data:</span></span><br></pre></td></tr></table></figure><p>编写<strong>Dockerfile:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia<span class="operator">/</span>cuda:<span class="number">12.8</span><span class="number">.0</span><span class="operator">-</span>cudnn<span class="operator">-</span>runtime<span class="operator">-</span>ubuntu22<span class="number">.04</span></span><br><span class="line"></span><br><span class="line">RUN apt<span class="operator">-</span><span class="keyword">get</span> <span class="keyword">update</span> <span class="operator">&amp;&amp;</span> apt<span class="operator">-</span><span class="keyword">get</span> install <span class="operator">-</span>y python3 python3<span class="operator">-</span>pip</span><br><span class="line"></span><br><span class="line">WORKDIR <span class="operator">/</span>app</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> requirements.txt .</span><br><span class="line"></span><br><span class="line">RUN pip install torch<span class="operator">=</span><span class="operator">=</span><span class="number">2.6</span><span class="number">.0</span> torchvision<span class="operator">=</span><span class="operator">=</span><span class="number">0.21</span><span class="number">.0</span> torchaudio<span class="operator">=</span><span class="operator">=</span><span class="number">2.6</span><span class="number">.0</span> <span class="comment">--index-url https://download.pytorch.org/whl/cu126</span></span><br><span class="line">RUN pip install <span class="comment">--no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> .<span class="operator">/</span>app <span class="operator">/</span>app</span><br><span class="line"></span><br><span class="line">CMD [&quot;python3&quot;, &quot;main.py&quot;]</span><br></pre></td></tr></table></figure><p>例如，在python中通过<code>minio:9000</code>，在本机中可以通过<code>http://localhost:9001/</code>访问。</p><h3 id="docker快速构建"><a class="markdownIt-Anchor" href="#docker快速构建"></a> docker快速构建</h3><ol><li>下载docker desktop，对于分盘的windows电脑，建议迁移一下docker位置</li><li>换源，我这里修改配置文件为：</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;gc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;defaultKeepStorage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://docker.xuanyuan.me&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol start="3"><li><p>构建镜像：<code>docker compose build</code></p></li><li><p>启动容器服务：<code>docker compose up -d</code> 没有下载过dockert-compose中的容器的会先下载</p></li><li><p>查看服务状态：<code>docker ps</code> -a<br /><img src="https://gcnaq17oc64n.feishu.cn/space/api/box/stream/download/asynccode/?code=NGI2NTJlZWU1OTExOGMzODgwMjAzZTM1NGJiMjhkNWNfZnA5ZE9tZHlwdWdhT3BOZjVtcVhzckd2Uk9Ma2pwdVRfVG9rZW46T2hBc2JGaHRHbzAyMEV4ZjAwZWMzSFYxbkloXzE3NTEyODkwNzk6MTc1MTI5MjY3OV9WNA" alt="" /></p></li><li><p>进入python容器：<code>docker exec -it labsecurity_app bash</code></p></li><li><p>测试一下cuda环境是否可用，运行脚本：</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="built_in">print</span>(torch.cuda.is_available())</span><br><span class="line"><span class="built_in">print</span>(torch.cuda.get_device_name(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><ol start="8"><li>结束所有服务： <code>docker-compose stop</code> 开始所有服务：<code>docker-compose start</code></li><li>我在docker-compose里面挂载了：</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">    - ./app:/app</span><br></pre></td></tr></table></figure><p>容器能看到本机的 <code>./app</code> 目录，点击vscode左下方的&gt;&lt;，选择Attach to Running Container，进入python容器，就可以愉快的开发了</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;浅试docker：为 AI 项目构建高可维护的开发环境&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>从0开始学java 02 ：委托与策略模式</title>
    <link href="https://atffang.github.io/2025/06/29/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java2/"/>
    <id>https://atffang.github.io/2025/06/29/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java2/</id>
    <published>2025-06-29T07:46:42.000Z</published>
    <updated>2025-06-29T08:44:50.335Z</updated>
    
    <content type="html"><![CDATA[<p>生活所迫呀。</p><span id="more"></span><p>上一期中，我们通过接口（interface）和抽象类（abstract class）理解了如何定义行为规范、如何实现多态等等。然而，在传统的继承方式中，子类通过覆盖方法来改变行为，但这种方式在面对行为切换、行为复用时显得僵硬。因此，我们希望有一种方式，不用继承，也能改变对象的行为，更适合“插件式”的行为结构。</p><p>这个时候，就需要一种新的模式<strong>委托</strong>，把行为交给另一个对象来完成。</p><p>首先，我们需要先定义一个接口，来规范要干的事情</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FlyBehavior</span>&#123;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现接口的类必须要实现fly这一个动作，我们定义一个实现FlyBehavior接口的类FlyWithWings，来实现有翅膀可以飞的动作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlyWithWings</span> <span class="keyword">implements</span> <span class="title class_">FlyBehavior</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;fly!!!!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们再定义一个实现FlyBehavior接口的类FlyNoWings，来实现没翅膀不能飞的动作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlyNoWings</span> <span class="keyword">implements</span> <span class="title class_">FlyBehavior</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;cannot fly!!!!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义玩接口和接口的实现之后，我们定义了两个飞行动作，现在，我们来定义实现飞行动作的对象。<br />我们定义一个鸭子抽象类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Duck</span>&#123;</span><br><span class="line"><span class="comment">// 声明引用变量</span></span><br><span class="line">FlyBehavior flyBehavior;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Duck</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象类的函数，子类必须实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 委托给行为类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performFly</span><span class="params">()</span> &#123;</span><br><span class="line">flyBehavior.fly();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里首先声明了一个FlyBehavior类型的引用变量，表示鸭子的飞行行为，当调用performFly()时，实际上调用的是flyBehavior对象的fly()方法。</p><p>好的，那么我们可以新建一个子类了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MallardDuck</span> <span class="keyword">extends</span> <span class="title class_">Duck</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MallardDuck</span><span class="params">()</span>&#123;</span><br><span class="line">flyBehavior = <span class="keyword">new</span> <span class="title class_">FlyNoWings</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;im MallardDuck&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 MallardDuck 构造函数里，给继承自父类的 flyBehavior 变量赋值为 new FlyWithWings() 实例。这样调用 performFly() 就会调用 FlyWithWings 类的 fly() 方法，实现“飞”的动作。<br />入口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunDuck</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line"><span class="type">Duck</span> <span class="variable">mallard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MallardDuck</span>();</span><br><span class="line">mallard.performFly();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出： cannot fly!!!</p><p><strong>但是</strong>，这样还是不够灵活，我们还想要让鸭子具有动态行为。为了实现这个目的，我们只需要在抽象类中加入一个设定方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Duck</span>&#123;</span><br><span class="line">FlyBehavior flyBehavior;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Duck</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performFly</span><span class="params">()</span> &#123;</span><br><span class="line">flyBehavior.fly();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新加入的方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFlyBehavior</span><span class="params">(FlyBehavior fb)</span>&#123;</span><br><span class="line">flyBehavior = fb;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随后，在实现时：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunDuck</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line"><span class="type">Duck</span> <span class="variable">mallard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MallardDuck</span>();</span><br><span class="line">mallard.performFly();</span><br><span class="line">mallard.setFlyBehavior(<span class="keyword">new</span> <span class="title class_">FlyWithWings</span>());</span><br><span class="line">mallard.performFly();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即可动态设定其行为，输出为：<br />cannot fly!!!<br />fly!!!</p><p><strong>这种通过组合行为接口的方式实现动态切换行为的设计模式，称为策略模式（Strategy Pattern），是面向对象设计中的重要思想</strong>。<br /><img src="https://atffang.github.io/2025/06/29/从0开始学java2/策略模式.png"/></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;生活所迫呀。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>美团商业分析精英大赛亚军</title>
    <link href="https://atffang.github.io/2025/06/25/%E7%BE%8E%E5%9B%A2%E5%95%86%E4%B8%9A%E5%88%86%E6%9E%90%E7%B2%BE%E8%8B%B1%E5%A4%A7%E8%B5%9B%E4%BA%9A%E5%86%9B/"/>
    <id>https://atffang.github.io/2025/06/25/%E7%BE%8E%E5%9B%A2%E5%95%86%E4%B8%9A%E5%88%86%E6%9E%90%E7%B2%BE%E8%8B%B1%E5%A4%A7%E8%B5%9B%E4%BA%9A%E5%86%9B/</id>
    <published>2025-06-25T01:29:59.000Z</published>
    <updated>2025-06-25T02:13:11.955Z</updated>
    
    <content type="html"><![CDATA[<p>一起聚——面向聚餐场景的智能餐厅推荐系统</p><span id="more"></span><p>从1206支队伍里杀到了第二，获此殊荣确实在我们意料之外。感谢美团提供的机会与money。<br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_01.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_02.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_03.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_04.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_05.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_06.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_07.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_08.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_09.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_10.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_11.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_12.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_13.png"/><br /><img src="https://atffang.github.io/2025/06/25/美团商业分析精英大赛亚军/决赛-终稿2.5_14.png"/></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;一起聚——面向聚餐场景的智能餐厅推荐系统&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ijgis online</title>
    <link href="https://atffang.github.io/2025/06/14/online%E5%BC%80%E9%A6%99%E6%A7%9F/"/>
    <id>https://atffang.github.io/2025/06/14/online%E5%BC%80%E9%A6%99%E6%A7%9F/</id>
    <published>2025-06-14T01:59:02.000Z</published>
    <updated>2025-06-14T02:11:11.658Z</updated>
    
    <content type="html"><![CDATA[<p>祝贺舒姐的ijgis上线。</p><span id="more"></span><p>从idea到online，前前后后花了一年多的时间，我在其中也只能提供一些微薄的帮助。作者真的太不容易了。<br />虽然现在没有机会主导撰写论文，但看到朋友的成功也会宽慰不少，共勉吧。</p><p>Xu, Y., Gong, Z., Fang, T., Zhang, H., &amp; Tang, G. (2025). Intercity human dynamics during holidays through the lens of travel movement–intention interactions in the hybrid physical–virtual space. <em>International Journal of Geographical Information Science</em>, 1–29. <a href="https://doi.org/10.1080/13658816.2025.2515200">https://doi.org/10.1080/13658816.2025.2515200</a></p><p><strong>Abstract</strong>:<br />Intercity human dynamics has involved increasing interactions between the physical world and cyberspace with the boom of the Internet and social media, expanding traditional intercity activities from a single dimension of physical space to a multidimensional hybrid space. Revealing the dynamics of intercity activities in a hybrid physical–virtual space requires considering interactions between human activities in both the physical world and cyberspace. However, existing studies often overlook cross-space interactions, failing to adequately model interactions between virtual and physical spaces in terms of the network structure and spatial effects. To address these gaps, this study investigates intercity human dynamics through travel movement–intention interactions. A multilayer network framework is proposed to represent the hybrid space, where travel movement–intention interactions can be conceptualized and measured. Using travel and search flows in China during the ‘Labor Day’ holiday periods in a three-year period of the pandemic, we demonstrate the proposed approach’s utility through an analysis of city centrality of multilayer networks. Results find that travel movement–intention interactions exhibit dynamic patterns that vary with city size and geographic distance. This approach is broadly applicable to studies of hybrid physical–virtual spaces, aiding the evaluation of human dynamics beyond intercity activities.</p><p>代码开源至：<br /><a href="https://doi.org/10.6084/m9.figshare.27929466">https://doi.org/10.6084/m9.figshare.27929466</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;祝贺舒姐的ijgis上线。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>从0开始学java 01 ：java面向对象的基础知识</title>
    <link href="https://atffang.github.io/2025/06/05/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java1/"/>
    <id>https://atffang.github.io/2025/06/05/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AD%A6java1/</id>
    <published>2025-06-05T11:54:41.000Z</published>
    <updated>2025-06-29T07:47:09.474Z</updated>
    
    <content type="html"><![CDATA[<p>生活所迫呀。</p><span id="more"></span><p>由于生活所迫，我宣布我现在开始学java。</p><h3 id="第-1-章类与对象实战"><a class="markdownIt-Anchor" href="#第-1-章类与对象实战"></a> 第 1 章：类与对象实战</h3><h4 id="11-定义类-属性-方法"><a class="markdownIt-Anchor" href="#11-定义类-属性-方法"></a> 1.1 定义类、属性、方法</h4><p>在 Java 中，<strong>类（class）是对象的模板</strong>，<strong>对象（object）是类的实例</strong>。类中可以包含：</p><ul><li>属性（字段、变量）：描述对象的特征</li><li>方法：描述对象的行为<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line"><span class="comment">// 属性（成员变量）</span></span><br><span class="line">String name;</span><br><span class="line"><span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法（成员方法）</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span>&#123;</span><br><span class="line">System.out.println(name);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12-创建对象并调用方法"><a class="markdownIt-Anchor" href="#12-创建对象并调用方法"></a> 1.2 创建对象并调用方法</h4><p>创建对象用关键字 <code>new</code>。创建后可以访问属性或调用方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">类名 对象名 = <span class="keyword">new</span> 类名();</span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">p.name = <span class="string">&quot;fty&quot;</span>;</span><br><span class="line">p.age = <span class="number">23</span>;</span><br><span class="line">p.sayHellow();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13-构造方法编写与重载"><a class="markdownIt-Anchor" href="#13-构造方法编写与重载"></a> 1.3 构造方法编写与重载</h4><p><strong>构造方法（Constructor）</strong> 是在 <code>new</code> 一个对象时调用的方法，用来初始化属性。</p><ul><li>构造方法名必须与类名相同</li><li>构造方法可以有多个（重载）<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">String name;</span><br><span class="line"><span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无参构造方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">name = <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">age = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有参构造方法（重载）</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.name = name;</span><br><span class="line"><span class="built_in">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14-使用-this-关键字"><a class="markdownIt-Anchor" href="#14-使用-this-关键字"></a> 1.4 使用 <code>this</code> 关键字</h4><p><code>this</code> 是 Java 中的一个关键字，代表“当前对象”。<br />用在两个场景中：</p><ol><li>解决<strong>方法参数名和属性名冲突</strong></li><li>在类的方法中调用该对象自己的属性或方法<br />如：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">String name;</span><br><span class="line"><span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.name = name;</span><br><span class="line"><span class="built_in">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">showInfo</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="built_in">this</span>.name + <span class="built_in">this</span>.age);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr /><h3 id="第-2-章封装与访问控制实践"><a class="markdownIt-Anchor" href="#第-2-章封装与访问控制实践"></a> 第 2 章：封装与访问控制实践</h3><h4 id="21-使用-private-属性封装数据"><a class="markdownIt-Anchor" href="#21-使用-private-属性封装数据"></a> 2.1 使用 <code>private</code> 属性封装数据</h4><p>在 Java 中，<strong>封装（Encapsulation）</strong> 是把对象的属性隐藏起来，只通过方法进行访问和修改。<br />这通常通过把属性设为 <code>private</code> 实现，防止外部直接访问。<br />如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;   <span class="comment">// 私有属性，外部无法直接访问</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">introduce</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hi, my name is &quot;</span> + name + <span class="string">&quot;, I’m &quot;</span> + age + <span class="string">&quot; years old.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="comment">// ❌ 不能直接访问私有属性</span></span><br><span class="line">        <span class="comment">// p.name = &quot;Tom&quot;;  // 编译错误！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22-编写-getter-setter"><a class="markdownIt-Anchor" href="#22-编写-getter-setter"></a> 2.2 编写 Getter / Setter</h4><p><strong>Getter/Setter</strong> 是访问私有属性的“通道”：</p><ul><li><code>getXxx()</code> 获取属性值</li><li><code>setXxx()</code> 设置属性值<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getter</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="comment">// 可以加判断逻辑，防止非法年龄</span></span><br><span class="line">        <span class="keyword">if</span> (age &gt;= <span class="number">0</span> &amp;&amp; age &lt;= <span class="number">150</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Invalid age.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        p.setName(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">        p.setAge(<span class="number">20</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + p.getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;Age: &quot;</span> + p.getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23-类的访问控制修饰符应用"><a class="markdownIt-Anchor" href="#23-类的访问控制修饰符应用"></a> 2.3 类的访问控制修饰符应用</h4><p>Java 提供四种访问修饰符控制类和类成员的访问范围：</p><table><thead><tr><th>修饰符</th><th>类内</th><th>同包</th><th>子类</th><th>其他包</th></tr></thead><tbody><tr><td><code>private</code></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><code>default</code>（无修饰）</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><code>protected</code></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><code>public</code></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>如：</td><td></td><td></td><td></td><td></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;Mammal&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span> <span class="variable">sound</span> <span class="operator">=</span> <span class="string">&quot;Growl&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">color</span> <span class="operator">=</span> <span class="string">&quot;Brown&quot;</span>;         <span class="comment">// default</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal info: &quot;</span> + type + <span class="string">&quot;, &quot;</span> + sound + <span class="string">&quot;, &quot;</span> + color + <span class="string">&quot;, &quot;</span> + age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line">        System.out.println(a.type);   <span class="comment">// ✅ public</span></span><br><span class="line">        System.out.println(a.sound);  <span class="comment">// ✅ 同包可访问 protected</span></span><br><span class="line">        System.out.println(a.color);  <span class="comment">// ✅ 同包可访问 default</span></span><br><span class="line">        <span class="comment">// System.out.println(a.age); // ❌ private，不能访问</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr /><h3 id="第-3-章继承语法与调用关系"><a class="markdownIt-Anchor" href="#第-3-章继承语法与调用关系"></a> 第 3 章：继承语法与调用关系</h3><h4 id="31-使用-extends-实现继承"><a class="markdownIt-Anchor" href="#31-使用-extends-实现继承"></a> 3.1 使用 <code>extends</code> 实现继承</h4><p>ava 使用 <code>extends</code> 关键字让一个类继承另一个类的属性和方法。<br />✅ 继承的作用：</p><ul><li>子类拥有父类的<strong>非 private 成员</strong>（属性和方法）</li><li>避免重复代码</li><li>体现「是一种（is-a）」的关系<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal is eating...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bark</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Dog is barking...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">        dog.eat();  <span class="comment">// 继承自 Animal</span></span><br><span class="line">        dog.bark(); <span class="comment">// 自己的</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="32-子类调用父类构造器与方法"><a class="markdownIt-Anchor" href="#32-子类调用父类构造器与方法"></a> 3.2 子类调用父类构造器与方法</h4><ul><li>构造器<strong>不能继承</strong>，但可以通过 <code>super()</code> 调用父类构造器。</li><li>子类实例化时，<strong>默认会先调用父类的无参构造器</strong>。<br />如：</li></ul><h5 id="321-父类有无参构造"><a class="markdownIt-Anchor" href="#321-父类有无参构造"></a> 3.2.1 父类有无参构造</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal constructor called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dog constructor called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="322-父类只有有参构造时子类必须显式调用"><a class="markdownIt-Anchor" href="#322-父类只有有参构造时子类必须显式调用"></a> 3.2.2  父类只有有参构造时，子类必须显式调用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="string">&quot;Buddy&quot;</span>); <span class="comment">// 必须显式调用父类构造器</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Dog created&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="33-使用-super-调用父类成员"><a class="markdownIt-Anchor" href="#33-使用-super-调用父类成员"></a> 3.3 使用 <code>super</code> 调用父类成员</h4><ul><li><code>super.变量名</code>：访问父类的属性</li><li><code>super.方法名()</code>：调用父类的方法<br />通常在<strong>子类重写父类方法</strong>时，用 <code>super</code> 调用原始实现。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal moves&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.move(); <span class="comment">// 调用父类方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Bird flies&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="34-子类方法重写override"><a class="markdownIt-Anchor" href="#34-子类方法重写override"></a> 3.4 子类方法重写（<code>@Override</code>）</h4><p>当子类对父类已有方法进行<strong>重新实现</strong>，称为“方法重写”或“覆盖”。<br />必须：</p><ul><li>方法名、参数列表相同</li><li>使用 <code>@Override</code> 注解（推荐）<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal makes a sound&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cat</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Cat meows&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cat</span>(); <span class="comment">// 向上转型</span></span><br><span class="line">        a.sound();            <span class="comment">// 输出 &quot;Cat meows&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然类型是 <code>Animal</code>，但调用的是 <code>Cat</code> 的实现 —— 这就是<strong>多态</strong>的表现。</p><hr /><h3 id="第-4-章方法重载与重写"><a class="markdownIt-Anchor" href="#第-4-章方法重载与重写"></a> 第 4 章：方法重载与重写</h3><h4 id="41-方法重载实现"><a class="markdownIt-Anchor" href="#41-方法重载实现"></a> 4.1 方法重载实现</h4><p><strong>方法重载</strong>是指在<strong>同一个类中</strong>，方法名相同，但参数列表不同（个数或类型）。其特点为：</p><ul><li>与返回值无关</li><li>是编译时多态的一种形式<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">add</span><span class="params">(<span class="type">double</span> a, <span class="type">double</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b + c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Calculator</span>();</span><br><span class="line">        System.out.println(c.add(<span class="number">1</span>, <span class="number">2</span>));           <span class="comment">// int + int</span></span><br><span class="line">        System.out.println(c.add(<span class="number">1.5</span>, <span class="number">2.5</span>));       <span class="comment">// double + double</span></span><br><span class="line">        System.out.println(c.add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));        <span class="comment">// 三个 int</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="42-方法重写规则"><a class="markdownIt-Anchor" href="#42-方法重写规则"></a> 4.2 方法重写规则</h4><p><strong>方法重写</strong>发生在<strong>继承结构中</strong>，子类重写父类已有方法，必须满足以下规则：</p><table><thead><tr><th>要求</th><th>内容</th></tr></thead><tbody><tr><td>方法名</td><td>必须相同</td></tr><tr><td>参数列表</td><td>必须相同</td></tr><tr><td>返回值类型</td><td>必须相同或子类型</td></tr><tr><td>访问权限</td><td>不能低于父类</td></tr><tr><td>抛出异常</td><td>不能抛出更多的受检异常</td></tr><tr><td>标记</td><td>建议使用 <code>@Override</code> 注解</td></tr><tr><td>如：</td><td></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal sound&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dog barks&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">        a.makeSound(); <span class="comment">// 输出：Dog barks</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="43-重写-vs-重载对比实战"><a class="markdownIt-Anchor" href="#43-重写-vs-重载对比实战"></a> 4.3 重写 vs 重载对比实战</h4><table><thead><tr><th>特性</th><th>重载（Overload）</th><th>重写（Override）</th></tr></thead><tbody><tr><td>定义位置</td><td>同一个类中</td><td>子类与父类之间</td></tr><tr><td>方法名</td><td>相同</td><td>相同</td></tr><tr><td>参数列表</td><td>必须不同</td><td>必须相同</td></tr><tr><td>返回值</td><td>可不同（不构成重载）</td><td>必须相同或是子类类型</td></tr><tr><td>访问修饰符</td><td>无限制</td><td>子类不能比父类更严格</td></tr><tr><td>多态</td><td>编译时多态</td><td>运行时多态</td></tr></tbody></table><hr /><h3 id="第-5-章多态与父类引用"><a class="markdownIt-Anchor" href="#第-5-章多态与父类引用"></a> 第 5 章：多态与父类引用</h3><h4 id="51-父类引用指向子类对象"><a class="markdownIt-Anchor" href="#51-父类引用指向子类对象"></a> 5.1 父类引用指向子类对象</h4><p>在Java中，<strong>父类类型的引用变量</strong>可以指向<strong>子类对象</strong>。这称为“向上转型”（Upcasting），是多态的基础。<br />如上面提到的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Animal</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br></pre></td></tr></table></figure><ul><li>这里<code>a</code>的类型是<code>Animal</code>，但实际引用的是<code>Dog</code>对象。</li><li>父类引用只能访问父类中声明的成员（变量和方法）。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal sound&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dog barks&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dog wags tail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();  <span class="comment">// 父类引用指向子类对象</span></span><br><span class="line">        a.makeSound();         <span class="comment">// 调用的是子类重写的方法</span></span><br><span class="line">        <span class="comment">// a.wagTail();        // 编译错误，父类引用不能调用子类独有方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="52-多态方法调用效果"><a class="markdownIt-Anchor" href="#52-多态方法调用效果"></a> 5.2 多态方法调用效果</h4><p>虽然引用类型是父类，但<strong>方法调用执行的是子类重写后的版本</strong>，体现“运行时绑定”。这让程序更加灵活，接口统一，具体实现多样。</p><ul><li>调用<strong>方法</strong>时，会执行子类重写的方法（如果有）；</li><li>访问<strong>成员变量</strong>时，访问的是引用类型所属类的变量（不支持多态）；<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Animal&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Cat&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line">        System.out.println(a.name);  <span class="comment">// 输出 &quot;Animal&quot;</span></span><br><span class="line">        a.printName();               <span class="comment">// 输出 &quot;Cat&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="53-多态与数组-集合应用"><a class="markdownIt-Anchor" href="#53-多态与数组-集合应用"></a> 5.3 多态与数组、集合应用</h4><p>多态也可以与数组和集合结合使用，方便统一管理不同子类对象。<br />如：</p><h5 id="531-多态数组"><a class="markdownIt-Anchor" href="#531-多态数组"></a> 5.3.1 多态数组</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Animal[] animals = <span class="keyword">new</span> <span class="title class_">Animal</span>[<span class="number">3</span>];</span><br><span class="line">animals[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">animals[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line">animals[<span class="number">2</span>] = <span class="keyword">new</span> <span class="title class_">Animal</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Animal a : animals) &#123;</span><br><span class="line">    a.makeSound();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="532-多态集合"><a class="markdownIt-Anchor" href="#532-多态集合"></a> 5.3.2 多态集合</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line">List&lt;Animal&gt; animalList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">animalList.add(<span class="keyword">new</span> <span class="title class_">Dog</span>());</span><br><span class="line">animalList.add(<span class="keyword">new</span> <span class="title class_">Cat</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Animal a : animalList) &#123;</span><br><span class="line">    a.makeSound();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr /><h3 id="第-6-章object-类与常用方法"><a class="markdownIt-Anchor" href="#第-6-章object-类与常用方法"></a> 第 6 章：<code>Object</code> 类与常用方法</h3><h4 id="61-tostring-方法重写"><a class="markdownIt-Anchor" href="#61-tostring-方法重写"></a> 6.1 <code>toString()</code> 方法重写</h4><p><code>toString()</code> 是 <code>Object</code> 类中定义的方法，所有Java类默认继承。 默认实现返回的是对象的<strong>类名 + @ + 哈希码</strong>，不够直观。 重写 <code>toString()</code> 让对象打印时更具可读性，常用于调试和日志。<br />如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;name=&#x27;&quot;</span> + name + <span class="string">&quot;&#x27;, age=&quot;</span> + age + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Alice&quot;</span>, <span class="number">25</span>);</span><br><span class="line">        System.out.println(p);  <span class="comment">// 自动调用 toString()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="62-equals-比较对象内容"><a class="markdownIt-Anchor" href="#62-equals-比较对象内容"></a> 6.2 <code>equals()</code> 比较对象内容</h4><p>默认 <code>equals()</code> 方法是比较两个对象的<strong>引用地址</strong>（即是否是同一个对象）, 重写 <code>equals()</code> 方法，通常基于对象的<strong>属性内容</strong>进行比较。常与 <code>hashCode()</code> 一起重写，以保证集合中的正确行为。<br />如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数和 getter/setter 省略</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == obj) <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 比较同一个对象</span></span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span> || getClass() != obj.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 类型检查</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Person</span> <span class="variable">other</span> <span class="operator">=</span> (Person) obj;</span><br><span class="line">        <span class="keyword">return</span> age == other.age &amp;&amp; (name != <span class="literal">null</span> ? name.equals(other.name) : other.name == <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Bob&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Bob&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(p1.equals(p2));  <span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="63-clone-方法与浅拷贝"><a class="markdownIt-Anchor" href="#63-clone-方法与浅拷贝"></a> 6.3 <code>clone()</code> 方法与浅拷贝</h4><p><code>clone()</code> 是 <code>Object</code> 中的一个方法，用来复制对象。 默认实现是<strong>浅拷贝</strong>：基本类型拷贝，引用类型只复制引用。 需要实现 <code>Cloneable</code> 接口并重写 <code>clone()</code>，否则会抛出异常。浅拷贝对于对象中有引用类型字段时，拷贝后两个对象会共享同一个引用字段。<br />如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Address</span><span class="params">(String city)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.city = city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Address <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> (Address) <span class="built_in">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter 省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Address address)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Person <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">cloned</span> <span class="operator">=</span> (Person) <span class="built_in">super</span>.clone();</span><br><span class="line">        <span class="comment">// 浅拷贝：address对象引用被复制，两个Person共享同一个Address对象</span></span><br><span class="line">        <span class="keyword">return</span> cloned;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Person</code> 的 <code>clone()</code> 是浅拷贝，拷贝的 <code>Person</code> 对象和原对象的 <code>address</code> 指向同一个 <code>Address</code> 实例。</li><li>若需完全拷贝（深拷贝），需要对引用字段也进行 <code>clone()</code>。</li></ul><hr /><h3 id="第-7-章static-与-final-关键字用法"><a class="markdownIt-Anchor" href="#第-7-章static-与-final-关键字用法"></a> 第 7 章：<code>static</code> 与 <code>final</code> 关键字用法</h3><h4 id="71-静态属性与静态方法"><a class="markdownIt-Anchor" href="#71-静态属性与静态方法"></a> 7.1 静态属性与静态方法</h4><ul><li><strong><code>static</code></strong> 修饰的成员属于类本身，而不是某个对象。</li><li>静态属性（变量）在内存中只有一份，所有对象共享。</li><li>静态方法可以直接通过类名调用，无需创建实例。</li><li>静态方法中不能访问非静态成员（因为非静态属于对象）。<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;  <span class="comment">// 静态变量，所有对象共享</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Counter</span><span class="params">()</span> &#123;</span><br><span class="line">        count++;  <span class="comment">// 每创建一个对象，count自增</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;  <span class="comment">// 静态方法，访问静态变量</span></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Counter</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Counter</span>();</span><br><span class="line">        System.out.println(Counter.getCount());  <span class="comment">// 输出 2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="72-静态代码块"><a class="markdownIt-Anchor" href="#72-静态代码块"></a> 7.2 静态代码块</h4><ul><li>静态代码块用于类加载时执行一次的初始化操作。</li><li>适合做复杂的静态变量初始化。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String ENV;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> MAX_USERS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ENV = <span class="string">&quot;production&quot;</span>;</span><br><span class="line">        MAX_USERS = <span class="number">1000</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;Config 类被加载，静态代码块执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(Config.ENV);       <span class="comment">// &quot;production&quot;</span></span><br><span class="line">        System.out.println(Config.MAX_USERS); <span class="comment">// 1000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：静态代码块只执行一次，且在类被首次加载时执行。</p><h4 id="73-final-类-方法-变量使用"><a class="markdownIt-Anchor" href="#73-final-类-方法-变量使用"></a> 7.3 <code>final</code> 类、方法、变量使用</h4><p><code>final</code> 可以修饰变量、方法、类，含义不同：</p><table><thead><tr><th>用法</th><th>说明</th></tr></thead><tbody><tr><td>final 变量</td><td>常量，一旦赋值不可更改</td></tr><tr><td>final 方法</td><td>不可被子类重写</td></tr><tr><td>final 类</td><td>不能被继承的类（比如 <code>String</code> 类）</td></tr><tr><td>如：</td><td></td></tr></tbody></table><h5 id="731-final变量"><a class="markdownIt-Anchor" href="#731-final变量"></a> 7.3.1 final变量</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Constants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">PI</span> <span class="operator">=</span> <span class="number">3.14159</span>;  <span class="comment">// 常量，命名规范全部大写</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// PI = 3.14;  // 编译错误，final变量不可修改</span></span><br><span class="line">        System.out.println(Constants.PI);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="732-final方法"><a class="markdownIt-Anchor" href="#732-final方法"></a> 7.3.2 final方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Parent final method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="comment">// public void show() &#123;  // 编译错误，final方法不能被重写</span></span><br><span class="line">    <span class="comment">//     System.out.println(&quot;Child override&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="733-final类"><a class="markdownIt-Anchor" href="#733-final类"></a> 7.3.3 final类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Utility</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">help</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Helping...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// class ExtendedUtility extends Utility &#123;  // 编译错误，final类不能被继承</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><hr /><h3 id="第-8-章抽象类与接口"><a class="markdownIt-Anchor" href="#第-8-章抽象类与接口"></a> 第 8 章：抽象类与接口</h3><h4 id="81-抽象类与抽象方法编写"><a class="markdownIt-Anchor" href="#81-抽象类与抽象方法编写"></a> 8.1 抽象类与抽象方法编写</h4><ul><li><strong>抽象类</strong> 是不能被实例化的类，用于被继承。</li><li>抽象类中可以包含抽象方法（没有方法体，只定义方法签名），必须由子类实现。</li><li>抽象类也可以有普通方法和成员变量。</li><li>用 <code>abstract</code> 关键字声明。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象方法，没有方法体</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">sound</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot; is sleeping.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot; says: Woof!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Animal</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;Buddy&quot;</span>);</span><br><span class="line">        dog.sound();  <span class="comment">// 输出 Buddy says: Woof!</span></span><br><span class="line">        dog.sleep();  <span class="comment">// 输出 Buddy is sleeping.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="82-接口的定义与实现"><a class="markdownIt-Anchor" href="#82-接口的定义与实现"></a> 8.2 接口的定义与实现</h4><ul><li><strong>接口</strong> 是一种纯抽象的规范，只有方法签名和常量（Java 8+ 支持默认方法和静态方法）。</li><li>类通过 <code>implements</code> 关键字实现接口，必须实现接口中的所有抽象方法。</li><li>接口体现的是“能做什么”的能力，抽象类体现的是“是什么”的属性和行为。<br />如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Flyable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Swimmable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Duck</span> <span class="keyword">implements</span> <span class="title class_">Flyable</span>, Swimmable &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Duck is flying.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Duck is swimming.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Duck</span> <span class="variable">duck</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Duck</span>();</span><br><span class="line">        duck.fly();</span><br><span class="line">        duck.swim();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="83-接口多实现-向上转型"><a class="markdownIt-Anchor" href="#83-接口多实现-向上转型"></a> 8.3 接口多实现、向上转型</h4><ul><li>一个类可以实现多个接口（多继承的替代方案）。</li><li>可以将实现类对象向上转型为接口类型，利用多态调用接口方法。</li><li>接口变量只能调用接口中声明的方法。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Duck</span> <span class="variable">duck</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Duck</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Flyable</span> <span class="variable">f</span> <span class="operator">=</span> duck;   <span class="comment">// 向上转型为Flyable接口</span></span><br><span class="line">        <span class="type">Swimmable</span> <span class="variable">s</span> <span class="operator">=</span> duck; <span class="comment">// 向上转型为Swimmable接口</span></span><br><span class="line"></span><br><span class="line">        f.fly();  <span class="comment">// 调用Flyable的方法</span></span><br><span class="line">        s.swim(); <span class="comment">// 调用Swimmable的方法</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// duck.fly();  // 直接调用实现类方法也可以</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="84-继承和实现的混合使用"><a class="markdownIt-Anchor" href="#84-继承和实现的混合使用"></a> 8.4 继承和实现的混合使用</h4><ul><li>一个类只能继承<strong>一个</strong>直接父类（单继承）。</li><li>但可以实现<strong>多个</strong>接口（多实现）。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal is eating&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Flyable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类继承父类，同时实现接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> <span class="keyword">implements</span> <span class="title class_">Flyable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bird is flying&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Bird</span> <span class="variable">bird</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bird</span>();</span><br><span class="line">        bird.eat();  <span class="comment">// 继承自 Animal</span></span><br><span class="line">        bird.fly();  <span class="comment">// 实现自 Flyable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第-8-章示例-地理要素系统"><a class="markdownIt-Anchor" href="#第-8-章示例-地理要素系统"></a> 第 8 章：示例-地理要素系统</h3><h4 id="设计说明"><a class="markdownIt-Anchor" href="#设计说明"></a> 设计说明</h4><ul><li>抽象类 <code>GeoFeature</code>（地理要素），定义公共属性和抽象方法</li><li>子类：<code>PointFeature</code>（点）、<code>LineFeature</code>（线）、<code>PolygonFeature</code>（多边形）</li><li>接口 <code>Renderable</code>（可渲染），<code>Calculable</code>（可计算面积或长度）</li><li>利用封装隐藏属性，提供 getter/setter</li><li>使用 <code>static</code> 统计创建的地理要素数量</li><li>使用 <code>final</code> 定义常量和禁止修改的方法</li><li>重写 <code>toString()</code>, <code>equals()</code>, <code>clone()</code></li><li>演示多态和接口多实现</li></ul><h4 id="代码实现"><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 抽象类，定义基础地理要素</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GeoFeature</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">featureCount</span> <span class="operator">=</span> <span class="number">0</span>;  <span class="comment">// 统计创建要素数量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GeoFeature</span><span class="params">(String id, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        featureCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装属性</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123; <span class="built_in">this</span>.id = id; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getFeatureCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> featureCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象方法，必须子类实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// final方法，不能被子类覆盖，打印信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">showInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;GeoFeature: &quot;</span> + toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写toString()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ID=&quot;</span> + id + <span class="string">&quot;, Name=&quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写equals，按id判断</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == obj) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> GeoFeature)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">GeoFeature</span> <span class="variable">other</span> <span class="operator">=</span> (GeoFeature) obj;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.id.equals(other.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现clone浅拷贝</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GeoFeature <span class="title function_">clone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (GeoFeature) <span class="built_in">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 接口：可渲染</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Renderable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">render</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 接口：可计算长度或面积</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Calculable</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="title function_">calculate</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 点要素</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointFeature</span> <span class="keyword">extends</span> <span class="title class_">GeoFeature</span> <span class="keyword">implements</span> <span class="title class_">Renderable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> x, y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PointFeature</span><span class="params">(String id, String name, <span class="type">double</span> x, <span class="type">double</span> y)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(id, name);</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getX</span><span class="params">()</span> &#123; <span class="keyword">return</span> x; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setX</span><span class="params">(<span class="type">double</span> x)</span> &#123; <span class="built_in">this</span>.x = x; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getY</span><span class="params">()</span> &#123; <span class="keyword">return</span> y; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setY</span><span class="params">(<span class="type">double</span> y)</span> &#123; <span class="built_in">this</span>.y = y; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Drawing Point at (&quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Rendering Point: &quot;</span> + getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.toString() + <span class="string">&quot;, Point(&quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 线要素</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LineFeature</span> <span class="keyword">extends</span> <span class="title class_">GeoFeature</span> <span class="keyword">implements</span> <span class="title class_">Renderable</span>, Calculable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LineFeature</span><span class="params">(String id, String name, <span class="type">double</span> length)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(id, name);</span><br><span class="line">        <span class="built_in">this</span>.length = length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getLength</span><span class="params">()</span> &#123; <span class="keyword">return</span> length; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLength</span><span class="params">(<span class="type">double</span> length)</span> &#123; <span class="built_in">this</span>.length = length; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Drawing Line of length &quot;</span> + length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Rendering Line: &quot;</span> + getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法重载：计算长度乘以比例尺</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculate</span><span class="params">(<span class="type">double</span> scale)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> length * scale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.toString() + <span class="string">&quot;, Line length=&quot;</span> + length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 多边形要素</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PolygonFeature</span> <span class="keyword">extends</span> <span class="title class_">GeoFeature</span> <span class="keyword">implements</span> <span class="title class_">Renderable</span>, Calculable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> area;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PolygonFeature</span><span class="params">(String id, String name, <span class="type">double</span> area)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(id, name);</span><br><span class="line">        <span class="built_in">this</span>.area = area;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getArea</span><span class="params">()</span> &#123; <span class="keyword">return</span> area; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArea</span><span class="params">(<span class="type">double</span> area)</span> &#123; <span class="built_in">this</span>.area = area; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Drawing Polygon of area &quot;</span> + area);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">render</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Rendering Polygon: &quot;</span> + getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> area;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.toString() + <span class="string">&quot;, Polygon area=&quot;</span> + area;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;生活所迫呀。&lt;/p&gt;</summary>
    
    
    
    <category term="编程学习-java" scheme="https://atffang.github.io/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0-java/"/>
    
    
  </entry>
  
  <entry>
    <title>继续聊聊异步</title>
    <link href="https://atffang.github.io/2025/05/29/%E7%BB%A7%E7%BB%AD%E8%81%8A%E8%81%8A%E5%BC%82%E6%AD%A5/"/>
    <id>https://atffang.github.io/2025/05/29/%E7%BB%A7%E7%BB%AD%E8%81%8A%E8%81%8A%E5%BC%82%E6%AD%A5/</id>
    <published>2025-05-29T15:39:59.000Z</published>
    <updated>2025-05-29T15:46:47.446Z</updated>
    
    <content type="html"><![CDATA[<p>和之前的文章呼应下，继续介绍python的异步机制。</p><span id="more"></span><p>在之前的文章中（指路[<a href="https://atffang.github.io/2025/02/21/asyncio%E6%B5%85%E6%9E%90/#more">https://atffang.github.io/2025/02/21/asyncio浅析/#more</a>]），我们简单学习了python的asynicio机制，但当我回看这篇文章时，仍然觉得许多东西——特别是概念，没有讲清楚。因此有了这篇文章，我们将从底层机制开始介绍python中的异步操作。</p><h3 id="为什么要异步"><a class="markdownIt-Anchor" href="#为什么要异步"></a> 为什么要异步？</h3><p>中国人应该都听过华罗庚烧开水的故事。其中办法甲是洗好水壶，灌上凉水，放在火上；在等待水开的时间里，洗茶壶、洗茶杯、拿茶叶；等水开了，泡茶喝。等待某个事件完成（比如水开）时，如果一直干等，时间就被浪费了；如果能利用等待时间去做其他有意义的事情，效率就会更高。在程序设计中，也是如此：</p><p>当程序遇到“必须等待”的操作时，比如等待网络响应、磁盘读写、用户输入，如果我们像传统方式那样干等，就会浪费大量宝贵时间。而如果我们能在等待的间隙去做别的事情，整体运行效率就能大幅提升。</p><p>这就是 <strong>异步编程（Asynchronous Programming）</strong> 的核心思想。异步编程是一种程序设计方式，它允许程序在遇到耗时操作时“暂时挂起当前任务”，去执行其他任务，待耗时操作完成后再回来继续执行。这样，程序不会因为等待某个操作而“卡死”或闲置，特别适合处理大量 I/O 操作的场景。</p><h3 id="协程"><a class="markdownIt-Anchor" href="#协程"></a> 协程</h3><p>协程（Coroutine）是一种程序结构，允许函数在执行过程中暂停（挂起）并在未来某个时间恢复执行。它是一种“可暂停的函数”，实现了非抢占式的多任务协作。通俗来说，协程可以在执行中途“让出控制权”，让其他协程运行，等到时机合适再“继续执行”，而不是像线程那样被操作系统抢占。</p><p>Python中的协程，特别是用 async def 定义的异步协程，实际上是基于<strong>生成器（generator）</strong> 机制演化而来的。生成器是一种特殊的迭代器，它可以在执行过程中暂停，并在需要时恢复执行。生成器函数使用 yield 关键字来生成值，每次调用 yield 时，函数会暂停执行，并返回一个值给调用者。下次调用生成器时，函数会从上次暂停的地方继续执行。这种暂停等待执行的状态成为<strong>挂起</strong>，传统函数调用有自己的调用栈，调用结束后栈帧销毁，而挂起状态的函数并不会销毁内部变量和参数。</p><p>Python中，每次函数调用都会创建一个 帧对象（PyFrameObject，C语言结构体），它包含了函数执行的所有上下文信息：</p><ul><li>当前指令指针（程序计数器，PC），指示下一条要执行的字节码位置</li><li>局部变量和参数</li><li>操作数栈状态</li><li>代码对象引用</li></ul><p>生成器和协程本质上也是函数调用，只不过在挂起时不会销毁帧对象，而是把它冻结保存起来。当协程执行到await或者yield时，Python解释器暂停执行当前帧，保存当前指令指针位置（即当前字节码执行到哪一步了）。局部变量、操作栈以及执行环境的状态都保存在该帧对象内，这个帧对象作为生成器/协程对象的内部状态，存活在内存中。当事件循环或调度器认为条件满足（比如等待的异步I/O完成），它会调用生成器/协程的 <code>.send()</code> 或 <code>.__await__()</code> 方法，让Python解释器加载之前保存的帧对象状态，从断点处继续执行字节码。</p><h3 id="事件循环"><a class="markdownIt-Anchor" href="#事件循环"></a> 事件循环</h3><p><strong>事件循环（Event Loop）</strong> 是异步编程的核心调度机制，它不断循环监视“任务队列”或“事件源”，并在任务准备好执行时唤醒它们。我们在之前的文章中已经提到，协程对象执行到 <code>await</code> 会挂起并返回控制权，而要继续执行，就必须有一个机制来等待 <code>await</code> 的异步任务完成，再恢复暂停的协程。这个“等待+恢复”的过程，由事件循环自动调度完成。事件循环由下面四个关键部分组成：</p><ul><li><p><strong>Task 队列（任务队列）</strong><br />一个 Task 是对协程的封装，用于注册到事件循环中，并自动驱动协程的执行流程。协程对象会被封装为 asyncio.Task 对象，并加入事件循环管理的队列。</p></li><li><p><strong>Future 对象</strong><br />表示一个尚未完成的异步操作，类似于 JavaScript 的 Promise。Future是Task的父类，而await 的结果通常是 Future。</p></li><li><p><strong>IO 多路复用器</strong><br />使用操作系统的 select/epoll/kqueue/IOCP 来等待 I/O 事件。每个 await 的对象会注册一个 I/O 事件（如 socket 可读、定时器到期），这些事件会被提交到 selector，操作系统会在事件准备好时通知事件循环，事件循环再调用回调函数恢复协程。</p></li><li><p><strong>调度器</strong><br />调度器是事件循环的大脑，它控制协程的暂停与恢复。协程本质是生成器（generator）的拓展，调度行为是调用其 <code>send()</code> 或 <code>throw()</code> 方法。协程首次执行相当于 <code>coro.send(None)</code>，遇到 <code>await</code> 时将控制权交还给事件循环，并返回一个 <code>Future</code> 对象。事件循环等待 <code>Future</code> 对象完成，然后调用 <code>task._step()</code> 方法，执行 <code>coro.send(result)</code> ，恢复协程执行直到下一个 <code>await</code> 或结束。</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------+</span><br><span class="line">| asyncio.Task |</span><br><span class="line">| - 包含一个协程对象 |</span><br><span class="line">+---------------------------+</span><br><span class="line">↓</span><br><span class="line">初始执行 coro.send(<span class="literal">None</span>)</span><br><span class="line">↓</span><br><span class="line">协程执行 → 遇到 <span class="keyword">await</span></span><br><span class="line">↓</span><br><span class="line">返回 Future，挂起协程</span><br><span class="line">↓</span><br><span class="line">Future 注册到底层 IO selector</span><br><span class="line">↓</span><br><span class="line">事件完成 → Future 被标记为 done</span><br><span class="line">↓</span><br><span class="line">唤醒 Task → 再次执行 coro.send(result)</span><br><span class="line">↓</span><br><span class="line">直至结束</span><br></pre></td></tr></table></figure><h3 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h3><h4 id="爬虫"><a class="markdownIt-Anchor" href="#爬虫"></a> 爬虫</h4><p>任务目标：我们有 5 个网页，要同时请求它们的内容并提取标题。我们希望在不阻塞主线程的情况下完成所有请求。如果使用串行执行的方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">  </span><br><span class="line">urls = [</span><br><span class="line"><span class="string">&quot;https://1.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://2.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://3.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://4.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;https://5.com&quot;</span></span><br><span class="line">] </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">url</span>):</span><br><span class="line">response = requests.get(url)</span><br><span class="line"><span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;url&#125;</span> - status: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line"><span class="built_in">print</span>(get_title(url))</span><br></pre></td></tr></table></figure><p>所有请求会一个接一个等。<br />如果使用异步方式（并发请求，非阻塞）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">session, url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        text = <span class="keyword">await</span> response.text()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;url&#125;</span> - status: <span class="subst">&#123;response.status&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        tasks = [get_title(session, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">            <span class="built_in">print</span>(r)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><h4 id="处理大量文件上传"><a class="markdownIt-Anchor" href="#处理大量文件上传"></a> 处理大量文件上传</h4><p>你在做一个网站，有很多用户同时上传文件（比如照片），你需要接收上传请求/将文件保存到磁盘或对象存储/同时记录用户上传日志（如用户名、时间、文件名）到数据库或日志文件中。<br />如果使用同步方式，所有请求会一个接一个等，用户上传文件时，其他用户只能等待:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_file</span>(<span class="params">user, file_name</span>):</span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 模拟写文件</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[保存] 用户 <span class="subst">&#123;user&#125;</span> 上传了 <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_upload</span>(<span class="params">user, file_name</span>):</span><br><span class="line">    time.sleep(<span class="number">1</span>)  <span class="comment"># 模拟写日志</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[日志] 记录 <span class="subst">&#123;user&#125;</span> 上传了 <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_upload</span>(<span class="params">user, file_name</span>):</span><br><span class="line">    save_file(user, file_name)</span><br><span class="line">    log_upload(user, file_name)</span><br><span class="line"></span><br><span class="line">users = [(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;a.png&quot;</span>), (<span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;b.jpg&quot;</span>), (<span class="string">&quot;Carol&quot;</span>, <span class="string">&quot;c.docx&quot;</span>)]</span><br><span class="line"><span class="keyword">for</span> user, file <span class="keyword">in</span> users:</span><br><span class="line">    handle_upload(user, file)</span><br></pre></td></tr></table></figure><p>如果使用异步方式，所有请求可以同时处理，用户上传文件时，其他用户可以继续上传。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">save_file</span>(<span class="params">user, file_name</span>):</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># 模拟异步写文件</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[保存] 用户 <span class="subst">&#123;user&#125;</span> 上传了 <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">log_upload</span>(<span class="params">user, file_name</span>):</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># 模拟异步写日志</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[日志] 记录 <span class="subst">&#123;user&#125;</span> 上传了 <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_upload</span>(<span class="params">user, file_name</span>):</span><br><span class="line">    <span class="keyword">await</span> save_file(user, file_name)</span><br><span class="line">    <span class="keyword">await</span> log_upload(user, file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    users = [(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;a.png&quot;</span>), (<span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;b.jpg&quot;</span>), (<span class="string">&quot;Carol&quot;</span>, <span class="string">&quot;c.docx&quot;</span>)]</span><br><span class="line">    tasks = [handle_upload(user, file) <span class="keyword">for</span> user, file <span class="keyword">in</span> users]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;和之前的文章呼应下，继续介绍python的异步机制。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>重返统计学1：从最大似然开始</title>
    <link href="https://atffang.github.io/2025/05/28/%E9%87%8D%E8%BF%94%E7%BB%9F%E8%AE%A1%E5%AD%A62%E4%BB%8E%E6%9C%80%E5%A4%A7%E4%BC%BC%E7%84%B6%E5%BC%80%E5%A7%8B/"/>
    <id>https://atffang.github.io/2025/05/28/%E9%87%8D%E8%BF%94%E7%BB%9F%E8%AE%A1%E5%AD%A62%E4%BB%8E%E6%9C%80%E5%A4%A7%E4%BC%BC%E7%84%B6%E5%BC%80%E5%A7%8B/</id>
    <published>2025-05-28T14:24:16.000Z</published>
    <updated>2025-05-28T14:28:10.645Z</updated>
    
    <content type="html"><![CDATA[<p>介绍一下最大似然</p><span id="more"></span><img src="https://atffang.github.io/2025/05/28/重返统计学2从最大似然开始/MLE.png"/>]]></content>
    
    
    <summary type="html">&lt;p&gt;介绍一下最大似然&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>重返统计学0：绪论</title>
    <link href="https://atffang.github.io/2025/05/27/%E9%87%8D%E8%BF%94%E7%BB%9F%E8%AE%A1%E5%AD%A60%E7%BB%AA%E8%AE%BA/"/>
    <id>https://atffang.github.io/2025/05/27/%E9%87%8D%E8%BF%94%E7%BB%9F%E8%AE%A1%E5%AD%A60%E7%BB%AA%E8%AE%BA/</id>
    <published>2025-05-27T12:20:35.000Z</published>
    <updated>2025-05-27T12:21:22.983Z</updated>
    
    <content type="html"><![CDATA[<p>挖个坑</p><span id="more"></span><p>作为一个地理系的学生，诚实的说，我对数学与统计学的认识十分有限而肤浅。唯一的训练是在本科时的基础课程概率论课上，那时正值南京新冠最严重的22年年初，多数的课通过网课的形式完成，或许这里面一多半时间还在睡梦中。在此之后，除了零零碎碎接触的知识，再也没系统性的学习过统计学，以至于现在总是力不从心。因此，打算新开一个坑，从一个小白的角度重新学习面向机器学习与地理的统计学知识，共勉！</p><p>统计学（Statistics）一词源自拉丁语 status（意为“国家事务”），最早在17世纪的德意志地区，用于指代关于国家人口、土地、税收的系统性数据收集与描述，被称为“政治算术”（Political Arithmetic）。随着时代发展，它逐渐脱离行政统计的原始功能，<strong>成为一门研究不确定性、分析数据规律、从样本推断总体的科学</strong>。</p><p>统计学的形成并非一蹴而就，而是在长期应对不确定性与社会复杂性的历史进程中逐步建立起来的。最初，17世纪的“政治算术”是统计思想的雏形，约翰·格朗特与威廉·配第通过对伦敦死亡票据的分析，首次尝试利用数据揭示人口规律，这种自国家行政管理中抽离出的数量思维，构成了统计学最早的社会实践背景。18世纪，雅各布·伯努利提出了大数定律，强调了样本频率与真实概率之间的趋同关系，拉开了从经验总结向概率理论过渡的序幕。同一时期，贝叶斯定理的提出标志着另一种思维路径的诞生，即将先验知识与数据更新相结合，探索对不确定现象进行概率建模的可能性</p><p>进入19世纪，随着数学分析的发展，统计学逐渐获得更加严密的形式化基础。高斯在误差理论中提出正态分布和最小二乘估计，拉普拉斯则将概率方法应用于天体运动分析，他们的工作将统计方法首次嵌入自然科学建模之中，也开启了参数估计与模型拟合的时代。到20世纪，统计学迎来了系统化的理论建构。罗纳德·费雪被广泛认为是现代统计学的奠基者之一，他不仅提出了极大似然估计、方差分析、设计实验等核心概念，还在哲学上确立了频率派立场，主张在重复试验中定义概率，并强调统计推断的客观性。与之并立的则是以杰弗里斯和萨维奇为代表的贝叶斯学派，强调知识的不确定性来源于认知主体本身，通过主观先验与后验更新，实现具有解释力的模型推理。这一“客观 vs 主观”、“频率 vs 信念”的思想分歧，至今仍构成统计方法论上的根本张力。</p><p>到了21世纪，随着计算能力的跃升与数据体量的激增，统计学与人工智能、机器学习逐步融合，形成了以预测精度、模型泛化能力为导向的新范式。在这一背景下，统计学习理论、正则化方法、贝叶斯推理和高维建模成为主流应用技术的理论支柱。统计模型不再仅仅用于科学实验与假设检验，而广泛应用于图像识别、自然语言处理、医疗诊断、政策评估等复杂系统的建模中，进一步模糊了“推断”与“预测”的边界。</p><p><strong>统计学的核心使命，是在面对不确定性和变异性的现实世界中，从有限样本中提取信息、推断总体特征，建立描述或解释变量间关系的模型</strong>。</p><p>频率与概率的区别，是统计学中一个根本而经典的问题，也正是区分统计学两大主要流派——频率派（Frequentist）和贝叶斯派（Bayesian）的核心所在。</p><p>在频率派统计学中，概率被严格定义为在大量重复独立试验中某事件发生的相对频率的极限。也就是说，概率是一个长期稳定出现的频率值，它是客观存在且可通过反复实验验证的数值。例如，抛硬币时正面朝上的概率是0.5，是在无限次抛掷中正面次数与总次数的比值趋近的极限。这种定义强调概率的客观性和实验可重复性，概率不存在于单次试验，而是长期统计规律的体现。</p><p>而在贝叶斯派中，概率则被解释为个体对某一事件发生不确定性的主观信念程度。概率是描述“知识状态”或“信息”的工具，可以用来表达对单个事件的可信度。贝叶斯概率不需要重复试验的物理基础，而是通过先验知识与新观测的结合，利用贝叶斯定理动态更新。比如，你对某个病人患病概率的估计，既包含医学知识，也包含个人观察结果，这种概率更像是“信念”的度量。</p><p>总结而言，频率派认为，参数是自然界固定的未知常数，数据是随机变量。统计推断的目标是利用样本数据来估计这些固定参数。而贝叶斯派则认为，参数本身就是随机变量，参数的不确定性通过一个先验分布来描述。在下一章中，我们将首先对这两个概念进行介绍，作为整个系列的引子。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;挖个坑&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
</feed>
